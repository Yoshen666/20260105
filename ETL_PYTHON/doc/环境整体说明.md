# 共通说明
## xinxiang/util/cons.py
    从Java抄过来的,没用到
## xinxiang/util/cons_error_code.py
    从Java抄过来的,用于报Alerm
    ETL
    SYNC共通都用到
## xinxiang/util/cons_table_name.py
    从Java抄过来的,新架构写法几乎没用到
## xinxiang/util/DetailEntity.py
    aps_etl_apc_webservice_20m专用的数据结构
## xinxiang/util/my_cmder.py
    exec_view_to_dat                                提供 Oracle > CSV的导出能力
## xinxiang/util/my_date.py
    给框架提供 日期相关 处理能力
## xinxiang/util/my_duck.py
    给框架提供 DuckDB相关 处理能力
    - get_temp_table_mark                           用于ETL处理时候,给TMP表追加前缀
    - get_select_column_in_duckdb                   根据DuckDb表名或者表中所有字段(中间产物,未被使用)
    - exec_sql                                      高频使用 Duckdb执行SQL的共通函数
                                                    获取处理后结果行数并打印的处理,被注释掉了,原因是DuckDB的TEMP表不支持
    - get_row_count_in_duckdb                       高频使用,根据表名(where条件),获取行数
    - create_duckdb_for_temp_table                  高频使用,用于创建TEMP表的实体文件
    - create_duckdb_in_file                         高频使用,用于创建ETL结果文件(包含APS_SRCFILE表)
    - create_duckdb_in_momory                       之前使用,现在被废弃,用于在内存中创建DuckDB
    - drop_table                                    在DuckDB中删除表,未被使用
    - attach_temp_db_write_able                     可写方式ATTACH Duck文件,一般用于TEMP表,ATTACH过来,且要将结果写入
    - attach_table                                  可Read Only方式ATTACH Duck文件,一般用于used表
    - detach_table                                  一般可用可不用,detach Duck,
    - get_all_used_table_file,                      根据表(列表)名到Oracle检索,得到此次使用的所有表的最新一般文件路径  
    - attach_used_table                             根据表(列表)名到Oracle检索,Attach此次使用的所有表的最新一般文件路径
    - detach_all_used_table                         一般可用可不用,Detach Duck,
    - get_target_file_name                          根据表名和时间戳得到Duckdb文件名
                                                    表名 AA_TABLE ,时间戳 2023121312013,返回 'AA_TABLE_2023121312013.db'
    - export_result_duck_file_and_close_duck_db_memory2
                                                    高频使用 将Duckdb文件进行落盘,并从 表名/inprocess/表名_时间戳.db > 表名/表名_时间戳.db
    - export_result_duck_file_and_close_duck_db_memory
                                                    将Duckdb文件进行落盘,并从 表名/inprocess/表名_时间戳.db > 表名/表名_时间戳.db
## xinxiang/util/my_file.py
    给框架提供 文件相关 处理能力
    - get_last_db_file 高频使用 根据表(列表)名到Oracle检索,得到此次使用的所有表的最新一般文件路径 
    - init_folder 初始化工作目录
    - delete_backup_files 删除保存超过一定日期的文件(表名_时间戳.db)
## xinxiang/util/my_log.py
    给框架提供 日志输出 处理能力
    如果使用apscheduler统一调度,会按照日期迭代日志
    如果使用windows定时任务,则无法集中管理
## xinxiang/util/my_memory.py
    给框架提供 内存占用测试 处理能力
    已经废除
## xinxiang/util/my_memory.py
    给框架提供 内存占用测试 处理能力
    已经废除
## xinxiang/util/my_oracle.py
    给框架提供 Oracle 处理能力  
    - ExecuteViewToTable                        抄Java的,Sync不到Oracle数据的时候,报错
    - GetCommonSkipViewExistTableData           抄Java的,  Sync不到Oracle数据的时候,哪些表不报错
    - get_row_count_in_oracle                   得到某张表(符合哪些条件的)在Oracle存在的行数
    - create_sql_from_oracle_to_duck            根据Oracle表结构创建Duckdb表结构,只有在oracle_to_duck_common#sync_oracle_to_duck中使用
                                                涉及对象包含sync_APS_SYNC_CSFLOWSAMPLINGCFG,sync_APS_SYNC_WIP
    - create_sql_from_oracle_to_duck2           给create_sql_from_oracle_to_duck使用
    - oracle_get_connection                     得到 Oracle的连接
    - oracle_get_connection_local               得到 Oracle的测试库连接,g_debug_mode = True的时候生效,用于测试
    - UUID 生成UUID
    - SaveEtlMethodLog                          记录ETL每个SQL执行时间,记录在[APS_ETL_METHOD_LOG_DUCK]表中
    - HandlingVerControl                        记录ETL版本号,记录在[APS_ETL_VER_CONTROL_DUCK]表中
                                                同时在[APS_ETL_SYNC_CONTROL_DUCK]记录一笔,用于回写到Pg的测试库
    - get_last_create_file                      得到某张表的最后一次处理结果文件路径, 记录保存在[APS_ETL_VER_CONTROL]中
    - StartCleanUpAndLog                        记录ETL开始日志 [ETL_EXEC_LOG]
    - EndCleanUpAndLog                          记录ETL结束日志 [ETL_EXEC_LOG]
    - SaveAlarmLogDataForSync                   记录Sync的Alerm信息 [ALARM_SEND_LOG]
    - SaveAlarmLogData                          记录ETL的Alerm信息 [ALARM_SEND_LOG]
    
    故新架构使用Oracle如下表:
        [APS_ETL_METHOD_LOG_DUCK]               记录某个ETL的某个SQL执行时间
        [APS_ETL_VER_CONTROL_DUCK]              记录某个ETL的产出结果
        [APS_ETL_SYNC_CONTROL_DUCK]             记录某个需要向PG测试库同步的ETL的产出结果
        [ETL_EXEC_LOG]                          记录某个ETL的开始执行时间,结束执行时间,执行总时间,异常信息
        [ALARM_SEND_LOG]                        记录ETL或Sync的报警信息
## xinxiang/util/my_postgres.py
    给框架提供 Postgres 处理能力  
    - postgres_get_connection                   得到PG生产库连接
    - postgres_get_test_db_connection           得到PG测试库连接
    - postgres_get_test_test_db_connection      得到PG测试的测试库连接
    - uuid_csv_file_name                        得到导出中间的csv文件名
    - copy_duckdb_to_postgres_for_test_pg       将结果回拷(sync中的定时任务)到PG测试库
    - copy_duckdb_to_postgres                   将结果(实时)同步到PG生产库(或者测试的测试库)
    - copy_to_yth_func                          拷贝到yth中,记录版本号,所有表都要写
    - copy_to_yto_func                          拷贝到yto中,记录版本号,his表不要写
    - decide_postgres_db_folder
    - decide_postgres_db_connection             根据情况确定向哪个PG实时库中写数据,PG生产库|测试的测试库
                                                (g_etl_prod_tables白名单中要写生产,否则向测试的测试库中写(根据配置也可能写到测试库))
## xinxiang/util/oracle_to_duck_common.py
    - 将View数据Sync到Duckdb
    - sync_oracle_to_duck_by_csv                通过 Oracle > CSV > DuckDB转换
    - sync_oracle_to_duck                       通过 Oracle > Pandas > DuckDB转换
## xinxiang/util/oracle_to_duck_his.py
    - 将His View数据Sync到Duckdb(增量方式Sync,并每天只保留3个版本)
    - delete_over_three_version                 遍历his表Sync结果,当天超过3个版本,则删除之前的第四个版本
    - check_need_resize_file                    duckdb delete Record bug的修复处理
    - sync_oracle_to_duck_by_csv                通过 Oracle > CSV > DuckDB转换
    - base_big_oracle_to_duck_by_csv
    - base_big_oracle_to_duck_resize_by_csv     给sync_oracle_to_duck_by_csv调用


# 项目说明
## Sync_Python

### init_duckdb.py
    用于初始化Sync环境

### View的Sync
    调用方式:所有JOB通过 
        - sync_his_jobs_sync_APS_MID_FHOPEHS.py         JOB执行方法
        - sync_his_jobs_sync_APS_MID_FHOPEHS.bat        静默方式执行 sync_his_jobs_sync_APS_MID_FHOPEHS.py
        - sync_his_jobs_sync_APS_MID_FHOPEHS.vbs        静默方式启动 Windows定时任务 执行sync_his_jobs_sync_APS_MID_FHOPEHS.bat
        - 并在 00_install_task_in_windows.bat 中注册写入windows的脚本
        -   在 00_delete_task_in_windows.bat 中注册删除windows的脚本
        
    实现原理:
    oracle_to_duck_common#sync_oracle_to_duck_by_csv
    -- 实现了Oracle的View到Duckdb文件的Sync,通过 Oracle > CSV > DuckDB转换,除了特殊表(譬如直接下导出SQL会导致SQL异常的)之外,都用此函数实现
    
    oracle_to_duck_common#sync_oracle_to_duck
    -- 实现了Oracle的View到Duckdb文件的Sync,通过 Oracle > Pandas > DuckDB转换,包含对象sync_APS_SYNC_CSFLOWSAMPLINGCFG,sync_APS_SYNC_WIP

### 历史表的Sync
    调用方式:所有JOB(类似)通过 
        - sync_his_jobs_sync_APS_MID_FHOPEHS.py         JOB执行方法
        - sync_his_jobs_sync_APS_MID_FHOPEHS.bat        静默方式执行 sync_his_jobs_sync_APS_MID_FHOPEHS.py
        - sync_his_jobs_sync_APS_MID_FHOPEHS.vbs        静默方式启动 Windows定时任务 执行sync_his_jobs_sync_APS_MID_FHOPEHS.bat
        - 并在 00_install_task_in_windows.bat 中注册写入windows的脚本
        -   在 00_delete_task_in_windows.bat 中注册删除windows的脚本
    
    实现原理:
    oracle_to_duck_his#sync_oracle_to_duck_by_csv
    -- 实现了Oracle的历史View到Duckdb文件的Sync
    -- 包含对象
        sync_APS_TMP_LOTHISTORY
        sync_APS_MID_RSPILOT_RUN_HS
        sync_APS_MID_FHOPEHS
        sync_APS_TMP_MASK_HISTORY
        sync_APS_MID_FHOPEHS_RETICLE
        sync_APS_TMP_OCS_MAIN_H
        sync_APS_MID_OCS_JOB_GROUP_PO_STATE_H
        
### 回写数据到PG测试库
    
    调用方式:所有JOB(类似)通过 
        - sync_his_jobs_sync_APS_MID_FHOPEHS.py         JOB执行方法
        - sync_his_jobs_sync_APS_MID_FHOPEHS.bat        静默方式执行 sync_his_jobs_sync_APS_MID_FHOPEHS.py
        - sync_his_jobs_sync_APS_MID_FHOPEHS.vbs        静默方式启动 Windows定时任务 执行sync_his_jobs_sync_APS_MID_FHOPEHS.bat
        - 并在 00_install_task_in_windows.bat 中注册写入windows的脚本
        -   在 00_delete_task_in_windows.bat 中注册删除windows的脚本
    
    读取[APS_ETL_SYNC_CONTROL_DUCK]数据,将一段时间内未回写到PG测试的数据回写,回写完成后删除表中数据
    这里起到类似队列的作用,数据的生产者是ETL,数据的消费者是本job

### 其他管理JOB

    manager_jobs_delete_backup_files_by_6_hours.bat
    manager_jobs_delete_backup_files_by_6_hours.py
    manager_jobs_delete_backup_files_by_6_hours.vbs    删除历史文件
    manager_jobs_delete_backup_files_by_day.bat
    manager_jobs_delete_backup_files_by_day.py
    manager_jobs_delete_backup_files_by_day.vbs        删除历史文件
    manager_jobs_delete_oracle_db_log_by_12_hours.bat
    manager_jobs_delete_oracle_db_log_by_12_hours.py
    manager_jobs_delete_oracle_db_log_by_12_hours.vbs  删除历史数据(Oracle执行历史)
    sync_his_jobs_delete_over_three_version.bat
    sync_his_jobs_delete_over_three_version.py
    sync_his_jobs_delete_over_three_version.vbs        删除His Sync文件,并只保留三个版本文件
    
    - 并在 00_install_task_in_windows.bat 中注册写入windows的脚本
    -   在 00_delete_task_in_windows.bat 中注册删除windows的脚本
    
## ETL_Python
### init_ETL.py
    用于初始化ETL环境,拉去Oracle现行数据,以及执行前置ETL
    
### Windows的PythonService_ETL服务
    调度etl_cron.py中的Job
    - 关闭需要手动关闭PythonService进程
    - 启动需要手动执行PythonService服务
    
### 注册的windows ETL执行JOB
    run_aps_etl_wip.bat
    run_aps_etl_wip.py
    run_aps_etl_wip.vbs
    ....
    
    - 并在 99_prod_temp_install_windows.bat 中注册写入windows的脚本
    -   在 99_prod_temp_uninstall_windows_task.bat 中注册删除windows的脚本
    
### 注册的Windows 回写 Oracle Job
    注意 
    - xinxiang/jobs_temp/write_back_to_oracle.py中的 execute_xxxx方法是否开启
    - 99_prod_temp_install_windows.bat.bat中的schtasks 注册是否被REM掉(注释掉)
    
    run_aps_etl_write_back_to_oracle_demand.bat
    run_aps_etl_write_back_to_oracle_demand.py
    run_aps_etl_write_back_to_oracle_demand.vbs
    
    最终回写Oracle要全部删除