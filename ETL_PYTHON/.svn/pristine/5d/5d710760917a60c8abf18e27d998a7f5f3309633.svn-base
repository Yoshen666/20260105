import gc
import logging
import os

from xinxiang import config
from xinxiang.util import my_duck, my_oracle, my_date, cons_error_code, cons, my_postgres


def create_temp_table(duck_db):
    '''
    这里在内存中创建使用到的临时表
    '''
    sql = """
    create table APS_TMP_ETL_MONITOR_DF_SOURCE
    (
        toolg_id          VARCHAR(64),
        tool_id           VARCHAR(64),
        ch_id             VARCHAR(64),
        job_id            VARCHAR(64),
        start_date        VARCHAR(64),
        end_date          VARCHAR(64),
        recipe            VARCHAR(64),
        job_status        VARCHAR(64),
        foup_id           VARCHAR(500),
        job_type          VARCHAR(64),
        job_spec_group_id VARCHAR(64),
        create_time       VARCHAR(64)
    )
    """
    duck_db.sql(sql)
    sql = """
    create table APS_TMP_ETL_MONITOR_DF_PROCESS
    (
        toolg_id          VARCHAR(64),
        tool_id           VARCHAR(64),
        ch_id             VARCHAR(64),
        job_id            VARCHAR(64),
        start_date        VARCHAR(64),
        end_date          VARCHAR(64),
        recipe            VARCHAR(64),
        job_status        VARCHAR(64),
        foup_id           VARCHAR(500),
        job_type          VARCHAR(64),
        job_spec_group_id VARCHAR(64),
        process_time      VARCHAR(64),
        create_time       VARCHAR(64)
    )
    """
    duck_db.sql(sql)
    sql = """
    create table APS_TMP_ETL_MONITOR_V1
    (
        parentid     VARCHAR(60) not null,
        toolg_id     VARCHAR(60) not null,
        tool_id      VARCHAR(60) not null,
        ch_id        VARCHAR(60) not null,
        job_id       VARCHAR(60) not null,
        start_date   VARCHAR(60) not null,
        end_date     VARCHAR(60) not null,
        process_time VARCHAR(60) not null,
        reticle_id   VARCHAR(60),
        recipe       VARCHAR(60),
        job_status   VARCHAR(60),
        track_in     VARCHAR(60),
        update_time  VARCHAR(60) not null,
        partcode     VARCHAR(60) not null,
        foup_id      VARCHAR(500),
        job_type     VARCHAR(60),
        tool_code    VARCHAR(60),
        fixed_flag   VARCHAR(1),
        fixed_time   VARCHAR(60)
    )
    """
    duck_db.sql(sql)
    sql = """
        create table APS_TMP_ETL_MONITOR_DF_PT
        (
            job_spec_group_id VARCHAR(64),
            tool_id           VARCHAR(64),
            track_in          VARCHAR(64),
            track_out         VARCHAR(64)
        )
        """
    duck_db.sql(sql)

    sql = """
           create table APS_TMP_ETL_MONITOR_TRACKIN
           (
                job_spec_group_id VARCHAR(64),
                tool_id           VARCHAR(64),
                track_in          VARCHAR(64),
                create_time       VARCHAR(64)
           )
           """
    duck_db.sql(sql)


def biz_method_01(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    sql = """
        INSERT INTO APS_TMP_ETL_MONITOR_TRACKIN(                                    
             JOB_SPEC_GROUP_ID, TOOL_ID, TRACK_IN, CREATE_TIME                                               
            )                                                                                  
             SELECT W.JOB_SPEC_GROUP_ID, W.MTOOL_ID,                                                                                                                     
                    MAX(H.START_TIME) AS TRACK_IN,                                                                                      
                    MAX(W.CREATE_TIME) AS CREATE_TIME                                                                                   
             FROM APS_SYNC_OCS_JOB_SPEC_GROUP_PO.APS_SYNC_OCS_JOB_SPEC_GROUP_PO W                            
             INNER JOIN APS_MID_OCS_JOB_GROUP_PO_STATE_H.APS_MID_OCS_JOB_GROUP_PO_STATE_H H                        
             ON W.JOB_SPEC_GROUP_ID = H.JOB_SPEC_GROUP_ID AND W.MTOOL_ID = H.TOOL_ID                                                     
             AND H.STATUS='OpeStart' AND W.STATUS = 'PRD' AND H.END_TIME > DATE_TRUNC('day', CURRENT_DATE) - INTERVAL '5 day'                                              
             WHERE  W.MTOOL_ID = W.PTOOL_ID                                                    
             GROUP BY  W.JOB_SPEC_GROUP_ID, W.MTOOL_ID      
           """.format(uuid=uuid, current_time=current_time)
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_MONITOR_TRACKIN",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_MONITOR_TRACKIN")

    sql = """
              INSERT  /*+ append */  INTO APS_ETL_MONITOR (                                                                                                                 
                     PARENTID, TOOLG_ID, TOOL_ID, CH_ID, JOB_ID, START_DATE, END_DATE,
                     PROCESS_TIME, RETICLE_ID, RECIPE, JOB_STATUS,TRACK_IN, PROCESS_START,
                     UPDATE_TIME,PARTCODE, FOUP_ID, JOB_TYPE, TOOL_CODE, FIXED_FLAG, FIXED_TIME 
            )      
            -- modify by xiecheng for version up                                                                                                                                                                
                WITH GET_TOOLG AS(                                                                                                                                                                                                                                                                                   
                 SELECT T.TOOL_ID,T.CH_ID,T.TOOLG_ID FROM APS_ETL_TOOL.APS_ETL_TOOL T                                                                                                                  
                     WHERE 
                     --T.PARTCODE = '" + lastPartCode + "'                                                                                                                      
                     1=1 AND POSITION('F' IN T.TOOL_ID) = 0                                                                                                                                                                                                                                               
         ),                                                                                                                                                                         
         MONITOR_PLAN_DATA AS (                                                                                                                                                     
           SELECT OP.MONTIOR_PLAN_NAME,                                                                                                                                             
             MAX(T.TOOLG_ID) AS  TOOLG_ID,                                                                                                                                        
             MAX(OP.JOB_SPEC_GROUP_ID) AS JOB_SPEC_GROUP_ID,                                                                                                                                        
             MAX(OP.CREATE_TIME) AS CREATE_TIME,                                                                                                                                                                                                                                                                                               
             MAX(OP.MTOOL_ID) AS MTOOL_ID,                                                                                                                                                                                                                                                                                                  
             MAX(OP.STATUS) AS STATUS,                                                                                                                                                   
             MAX(OP.RETICLE) AS RETICLE,                                                                                                                                                  
             MAX(OP.TEST_FOR) AS TEST_FOR,                                                                                                                                        
             STRING_AGG(OP.FOUP_ID,',') WITHIN GROUP (ORDER BY OP.FOUP_ID) AS FOUP_ID  ,                                                                                    
             STRING_AGG(COALESCE(T1.CH_ID,OP.MTOOL_ID),';') WITHIN GROUP (ORDER BY OP.MTOOL_ID) AS CH_ID                                                                                                                                              
           FROM APS_SYNC_OCS_JOB_SPEC_GROUP_PO.APS_SYNC_OCS_JOB_SPEC_GROUP_PO OP                                                                                                      
           INNER JOIN GET_TOOLG T                                                                                                                                                   
           ON OP.MTOOL_ID = T.TOOL_ID                                                                                                                                               
           LEFT JOIN GET_TOOLG T1                                                                                                                                                   
           ON OP.MTOOL_ID || '.' || OP.SUB_NAME = T1.CH_ID                                                                                                                            
           WHERE OP.MAINTOOLFLAG='True' AND PTOOL_ID = MTOOL_ID                                                                                                                     
           AND OP.MONTIOR_PLAN_NAME IS NOT NULL                                                                                                                                     
           --AND OP.PARTCODE = '" + partCodeList.get(0) + "' 
           --modify by xiecheng for version up 
           -- AND OP.CREATE_TIME >= SYSDATE -3 
            AND OP.CREATE_TIME >=  DATE_TRUNC('day', CURRENT_DATE) - INTERVAL '3 day'                                                                                                                 
           GROUP BY OP.MONTIOR_PLAN_NAME                                                                                                                                            
         ),                                                                                                                                                                         
         SOURCE_DATA AS (                                                                                                                                                           
          SELECT   OP.JOB_SPEC_GROUP_ID,                                                                                                                                            
               T.TOOLG_ID,                                                                                                                                                                                
             OP.CREATE_TIME,                                                                                                                                                    
             OP.FOUP_ID,                                                                                                                                                        
             OP.MTOOL_ID,                                                                                                                                                       
             OP.SUB_NAME,                                                                                                                                                       
             OP.STATUS,                                                                                                                                                         
             OP.RETICLE,                                                                                                                                                        
             OP.TEST_FOR,                                                                                                                                                       
             COALESCE(T1.CH_ID,OP.MTOOL_ID) AS CH_ID,                                                                                                                                 
             CASE WHEN OP.JOB_SPEC_GROUP_ID <> OP.SUB_NAME THEN REPLACE(OP.JOB_SPEC_GROUP_ID,OP.SUB_NAME,'*') ELSE OP.JOB_SPEC_GROUP_ID END AS JOB_SPEC_ID ,                    
             OP.JOB_SPEC_GROUP_ID || '(' || OP.SUB_NAME || ')' AS JOB_ID                                                                                                                                               
           FROM APS_SYNC_OCS_JOB_SPEC_GROUP_PO.APS_SYNC_OCS_JOB_SPEC_GROUP_PO OP                                                                                                      
           INNER JOIN GET_TOOLG T ON OP.MTOOL_ID = T.TOOL_ID                                                                                                                        
           LEFT JOIN GET_TOOLG T1 ON OP.MTOOL_ID || '.' || OP.SUB_NAME = T1.CH_ID                                                                                                                             
           WHERE OP.MAINTOOLFLAG='True'                                                                                                                                             
           AND OP.PTOOL_ID = OP.MTOOL_ID                                                                                                                                            
           AND OP.MONTIOR_PLAN_NAME IS NULL                                                                                                                                         
           --AND OP.PARTCODE = '" + partCodeList.get(0) + "' 
            --modify by xiecheng for version up    
           --AND OP.CREATE_TIME >= SYSDATE -3        
             AND OP.CREATE_TIME >=  DATE_TRUNC('day', CURRENT_DATE) - INTERVAL '3 day'                                                                                                                        
         ),                                                                                                                                                                         
         OTHER_PLAN_DATA AS (                                                                                                                                                       
             SELECT JOB_SPEC_ID,                                                                                                                                                    
                    MTOOL_ID,                                                                                                                                                       
                    TOOLG_ID,                                                                                                                                                       
                    MAX(D.CREATE_TIME) AS CREATE_TIME,                                                                                                                              
                    MAX(TEST_FOR) AS TEST_FOR,                                                                                                                                      
                    MIN(STATUS) AS STATUS,                                                                                                                                          
                    MAX(RETICLE) AS RETICLE,                                                                                                                                        
                    MAX(JOB_SPEC_GROUP_ID) AS JOB_SPEC_GROUP_ID,                                                                                                                    
                    STRING_AGG(D.FOUP_ID,',') OVER (PARTITION BY D.FOUP_ID ORDER BY D.FOUP_ID) AS FOUP_ID,                                                                                   
                    STRING_AGG(D.JOB_ID,';') OVER (PARTITION BY D.JOB_ID ORDER BY D.JOB_ID) AS JOB_ID,                                                                                      
                    STRING_AGG(D.CH_ID,';') OVER (PARTITION BY D.CH_ID ORDER BY D.CH_ID) AS CH_ID                                                                                          
             FROM SOURCE_DATA D                                                                                                                                                     
             GROUP BY D.JOB_SPEC_ID,D.MTOOL_ID,TOOLG_ID                                                                                                                             
         ),                                                                                                                                                                         
         ALL_DATA AS (                                                                                                                                                              
             SELECT MONTIOR_PLAN_NAME || '('|| FOUP_ID ||')' AS JOB_ID,                                                                                                             
                   JOB_SPEC_GROUP_ID,                                                                                                                                               
                   CREATE_TIME,                                                                                                                                                     
                   MTOOL_ID,                                                                                                                                                        
                   STATUS,                                                                                                                                                          
                   RETICLE,                                                                                                                                                         
                   TEST_FOR,                                                                                                                                                        
                   CH_ID,                                                                                                                                                           
                   FOUP_ID,                                                                                                                                                         
                   TOOLG_ID                                                                                                                                                         
             FROM MONITOR_PLAN_DATA DA                                                                                                                                              
             UNION ALL                                                                                                                                                              
             SELECT JOB_ID,                                                                                                                                                         
                   JOB_SPEC_GROUP_ID,                                                                                                                                               
                   CREATE_TIME,                                                                                                                                                     
                   MTOOL_ID,                                                                                                                                                        
                   STATUS,                                                                                                                                                          
                   RETICLE,                                                                                                                                                         
                   TEST_FOR,                                                                                                                                                        
                   CH_ID,                                                                                                                                                           
                   FOUP_ID,                                                                                                                                                         
                   TOOLG_ID                                                                                                                                                         
             FROM OTHER_PLAN_DATA DA1                                                                                                                                               
         ),                                                                                                                                                                         
         TRACKIN_DATA AS (                                                                                                                                                          
              SELECT  H.JOB_SPEC_GROUP_ID,                                                                                                                                          
                      H.SUB_NAME,H.MTOOL_ID,                                                                                                                                        
                      P.FOUP_ID,                                                                                                                                                    
                      MAX(H.PROCESS_ST_TIME) AS TRACK_IN                                                                                                                            
              FROM APS_TMP_OCS_MAIN_H.APS_TMP_OCS_MAIN_H H                                                                                                                  
              INNER JOIN APS_SYNC_OCS_JOB_SPEC_GROUP_PO.APS_SYNC_OCS_JOB_SPEC_GROUP_PO P                                                                                                                          
              ON P.JOB_SPEC_GROUP_PO_ID = H.JOB_SPEC_GROUP_PO_ID                                                                                                                    
              AND P.SUB_NAME = H.SUB_NAME                                                                                                                                           
              AND P.MTOOL_ID = H.MTOOL_ID                                                                                                                                           
              WHERE H.STATUS='OpeStart' AND P.STATUS = 'PRD' 
              --AND P.PARTCODE = '" + partCodeList.get(0) + "'                                                                                                                  
              GROUP BY H.JOB_SPEC_GROUP_PO_ID,                                                                                                                                      
              H.SUB_NAME,H.MTOOL_ID,P.FOUP_ID,H.JOB_SPEC_GROUP_ID                                                                                                                   
          ),                                                                                                                                                                        
          GROUP_DATA AS (                                                                                                                                                           
               SELECT A.JOB_ID,                                                                                                                                                     
                   MAX(A.JOB_SPEC_GROUP_ID) AS JOB_SPEC_GROUP_ID,                                                                                                                   
                   MAX(A.CREATE_TIME) AS CREATE_TIME,                                                                                                                               
                   A.MTOOL_ID,                                                                                                                                                      
                   MIN(A.STATUS) AS STATUS,                                                                                                                                         
                   MAX(A.RETICLE) AS RETICLE,                                                                                                                                       
                   MAX(A.TEST_FOR) AS TEST_FOR,                                                                                                                                     
                   A.CH_ID,                                                                                                                                                         
                   MAX(A.FOUP_ID) AS FOUP_ID,                                                                                                                                       
                   A.TOOLG_ID,                                                                                                                                                      
                   MAX(TD.TRACK_IN) AS TRACK_IN                                                                                                                                     
             FROM ALL_DATA A                                                                                                                                                        
             LEFT JOIN TRACKIN_DATA TD ON TD.JOB_SPEC_GROUP_ID = A.JOB_SPEC_GROUP_ID                                                                                                
             ----AND TD.SUB_NAME = A.SUB_NAME                                                                                                                                       
             AND TD.MTOOL_ID = A.MTOOL_ID                                                                                                                                           
             GROUP BY A.MTOOL_ID,A.TOOLG_ID,A.JOB_ID,A.CH_ID                                                                                                                        
          )                                                                                                                                                                         
         SELECT                                                                                                                                                                     
                '{uuid}' AS PARENTID,                                                                                                                                 
              M.TOOLG_ID,                                                                                                                                                           
              M.MTOOL_ID AS TOOL_ID,                                                                                                                                                
              CASE WHEN LENGTH(M.CH_ID) > 128 THEN SUBSTR(M.CH_ID,0,128) ELSE M.CH_ID END AS CH_ID,                                                                                 
              CASE WHEN LENGTH(M.JOB_ID) > 512 THEN SUBSTR(M.JOB_ID,0,512) ELSE M.JOB_ID END AS JOB_ID,                                                                                                                                                                                                                                                       
              --TO_CHAR(M.CREATE_TIME, 'YYYY-MM-DD HH24:MI:SS') AS START_DATE,
              STRFTIME(M.CREATE_TIME, '%Y-%m-%d %H:%M:%S') AS START_DATE,                                                                                                        
              CASE WHEN CT.JOB_SPEC_GROUP_ID IS NOT NULL AND CT.MEASURE_CT > 0                                                                                                      
                   --THEN TO_CHAR(M.CREATE_TIME +20/24 - CT.MEASURE_CT/24, 'YYYY-MM-DD HH24:MI:SS') ELSE TO_CHAR(M.CREATE_TIME +20/24, 'YYYY-MM-DD HH24:MI:SS') END AS END_DATE,          
                   THEN STRFTIME(M.CREATE_TIME + INTERVAL '20 hours' -  INTERVAL (CT.MEASURE_CT) HOUR,'%Y-%m-%d %H:%M:%S')
                    ELSE STRFTIME(M.CREATE_TIME + INTERVAL '20 hours','%Y-%m-%d %H:%M:%S') END AS END_DATE,     
           -- NVL(ZD.PROCESS_TIME,NVL(ZD32.PROCESS_TIME,0)) AS PROCESS_TIME,   
                COALESCE(ZD.PROCESS_TIME,COALESCE(ZD32.PROCESS_TIME,0)) AS PROCESS_TIME,                                                                                                       
              M.RETICLE AS RETICLE_ID,                                                                                                                                              
              '' AS RECIPE,                                                                                                                                                         
             -- DECODE(M.STATUS,'PRD','RUN','SBY','WAIT',M.STATUS) AS JOB_STATUS,
               CASE WHEN M.STATUS = 'PRD' THEN 'RUN'
                       WHEN M.STATUS = 'SBY' THEN 'WAIT'
                       ELSE M.STATUS END AS JOB_STATUS,     
              --modify by xiecheng for version up                                                                                                                   
              --TO_CHAR(M.TRACK_IN, 'YYYY-MM-DD HH24:MI:SS') AS TRACK_IN,             
              --STRFTIME(M.TRACK_IN, '%Y-%m-%d %H:%M:%S') AS TRACK_IN,    
              CASE WHEN M.STATUS = 'PRD' AND TI.TRACK_IN >= M.CREATE_TIME THEN STRFTIME(TI.TRACK_IN, '%Y-%m-%d %H:%M:%S') END AS TRACK_IN,
              --modify by xiecheng for version up  
              CASE WHEN M.STATUS = 'PRD' AND M.TRACK_IN >= TI.TRACK_IN AND TI.TRACK_IN >= M.CREATE_TIME THEN STRFTIME(M.TRACK_IN, '%Y-%m-%d %H:%M:%S') END AS PROCESS_START,                                                                                                           
             '{current_time}' AS UPDATE_TIME,                                                                                                                              
              '' AS PARTCODE,                                                                                                              
              CASE WHEN LENGTH(M.FOUP_ID) > 2048 THEN SUBSTR(M.FOUP_ID,0,2048) ELSE M.FOUP_ID END AS FOUP_ID,                                                                       
              CASE WHEN M.TEST_FOR='RT'THEN 'RT Monitor' ELSE 'Monitor' END AS JOB_TYPE,                                                                                            
              '' AS TOOL_CODE,                                                                                                                                                      
              '' AS FIXED_FLAG,                                                                                                                                                     
              '' AS FIXED_TIME                                                                                                                                                      
          FROM GROUP_DATA M                                                                                                                                                         
          LEFT JOIN APS_MID_TYPE31_MEDIAN.APS_MID_TYPE31_MEDIAN ZD ON  ZD.TOOLG_ID = M.TOOLG_ID                                                                                                                  
          AND ZD.PLAN_ID = M.JOB_ID  AND ZD.TOOL_ID = M.MTOOL_ID                                                                                                                    
          LEFT JOIN APS_MID_TYPE32_MEDIAN.APS_MID_TYPE32_MEDIAN ZD32 ON  ZD32.TOOLG_ID = M.TOOLG_ID                                                                                                                                                                                                                  
          LEFT JOIN APS_MID_OCS_MEASURE_CT.APS_MID_OCS_MEASURE_CT CT ON  CT.JOB_SPEC_GROUP_ID = M.JOB_SPEC_GROUP_ID  
          --modify by xiecheng for version up
          LEFT JOIN APS_TMP_ETL_MONITOR_TRACKIN TI ON TI.JOB_SPEC_GROUP_ID = M.JOB_SPEC_GROUP_ID  AND TI.TOOL_ID = M.MTOOL_ID                                                                                                                                  
        """.format(uuid=uuid, current_time=current_time)

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_ETL_MONITOR",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_ETL_MONITOR")
    sql = """
           INSERT  /*+ append */  INTO APS_ETL_MONITOR(
                   PARENTID, TOOLG_ID, TOOL_ID, CH_ID, JOB_ID, START_DATE, END_DATE,
                   PROCESS_TIME, RETICLE_ID, RECIPE, JOB_STATUS,TRACK_IN, UPDATE_TIME,
                   PARTCODE, FOUP_ID, JOB_TYPE, TOOL_CODE, FIXED_FLAG, FIXED_TIME
          )
           WITH EQP_INFO AS (
                SELECT EQP_ID,MAX(EQP_G) AS TOOLG_ID,
                       MAX(EQP_CHAMBER_FLAG) AS EQP_FLAG,
                       MAX(PREV_E10_STATE_CODE) AS STATE_CODE,
                       MAX(PREV_STATE) AS PREV_STATE,
                       MAX(E10CHG_STARTTMST) AS E10CHG_STARTTMST,
                       MAX(MODULE) AS MODULE
                FROM APS_SYNC_ETL_TOOL.APS_SYNC_ETL_TOOL T 
                --modify by xiecheng for version up
                where HOST_EQP_FLAG='Y'  
                GROUP BY EQP_ID
           ),
           PM_DATA_F AS (
                SELECT F.EQUIPMENT_NO,
                        CASE WHEN E.EQP_FLAG = 'Chamber' AND TRIM(' ' FROM F.CHAMBER_NO) IS NOT NULL
                         THEN (F.EQUIPMENT_NO||'.'||F.CHAMBER_NO)
                         ELSE F.EQUIPMENT_NO END AS CHAMBER_NO,
                        F.PM_TYPE,
                        F.TARGET_TIME,
                        F.FORECAST_TIME,
                        E.TOOLG_ID,
                        E.EQP_FLAG,
                        E.STATE_CODE,
                        E.PREV_STATE,
                        E.E10CHG_STARTTMST,
                        F.TEST_TIME,
                        E.MODULE
                FROM APS_SYNC_TMS_EQP_PARAMETER.APS_SYNC_TMS_EQP_PARAMETER F
                INNER JOIN EQP_INFO E
                ON E.EQP_ID = F.EQUIPMENT_NO
                WHERE
                 --TO_CHAR(TO_DATE(F.FORECAST_TIME,'YYYY-MM-DD HH24:MI:SS'), 'YYYY-MM-DD') = TO_CHAR(SYSDATE,'YYYY-MM-DD')
                   --   AND TO_DATE(F.FORECAST_TIME,'YYYY-MM-DD HH24:MI:SS') > SYSDATE
                       STRFTIME(cast(F.FORECAST_TIME as Date), '%Y-%m-%d') = STRFTIME(cast(CURRENT_DATE as Date),'%Y-%m-%d')
                       AND F.FORECAST_TIME > CURRENT_DATE
           -- MFG要求过滤Track借机的数据(最新需求严格按照('*D PM')过滤)
                      AND ((SUBSTRING(F.EQUIPMENT_NO,0,1)='P' AND F.PM_TYPE LIKE ('%D PM'))  OR (SUBSTRING(F.EQUIPMENT_NO,0,1)<>'P'))
                      AND E.MODULE<>'WET'
           ),
           PM_DATA AS (
                SELECT * FROM (
                  SELECT F.EQUIPMENT_NO,
                         F.CHAMBER_NO,
                         F.PM_TYPE,
                         F.TARGET_TIME,
                         F.FORECAST_TIME,
                         F.TOOLG_ID,
                         F.EQP_FLAG,
                         F.STATE_CODE,
                         F.PREV_STATE,
                         F.E10CHG_STARTTMST,
                         F.TEST_TIME,
                         F.MODULE,
                         ROW_NUMBER() OVER (PARTITION BY F.EQUIPMENT_NO,F.CHAMBER_NO,F.PM_TYPE,F.TOOLG_ID
                                ORDER BY F.FORECAST_TIME DESC) AS RN
                  FROM PM_DATA_F F
                )
                WHERE RN = 1
           ),
           PROP_TIME_DATA1 AS (
               SELECT EQP_ID,BEGIN_TIME,END_TIME
               FROM APS_SYNC_SCHE_PM_PROP_TIME.APS_SYNC_SCHE_PM_PROP_TIME P
               WHERE P.PM_TYPE = '*'
              AND STRFTIME( cast(P.BEGIN_TIME as Date),'%Y-%m-%d') = STRFTIME(cast(CURRENT_DATE as Date),'%Y-%m-%d')
               AND P.END_TIME > CURRENT_DATE
           ),
           PROP_TIME_DATA2 AS (
               SELECT EQP_ID,BEGIN_TIME,END_TIME,PM_TYPE
               FROM APS_SYNC_SCHE_PM_PROP_TIME.APS_SYNC_SCHE_PM_PROP_TIME P
               WHERE P.PM_TYPE <> '*'
               AND STRFTIME( cast(P.BEGIN_TIME as Date),'%Y-%m-%d') = STRFTIME(cast(CURRENT_DATE as Date),'%Y-%m-%d')
               AND P.END_TIME > CURRENT_DATE
           ),
           BOOKING_INFO AS (
              SELECT S.EQP_ID,S.PM_TYPE,
                     S.START_TIME,
                     S.END_TIME,
                     S.EST_SPEC,
                     S.FORCE_FLAG,
                     S.UPDATE_TIME
              FROM APS_SYNC_EQP_STATUS_BOOKING_SETTING.APS_SYNC_EQP_STATUS_BOOKING_SETTING S
             WHERE S.E10_STATE='SDT' AND S.E10_CODE='4110'
                 AND STRFTIME( cast(S.START_TIME  as Date),'%Y-%m-%d') = STRFTIME(cast(CURRENT_DATE as Date),'%Y-%m-%d')
                 AND (S.END_TIME IS NULL OR S.END_TIME > CURRENT_DATE)
           )
           SELECT
                  '{uuid}' AS PARENTID,
                  T.TOOLG_ID,
                  T.EQUIPMENT_NO,
                  T.CHAMBER_NO AS CH_ID,
                  T.PM_TYPE AS JOB_ID,
                 CASE WHEN I.EQP_ID IS NOT NULL THEN STRFTIME(cast(I.START_TIME as Date), '%Y-%m-%d %H:%M:%S')   ELSE (
                     CASE WHEN P2.EQP_ID IS NOT NULL THEN STRFTIME(cast(P2.BEGIN_TIME as Date), '%Y-%m-%d %H:%M:%S')   ELSE (
                            CASE WHEN P.EQP_ID IS NOT NULL THEN STRFTIME(cast(P.BEGIN_TIME as Date), '%Y-%m-%d %H:%M:%S') ELSE
                                 (STRFTIME(STRPTIME(T.FORECAST_TIME,'%Y/%m/%d %H:%M'),'%Y-%m-%d')|| ' 00:00:00')   END)
                 END) END AS START_DATE,
                  CASE WHEN I.EQP_ID IS NOT NULL THEN STRFTIME(cast(I.END_TIME as Date), '%Y-%m-%d %H:%M:%S') ELSE (
                     CASE WHEN P2.EQP_ID IS NOT NULL THEN STRFTIME(cast(P2.END_TIME as Date), '%Y-%m-%d %H:%M:%S')  ELSE (
                          CASE WHEN P.EQP_ID IS NOT NULL THEN STRFTIME(cast(P.END_TIME as Date), '%Y-%m-%d %H:%M:%S')  ELSE
                               STRFTIME(STRPTIME(T.FORECAST_TIME,'%Y/%m/%d %H:%M'), '%Y-%m-%d %H:%M:%S') END)
                 END) END AS END_DATE,
                  CASE WHEN T.MODULE IN ('WET','DIFF') THEN (CASE WHEN I.EQP_ID IS NOT NULL THEN cast(I.EST_SPEC as decimal) ELSE cast(T.TARGET_TIME as decimal) END)+COALESCE(cast(T.TEST_TIME as decimal),0)  
                     ELSE (CASE WHEN I.EQP_ID IS NOT NULL THEN I.EST_SPEC ELSE cast(T.TARGET_TIME as decimal) END) END AS PROCESS_TIME,
                  '' AS RETICLE_ID,
                  '' AS RECIPE,
                  CASE WHEN T.STATE_CODE='SDT' AND T.PREV_STATE='4110'
                            THEN 'RUN' ELSE 'WAIT' END AS JOB_STATUS,
                  CASE WHEN T.STATE_CODE='SDT' AND T.PREV_STATE='4110'
                            THEN STRFTIME( cast(T.E10CHG_STARTTMST as Date), '%Y-%m-%d %H:%M:%S')
                             ELSE NULL END AS TRACK_IN,     
                  '{current_time}' AS UPDATE_TIME,
                  '' AS PARTCODE,
                  '' AS FOUP_ID,
                  'PM' AS JOB_TYPE,
                  'SDT-4110' AS TOOL_CODE,
                  CASE WHEN I.EQP_ID IS NOT NULL AND I.FORCE_FLAG='Y' THEN 'Y' ELSE 'N' END AS FIXED_FLAG,
                  CASE WHEN I.EQP_ID IS NOT NULL AND I.FORCE_FLAG='Y'
                          THEN STRFTIME(cast(I.UPDATE_TIME as Date), '%Y-%m-%d %H:%M:%S') ELSE NULL END AS FIXED_TIME
           FROM PM_DATA T
           LEFT JOIN PROP_TIME_DATA1 P
           ON P.EQP_ID = T.EQUIPMENT_NO
           LEFT JOIN PROP_TIME_DATA2 P2
           ON P2.EQP_ID = T.EQUIPMENT_NO
           AND P2.PM_TYPE = T.PM_TYPE
           LEFT JOIN BOOKING_INFO I
           ON I.EQP_ID = T.EQUIPMENT_NO
           AND I.PM_TYPE = T.PM_TYPE   
        """.format(uuid=uuid, current_time=current_time)

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_ETL_MONITOR",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_ETL_MONITOR")
    sql = """
            INSERT  /*+ append */  INTO APS_ETL_MONITOR (
                   PARENTID, TOOLG_ID, TOOL_ID, CH_ID, JOB_ID, START_DATE, END_DATE,
                   PROCESS_TIME, RETICLE_ID, RECIPE, JOB_STATUS,TRACK_IN, UPDATE_TIME,
                   PARTCODE, FOUP_ID, JOB_TYPE, TOOL_CODE, FIXED_FLAG, FIXED_TIME
            )
             WITH EQP_INFO AS (
                  SELECT EQP_ID,MAX(EQP_G) AS TOOLG_ID,
                         MAX(EQP_CHAMBER_FLAG) AS EQP_FLAG,
                         MAX(PREV_E10_STATE_CODE) AS STATE_CODE,
                         MAX(PREV_STATE) AS PREV_STATE,
                         MAX(E10CHG_STARTTMST) AS E10CHG_STARTTMST
                  FROM APS_SYNC_ETL_TOOL.APS_SYNC_ETL_TOOL
                  --modify by xiecheng for version up
                  WHERE HOST_EQP_FLAG='Y'
                  GROUP BY EQP_ID
             ),  
             --modify by xiecheng for version up
             RESULT_DATA AS (                                                                                                             
                 SELECT                                                                                                                       
                 '{uuid}'  AS PARENTID,                                                                                 
                 E.TOOLG_ID,                                                                                                           
                 S.EQP_ID,                                                                                                             
                 CASE WHEN S.CHAMBER_NO IS NOT NULL AND EXISTS (SELECT 1 FROM APS_ETL_TOOL.APS_ETL_TOOL L                
                             WHERE  L.CH_ID = S.EQP_ID || '.' || S.CHAMBER_NO)          
                 THEN S.EQP_ID || '.' || S.CHAMBER_NO ELSE S.EQP_ID END AS CH_ID,    
                    CASE WHEN S.E10_STATE='SDT' AND S.E10_CODE='4110' THEN S.PM_TYPE ELSE 'ToolDown-'||S.E10_STATE END AS JOB_ID,
                    STRFTIME(S.START_TIME, '%Y-%m-%d %H:%M:%S') AS START_DATE,
                    --modify by xiecheng for version up
                   -- CASE WHEN S.END_TIME IS NULL THEN NULL ELSE STRFTIME(S.END_TIME, '%Y-%m-%d %H:%M:%S')  END AS END_DATE,
                   COALESCE(STRFTIME(S.END_TIME, '%Y-%m-%d %H:%M:%S'),STRFTIME(S.START_TIME, '%Y-%m-%d %H:%M:%S'))
                    S.EST_SPEC AS PROCESS_TIME,
                    '' AS RETICLE_ID,
                    '' AS RECIPE,
                    CASE WHEN E.STATE_CODE='SDT' AND E.PREV_STATE='4110' THEN 'RUN' ELSE 'WAIT' END AS JOB_STATUS,
                    CASE WHEN E.STATE_CODE='SDT' AND E.PREV_STATE='4110' THEN E.E10CHG_STARTTMST ELSE NULL END AS TRACK_IN,
                    '{current_time}'  AS UPDATE_TIME,
                    '' AS PARTCODE,
                    '' AS FOUP_ID,
                    CASE WHEN S.E10_STATE='SDT' AND S.E10_CODE='4110' THEN 'PM' ELSE 'ToolDown' END AS JOB_TYPE,
                    CASE WHEN S.E10_CODE IS NULL THEN S.E10_STATE 
                    ELSE (S.E10_STATE || '-' || S.E10_CODE) END AS TOOL_CODE,
                    S.FORCE_FLAG AS FIXED_FLAG,
                    CASE WHEN S.FORCE_FLAG='Y' THEN S.UPDATE_TIME ELSE NULL END AS FIXED_TIME
             FROM APS_SYNC_EQP_STATUS_BOOKING_SETTING.APS_SYNC_EQP_STATUS_BOOKING_SETTING  S
             INNER JOIN EQP_INFO E ON E.EQP_ID = S.EQP_ID
             WHERE STRFTIME(cast(S.START_TIME as Date),'%Y-%m-%d') = STRFTIME(cast(CURRENT_DATE as Date),'%Y-%m-%d')
             AND (S.END_TIME IS NULL OR S.END_TIME > CURRENT_DATE)
           -- MFG要求过滤Track借机的数据(最新需求严格按照('*D PM')过滤)
           --modify by xiecheng for version up
            --AND ((SUBSTRING(S.EQP_ID,0,1)='P' AND S.PM_TYPE LIKE ('%D PM'))  OR (SUBSTRING(S.EQP_ID,0,1)<>'P'))
             AND NOT EXISTS (
                 SELECT T.EQUIPMENT_NO
                 FROM APS_SYNC_TMS_EQP_PARAMETER.APS_SYNC_TMS_EQP_PARAMETER  T
                 WHERE S.EQP_ID = T.EQUIPMENT_NO
                 --modify by xiecheng for version up
                 --AND S.PM_TYPE = T.PM_TYPE
                 AND COALESCE(S.CHAMBER_NO,'*') = COALESCE(T.CHAMBER_NO,'*') 
                 AND COALESCE(S.PM_TYPE,'*') = COALESCE(T.PM_TYPE,'*')  
                 AND STRFTIME(cast(T.FORECAST_TIME as Date),'%Y-%m-%d') =STRFTIME(cast(CURRENT_DATE as Date),'%Y-%m-%d')
                 AND T.FORECAST_TIME > CURRENT_DATE
             )
                  )                                                             
         SELECT PARENTID,                                              
                TOOLG_ID,                                              
                EQP_ID,                                                
                CH_ID,                                                 
                JOB_ID,                                                
                MIN(START_DATE) AS START_DATE,                         
                MIN(END_DATE) AS END_DATE,                             
                MAX(PROCESS_TIME) AS PROCESS_TIME,                     
                MAX(RETICLE_ID) AS RETICLE_ID,                         
                MAX(RECIPE) AS RECIPE,                                 
                MAX(JOB_STATUS) AS JOB_STATUS,                         
                MAX(TRACK_IN) AS TRACK_IN,                             
                MAX(UPDATE_TIME) AS UPDATE_TIME,                       
                PARTCODE,                                              
                MAX(FOUP_ID) AS FOUP_ID,                               
                MAX(JOB_TYPE) AS JOB_TYPE,                             
                MAX(TOOL_CODE) AS TOOL_CODE,                           
                MAX(FIXED_FLAG) AS FIXED_FLAG,                         
                MAX(FIXED_TIME) AS FIXED_TIME                          
         FROM RESULT_DATA                                              
         WHERE JOB_ID IS NOT NULL                                      
         GROUP BY PARENTID,TOOLG_ID,EQP_ID,CH_ID, JOB_ID,PARTCODE     
        """.format(uuid=uuid, current_time=current_time)

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_ETL_MONITOR",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_ETL_MONITOR")
    sql = """
        INSERT  /*+ append */  INTO APS_TMP_ETL_MONITOR_V1 (
               PARENTID, TOOLG_ID, TOOL_ID, CH_ID, JOB_ID, START_DATE, END_DATE,
               PROCESS_TIME, RETICLE_ID, RECIPE, JOB_STATUS,TRACK_IN, UPDATE_TIME,
               PARTCODE, FOUP_ID, JOB_TYPE, TOOL_CODE, FIXED_FLAG, FIXED_TIME
        )
         WITH EQP_INFO AS (
              SELECT EQP_ID,MAX(EQP_G) AS TOOLG_ID,
                     MAX(EQP_CHAMBER_FLAG) AS EQP_FLAG,
                     MAX(PREV_E10_STATE_CODE) AS STATE_CODE,
                     MAX(PREV_STATE) AS PREV_STATE,
                     MAX(E10CHG_STARTTMST) AS E10CHG_STARTTMST,
                     MAX(MODULE) AS MODULE
              FROM APS_SYNC_ETL_TOOL.APS_SYNC_ETL_TOOL  T
              GROUP BY EQP_ID
         ),
         PM_DATA_F AS (
              SELECT F.EQUIPMENT_NO,
                      CASE WHEN E.EQP_FLAG = 'Chamber' AND TRIM(' ' from F.CHAMBER_NO) IS NOT NULL
                       THEN (F.EQUIPMENT_NO||'.'||F.CHAMBER_NO)
                       ELSE F.EQUIPMENT_NO END AS CHAMBER_NO,
                      F.PM_TYPE,
                      F.TARGET_TIME,
                      F.FORECAST_TIME,
                      E.TOOLG_ID,
                      E.EQP_FLAG,
                      E.STATE_CODE,
                      E.PREV_STATE,
                      E.E10CHG_STARTTMST,
                      F.TEST_TIME,
                      E.MODULE
              FROM APS_SYNC_TMS_EQP_PARAMETER.APS_SYNC_TMS_EQP_PARAMETER  F
              INNER JOIN EQP_INFO E
              ON E.EQP_ID = F.EQUIPMENT_NO
              WHERE
              --TO_CHAR(TO_DATE(F.FORECAST_TIME,'YYYY-MM-DD HH24:MI:SS'), 'YYYY-MM-DD') = TO_CHAR(SYSDATE,'YYYY-MM-DD')
                   STRFTIME(cast(F.FORECAST_TIME as Date), '%Y-%m-%d') = STRFTIME(cast(CURRENT_DATE as Date),'%Y-%m-%d')
                    AND F.FORECAST_TIME > CURRENT_DATE
        -- MFG要求过滤Track借机的数据(最新需求严格按照('*D PM')过滤)
                    AND ((SUBSTRING(F.EQUIPMENT_NO,0,1)='P' AND F.PM_TYPE LIKE ('%D PM'))  OR (SUBSTRING(F.EQUIPMENT_NO,0,1)<>'P'))
                    AND E.MODULE='WET'
         ),
         PM_DATA AS (
              SELECT * FROM (
                SELECT F.EQUIPMENT_NO,
                       F.CHAMBER_NO,
                       F.PM_TYPE,
                       F.TARGET_TIME,
                       F.FORECAST_TIME,
                       F.TOOLG_ID,
                       F.EQP_FLAG,
                       F.STATE_CODE,
                       F.PREV_STATE,
                       F.E10CHG_STARTTMST,
                       F.TEST_TIME,
                       F.MODULE,
                       ROW_NUMBER() OVER (PARTITION BY F.EQUIPMENT_NO,F.CHAMBER_NO,F.PM_TYPE,F.TOOLG_ID
                              ORDER BY F.FORECAST_TIME DESC) AS RN
                FROM PM_DATA_F F
              )
              WHERE RN = 1
         ),
         PROP_TIME_DATA AS (
             SELECT EQP_ID,                                                                                                    
                  CASE WHEN LENGTH(P.BEGIN_TIMES) = 5 THEN                                                                   
                      STRFTIME(cast(CURRENT_DATE as Date),'%Y-%m-%d')  || ' ' || P.BEGIN_TIMES ||':00'                                          
                   WHEN LENGTH(P.BEGIN_TIMES) = 4 AND  position(':' in P.BEGIN_TIMES)=3 THEN                                            
                        STRFTIME(cast(CURRENT_DATE as Date),'%Y-%m-%d') || ' ' || SUBSTR(P.BEGIN_TIMES,1,3)||'0'||SUBSTR(P.BEGIN_TIMES,4,1)||':00'  
                   WHEN LENGTH(P.BEGIN_TIMES) = 4 AND  position(':' in P.BEGIN_TIMES)=2 THEN                                            
                        STRFTIME(cast(CURRENT_DATE as Date),'%Y-%m-%d') || ' 0' || P.BEGIN_TIMES ||':00'                                            
                   ELSE                                                                                                          
                         STRFTIME(cast(CURRENT_DATE as Date),'%Y-%m-%d') || ' 00:00:00'                                                             
                   END BEGIN_TIME,                                                                                               
                   CASE WHEN LENGTH(P.END_TIMES) = 5 THEN                                                                        
                        STRFTIME(cast(CURRENT_DATE as Date),'%Y-%m-%d') || ' ' || P.END_TIMES ||':00'                                               
                   WHEN LENGTH(P.END_TIMES) = 4 AND position(':' in P.END_TIMES)=3  THEN                                               
                        STRFTIME(cast(CURRENT_DATE as Date),'%Y-%m-%d') || ' ' || SUBSTR(P.END_TIMES,1,3)||'0'||SUBSTR(P.END_TIMES,4,1)||':00'      
                   WHEN LENGTH(P.END_TIMES) = 4 AND  position(':' in P.END_TIMES)=2  THEN                                         
                        STRFTIME(cast(CURRENT_DATE as Date),'%Y-%m-%d') || ' 0' || P.END_TIMES ||':00'                                          
                   ELSE                                                                                                    
                        STRFTIME(cast(CURRENT_DATE as Date),'%Y-%m-%d') || ' 00:00:00'                                                         
                   END END_TIME,                                                                                              
                  PM_TYPE                                                                                                    
           FROM APS_SYNC_SCHE_PM_PROP_TIME.APS_SYNC_SCHE_PM_PROP_TIME P                                                       
           WHERE P.PM_TYPE LIKE REPLACE(P.PM_TYPE,'*','%')                                                                                                                                   
              AND P.MUDULE='WET'                                                                                             
               AND (P.BEGIN_TIMES > ' ' AND P.END_TIMES > ' ')  
         ),
         BOOKING_INFO AS (
            SELECT S.EQP_ID,S.PM_TYPE,
                   S.START_TIME,
                   S.END_TIME,
                   S.EST_SPEC,
                   S.FORCE_FLAG,
                   S.UPDATE_TIME
            FROM APS_SYNC_EQP_STATUS_BOOKING_SETTING.APS_SYNC_EQP_STATUS_BOOKING_SETTING  S
            WHERE S.E10_STATE='SDT' AND S.E10_CODE='4110'
            AND STRFTIME(cast(S.START_TIME as Date),'%Y-%m-%d') = STRFTIME(cast(CURRENT_DATE as Date),'%Y-%m-%d')
            AND (S.END_TIME IS NULL OR S.END_TIME > CURRENT_DATE)
         )
         SELECT
                '{uuid}'  AS PARENTID,
                T.TOOLG_ID,
                T.EQUIPMENT_NO,
                T.CHAMBER_NO AS CH_ID,
                T.PM_TYPE AS JOB_ID,
                CASE WHEN I.EQP_ID IS NOT NULL THEN
                 --TO_CHAR(I.START_TIME, 'YYYY-MM-DD HH24:MI:SS')
                 STRFTIME(cast(I.START_TIME as Date), '%Y-%m-%d %H:%M:%S')
                ELSE
                  (CASE WHEN P.EQP_ID IS NOT NULL THEN
                     --TO_CHAR(P.BEGIN_TIME, 'YYYY-MM-DD HH24:MI:SS')
                     STRFTIME(cast(P.BEGIN_TIME as Date), '%Y-%m-%d %H:%M:%S')
                  ELSE
                     --(TO_CHAR(TO_DATE(T.FORECAST_TIME,'YYYY-MM-DD HH24:MI:SS'),'YYYY-MM-DD')|| ' 00:00:00')
                     (STRFTIME(STRPTIME(T.FORECAST_TIME,'%Y/%m/%d %H:%M'),'%Y-%m-%d')|| ' 00:00:00')
                  END)
                END AS START_DATE,

                CASE WHEN I.EQP_ID IS NOT NULL THEN
                 -- TO_CHAR(I.END_TIME, 'YYYY-MM-DD HH24:MI:SS')
                    STRFTIME(cast(I.END_TIME as Date), '%Y-%m-%d %H:%M:%S')
                ELSE
                  CASE WHEN P.EQP_ID IS NOT NULL THEN
                    -- TO_CHAR(P.END_TIME, 'YYYY-MM-DD HH24:MI:SS')
                       STRFTIME(cast(P.END_TIME as Date), '%Y-%m-%d %H:%M:%S')
                  ELSE
                    -- TO_CHAR(TO_DATE(T.FORECAST_TIME, 'YYYY-MM-DD HH24:MI:SS'),'YYYY-MM-DD HH24:MI:SS')
                       STRFTIME(STRPTIME(T.FORECAST_TIME,'%Y/%m/%d %H:%M'), '%Y-%m-%d %H:%M:%S')
                  END
                END AS END_DATE,
                 COALESCE(CAST(T.TARGET_TIME AS DECIMAL), 0) + COALESCE(CAST(T.TEST_TIME AS DECIMAL), 0) AS PROCESS_TIME,
                '' AS RETICLE_ID,
                '' AS RECIPE,
                CASE WHEN T.STATE_CODE='SDT' AND T.PREV_STATE='4110'
                          THEN 'RUN' ELSE 'WAIT' END AS JOB_STATUS,
                CASE WHEN T.STATE_CODE='SDT' AND T.PREV_STATE='4110'
                          THEN STRFTIME(cast(T.E10CHG_STARTTMST as Date), '%Y-%m-%d %H:%M:%S') ELSE NULL END AS TRACK_IN,
                '{current_time}' AS UPDATE_TIME,
                '' AS PARTCODE,
                '' AS FOUP_ID,
                'PM' AS JOB_TYPE,
                'SDT-4110' AS TOOL_CODE,
                CASE WHEN I.EQP_ID IS NOT NULL AND I.FORCE_FLAG='Y' THEN 'Y' ELSE 'N' END AS FIXED_FLAG,
                CASE WHEN I.EQP_ID IS NOT NULL AND I.FORCE_FLAG='Y'
                         THEN STRFTIME(cast(I.UPDATE_TIME as Date), '%Y-%m-%d %H:%M:%S') ELSE NULL END AS FIXED_TIME
         FROM PM_DATA T
         LEFT JOIN PROP_TIME_DATA P
         ON T.EQUIPMENT_NO LIKE REPLACE(P.EQP_ID,'*','%')
         AND T.PM_TYPE LIKE  REPLACE(P.PM_TYPE  ,'*','%')
         LEFT JOIN BOOKING_INFO I
         ON I.EQP_ID = T.EQUIPMENT_NO
         AND I.PM_TYPE = T.PM_TYPE
         """.format(uuid=uuid, current_time=current_time)

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_MONITOR_V1",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_MONITOR_V1")

    sql = """
         INSERT INTO APS_TMP_ETL_MONITOR_DF_SOURCE(
             TOOLG_ID, FOUP_ID, TOOL_ID, CH_ID, JOB_ID, RECIPE, START_DATE, END_DATE, JOB_STATUS, JOB_TYPE, JOB_SPEC_GROUP_ID
              --modify by xiecheng for version up
             , CREATE_TIME
        )
         WITH SOURCE_DATA AS (
             SELECT   ROW_NUMBER() OVER (PARTITION BY OP.JOB_SPEC_GROUP_ID,OP.PTOOL_ID  ORDER BY OP.SEQNO) AS RN,
                      OP.JOB_SPEC_GROUP_ID,OP.PTOOL_ID,OP.SUB_NAME,
                      OP.CREATE_TIME,OP.STATUS,OP.RECIPE,OP.FOUP_ID,
                      OP.MAINTOOLFLAG
             FROM APS_SYNC_OCS_JOB_SPEC_GROUP_PO.APS_SYNC_OCS_JOB_SPEC_GROUP_PO OP
             WHERE
             --modify by xiecheng for version up
             -- TEST_FOR='RT'
            -- AND STATUS IN ('SBY','PRD')
             (CASE WHEN STATUS = 'SBY' AND TEST_FOR='RT' THEN 1
                   WHEN STATUS = 'PRD' THEN 1   
                ELSE 0 END = 1)  
             AND POSITION('F' IN MTOOL_ID) = 1
        -- 过滤超过三天的数据
             AND OP.CREATE_TIME >= DATE_TRUNC('day', CURRENT_DATE) - INTERVAL '3 day'
         ),
         GROUP_DATA AS (
             SELECT OP.PTOOL_ID,OP.JOB_SPEC_GROUP_ID,
                    MAX(SUB_NAME) AS SUB_NAME,
                    MAX(OP.CREATE_TIME) AS CREATE_TIME,
                    --modify by xiecheng for version up
                    --MAX(OP.STATUS) AS STATUS,
                    MIN(OP.STATUS) AS STATUS, 
                    MAX(RECIPE) AS RECIPE,
                    REGEXP_REPLACE(STRING_AGG(OP.FOUP_ID,',' ORDER BY OP.FOUP_ID) ,'([^,]*)(,\1)+($|,)','\1\3') AS FOUP_ID
             FROM SOURCE_DATA OP
             WHERE 1=1
             AND OP.MAINTOOLFLAG = 'True'
             GROUP BY OP.PTOOL_ID,OP.JOB_SPEC_GROUP_ID
         )
         SELECT T.TOOLG_ID,
                OP.FOUP_ID,OP.PTOOL_ID AS TOOL_ID,
                COALESCE(T.CH_ID,OP.PTOOL_ID) AS CH_ID,
               JOB_SPEC_GROUP_ID || '(' || SUB_NAME || ')' AS JOB_ID,
               OP.RECIPE,STRFTIME(OP.CREATE_TIME, '%Y-%m-%d %H:%M:%S') AS START_DATE,
        -- 针对过期时间：当天白天建的(7:30-19:30)，要在当班做完(7:30-次日7：30).如果是晚上建的(19:30-次日7：30)，则顺延一天（次日7：30- 第三日7：30）
                CASE WHEN (STRFTIME(OP.CREATE_TIME,'%H:%M:%S') >= '00:00:00') AND STRFTIME(OP.CREATE_TIME,'%H:%M:%S') <= '19:30:00'
               THEN STRFTIME(CURRENT_DATE +1, '%Y-%m-%d') || ' 07:30:00'
               ELSE STRFTIME(CURRENT_DATE +2, '%Y-%m-%d') || ' 07:30:00' END AS END_DATE,
               --DECODE(OP.STATUS,'PRD','RUN','SBY','WAIT',OP.STATUS) AS JOB_STATUS,
               CASE WHEN OP.STATUS = 'PRD' THEN 'RUN'
                    WHEN OP.STATUS = 'SBY' THEN 'WAIT'
                    ELSE OP.STATUS END  AS JOB_STATUS,
               'RT Monitor' AS JOB_TYPE, JOB_SPEC_GROUP_ID
                --modify by xiecheng for version up
               , OP.CREATE_TIME
         FROM GROUP_DATA OP
         INNER JOIN APS_ETL_TOOL.APS_ETL_TOOL T
         ON T.MODULE ='DIFF'
         AND (T.TOOL_ID = OP.PTOOL_ID
         OR OP.PTOOL_ID || '.' || OP.SUB_NAME = T.CH_ID)
          """.format(uuid=uuid, current_time=current_time)

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_MONITOR_DF_SOURCE",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_MONITOR_DF_SOURCE")

    sql = """
        INSERT INTO  APS_TMP_ETL_MONITOR_DF_PROCESS (
              TOOLG_ID, FOUP_ID, TOOL_ID, CH_ID, JOB_ID, RECIPE, START_DATE, END_DATE, JOB_STATUS, JOB_TYPE, JOB_SPEC_GROUP_ID, PROCESS_TIME, CREATE_TIME
        )
         SELECT T.TOOLG_ID,
                T.FOUP_ID,T.TOOL_ID,
                T.CH_ID,
                T.JOB_ID,
                T.RECIPE,T.START_DATE,
               CASE WHEN CT.JOB_SPEC_GROUP_ID IS NOT NULL AND CT.MEASURE_CT > 0                                                                     
               THEN STRFTIME(CAST(T.END_DATE AS DATE) - INTERVAL '12 hours','%Y-%m-%d %H:%M:%S')                        
               ELSE T.END_DATE END AS END_DATE,  
                T.JOB_STATUS,
                T.JOB_TYPE,T.JOB_SPEC_GROUP_ID,
                COALESCE(ZD.PROCESS_TIME,COALESCE(ZD32.PROCESS_TIME,0)) AS PROCESS_TIME,
                 T.CREATE_TIME
         FROM  APS_TMP_ETL_MONITOR_DF_SOURCE  T
         LEFT JOIN APS_MID_TYPE31_MEDIAN.APS_MID_TYPE31_MEDIAN ZD ON ZD.TOOLG_ID = T.TOOLG_ID
         AND ZD.PLAN_ID = T.JOB_SPEC_GROUP_ID  AND ZD.TOOL_ID = T.TOOL_ID
         LEFT JOIN  APS_MID_TYPE32_MEDIAN.APS_MID_TYPE32_MEDIAN  ZD32 ON ZD32.TOOLG_ID = T.TOOLG_ID
         LEFT JOIN APS_MID_OCS_MEASURE_CT.APS_MID_OCS_MEASURE_CT CT ON CT.JOB_SPEC_GROUP_ID = T.JOB_SPEC_GROUP_ID  
         """.format(uuid=uuid, current_time=current_time)

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_MONITOR_DF_PROCESS",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_MONITOR_DF_PROCESS")

    sql = """
        INSERT INTO  APS_TMP_ETL_MONITOR_DF_PT (                                          
         JOB_SPEC_GROUP_ID, TOOL_ID, TRACK_IN, TRACK_OUT                                                             
         )                                                                            
          SELECT W.JOB_SPEC_GROUP_ID, W.TOOL_ID,                                                                                      
          MAX(H.PROCESS_ST_TIME) AS TRACK_IN,                                                                                         
          MAX(H.PROCESS_ED_TIME) AS TRACK_OUT                                                                                         
          FROM  APS_TMP_ETL_MONITOR_DF_PROCESS  W                                                                          
          INNER JOIN  APS_TMP_OCS_MAIN_H.APS_TMP_OCS_MAIN_H  H                                                                  
          ON W.JOB_SPEC_GROUP_ID = H.JOB_SPEC_GROUP_ID AND W.TOOL_ID = H.MTOOL_ID                                                     
          AND H.STATUS='OpeStart' AND W.JOB_STATUS = 'RUN' AND H.END_TIME >  DATE_TRUNC('day', CURRENT_DATE) - INTERVAL '5 day'                                              
          GROUP BY  W.JOB_SPEC_GROUP_ID, W.TOOL_ID                     
          """.format(uuid=uuid, current_time=current_time)

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_MONITOR_DF_PT",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_MONITOR_DF_PT")

    sql = """
          INSERT INTO APS_ETL_MONITOR (
           --modify by xiecheng for version up
               TOOLG_ID, FOUP_ID, TOOL_ID, CH_ID, JOB_ID, RECIPE, START_DATE, END_DATE, JOB_STATUS, JOB_TYPE,
               PROCESS_TIME, TRACK_IN, PROCESS_START, PARENTID, UPDATE_TIME, PARTCODE
         )
          WITH TRACK_IN_DATA AS (
                 SELECT W.JOB_SPEC_GROUP_ID, W.TOOL_ID,
                 --modify by xiecheng for version up
                 --MAX(H.PROCESS_ST_TIME) AS TRACK_IN,               
                 --MAX(H.PROCESS_ED_TIME) AS TRACK_OUT
                 MAX(H.START_TIME) AS TRACK_IN,  
                 MAX(W.CREATE_TIME) AS CREATE_TIME  
                 FROM APS_TMP_ETL_MONITOR_DF_PROCESS  W
                 --modify by xiecheng for version up
                 --INNER JOIN APS_TMP_OCS_MAIN_H.APS_TMP_OCS_MAIN_H H
                 INNER JOIN APS_MID_OCS_JOB_GROUP_PO_STATE_H.APS_MID_OCS_JOB_GROUP_PO_STATE_H H
                 ON W.JOB_SPEC_GROUP_ID = H.JOB_SPEC_GROUP_ID AND W.TOOL_ID = H.MTOOL_ID
                 AND H.STATUS='OpeStart' AND W.JOB_STATUS = 'RUN' AND H.END_TIME > DATE_TRUNC('day', CURRENT_DATE) - INTERVAL '5 day'
                 GROUP BY W.JOB_SPEC_GROUP_ID, W.TOOL_ID
          ),
           WIP_DATA AS (
                 SELECT MAX(W.LOT_ID) AS LOT_ID,W.EQP_ID,
                 W.CASSETE_ID,MAX(W.OPE_NO_START_TIME) AS OPE_NO_START_TIME
                 --modify by xiecheng for version up
                 ,MAX(W.PROCESS_START_TIME) AS PROCESS_START_TIME  
                 FROM APS_SYNC_WIP.APS_SYNC_WIP  W
                 WHERE
                 LOT_TYPE ='Process Monitor'
                 AND W.EQP_ID IS NOT NULL
                 GROUP BY EQP_ID,CASSETE_ID
          )
          SELECT T.TOOLG_ID,
                 T.FOUP_ID,T.TOOL_ID,
                 T.CH_ID,
                 T.JOB_ID,
                 T.RECIPE,T.START_DATE,
                 T.END_DATE,
                 CASE WHEN W.EQP_ID IS NOT NULL THEN 'RUN' ELSE T.JOB_STATUS END AS JOB_STATUS,
                 T.JOB_TYPE,
                 T.PROCESS_TIME,
                 CASE WHEN W.EQP_ID IS NOT NULL THEN STRFTIME(W.OPE_NO_START_TIME, '%Y-%m-%d %H:%M:%S') ELSE
                  --modify by xiecheng for version up
                 -- (CASE WHEN T.JOB_STATUS ='RUN' AND TRACK_OUT < TRACK_IN THEN STRFTIME(D.TRACK_IN, '%Y-%m-%d %H:%M:%S') END) END AS TRACK_IN,
                 (CASE WHEN T.JOB_STATUS ='RUN' AND  D.TRACK_IN > D.CREATE_TIME THEN STRFTIME(D.TRACK_IN, '%Y-%m-%d %H:%M:%S') END) END AS TRACK_IN,    
                 CASE WHEN W.EQP_ID IS NOT NULL THEN STRFTIME(W.PROCESS_START_TIME, '%Y-%m-%d %H:%M:%S') ELSE
                 (CASE WHEN T.JOB_STATUS ='RUN' AND DP.TRACK_IN > D.TRACK_IN AND (DP.TRACK_OUT IS NULL OR DP.TRACK_IN > DP.TRACK_OUT) 
                 THEN STRFTIME(DP.TRACK_IN, '%Y-%m-%d %H:%M:%S') END) END AS PROCESS_START,  
                 '{uuid}' AS PARENTID,
                 '{current_time}' AS UPDATE_TIME,
                 '' AS PARTCODE
          FROM  APS_TMP_ETL_MONITOR_DF_PROCESS  T
          LEFT JOIN TRACK_IN_DATA D
          ON D.JOB_SPEC_GROUP_ID = T.JOB_SPEC_GROUP_ID AND T.TOOL_ID = D.TOOL_ID
          LEFT JOIN WIP_DATA W
          ON W.EQP_ID = T.TOOL_ID AND POSITION(W.CASSETE_ID IN T.FOUP_ID) > 0
          LEFT JOIN APS_TMP_ETL_MONITOR_DF_PT DP
          ON DP.JOB_SPEC_GROUP_ID = T.JOB_SPEC_GROUP_ID AND T.TOOL_ID = DP.TOOL_ID 
              """.format(uuid=uuid, current_time=current_time)

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_ETL_MONITOR",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_ETL_MONITOR")


def execute():
    ###############################################################
    ### 以下参数必须定义
    ### ETL_Proc_Name    : ETL 名称
    ### current_time     ：请直接拷贝
    ### current_time_short ：请直接拷贝
    ### uuid             ：请直接拷贝
    ### target_table     : 该ETL输出表名
    ### used_table_list  : 该ETL使用到的，参考到的表名(中间表不算)
    ### target_table_sql ： 该ETL输出表定义SQL
    ###############################################################
    ETL_Proc_Name = "APS_ETL_BR.APS_ETL_MONITOR_10M"
    current_time = my_date.date_time_second_str()
    current_time_short = my_date.date_time_second_short_str()
    uuid = my_oracle.UUID()

    target_table = "APS_ETL_MONITOR"
    used_table_list = ['APS_SYNC_OCS_JOB_SPEC_GROUP_PO',
                       'APS_SYNC_ETL_TOOL',
                       'APS_TMP_OCS_MAIN_H',
                       'APS_MID_TYPE31_MEDIAN',
                       'APS_MID_TYPE32_MEDIAN',
                       'APS_SYNC_TMS_EQP_PARAMETER',
                       'APS_SYNC_SCHE_PM_PROP_TIME',
                       'APS_SYNC_EQP_STATUS_BOOKING_SETTING',
                       'APS_SYNC_WIP',
                       'APS_ETL_TOOL',
                       'APS_MID_OCS_MEASURE_CT',
                       'APS_MID_OCS_JOB_GROUP_PO_STATE_H'
                       ]
    target_table_sql = """
        create table {}APS_ETL_MONITOR
        (
            parentid      VARCHAR(60) not null,
            toolg_id      VARCHAR(60) not null,
            tool_id       VARCHAR(60) not null,
            ch_id         VARCHAR(60) not null,
            job_id        VARCHAR(60) not null,
            start_date    VARCHAR(60) not null,
            end_date      VARCHAR(60) not null,
            process_time  VARCHAR(60) not null,
            reticle_id    VARCHAR(60),
            recipe        VARCHAR(60),
            job_status    VARCHAR(60),
            track_in      VARCHAR(60),
            update_time   VARCHAR(60) not null,
            partcode      VARCHAR(60) not null,
            foup_id       VARCHAR(500),
            job_type      VARCHAR(60),
            tool_code     VARCHAR(60),
            fixed_flag    VARCHAR(1),
            fixed_time    VARCHAR(60),
            process_start VARCHAR(64)
        )
    """.format("")  # 注意:这里一定要这么写 [create table 表名] => [create table {}表名]
    target_db_file = my_duck.get_target_file_name(target_table, current_time_short)

    oracle_conn = None
    try:
        oracle_conn = my_oracle.oracle_get_connection()
        # 开始日志
        my_oracle.StartCleanUpAndLog(oracle_conn, ETL_Proc_Name, current_time)
        # 创建DuckDB
        duck_db_memory = my_duck.create_duckdb_in_momory(target_table_sql)
        if config.g_thread_and_memory_limit:  # 是否手动管理内存和进程
            duck_db_memory.sql('SET threads TO 2')
            # 加上TMP目录:LQN:2023/08/21
            duck_db_memory.execute("SET temp_directory='{}'".format(os.path.join(config.g_mem_etl_output_path, 'duck_temp', uuid)))
        # 创建Temp表
        create_temp_table(duck_db_memory)
        # Attach用到的表
        my_duck.attach_used_table(oracle_conn, duck_db_memory, used_table_list)
        ################################################################################################################
        ## 以下为业务逻辑
        ################################################################################################################

        biz_method_01(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name)

        ################################################################################################################
        ## 以上为业务逻辑
        ################################################################################################################
        if config.g_copy_to_pg:
            select_sql_in_duck = """select parentid,toolg_id,tool_id,ch_id,job_id, start_date,end_date,
                                           process_time,reticle_id,recipe,job_status,track_in,update_time,
                                           foup_id,job_type,tool_code,fixed_flag,fixed_time,process_start from APS_ETL_MONITOR
                                             """
            postgres_table_define = """etl_monitor(parentid,toolg_id,tool_id,ch_id,job_id, start_date,end_date,
                                                   process_time,reticle_id,recipe,job_status,track_in,update_time,
                                                    foup_id,job_type,tool_code,fixed_flag,fixed_time,process_start)
                                         """
            my_postgres.copy_duckdb_to_postgres(uuid=uuid,
                                                duckdb=duck_db_memory,
                                                table_name_in_duckdb=target_table,
                                                table_name_in_pg="etl_monitor",  # 要小写
                                                select_sql_in_duck=select_sql_in_duck,
                                                postgres_table_define=postgres_table_define)
        # 导出到目标文件中
        target_db_file = my_duck.export_result_duck_file_and_close_duck_db_memory(duck_db_memory,
                                                                                  target_table,
                                                                                  target_table_sql.format("file_db."),
                                                                                  current_time_short)
        # 写版本号
        my_oracle.HandlingVerControl(oracle_conn, uuid, target_table, target_db_file)
        # 写完成日志
        my_oracle.EndCleanUpAndLog(oracle_conn, ETL_Proc_Name, current_time)
    except Exception as e:
        # 写警告日志
        my_oracle.SaveAlarmLogData(oracle_conn, ETL_Proc_Name, e, target_db_file,
                                   cons_error_code.APS_ETL_MONITOR_CODE_XX_ETL)
        logging.exception("{ETL_Proc_Name} 處理出錯 : {e}".format(ETL_Proc_Name=ETL_Proc_Name, e=e))
        raise e
    finally:
        oracle_conn.commit()
        oracle_conn.close()
        if config.g_thread_and_memory_limit:  # 是否手动管理内存和进程
            # 删除TMP目录:LQN:2023/08/21
            if os.path.exists(os.path.join(config.g_mem_etl_output_path, 'duck_temp', uuid)):
                os.remove(os.path.join(config.g_mem_etl_output_path, 'duck_temp', uuid))
        gc.collect()  # 内存释放

if __name__ == '__main__':
    # 单JOB测试用
    print("start")
    execute()
