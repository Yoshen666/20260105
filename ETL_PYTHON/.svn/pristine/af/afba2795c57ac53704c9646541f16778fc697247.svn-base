import gc
import logging
import os

from xinxiang import config
from xinxiang.util import my_duck, my_oracle, my_date, cons_error_code, cons, my_postgres


def create_temp_table(duck_db):
    '''
    这里在内存中创建使用到的临时表
    '''
    sql = """
    create table APS_TMP_ETL_LOTHISTROY
    (
        lot_id             VARCHAR(64),
        prodspec_id        VARCHAR(64),
        mainpd_id          VARCHAR(64),
        priority           VARCHAR(64),
        ope_no             VARCHAR(64),
        wafer_qty          VARCHAR(64),
        reticle_id         VARCHAR(128),
        prev_op_comp_time  VARCHAR(64),
        op_start_date_time VARCHAR(64),
        claim_time         VARCHAR(64),
        pass_count         VARCHAR(64),
        ctrl_job           VARCHAR(64),
        process_start_time VARCHAR(64),
        eqp_id             VARCHAR(64),
        toolg_id           VARCHAR(64),
        real_module        VARCHAR(64),
        ope_seq            VARCHAR(64),
        chamber_set        VARCHAR(512)
    )
    """
    duck_db.sql(sql)
    sql = """
    create table APS_TMP_ETL_LOTHISTROY_FHOPEH
    (
        ctrl_job     VARCHAR(64),
        lot_id       VARCHAR(64),
        tech_id      VARCHAR(64),
        ph_recipe_id VARCHAR(64),
        customer_id  VARCHAR(64),
        lot_type     VARCHAR(64),
        claim_time   VARCHAR(64),
        ope_category VARCHAR(64),
        eqp_id       VARCHAR(64),
        ope_no       VARCHAR(64)
    )
    """
    duck_db.sql(sql)
    sql = """
    create table APS_TMP_ETL_LOTHISTROY_RECIPE
    (
        lcrecipe_id VARCHAR(64),
        ope_no      VARCHAR(64),
        prodspec_id VARCHAR(64),
        mainpd_id   VARCHAR(64)
    )
    """
    duck_db.sql(sql)

    sql = """
    create table APS_TMP_ETL_LOTHISTROY_RECIPE1
    (
        lcrecipe_id VARCHAR(64),
        ope_no      VARCHAR(64),
        prodspec_id VARCHAR(64),
        mainpd_id   VARCHAR(64)
    )
    """
    duck_db.sql(sql)

    sql = """
     create table APS_TMP_ETL_LOTHISTROY_FLOW
     (
        prod_id VARCHAR(64),
        plan_id VARCHAR(64),
        layer   VARCHAR(64),
        stage   VARCHAR(64),
        step_id VARCHAR(64)
     )
     """
    duck_db.sql(sql)

    sql = """
     create table APS_TMP_ETL_LOTHISTROY_PO_N1
     (
        pos_pdid  VARCHAR(64) not null,
        mainpd_id VARCHAR(64) not null,
        ope_no    VARCHAR(10) not null
     )
     """
    duck_db.sql(sql)

    sql = """
     create table APS_TMP_ETL_LOTHISTROY_EQP_LOAD
     (
        eqp_id      VARCHAR(10),
        lcrecipe_id VARCHAR(40),
        pd_id       VARCHAR(40) not null,
        prodspec_id VARCHAR(30) not null
     )
     """
    duck_db.sql(sql)

    sql = """
     create table APS_TMP_ETL_LOTHISTROY_RECIPE_GROUP
     (
        tool_id       VARCHAR(64),
        ppid          VARCHAR(64),
        rtd_groupname VARCHAR(64)
     )
     """
    duck_db.sql(sql)

    sql = """
     create table APS_TMP_ETL_LOTHISTROY_PROCESSDATA
     (
        ctrl_job      VARCHAR(64),
        lot_id        VARCHAR(64),
        tech_id       VARCHAR(64),
        ph_recipe_id  VARCHAR(64),
        customer_id   VARCHAR(64),
        lot_type      VARCHAR(64),
        rtd_groupname VARCHAR(64),
        reserve_time  VARCHAR(64),
        process_end   VARCHAR(64),
        scanner_end   VARCHAR(64),
        scanner_start VARCHAR(64)
     )
     """
    duck_db.sql(sql)

    sql = """
     create table APS_TMP_ETL_LOTHISTROY_SPLITDATA
     (
        ope_no     VARCHAR(64),
        lot_id     VARCHAR(64),
        split_time VARCHAR(64)
     )
     """
    duck_db.sql(sql)

    sql = """
     create table APS_TMP_ETL_LOTHISTROY_TOOLDATA
     (
        toolg_id     VARCHAR(64),
        tool_id      VARCHAR(64),
        module       VARCHAR(64),
        eqp_category VARCHAR(64),
        eqp_chamber_flag VARCHAR(64)
     )
     """
    duck_db.sql(sql)

    sql = """
     create table APS_TMP_ETL_LOTHS_PRODG
     (
        prodg_id    VARCHAR(64),
        prodg_tech  VARCHAR(12),
        prodspec_id VARCHAR(64) not null
     )
     """
    duck_db.sql(sql)

    sql = """
     create table APS_TMP_ETL_LOTHS_V1
     (
        lot_id             VARCHAR(64),
        eqp_g              VARCHAR(64),
        prodspec_id        VARCHAR(64),
        mainpd_id          VARCHAR(64),
        step_id            VARCHAR(64),
        priority           VARCHAR(64),
        ope_no             VARCHAR(64),
        wafer_qty          VARCHAR(64),
        reticle_id         VARCHAR(128),
        prev_op_comp_time  VARCHAR(64),
        op_start_date_time VARCHAR(64),
        claim_time         VARCHAR(64),
        pass_count         VARCHAR(64),
        real_module        VARCHAR(64),
        ctrl_job           VARCHAR(64),
        process_start_time VARCHAR(64),
        eqp_id             VARCHAR(64),
        chamber_set        VARCHAR(512)
     )
     """
    duck_db.sql(sql)

    sql = """
       create table APS_TMP_ETL_LOTHISTROY_CHAMBER_RULE
       (
            line              VARCHAR(60),
            prod_id           VARCHAR(64),
            ope_no            VARCHAR(64),
            eqp_id            VARCHAR(64),
            recipe_id         VARCHAR(128),
            chamber_user_flag VARCHAR(64),
            ch_id             VARCHAR(512)
       )
       """
    duck_db.sql(sql)

    sql = """
       create table APS_TMP_ETL_LOTHISTROY_EQP_CHAMBER_RULE
       (
            eqp_id VARCHAR(64),
            ch_id  VARCHAR(512)
       )
       """
    duck_db.sql(sql)

    sql = """
       create table APS_TMP_ETL_LOTHISTROY_ONLY_EQP_CHAMBER_RULE
       (
         eqp_id VARCHAR(64)
       )
       """
    duck_db.sql(sql)


def biz_method_02(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    sql = """
        INSERT  /*+ append */  INTO APS_ETL_LOTHISTORY(                                                       
                LOT_ID, TOOLG_ID, TOOL_ID, PROD_ID, PLAN_ID, STEP_ID, LOT_TYPE,PTY,SHR_FLAG, 
                LAYER, STAGE, RECIPE, PPID, QTY, RETICLE_ID, TECH_ID, CUSTOMER, ARRIVAL, JOB_PREPARE,
                TRACK_IN, PROCESS_START, PROCESS_END, TRACK_OUT, REWORK_FLAG, BACKUP_FLAG, MODULE,
                PRODG_ID, PRODG_TECH, UPDATE_TIME, PARTKEY, SCANNER_START, SCANNER_END, RECIPE_SETUP,CH_SET                                                                                           
        )                                                                                                                
         SELECT                                                                                                      
         LH.LOT_ID,                                                                                                  
         LH.EQP_G AS TOOLG_ID,                                                                                       
         LH.EQP_ID AS TOOL_ID,                                                                                       
         LH.PRODSPEC_ID AS PROD_ID,                                                                                  
         LH.MAINPD_ID AS PLAN_ID,                                                                                    
         LH.STEP_ID,                                                                                                 
         FH.LOT_TYPE AS LOT_TYPE,                                                                                    
         CAST(LH.PRIORITY AS INTEGER) AS PTY,                                                                                         
         CAST(COALESCE(SP.PRI,'-1') AS INTEGER) AS SHR_FLAG,                                                                               
         SUBSTRING(LH.OPE_NO, 1, POSITION('.' IN LH.OPE_NO)-1 ) AS LAYER,                                                 
         SUBSTRING(LH.OPE_NO, POSITION('.' IN LH.OPE_NO) +1 ) AS STAGE,                                                    
         FO.LCRECIPE_ID AS RECIPE,                                                                                   
         FH.PH_RECIPE_ID AS PPID,                                                                                    
         CAST(LH.WAFER_QTY AS DECIMAL) AS QTY,                                                                                        
         LH.RETICLE_ID,                                                                                              
         FH.TECH_ID AS TECH_ID,                                                                                      
         FH.CUSTOMER_ID AS CUSTOMER,                                                                                 
         CASE WHEN SA.LOT_ID IS NOT NULL AND SA.SPLIT_TIME > LH.PREV_OP_COMP_TIME AND SA.SPLIT_TIME < LH.OP_START_DATE_TIME THEN      
         CAST(STRFTIME(SA.SPLIT_TIME, '%Y-%m-%d %H:%M:%S') AS TIMESTAMP) ELSE CAST(STRFTIME(LH.PREV_OP_COMP_TIME, '%Y-%m-%d %H:%M:%S') AS TIMESTAMP)END AS ARRIVAL,    
         CAST(STRFTIME(FH.RESERVE_TIME, '%Y-%m-%d %H:%M:%S') AS TIMESTAMP) AS JOB_PREPARE,                                            
         CAST(STRFTIME(LH.OP_START_DATE_TIME, '%Y-%m-%d %H:%M:%S') AS TIMESTAMP) AS TRACK_IN,                                         
         CAST(COALESCE(STRFTIME(LH.PROCESS_START_TIME, '%Y-%m-%d %H:%M:%S'),STRFTIME(LH.OP_START_DATE_TIME, '%Y-%m-%d %H:%M:%S')) AS TIMESTAMP) AS PROCESS_START,       
         CAST(COALESCE(STRFTIME(FH.PROCESS_END, '%Y-%m-%d %H:%M:%S'),STRFTIME(LH.CLAIM_TIME, '%Y-%m-%d %H:%M:%S')) AS TIMESTAMP) AS PROCESS_END,  
         CAST(STRFTIME(LH.CLAIM_TIME, '%Y-%m-%d %H:%M:%S') AS TIMESTAMP) AS TRACK_OUT,                                                
         CASE WHEN SUBSTRING(LH.MAINPD_ID,1,1)='Y' THEN 'Y' ELSE 'N' END AS REWORK_FLAG,                                
         'N' AS BACKUP_FLAG,                                                                                         
         LH.REAL_MODULE AS MODULE, P.PRODG_ID, P.PRODG_TECH,                                                         
         CAST('{current_time}' AS TIMESTAMP) AS UPDATE_TIME,                                                                      
         STRFTIME(LH.OP_START_DATE_TIME, '%Y-%m-%d %H:%M:%S') AS PARTKEY,        
         CAST(STRFTIME(FH.SCANNER_START, '%Y-%m-%d %H:%M:%S') AS TIMESTAMP) AS SCANNER_START,                                         
         CAST(STRFTIME(FH.SCANNER_END, '%Y-%m-%d %H:%M:%S') AS TIMESTAMP) AS SCANNER_END,                                             
         FH.RTD_GROUPNAME AS SCANNER_END,'' AS CH_SET                                                                              
         FROM APS_TMP_ETL_LOTHS_V1 LH                                                                                                             
         LEFT JOIN APS_TMP_ETL_LOTHISTROY_PROCESSDATA FH ON LH.LOT_ID = FH.LOT_ID AND LH.CTRL_JOB = FH.CTRL_JOB         
         LEFT JOIN APS_SYNC_SHR_PRI.APS_SYNC_SHR_PRI SP ON SP.LOT_ID = LH.LOT_ID                                                                                   
         LEFT JOIN APS_TMP_ETL_LOTHS_PRODG P ON P.PRODSPEC_ID = LH.PRODSPEC_ID                                 
         LEFT JOIN APS_TMP_ETL_LOTHISTROY_RECIPE FO ON FO.PRODSPEC_ID = LH.PRODSPEC_ID                                  
         AND FO.MAINPD_ID = LH.MAINPD_ID AND FO.OPE_NO = LH.OPE_NO                                                   
         LEFT JOIN APS_TMP_ETL_LOTHISTROY_SPLITDATA SA ON LH.LOT_ID = SA.LOT_ID AND LH.OPE_NO = SA.OPE_NO                                                                                                   
    """.format(uuid=uuid, current_time=current_time)

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_ETL_LOTHISTORY",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_ETL_LOTHISTORY")
    sql = """
          INSERT  /*+ append */  INTO APS_ETL_LOTHISTORY(                                 
                LOT_ID, TOOLG_ID, TOOL_ID, PROD_ID, PLAN_ID, STEP_ID, LOT_TYPE,PTY,SHR_FLAG, 
                LAYER, STAGE, RECIPE, PPID, QTY, RETICLE_ID, TECH_ID, CUSTOMER, ARRIVAL, JOB_PREPARE,
                TRACK_IN, PROCESS_START, PROCESS_END, TRACK_OUT, REWORK_FLAG, BACKUP_FLAG, MODULE,
                PRODG_ID, PRODG_TECH, UPDATE_TIME, PARTKEY, SCANNER_START, SCANNER_END, RECIPE_SETUP,CH_SET                                                                                      
         )                                                                                       
          SELECT H.CJ_ID AS LOT_ID,                                                              
                 MAX(T.TOOLG_ID) AS TOOLG_ID,                                                    
                 MAX(H.MTOOL_ID) AS TOOL_ID,                                                     
                 MAX(H.JOB_SPEC_GROUP_ID) AS PROD_ID,                                            
                 MAX(H.JOB_SPEC_GROUP_ID) AS PLAN_ID,                                            
                 '0' AS STEP_ID,                                                                 
                 'Monitor' AS LOT_TYPE,                                                          
                 CAST('-1' AS INTEGER) AS PTY, CAST('-1' AS INTEGER) AS SHR_FLAG,                                                  
                 '' AS LAYER, '' AS STAGE,                                                       
                 MAX(H.RECIPE) AS RECIPE,                                                        
                 MAX(H.RECIPE) AS PPID,                                                          
                CAST((LENGTH(                                                                         
                         REGEXP_REPLACE( (STRING_AGG(SLOT,',')                                      
                           WITHIN GROUP (ORDER BY SLOT)),'([^,]+)(,\\1)*(,|$)','\\1\\3')        
                ) - LENGTH(REPLACE(                                                              
                         REGEXP_REPLACE( (STRING_AGG(SLOT,',')                                      
                           WITHIN GROUP (ORDER BY SLOT)),'([^,]+)(,\\1)*(,|$)','\\1\\3')         
                ,',',''))+1) AS DECIMAL) AS QTY,                                                             
                 MAX(H.RETICLE) AS RETICLE_ID,                                                   
                 '' AS TECH_ID,                                                                  
                 '' AS CUSTOMER,                                                                 
                 CAST(STRFTIME(MIN(H.PROCESS_ST_TIME), '%Y-%m-%d %H:%M:%S') AS TIMESTAMP) AS ARRIVAL,            
                 CAST(STRFTIME(MIN(H.PROCESS_ST_TIME), '%Y-%m-%d %H:%M:%S') AS TIMESTAMP) AS JOB_PREPARE,        
                  CAST(STRFTIME(MIN(H.PROCESS_ST_TIME), '%Y-%m-%d %H:%M:%S') AS TIMESTAMP) AS TRACK_IN,           
                  CAST(STRFTIME(MIN(H.PROCESS_ST_TIME), '%Y-%m-%d %H:%M:%S') AS TIMESTAMP) AS PROCESS_START,      
                  CAST(STRFTIME(MAX(H.PROCESS_ED_TIME), '%Y-%m-%d %H:%M:%S') AS TIMESTAMP) AS PROCESS_END,        
                  CAST(STRFTIME(MAX(H.PROCESS_ED_TIME), '%Y-%m-%d %H:%M:%S') AS TIMESTAMP) AS TRACK_OUT,          
                 '' AS REWORK_FLAG,                                                              
                 '' AS BACKUP_FLAG,                                                              
                 MAX(T.MODULE) AS MODULE,                                                        
                 '' AS PRODG_ID,                                                                 
                 '' AS PRODG_TECH,                                                               
                 CAST('{current_time}' AS TIMESTAMP) AS UPDATE_TIME,                                          
                 STRFTIME(MIN(H.PROCESS_ST_TIME), '%Y-%m-%d %H:%M:%S') AS PARTKEY,       
                 CAST(NULLIF('','') AS TIMESTAMP) AS SCANNER_START,                                                            
                 CAST(NULLIF('','') AS TIMESTAMP) AS SCANNER_END,                                                              
                 '' AS RECIPE_SETUP,'' AS CH_SET                                                            
          FROM APS_TMP_OCS_MAIN_H_VIEW.APS_TMP_OCS_MAIN_H_VIEW H                                                                 
          INNER JOIN APS_TMP_ETL_LOTHISTROY_TOOLDATA T                                              
          ON T.TOOL_ID = H.MTOOL_ID         
          --modify by xiecheng for version up                                                  
          WHERE H.PROCESS_ED_TIME IS NOT NULL AND H.PROCESS_ST_TIME IS NOT NULL                                               
          AND H.STATUS = 'OpeComplete'                                                           
          AND T.EQP_CATEGORY IN ('Internal Buffer','Process','Wafer Bonding')                    
          GROUP BY H.CJ_ID                                                                                                                                                                         
        """.format(uuid=uuid, current_time=current_time)

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_ETL_LOTHISTORY",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_ETL_LOTHISTORY")


def biz_method_01(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    sql = """
        INSERT INTO APS_TMP_ETL_LOTHISTROY_RECIPE_GROUP(      
          TOOL_ID, PPID, RTD_GROUPNAME                                           
        )                                                        
         SELECT DISTINCT P.TOOL_ID,                              
                P.PPID,                                          
                MAX(P.RTD_GROUPNAME) AS RTD_GROUPNAME            
         FROM APS_SYNC_RTD_RECIPEGROUP.APS_SYNC_RTD_RECIPEGROUP P 
         WHERE P.RTD_GROUPNAME <> '*'                             
         GROUP BY P.TOOL_ID,P.PPID                                                                                                  
        """.format()

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_LOTHISTROY_RECIPE_GROUP",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_LOTHISTROY_RECIPE_GROUP")
    sql = """
        INSERT INTO APS_TMP_ETL_LOTHISTROY_PO_N1(                          
         POS_PDID, MAINPD_ID, OPE_NO                                            
        )                                                                    
         SELECT N.POS_PDID,N.MAINPD_ID,N.OPE_NO                                                                    
         FROM APS_SYNC_PF_PO_N1.APS_SYNC_PF_PO_N1 N                               
        """.format()

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_LOTHISTROY_PO_N1",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_LOTHISTROY_PO_N1")
    sql = """
        INSERT INTO APS_TMP_ETL_LOTHISTROY_EQP_LOAD(                         
         EQP_ID, LCRECIPE_ID, PD_ID, PRODSPEC_ID                                                        
        )                                                                         
         SELECT L.EQP_ID,L.LCRECIPE_ID,                                                            
                L.PD_ID,L.PRODSPEC_ID                                                                      
         FROM APS_SYNC_PD_RECIPE_EQP_MAIN.APS_SYNC_PD_RECIPE_EQP_MAIN L   
         --modify by xiecheng for version up                              
        -- UNION ALL                                                                 
       --  SELECT L.EQP_ID,L.LCRECIPE_ID,                                                            
            --    L.PD_ID,L.PRODSPEC_ID                                                                      
        -- FROM APS_SYNC_PD_RECIPE_EQP_REWORK.APS_SYNC_PD_RECIPE_EQP_REWORK L                                                                                                   
    """.format()

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_LOTHISTROY_EQP_LOAD",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_LOTHISTROY_EQP_LOAD")
    sql = """
        INSERT INTO APS_TMP_ETL_LOTHISTROY_TOOLDATA( 
           TOOLG_ID, TOOL_ID, MODULE, EQP_CATEGORY, EQP_CHAMBER_FLAG                              
        )                                                 
         SELECT MAX(EQP_G) AS TOOLG_ID,                  
                EQP_ID AS TOOL_ID,                       
                MAX(REAL_MODULE) AS MODULE,              
                MAX(EQP_CATEGORY) AS EQP_CATEGORY,
                MAX(EQP_CHAMBER_FLAG) AS EQP_CHAMBER_FLAG      
         FROM APS_SYNC_ETL_TOOL.APS_SYNC_ETL_TOOL    
         WHERE HOST_EQP_FLAG ='Y'                           
         GROUP BY EQP_ID                                                                   
    """.format()

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_LOTHISTROY_TOOLDATA",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_LOTHISTROY_TOOLDATA")

    # 把机台对应所有的CH信息列出来
    sql = """
        INSERT INTO APS_TMP_ETL_LOTHISTROY_EQP_CHAMBER_RULE(                                                       
             EQP_ID, CH_ID                                                                                
             )                                                                                                   
              WITH EQP_CH_ID AS (                                                                                
                   SELECT SUBSTR(T.EQP_ID, 1, position('.' in T.EQP_ID) -1) AS EQP_ID,                               
                   EQP_ID AS CH_ID                                                                               
                   FROM APS_SYNC_ETL_TOOL.APS_SYNC_ETL_TOOL T WHERE T.EQP_CHAMBER_FLAG='Chamber'           
                   AND T.HOST_EQP_FLAG ='N'              
              )                                                                                                  
              SELECT DISTINCT EQP_ID,                                                                            
                     STRING_AGG(CH_ID,';') OVER (PARTITION BY EQP_ID ORDER BY CH_ID) AS EQP_CH_ID    
              FROM EQP_CH_ID                                                                                                                                                              
        """.format()

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_LOTHISTROY_EQP_CHAMBER_RULE",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_LOTHISTROY_EQP_CHAMBER_RULE")

    sql = """
        INSERT INTO APS_TMP_ETL_LOTHISTROY_CHAMBER_RULE(                                                                                      
             LINE, EQP_ID, RECIPE_ID, CH_ID                                                                                                          
           )                                                                                                                                  
            WITH  CHAMBER_RULE_DATA AS (                                                                                                                                                                                         
               SELECT CASE WHEN position('|' in CHAMBER_RULE)=0 AND position('&' in CHAMBER_RULE)=0 THEN CHAMBER_RULE                                     
                      ELSE REPLACE(REPLACE(REPLACE(REPLACE(CHAMBER_RULE,'(',''),')',''),'|',',@'),'&',';@')                                   
                      END AS RULE_NAME,                                                                                                       
                      R.LINE,R.EQP_ID,                                                                                                        
                      R.RECIPE_ID                                                                                                             
               FROM APS_SYNC_CSCMBMRCPRULE.APS_SYNC_CSCMBMRCPRULE R                                                                                                                                           
            ),                                                                                                                                
            ALL_DATA AS (                                                                                                                     
               SELECT                                                                                                                         
                   R.LINE, R.EQP_ID,                                                                                                          
                   R.RECIPE_ID,                                                                                                               
                   R.EQP_ID||'.'|| REPLACE(RULE_NAME,'@',R.EQP_ID||'.') AS CH_ID                                                              
               FROM                                                                                                                           
               CHAMBER_RULE_DATA R                                                                                                            
            )                                                                                                                                 
            SELECT                                                                                                                            
                  R.LINE,R.EQP_ID,                                                                                                            
                  R.RECIPE_ID,                                                                                                                
                  CASE WHEN LENGTH(R.CH_ID) > 512 THEN SUBSTR(R.CH_ID,0,512) ELSE R.CH_ID END AS CH_ID                                        
            FROM                                                                                                                              
            ALL_DATA R                                                                                                                                                                                                                                         
            """.format()

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_LOTHISTROY_CHAMBER_RULE",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_LOTHISTROY_CHAMBER_RULE")

    # 存放由ChamberRule机台信息
    sql = """
        INSERT INTO APS_TMP_ETL_LOTHISTROY_ONLY_EQP_CHAMBER_RULE(                           
            EQP_ID                                                            
        )                                                                           
         SELECT DISTINCT R.EQP_ID                                                                                       
         FROM APS_TMP_ETL_LOTHISTROY_CHAMBER_RULE R                                                                                                                                                                                                                                  
                """.format()

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_LOTHISTROY_ONLY_EQP_CHAMBER_RULE",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_LOTHISTROY_ONLY_EQP_CHAMBER_RULE")

    sql = """
        INSERT INTO APS_TMP_ETL_LOTHISTROY(                           
             LOT_ID,PRODSPEC_ID,MAINPD_ID,PRIORITY,OPE_NO,OPE_SEQ,WAFER_QTY,
             RETICLE_ID,PREV_OP_COMP_TIME,OP_START_DATE_TIME,CLAIM_TIME,PASS_COUNT,
             CTRL_JOB,PROCESS_START_TIME,EQP_ID,TOOLG_ID,REAL_MODULE,CHAMBER_SET                                               
       )                                                                         
        SELECT HS.LOT_ID,                                                                        
             HS.PRODSPEC_ID,                                                                     
             HS.MAINPD_ID,                                                                                                                                                                        
             HS.PRIORITY_CLASS AS PRIORITY,                                                                       
             HS.OPE_NO,                                                                          
             HS.OPE_SEQ,                                                                             
             HS.WAFER_QTY,HS.RETICLE_ID,                                                         
             HS.PREV_OP_COMP_TIME,                                                               
             HS.OP_START_DATE_TIME,                                                              
             HS.CLAIM_TIME,                                                                      
             HS.PASS_COUNT,                                                                      
             HS.CTRL_JOB,                                                                        
             HS.PROCESS_START_TIME,                                                              
             HS.EQP_ID,                                                                          
             TD.TOOLG_ID,TD.MODULE,
             '' AS CHAMBER_SET                                                              
        FROM APS_TMP_MASK_HISTORY_VIEW.APS_TMP_MASK_HISTORY_VIEW HS                                      
        INNER JOIN APS_TMP_ETL_LOTHISTROY_TOOLDATA TD                                               
        ON TD.TOOL_ID = HS.EQP_ID                                                                 
        WHERE 1=1                                                                                 
             AND HS.OPE_CATEGORY ='OperationComplete'                                             
             AND HS.CLAIM_TIME >= DATE_TRUNC('day', CURRENT_DATE) - INTERVAL '40 day'                                                                                                                                                            
     """.format()

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_LOTHISTROY",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_LOTHISTROY")

    sql = """
     INSERT INTO APS_TMP_ETL_LOTHISTROY_FHOPEH(                         
       CTRL_JOB, LOT_ID, TECH_ID, PH_RECIPE_ID, CUSTOMER_ID, LOT_TYPE, CLAIM_TIME, OPE_CATEGORY, EQP_ID, OPE_NO                                                                            
     )                                                                                      
      SELECT F.CTRL_JOB,F.LOT_ID,                                                        
             F.TECH_ID,                                                                  
             F.PH_RECIPE_ID,                                                             
             F.CUSTOMER_ID,                                                              
             F.LOT_TYPE,                                                                 
             F.CLAIM_TIME,                                                               
             F.OPE_CATEGORY,                                                             
             F.EQP_ID,                                                                   
             F.OPE_NO                                                                 
      FROM APS_MID_FHOPEHS_VIEW.APS_MID_FHOPEHS_VIEW F                                                       
      WHERE 1=1                                                                          
      AND F.OPE_CATEGORY IN ('Reserve','ProcessEnd','ScannerEnd','ScannerStart','Split')   
        AND F.CLAIM_TIME >= DATE_TRUNC('day', CURRENT_DATE) - INTERVAL '50 day'                           
    """.format()

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_LOTHISTROY_FHOPEH",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_LOTHISTROY_FHOPEH")

    sql = """
         INSERT INTO APS_TMP_ETL_LOTHISTROY_RECIPE1(                                          
               LCRECIPE_ID, OPE_NO, PRODSPEC_ID, MAINPD_ID                                                                              
         )                                                                                               
         SELECT MAX(BB.LCRECIPE_ID) AS LCRECIPE_ID,                                                                      
                AA.OPE_NO,BB.PRODSPEC_ID,AA.MAINPD_ID                                                                            
         FROM APS_TMP_ETL_LOTHISTROY_PO_N1 AA, APS_TMP_ETL_LOTHISTROY_EQP_LOAD BB,                                 
         APS_TMP_ETL_LOTHISTROY LL                                                               
         WHERE 1=1                                                                                                   
         AND AA.POS_PDID = BB.PD_ID                                                                    
         AND LL.PRODSPEC_ID = BB.PRODSPEC_ID                                                           
         AND LL.OPE_NO = AA.OPE_NO                                                                     
         AND LL.MAINPD_ID = AA.MAINPD_ID                                                               
         GROUP BY AA.OPE_NO,BB.PRODSPEC_ID ,AA.MAINPD_ID                                                                                                                                                
        """.format()

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_LOTHISTROY_RECIPE1",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_LOTHISTROY_RECIPE1")

    sql = """
        INSERT INTO APS_TMP_ETL_LOTHISTROY_FLOW(                                                    
          PROD_ID, PLAN_ID, LAYER, STAGE, STEP_ID                                                                                
         )                                                                                                
          SELECT PROD_ID,PLAN_ID,                                                                                          
                 LAYER,STAGE,STEP_ID                                                                                               
          FROM APS_ETL_FLOW.APS_ETL_FLOW                                                                                                                                        
    """.format()

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_LOTHISTROY_FLOW",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_LOTHISTROY_FLOW")

    sql = """
        INSERT INTO APS_TMP_ETL_LOTHISTROY_PROCESSDATA(                                                     
               CTRL_JOB, LOT_ID, TECH_ID, PH_RECIPE_ID, CUSTOMER_ID, LOT_TYPE,
               RTD_GROUPNAME, RESERVE_TIME, PROCESS_END, SCANNER_END, SCANNER_START                                                                                                   
       )                                                                                                                 
        SELECT CTRL_JOB,LOT_ID,MAX(TECH_ID) AS TECH_ID,                                                                                                                   
                 MAX(PH_RECIPE_ID) AS PH_RECIPE_ID,                                                                      
                 MAX(CUSTOMER_ID) AS CUSTOMER_ID,                                                                        
                 MAX(LOT_TYPE) AS LOT_TYPE,                                                                              
                 MAX(RTD_GROUPNAME) AS RTD_GROUPNAME,                                                                    
                 MAX(RESERVE_TIME) AS RESERVE_TIME,                                                                      
                 MAX(PROCESS_END) AS PROCESS_END,                                                                        
                 MAX(SCANNER_END) AS SCANNER_END,                                                                        
                 MAX(SCANNER_START) AS SCANNER_START                                                                     
        FROM (                                                                                                           
          SELECT CTRL_JOB,LOT_ID,PH_RECIPE_ID,TECH_ID,CUSTOMER_ID,LOT_TYPE,ETR.RTD_GROUPNAME,                       
             CASE WHEN OPE_CATEGORY='Reserve' THEN CLAIM_TIME ELSE NULL END AS RESERVE_TIME,                        
             CASE WHEN OPE_CATEGORY='ProcessEnd' THEN CLAIM_TIME ELSE NULL END AS PROCESS_END,                      
             CASE WHEN OPE_CATEGORY='ScannerEnd' THEN CLAIM_TIME ELSE NULL END AS SCANNER_END,                      
             CASE WHEN OPE_CATEGORY='ScannerStart' THEN CLAIM_TIME ELSE NULL END AS SCANNER_START                   
          FROM APS_TMP_ETL_LOTHISTROY_FHOPEH LH                                                                          
          LEFT JOIN APS_TMP_ETL_LOTHISTROY_RECIPE_GROUP ETR ON ETR.TOOL_ID = LH.EQP_ID AND ETR.PPID = LH.PH_RECIPE_ID    
          WHERE OPE_CATEGORY IN ('Reserve','ProcessEnd','ScannerEnd','ScannerStart')                                                                          
        ) T                                                                                                              
        GROUP BY T.CTRL_JOB,T.LOT_ID                                                                                                                       
       """.format()

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_LOTHISTROY_PROCESSDATA",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_LOTHISTROY_PROCESSDATA")

    sql = """
         INSERT INTO APS_TMP_ETL_LOTHISTROY_SPLITDATA(                                                        
               OPE_NO, LOT_ID, SPLIT_TIME                                                                                                     
        )                                                                                                                  
         SELECT OPE_NO,LOT_ID,                                                                                               
                 MAX(SPLIT_TIME) AS SPLIT_TIME                                                                   
         FROM (                                                                                                 
              SELECT OPE_NO,LOT_ID,                                                                              
                     CLAIM_TIME AS SPLIT_TIME                                                                             
                     FROM APS_TMP_ETL_LOTHISTROY_FHOPEH                                                             
              WHERE OPE_CATEGORY IN ('Split')                                                                                                                             
         ) T                                                                                                    
         GROUP BY T.OPE_NO,T.LOT_ID                                               
          """.format()

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_LOTHISTROY_SPLITDATA",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_LOTHISTROY_SPLITDATA")
    sql = """      
        INSERT INTO APS_TMP_ETL_LOTHS_PRODG
             ( PRODG_ID,PRODG_TECH,PRODSPEC_ID)
               SELECT MAX(PRODG1) AS PRODG_ID, MAX(GROUP_TECH) AS PRODG_TECH,PRODSPEC_ID                                                                             
               FROM APS_SYNC_PRODUCT.APS_SYNC_PRODUCT                                                                                                              
               GROUP BY PRODSPEC_ID                                                                                              
          """.format()
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_LOTHS_PRODG",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_LOTHS_PRODG")

    sql = """      
           INSERT INTO APS_TMP_ETL_LOTHS_V1(
              LOT_ID,EQP_G,PRODSPEC_ID,MAINPD_ID,STEP_ID,PRIORITY,OPE_NO,WAFER_QTY,RETICLE_ID,                                       
              PREV_OP_COMP_TIME,OP_START_DATE_TIME,CLAIM_TIME,PASS_COUNT,REAL_MODULE,CTRL_JOB,PROCESS_START_TIME,EQP_ID,CHAMBER_SET)                                                 
             SELECT HS.LOT_ID,MAX(HS.TOOLG_ID) AS EQP_G,HS.PRODSPEC_ID,                                                                                                  
                  HS.MAINPD_ID,                                                                                                                                          
                  FL.STEP_ID AS STEP_ID,                                                                                                                                 
                  MAX(HS.PRIORITY) AS PRIORITY, HS.OPE_NO,                                                                                                               
                  MAX(HS.WAFER_QTY) AS WAFER_QTY,MAX(HS.RETICLE_ID) AS RETICLE_ID,                                                                                       
                  MAX(HS.PREV_OP_COMP_TIME) AS PREV_OP_COMP_TIME,HS.OP_START_DATE_TIME,                                                                                  
                  MAX(HS.CLAIM_TIME) AS CLAIM_TIME,MAX(HS.PASS_COUNT) AS PASS_COUNT,                                                                                     
                  MAX(HS.REAL_MODULE) AS REAL_MODULE, MAX(HS.CTRL_JOB) AS CTRL_JOB,                                                                                      
                  MAX(HS.PROCESS_START_TIME) AS PROCESS_START_TIME,HS.EQP_ID,
                  MAX(HS.CHAMBER_SET) AS CHAMBER_SET                                                                                             
                  FROM APS_TMP_ETL_LOTHISTROY HS                                                                                                                 
                  INNER JOIN APS_TMP_ETL_LOTHISTROY_FLOW FL                                                                                                                  
                  ON FL.PROD_ID = HS.PRODSPEC_ID AND FL.PLAN_ID = HS.MAINPD_ID                                                                                          
                  AND FL.LAYER = SUBSTRING(HS.OPE_NO, 1, POSITION('.' IN HS.OPE_NO) -1 )                                                                                      
                  AND FL.STAGE = SUBSTRING(HS.OPE_NO, POSITION('.' IN HS.OPE_NO) +1 )                                                                                         
                  GROUP BY HS.LOT_ID,HS.PRODSPEC_ID, HS.MAINPD_ID,                                                                                                      
                  HS.OPE_NO,HS.EQP_ID, HS.OP_START_DATE_TIME,FL.STEP_ID                                                                                                 
                  UNION ALL                                                                                                                                             
                  SELECT HS.LOT_ID,MAX(HS.TOOLG_ID) AS EQP_G,HS.PRODSPEC_ID,                                                                                             
                  HS.MAINPD_ID,                                                                                                                                          
                  '.9999.9999' AS STEP_ID,                                                                                                                               
                  MAX(HS.PRIORITY) AS PRIORITY, HS.OPE_NO,                                                                                                               
                  MAX(HS.WAFER_QTY) AS WAFER_QTY,MAX(HS.RETICLE_ID) AS RETICLE_ID,                                                                                       
                  MAX(HS.PREV_OP_COMP_TIME) AS PREV_OP_COMP_TIME,HS.OP_START_DATE_TIME,                                                                                  
                  MAX(HS.CLAIM_TIME) AS CLAIM_TIME,MAX(HS.PASS_COUNT) AS PASS_COUNT,                                                                                     
                  MAX(HS.REAL_MODULE) AS REAL_MODULE, MAX(HS.CTRL_JOB) AS CTRL_JOB,                                                                                      
                  MAX(HS.PROCESS_START_TIME) AS PROCESS_START_TIME,HS.EQP_ID,
                  MAX(HS.CHAMBER_SET) AS CHAMBER_SET                                                                                           
                  FROM APS_TMP_ETL_LOTHISTROY HS                                                                                                                 
                  WHERE POSITION('DYB' IN HS.MAINPD_ID) =1                                                                                                                                                                                                                                             
                  GROUP BY HS.LOT_ID,HS.PRODSPEC_ID, HS.MAINPD_ID,                                                                                                      
                  HS.OPE_NO,HS.EQP_ID, HS.OP_START_DATE_TIME                                                                                                 
           """.format()

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_LOTHS_V1",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_LOTHS_V1")


def execute():
    ###############################################################
    ### 以下参数必须定义
    ### ETL_Proc_Name    : ETL 名称
    ### current_time     ：请直接拷贝
    ### current_time_short ：请直接拷贝
    ### uuid             ：请直接拷贝
    ### target_table     : 该ETL输出表名
    ### used_table_list  : 该ETL使用到的，参考到的表名(中间表不算)
    ### target_table_sql ： 该ETL输出表定义SQL
    ###############################################################
    ETL_Proc_Name = "APS_ETL_BR.APS_ETL_LOTHISTORY_60M"
    current_time = my_date.date_time_second_str()
    current_time_short = my_date.date_time_second_short_str()
    uuid = my_oracle.UUID()

    target_table = "APS_ETL_LOTHISTORY"
    used_table_list = ['APS_SYNC_PRODUCT',
                       'APS_SYNC_RTD_RECIPEGROUP',
                       'APS_SYNC_PF_PO_N1',
                       'APS_SYNC_PD_RECIPE_EQP_MAIN',
                       'APS_SYNC_ETL_TOOL',
                       'APS_ETL_FLOW',
                       'APS_TMP_OCS_MAIN_H_VIEW',
                       'APS_SYNC_SHR_PRI',
                       'APS_TMP_MASK_HISTORY_VIEW',
                       'APS_MID_FHOPEHS_VIEW',
                       'APS_SYNC_CSCMBMRCPRULE'
                       ]
    target_table_sql = """
        create table {}APS_ETL_LOTHISTORY
        (
            lot_id        VARCHAR(60) not null,
            toolg_id      VARCHAR(60) not null,
            tool_id       VARCHAR(60) not null,
            prod_id       VARCHAR(60) not null,
            plan_id       VARCHAR(60) not null,
            step_id       VARCHAR(60),
            lot_type      VARCHAR(30),
            pty           INTEGER not null,
            shr_flag      INTEGER not null,
            layer         VARCHAR(60),
            stage         VARCHAR(60),
            recipe        VARCHAR(60),
            ppid          VARCHAR(60),
            qty           DECIMAL not null,
            reticle_id    VARCHAR(60),
            tech_id       VARCHAR(60),
            customer      VARCHAR(60),
            arrival       TIMESTAMP not null,
            job_prepare   TIMESTAMP,
            track_in      TIMESTAMP not null,
            process_start TIMESTAMP not null,
            process_end   TIMESTAMP not null,
            track_out     TIMESTAMP not null,
            rework_flag   VARCHAR(1),
            backup_flag   VARCHAR(2),
            update_time   TIMESTAMP not null,
            module        VARCHAR(60),
            prodg_id      VARCHAR(60),
            prodg_tech    VARCHAR(60),
            partkey       VARCHAR(60) not null,
            scanner_start TIMESTAMP,
            scanner_end   TIMESTAMP,
            recipe_setup  VARCHAR(64),
            ch_set        VARCHAR(512),
            PRIMARY KEY (LOT_ID, TOOL_ID, PROD_ID, PLAN_ID, TRACK_IN, PARTKEY)
        )
    """.format("")  # 注意:这里一定要这么写 [create table 表名] => [create table {}表名]
    target_db_file = my_duck.get_target_file_name(target_table, current_time_short)

    oracle_conn = None
    try:
        oracle_conn = my_oracle.oracle_get_connection()
        # 开始日志
        my_oracle.StartCleanUpAndLog(oracle_conn, ETL_Proc_Name, current_time)
        # 创建DuckDB
        duck_db_memory = my_duck.create_duckdb_in_momory(target_table_sql)
        if config.g_thread_and_memory_limit:  # 是否手动管理内存和进程
            duck_db_memory.sql('SET threads TO 2')
            # 加上TMP目录:LQN:2023/08/21
            duck_db_memory.execute("SET temp_directory='{}'".format(os.path.join(config.g_mem_etl_output_path, 'duck_temp', uuid)))
        # 创建Temp表
        create_temp_table(duck_db_memory)
        # Attach用到的表
        my_duck.attach_used_table(oracle_conn, duck_db_memory, used_table_list)
        ################################################################################################################
        ## 以下为业务逻辑
        ################################################################################################################

        biz_method_01(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name)

        row_count = my_duck.get_row_count_in_duckdb(duck_db=duck_db_memory, tableName="APS_TMP_ETL_LOTHS_V1")
        if row_count == 0:
            my_oracle.EndCleanUpAndLog(oracle_conn, ETL_Proc_Name, current_time,
                                       "APS_TMP_ETL_LOTHS_V1没有数据，请及时确认一下！！")
            return

        biz_method_02(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name)

        ################################################################################################################
        ## 以上为业务逻辑
        ################################################################################################################
        if config.g_copy_to_pg:
            select_sql_in_duck = """select  lot_id, toolg_id, tool_id, prod_id, plan_id,step_id, prodg_id,prodg_tech,lot_type, pty,shr_flag,layer, stage,recipe,ppid,
                                            qty,reticle_id,tech_id, customer,arrival,job_prepare,track_in,process_start, process_end,track_out, rework_flag,
                                            backup_flag,update_time, scanner_start,scanner_end, recipe_setup from APS_ETL_LOTHISTORY
                                        """
            postgres_table_define = """etl_lothistory(lot_id, toolg_id, tool_id, prod_id, plan_id,step_id, prodg_id,prodg_tech,lot_type, pty,shr_flag,layer, stage,recipe,ppid,
                                                      qty,reticle_id,tech_id, customer,arrival,job_prepare,track_in,process_start, process_end,track_out, rework_flag,
                                                      backup_flag,update_time, scanner_start,scanner_end, recipe_setup )
                                     """
            my_postgres.copy_duckdb_to_postgres(uuid=uuid,
                                                duckdb=duck_db_memory,
                                                table_name_in_duckdb=target_table,
                                                table_name_in_pg="etl_lothistory",  # 要小写
                                                select_sql_in_duck=select_sql_in_duck,
                                                postgres_table_define=postgres_table_define)
        # 导出到目标文件中
        target_db_file = my_duck.export_result_duck_file_and_close_duck_db_memory(duck_db_memory,
                                                                                  target_table,
                                                                                  target_table_sql.format("file_db."),
                                                                                  current_time_short)
        # 写版本号
        my_oracle.HandlingVerControl(oracle_conn, uuid, target_table, target_db_file)
        # 写完成日志
        my_oracle.EndCleanUpAndLog(oracle_conn, ETL_Proc_Name, current_time)
    except Exception as e:
        # 写警告日志
        my_oracle.SaveAlarmLogData(oracle_conn, ETL_Proc_Name, e, target_db_file,
                                   cons_error_code.APS_ETL_LOTHISTORY_CODE_XX_ETL)
        logging.exception("{ETL_Proc_Name} 處理出錯 : {e}".format(ETL_Proc_Name=ETL_Proc_Name, e=e))
        raise e
    finally:
        oracle_conn.commit()
        oracle_conn.close()
        if config.g_thread_and_memory_limit:  # 是否手动管理内存和进程
            # 删除TMP目录:LQN:2023/08/21
            if os.path.exists(os.path.join(config.g_mem_etl_output_path, 'duck_temp', uuid)):
                os.remove(os.path.join(config.g_mem_etl_output_path, 'duck_temp', uuid))
        gc.collect()  # 内存释放


if __name__ == '__main__':
    # 单JOB测试用
    print("start")
    execute()
