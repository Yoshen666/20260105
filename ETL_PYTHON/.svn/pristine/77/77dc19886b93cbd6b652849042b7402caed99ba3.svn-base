import gc
import logging
import os

from xinxiang import config
from xinxiang.util import my_duck, my_oracle, my_date, cons_error_code, cons, my_postgres, my_runner


def create_temp_table(duck_db):
    pass


def biz_method_01(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    sql = """
   INSERT /*+ append */
   INTO APS_ETL_SIZE_CONTROL
     (PARENTID,
      RULE_NAME,
      TOOLG_ID,
      TOOL_ID,
      PRODG_TECH,
      PRODG_ID,
      PROD_ID,
      LAYER,
      STAGE,
      LOT_TYPE,
      FOUP_CON,
      MIN_BATCH_SIZE,
      MAX_BATCH_SIZE,
      MIN_FOUP_SIZE,
      MAX_FOUP_SIZE,
      HARD_FLAG,
      UPDATE_TIME,
      PARTCODE)
     WITH TOOL_DATA AS
      (SELECT T.MODULE, T.EQP_ID, T.EQP_G
         FROM APS_SYNC_ETL_TOOL.APS_SYNC_ETL_TOOL T
        WHERE T.HOST_EQP_FLAG = 'Y')
     SELECT '{uuid}'  AS PARENTID,
            S.RULE_NAME,
            T.EQP_G AS TOOLG_ID,    
            T.EQP_ID AS TOOL_ID,
            S.PRODG_TECH,
            S.PRODG_ID,
            S.PROD_ID,
            CASE
              WHEN S.OPE_NO IS NULL OR S.OPE_NO = '' THEN
               ''
              ELSE
               -- SUBSTRING(S.OPE_NO, 1, POSITION('.' IN S.OPE_NO) - 1)
               rtrim(S.OPE_NO, '.' ||split_part(S.OPE_NO, '.', -1))
            END AS LAYER,
            CASE
              WHEN S.OPE_NO IS NULL OR S.OPE_NO = '' THEN
               ''
              ELSE
               -- SUBSTRING(S.OPE_NO, POSITION('.' IN S.OPE_NO) + 1)
               split_part(S.OPE_NO, '.', -1)
            END AS STAGE,
            S.LOT_TYPE,
            S.FOUP_CNT_EXACT AS FOUP_CON,
            S.BATCH_QTY_MIN AS MIN_BATCH_SIZE,
            S.BATCH_QTY_MAX AS MAX_BATCH_SIZE,
            S.FOUP_CNT_MIN AS MIN_FOUP_SIZE,
            S.FOUP_CNT_MAX AS MAX_FOUP_SIZE,
            S.HARD_FLAG,
             '{current_time}' AS UPDATE_TIME,
            '' AS PARTCODE
       FROM APS_SYNC_UMT_RUN_RULE_BATCH_SIZE.APS_SYNC_UMT_RUN_RULE_BATCH_SIZE S,
            TOOL_DATA T
      WHERE T.MODULE = S.MODULE_ID     
       -- DECODE(S.TOOLG_ID,'%',T.EQP_G,S.TOOLG_ID) = T.EQP_G     
       AND  ((S.TOOLG_ID <> '%'
             AND
             S.TOOLG_ID = T.EQP_G
            ) OR S.TOOLG_ID = '%')          
        AND T.EQP_ID LIKE S.TOOL_ID                                                                                                                                                          
    """.format(uuid=uuid, current_time=current_time)

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_ETL_SIZE_CONTROL",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_ETL_SIZE_CONTROL")

    sql = """
     INSERT  /*+ append */  INTO APS_ETL_SIZE_CONTROL(               
         PARENTID, RULE_NAME, TOOLG_ID, TOOL_ID, PROD_ID, LAYER,
         STAGE, MIN_FOUP_SIZE, MAX_FOUP_SIZE,HARD_FLAG, UPDATE_TIME, PARTCODE                                                    
         )                                                                     
   WITH TOOL_DATA AS (                                                                                                                                                                          
        SELECT EQP_ID,                                                                                             
               EQP_G                                                                                               
        FROM APS_SYNC_ETL_TOOL.APS_SYNC_ETL_TOOL                                                                                          
        WHERE HOST_EQP_FLAG='Y'                                                                                    
        AND MODULE='WET'                                                                                                                         
   )                                                                                                               
   SELECT DISTINCT '{uuid}' AS PARENTID,                                                                                   
         'WET Batch Size Setting' AS RULE_NAME,                                                                    
         D.EQP_G AS TOOLG_ID,                                                                                      
         REPLACE(T.EQP_ID,'*','%') AS TOOL_ID,                                                                                      
         REPLACE(T.PRODSPEC_ID,'*','%') AS PROD_ID,                                                                
         CASE WHEN T.OPE_NO = '*' THEN '%'                                                                         
              WHEN T.OPE_NO LIKE '%.%' THEN REPLACE(SUBSTRING(T.OPE_NO, 1, POSITION('.' IN T.OPE_NO)-1),'*','%')         
              ELSE '%'                                                                                             
         END AS LAYER,                                                                                             
         CASE WHEN T.OPE_NO = '*' THEN '%'                                                                         
              WHEN T.OPE_NO LIKE '%.%' THEN REPLACE(SUBSTR(T.OPE_NO, POSITION('.' IN T.OPE_NO)+1),'*','%')            
              ELSE REPLACE(T.OPE_NO,'*','%')                                                                       
         END AS STAGE,                                                                                             
         T.BATCH_SIZE AS MIN_FOUP_SIZE,                                                                            
         T.BATCH_SIZE AS MAX_FOUP_SIZE,                                                                            
         '1' AS HARD_FLAG,                                                                                         
         '{current_time}' AS UPDATE_TIME,                                                            
         '' AS PARTCODE                                                 
   FROM APS_SYNC_RTD_WET_BATCH_SIZE_SETTING.APS_SYNC_RTD_WET_BATCH_SIZE_SETTING T                                                                             
   INNER JOIN TOOL_DATA D                                                                                          
   ON 
   --D.EQP_ID LIKE ( CASE WHEN T.EQP_ID = '*' THEN D.EQP_ID                                                                                            
     --                ELSE REPLACE(T.EQP_ID,'*','%') END)                      
            ((T.EQP_ID <> '%'
             AND
             D.EQP_ID LIKE REPLACE(T.EQP_ID,'*','%')
            ) OR T.EQP_ID = '%')                               
   WHERE T.REQUIRE_FLAG = 'Y'                                                                                                                                                                                                                                                                        
    """.format(uuid=uuid, current_time=current_time)

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_ETL_SIZE_CONTROL",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_ETL_SIZE_CONTROL")

    sql = """
       INSERT  /*+ append */  INTO APS_ETL_SIZE_CONTROL(               
       PARENTID, RULE_NAME, TOOLG_ID, TOOL_ID, PRODG_TECH, PRODG_ID,PROD_ID, LAYER,
                    STAGE, MAX_BATCH_SIZE, OTHER_MIN_BATCH_SIZE,
                    HARD_FLAG, UPDATE_TIME, PARTCODE                                               
      )                                                                     
       SELECT '{uuid}' AS PARENTID,                           
             'Other Min Batch Size Control' AS RULE_NAME,                  
             S.EQP_G AS TOOLG_ID,                                          
             S.EQP_ID AS TOOL_ID,                                          
             REPLACE(S.TECH,'*','%') AS PRODG_TECH,                        
             REPLACE(S.PRODG1,'*','%') AS PRODG_ID,                        
             REPLACE(S.PRODUCT_ID,'*','%') AS PROD_ID,                     
             SUBSTRING(S.OPE_NO, 1, POSITION('.' IN S.OPE_NO)-1) AS LAYER,       
             SUBSTRING(S.OPE_NO, POSITION('.' IN S.OPE_NO)+1) AS STAGE,          
             S.MAX_CTRL AS MAX_BATCH_SIZE,                                 
             S.OTHER_MIN_CTRL AS OTHER_MIN_BATCH_SIZE,                     
             '1' AS HARD_FLAG,                                             
             '{current_time}' AS UPDATE_TIME,                        
             '' AS PARTCODE             
       FROM APS_SYNC_UMT_BOAT_CONSTAINT_SETTING.APS_SYNC_UMT_BOAT_CONSTAINT_SETTING S                                                                                                                                                                                                                                                                                                                                          
        """.format(uuid=uuid, current_time=current_time)
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_ETL_SIZE_CONTROL",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_ETL_SIZE_CONTROL")

    sql = """
        INSERT  /*+ append */  INTO APS_ETL_SIZE_CONTROL(                                                  
        PARENTID, RULE_NAME, TOOLG_ID, TOOL_ID, FOUP_CON, MIN_BATCH_SIZE, HARD_FLAG, UPDATE_TIME, PARTCODE                                                                                       
        )                                                                                                       
          WITH FOUP_DATA AS (                                                                                  
               SELECT DISTINCT FOUP_NUM,TOOL_ID                                                                
               FROM APS_ETL_TOOL.APS_ETL_TOOL                                                                               
               WHERE MODULE='WET'                                                                                                                                  
          )                                                                                                    
          SELECT '{uuid}' AS PARENTID,                                                            
                'rtd_mfg_hwld_spec' AS RULE_NAME,                                                              
                S.EQP_G AS TOOLG_ID,                                                                           
                S.EQP_ID AS TOOL_ID,                                                                           
                T.DZ AS FOUP_CON,                                                                              
                (CAST(S.QTY_SPEC AS INTEGER)*CAST(T.DZ AS INTEGER) +1) AS MIN_BATCH_SIZE,                                                        
               '1' AS HARD_FLAG,                                                                               
               '{current_time}'  AS UPDATE_TIME,                                                         
               '' AS PARTCODE                                              
          FROM APS_SYNC_RTD_MFG_HWLD_SPEC.APS_SYNC_RTD_MFG_HWLD_SPEC S                                                                           
          INNER JOIN FOUP_DATA D                                                                               
          ON D.TOOL_ID = S.EQP_ID                                                                              
          --LEFT JOIN (SELECT LEVEL DZ FROM DUAL CONNECT BY LEVEL <= 25) T ON T.DZ >= 1 AND T.DZ <= D.FOUP_NUM
          LEFT JOIN (WITH RECURSIVE cte(DZ) as ( select 1 as dz union all select dz + 1 from cte where dz < 25) select dz from cte ) T  
          ON T.DZ >= 1 AND T.DZ <= D.FOUP_NUM   
          WHERE S.MODULE ='WET'                                                                                
          AND S.FLAG ='Y'                                                                                                                                                                                                                                                                                                                                                                                                                                                               
        """.format(uuid=uuid, current_time=current_time)
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_ETL_SIZE_CONTROL",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_ETL_SIZE_CONTROL")


def execute():
    ###############################################################
    ### 以下参数必须定义
    ### ETL_Proc_Name    : ETL 名称
    ### current_time     ：请直接拷贝
    ### current_time_short ：请直接拷贝
    ### uuid             ：请直接拷贝
    ### target_table     : 该ETL输出表名
    ### used_table_list  : 该ETL使用到的，参考到的表名(中间表不算)
    ### target_table_sql ： 该ETL输出表定义SQL
    ###############################################################
    ETL_Proc_Name = "APS_ETL_BR.APS_ETL_SIZE_CONTROL_60M"
    current_time = my_date.date_time_second_str()
    current_time_short = my_date.date_time_second_short_str()
    uuid = my_oracle.UUID()

    target_table = "APS_ETL_SIZE_CONTROL"
    used_table_list = ['APS_SYNC_UMT_RUN_RULE_BATCH_SIZE',
                       'APS_SYNC_ETL_TOOL',
                       'APS_SYNC_RTD_WET_BATCH_SIZE_SETTING',
                       'APS_SYNC_UMT_BOAT_CONSTAINT_SETTING',
                       'APS_SYNC_RTD_MFG_HWLD_SPEC',
                       'APS_ETL_TOOL']
    target_table_sql = """
    create table {}APS_ETL_SIZE_CONTROL
    (
        parentid             VARCHAR(64) not null,
        rule_name            VARCHAR(64) not null,
        toolg_id             VARCHAR(64) not null,
        tool_id              VARCHAR(64) not null,
        prodg_tech           VARCHAR(64),
        prodg_id             VARCHAR(64),
        prod_id              VARCHAR(64),
        layer                VARCHAR(64),
        stage                VARCHAR(64),
        lot_type             VARCHAR(64),
        foup_con             VARCHAR(64),
        min_batch_size       VARCHAR(64),
        max_batch_size       VARCHAR(64),
        min_foup_size        VARCHAR(64),
        max_foup_size        VARCHAR(64),
        hard_flag            VARCHAR(64),
        update_time          VARCHAR(64) not null,
        partcode             VARCHAR(64) not null,
        other_min_batch_size VARCHAR(64)
    )
    """.format("")  # 注意:这里一定要这么写 [create table 表名] => [create table {}表名]
    target_db_file = my_duck.get_target_file_name(target_table, current_time_short)

    # -------------------------- 内存模式改成文件模式
    _temp_db_path = os.path.join(config.g_mem_speed_etl_output_path, target_table, "inprocess")
    if not os.path.exists(_temp_db_path):
        os.makedirs(_temp_db_path)

    temp_db_file = os.path.join(_temp_db_path, target_table + "_" + current_time_short + "_temp.db")
    # 处理中文件
    in_process_db_file = os.path.join(_temp_db_path, target_table + "_" + current_time_short + ".db")
    # 结果文件
    target_db_file = os.path.join(config.g_mem_etl_output_path, target_table,
                                  target_table + "_" + current_time_short + ".db")
    # --------------------------

    oracle_conn = None
    try:
        oracle_conn = my_oracle.oracle_get_connection()
        # 开始日志
        my_oracle.StartCleanUpAndLog(oracle_conn, ETL_Proc_Name, current_time)
        # -------------------------- 内存模式改成文件模式
        # 创建DuckDB
        duck_db_memory = my_duck.create_duckdb_in_file(_temp_db_path, in_process_db_file, target_table_sql)
        duck_db_memory.sql('SET threads TO 4')

        if not os.path.exists(os.path.join(config.g_mem_speed_etl_output_path, 'duck_temp', uuid)):
            os.makedirs(os.path.join(config.g_mem_speed_etl_output_path, 'duck_temp', uuid))
        duck_db_memory.execute(
            "SET temp_directory='{}'".format(os.path.join(config.g_mem_speed_etl_output_path, 'duck_temp', uuid)))

        if not config.g_debug_mode:
            create_temp_table(duck_db_memory)
        else:
            duck_db_temp = my_duck.create_duckdb_for_temp_table(_temp_db_path, temp_db_file)
            # 创建Temp表
            create_temp_table(duck_db_temp)
            duck_db_temp.commit()
            duck_db_temp.close()
            my_duck.attach_temp_db_write_able(duck_db_memory, "TEMPDB", temp_db_file)
        # --------------------------
        # Attach用到的表
        my_duck.attach_used_table(oracle_conn, duck_db_memory, used_table_list)
        ################################################################################################################
        ## 以下为业务逻辑
        ################################################################################################################

        biz_method_01(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name)

        ################################################################################################################
        ## 写入log
        ################################################################################################################
        # 写版本号
        my_oracle.Monitor_HandlingVerControl(oracle_conn, uuid, target_table, target_db_file, current_time_short)

        ################################################################################################################
        ## 以上为业务逻辑
        ################################################################################################################
        if config.g_copy_to_pg and my_runner.judge_main_server(oracle_conn):
            select_sql_in_duck = """select  parentid,
                                            CASE WHEN rule_name='' THEN NULL ELSE rule_name END AS rule_name,
                                            CASE WHEN toolg_id='' THEN NULL ELSE toolg_id END AS toolg_id,
                                            CASE WHEN tool_id='' THEN NULL ELSE tool_id END AS tool_id,
                                            CASE WHEN prodg_tech='' THEN NULL ELSE prodg_tech END AS prodg_tech,
                                            CASE WHEN prodg_id='' THEN NULL ELSE prodg_id END AS prodg_id,
                                            CASE WHEN prod_id='' THEN NULL ELSE prod_id END AS prod_id,
                                            CASE WHEN layer='' THEN NULL ELSE layer END AS layer,
                                            CASE WHEN stage='' THEN NULL ELSE stage END AS stage,
                                            CASE WHEN lot_type='' THEN NULL ELSE lot_type END AS lot_type,
                                            CASE WHEN foup_con='' THEN NULL ELSE foup_con END AS foup_con,
                                            CASE WHEN min_batch_size='' THEN NULL ELSE min_batch_size END AS min_batch_size,
                                            CASE WHEN max_batch_size='' THEN NULL ELSE max_batch_size END AS max_batch_size,
                                            CASE WHEN min_foup_size='' THEN NULL ELSE min_foup_size END AS min_foup_size,
                                            CASE WHEN max_foup_size='' THEN NULL ELSE max_foup_size END AS max_foup_size,
                                            CASE WHEN hard_flag='' THEN NULL ELSE hard_flag END AS hard_flag,
                                            update_time,
                                            CASE WHEN other_min_batch_size='' THEN NULL ELSE other_min_batch_size END AS other_min_batch_size 
                                            from APS_ETL_SIZE_CONTROL
                                        """
            postgres_table_define = """etl_size_control(parentid,rule_name,toolg_id,tool_id,prodg_tech,prodg_id,prod_id,layer,stage,lot_type,foup_con,
                                                        min_batch_size,max_batch_size,min_foup_size,max_foup_size,hard_flag,update_time,other_min_batch_size )
                                           """
            my_postgres.copy_duckdb_to_postgres(uuid=uuid,
                                                duckdb=duck_db_memory,
                                                table_name_in_duckdb=target_table,
                                                table_name_in_pg="etl_size_control",  # 要小写
                                                select_sql_in_duck=select_sql_in_duck,
                                                postgres_table_define=postgres_table_define,
                                                oracle_conn=oracle_conn,
                                                ETL_Proc_Name=ETL_Proc_Name)
        # 导出到目标文件中
        target_db_file = my_duck.export_result_duck_file_and_close_duck_db_memory2(duck_db_memory,
                                                                                   in_process_db_file=in_process_db_file,
                                                                                   target_table=target_table,
                                                                                   current_time=current_time_short)
        # 写版本号
        my_oracle.HandlingVerControl(oracle_conn, uuid, target_table, target_db_file, current_time_short)
        # 加入PG执行结束的时间更新
        my_oracle.Update_PG_HandlingVerControl(oracle_conn, uuid, target_table, target_db_file, current_time_short)
        # 写完成日志
        my_oracle.EndCleanUpAndLog(oracle_conn, ETL_Proc_Name, current_time)
    except Exception as e:
        # 写警告日志
        my_oracle.SaveAlarmLogData(oracle_conn, ETL_Proc_Name, e, target_db_file,
                                   cons_error_code.APS_ETL_SIZE_CONTROL_CODE_XX_ETL)
        logging.exception("{ETL_Proc_Name} 處理出錯 : {e}".format(ETL_Proc_Name=ETL_Proc_Name, e=e))
        # 导出到目标文件中
        my_duck.export_result_duck_file_and_close_duck_db_memory2(duck_db_memory,
                                                                  in_process_db_file=in_process_db_file,
                                                                  target_table=target_table,
                                                                  current_time=current_time_short)
        raise e
    finally:
        oracle_conn.commit()
        oracle_conn.close()
        # 删除TMP目录:LQN:2023/08/21
        if os.path.exists(os.path.join(config.g_mem_etl_output_path, 'duck_temp', uuid)):
            os.remove(os.path.join(config.g_mem_etl_output_path, 'duck_temp', uuid))
        if os.path.exists(temp_db_file) and not config.g_debug_mode:
            os.remove(temp_db_file)
        gc.collect()  # 内存释放


if __name__ == '__main__':
    # 单JOB测试用
    print("start")
    execute()