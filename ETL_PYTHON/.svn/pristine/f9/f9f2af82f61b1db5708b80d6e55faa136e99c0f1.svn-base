import gc
import logging
import os

from xinxiang import config
from xinxiang.util import my_duck, my_oracle, my_date, cons_error_code, cons, my_postgres


def create_temp_table(duck_db):
    '''
    这里在内存中创建使用到的临时表
    '''
    sql = """
    create table APS_TMP_ETL_PIRUN
    (
        toolg_id        VARCHAR(60),
        tool_id         VARCHAR(60),
        ch_id           VARCHAR(60),
        prod_id         VARCHAR(60),
        plan_id         VARCHAR(60),
        step_id         VARCHAR(60),
        recipe          VARCHAR(60),
        ppid            VARCHAR(60),
        layer           VARCHAR(60),
        stage           VARCHAR(60),
        tech            VARCHAR(60),
        customer        VARCHAR(60),
        lot_id          VARCHAR(60),
        reticle_id      VARCHAR(60),
        pre_tool_id     VARCHAR(60),
        rule_name       VARCHAR(60),
        remaining_count VARCHAR(60),
        remaining_time  VARCHAR(60),
        recover_time    VARCHAR(60),
        valid_recipe    VARCHAR(60),
        valid_time      VARCHAR(60),
        hold_time       VARCHAR(60),
        valid_lot       VARCHAR(60),
        split_qty       VARCHAR(60)
    )
    """
    duck_db.sql(sql)
    sql = """
    create table APS_TMP_ETL_PIRUN1
    (
        toolg_id        VARCHAR(60),
        tool_id         VARCHAR(60),
        ch_id           VARCHAR(60),
        prod_id         VARCHAR(60),
        plan_id         VARCHAR(60),
        step_id         VARCHAR(60),
        recipe          VARCHAR(60),
        ppid            VARCHAR(60),
        layer           VARCHAR(60),
        stage           VARCHAR(60),
        tech            VARCHAR(60),
        customer        VARCHAR(60),
        lot_id          VARCHAR(60),
        reticle_id      VARCHAR(60),
        pre_tool_id     VARCHAR(60),
        rule_name       VARCHAR(60),
        remaining_count VARCHAR(60),
        remaining_time  VARCHAR(60),
        recover_time    VARCHAR(60),
        valid_recipe    VARCHAR(60),
        valid_time      VARCHAR(60),
        hold_time       VARCHAR(60),
        valid_lot       VARCHAR(60),
        split_qty       VARCHAR(60)
    )
    """
    duck_db.sql(sql)
    sql = """
    create table APS_TMP_ETL_PIRUN2
    (
        toolg_id        VARCHAR(60),
        tool_id         VARCHAR(60),
        ch_id           VARCHAR(60),
        prod_id         VARCHAR(60),
        plan_id         VARCHAR(60),
        step_id         VARCHAR(60),
        recipe          VARCHAR(60),
        ppid            VARCHAR(60),
        layer           VARCHAR(60),
        stage           VARCHAR(60),
        tech            VARCHAR(60),
        customer        VARCHAR(60),
        lot_id          VARCHAR(60),
        reticle_id      VARCHAR(60),
        pre_tool_id     VARCHAR(60),
        rule_name       VARCHAR(60),
        remaining_count VARCHAR(60),
        remaining_time  VARCHAR(60),
        recover_time    VARCHAR(60),
        valid_recipe    VARCHAR(60),
        valid_time      VARCHAR(60),
        hold_time       VARCHAR(60),
        valid_lot       VARCHAR(60),
        split_qty       VARCHAR(60)
    )
    """
    duck_db.sql(sql)

    sql = """
    create table APS_TMP_ETL_PIRUN3
    (
        toolg_id        VARCHAR(60),
        tool_id         VARCHAR(60),
        ch_id           VARCHAR(60),
        prod_id         VARCHAR(60),
        plan_id         VARCHAR(60),
        step_id         VARCHAR(60),
        recipe          VARCHAR(60),
        ppid            VARCHAR(60),
        layer           VARCHAR(60),
        stage           VARCHAR(60),
        tech            VARCHAR(60),
        customer        VARCHAR(60),
        lot_id          VARCHAR(60),
        reticle_id      VARCHAR(60),
        pre_tool_id     VARCHAR(60),
        rule_name       VARCHAR(60),
        remaining_count VARCHAR(60),
        remaining_time  VARCHAR(60),
        recover_time    VARCHAR(60),
        valid_recipe    VARCHAR(60),
        valid_time      VARCHAR(60),
        hold_time       VARCHAR(60),
        valid_lot       VARCHAR(60),
        split_qty       VARCHAR(60)
    )
    """
    duck_db.sql(sql)

    sql = """
     create table APS_TMP_ETL_PIRUN4
     (
        toolg_id        VARCHAR(60),
        tool_id         VARCHAR(60),
        ch_id           VARCHAR(60),
        prod_id         VARCHAR(60),
        plan_id         VARCHAR(60),
        step_id         VARCHAR(60),
        recipe          VARCHAR(60),
        ppid            VARCHAR(60),
        layer           VARCHAR(60),
        stage           VARCHAR(60),
        tech            VARCHAR(60),
        customer        VARCHAR(60),
        lot_id          VARCHAR(60),
        reticle_id      VARCHAR(60),
        pre_tool_id     VARCHAR(60),
        rule_name       VARCHAR(60),
        remaining_count VARCHAR(60),
        remaining_time  VARCHAR(60),
        recover_time    VARCHAR(60),
        valid_recipe    VARCHAR(60),
        valid_time      VARCHAR(60),
        hold_time       VARCHAR(60),
        valid_lot       VARCHAR(60),
        split_qty       VARCHAR(60)
     )
     """
    duck_db.sql(sql)

    sql = """
     create table APS_TMP_ETL_PIRUN5
     (
        toolg_id        VARCHAR(60),
        tool_id         VARCHAR(60),
        ch_id           VARCHAR(60),
        prod_id         VARCHAR(60),
        plan_id         VARCHAR(60),
        step_id         VARCHAR(60),
        recipe          VARCHAR(60),
        ppid            VARCHAR(60),
        layer           VARCHAR(60),
        stage           VARCHAR(60),
        tech            VARCHAR(60),
        customer        VARCHAR(60),
        lot_id          VARCHAR(60),
        reticle_id      VARCHAR(60),
        pre_tool_id     VARCHAR(60),
        rule_name       VARCHAR(60),
        remaining_count VARCHAR(60),
        remaining_time  VARCHAR(60),
        recover_time    VARCHAR(60),
        valid_recipe    VARCHAR(60),
        valid_time      VARCHAR(60),
        hold_time       VARCHAR(60),
        valid_lot       VARCHAR(60),
        split_qty       VARCHAR(60)
     )
     """
    duck_db.sql(sql)

    sql = """
     create table APS_TMP_ETL_PIRUN7
     (
        toolg_id        VARCHAR(60),
        tool_id         VARCHAR(60),
        ch_id           VARCHAR(60),
        prod_id         VARCHAR(60),
        plan_id         VARCHAR(60),
        step_id         VARCHAR(60),
        recipe          VARCHAR(60),
        ppid            VARCHAR(60),
        layer           VARCHAR(60),
        stage           VARCHAR(60),
        tech            VARCHAR(60),
        customer        VARCHAR(60),
        lot_id          VARCHAR(60),
        reticle_id      VARCHAR(60),
        pre_tool_id     VARCHAR(60),
        rule_name       VARCHAR(60),
        remaining_count VARCHAR(60),
        remaining_time  VARCHAR(60),
        recover_time    VARCHAR(60),
        valid_recipe    VARCHAR(60),
        valid_time      VARCHAR(60),
        hold_time       VARCHAR(60),
        valid_lot       VARCHAR(60),
        split_qty       VARCHAR(60)
     )
     """
    duck_db.sql(sql)

    sql = """
     create table APS_TMP_ETL_PIRUN_CSFRINHIBIT
     (
        productid    VARCHAR(60),
        routeid      VARCHAR(60),
        openo        VARCHAR(60),
        equipmentid  VARCHAR(60),
        pass_flg_prc VARCHAR(60),
        pass_flg_mfg VARCHAR(60),
        prc_upt_user VARCHAR(60),
        update_time  VARCHAR(60)
     )
     """
    duck_db.sql(sql)

    sql = """
     create table APS_TMP_ETL_PIRUN_PB1
     (
        pr_unit_id   VARCHAR(60),
        prodspec_id  VARCHAR(60),
        pr_op_no     VARCHAR(60),
        mask         VARCHAR(60),
        pb_flag      VARCHAR(60),
        remain_day   VARCHAR(60),
        max_efec_day VARCHAR(60),
        split_count  VARCHAR(60)
     )
     """
    duck_db.sql(sql)

    sql = """
     create table APS_TMP_ETL_PIRUN_PA1
     (
        pr_unit_id    VARCHAR(60),
        prodspec_id   VARCHAR(60),
        pr_op_no      VARCHAR(60),
        mask_nm       VARCHAR(60),
        op_no_1       VARCHAR(60),
        unit_id_1     VARCHAR(60),
        op_no_2       VARCHAR(60),
        unit_id_2     VARCHAR(60),
        pa_flag       VARCHAR(60),
        remain_day    VARCHAR(60),
        max_efct_time VARCHAR(60),
        split_count   VARCHAR(60)
     )
     """
    duck_db.sql(sql)

    sql = """
     create table APS_TMP_ETL_PIRUN_TEST_RUN_RECIPE
     (
        m_recipe   VARCHAR(64),
        toolid     VARCHAR(64),
        expiretime VARCHAR(64),
        jobgroupid VARCHAR(64),
        jobspecid  VARCHAR(64),
        lifetime   VARCHAR(64),
        subname    VARCHAR(64),
        eqp_g      VARCHAR(64),
        state      VARCHAR(64)
     )
     """
    duck_db.sql(sql)

    sql = """
     create table APS_TMP_ETL_PIRUN_TEST_RUN_T21
     (
        toolg_id VARCHAR(64),
        tool_id  VARCHAR(64),
        ppid     VARCHAR(64),
        pt       VARCHAR(64)
     )
     """
    duck_db.sql(sql)

    sql = """
     create table APS_TMP_ETL_PIRUN_TEST_RUN_T22
     (
        toolg_id VARCHAR(64),
        ppid     VARCHAR(64),
        pt       VARCHAR(64)
     )
     """
    duck_db.sql(sql)

    sql = """
     create table APS_TMP_ETL_PIRUN_TEST_RUN_T221
     (
        toolg_id VARCHAR(64),
        tool_id  VARCHAR(64),
        ch_cnt   VARCHAR(64),
        pt       VARCHAR(64)
     )
     """
    duck_db.sql(sql)

    sql = """
     create table APS_TMP_ETL_PIRUN_RTDRUN_PSTART
     (
        eqp_id       VARCHAR(64),
        ope_no       VARCHAR(64),
        prodspec_id  VARCHAR(64),
        claim_time   VARCHAR(64),
        ope_category VARCHAR(64),
        lot_id       VARCHAR(64),
        ctrl_job     VARCHAR(64)
     )
     """
    duck_db.sql(sql)

    sql = """
    create table APS_TMP_ETL_PIRUN_RTDRUN_COUNT
    (
        eqp_id    VARCHAR(64),
        layer     VARCHAR(64),
        pd_id     VARCHAR(64),
        lot_count VARCHAR(64)
    )
    """
    duck_db.sql(sql)
    sql = """
        create table APS_TMP_ETL_PIRUN_RTDRUN_LOTCOUNT
        (
            eqp_id VARCHAR(64),
            layer  VARCHAR(64),
            pd_id  VARCHAR(64),
            rn     VARCHAR(64)
        )
        """
    duck_db.sql(sql)
    sql = """
        create table APS_TMP_ETL_PIRUN_RTDRUN_PS
        (
            eqp_id       VARCHAR(64),
            ope_no       VARCHAR(64),
            prodspec_id  VARCHAR(64),
            claim_time   VARCHAR(64),
            ope_category VARCHAR(64),
            lot_id       VARCHAR(64),
            ctrl_job     VARCHAR(64)
        )
        """
    duck_db.sql(sql)
    sql = """
        create table APS_TMP_ETL_PIRUN_RTDRUN_PE
        (
            eqp_id       VARCHAR(64),
            ope_no       VARCHAR(64),
            prodspec_id  VARCHAR(64),
            claim_time   VARCHAR(64),
            ope_category VARCHAR(64),
            lot_id       VARCHAR(64),
            ctrl_job     VARCHAR(64)
        )
        """
    duck_db.sql(sql)
    sql = """
        create table APS_TMP_ETL_PIRUN_TOOL
        (
            tool_id       VARCHAR(64),
            toolg_id      VARCHAR(64),
            module        VARCHAR(64),
            host_eqp_flag VARCHAR(64)
        )
        """
    duck_db.sql(sql)
    sql = """
        create table APS_TMP_ETL_PIRUN_FOUR_CSB
            (
                productid    VARCHAR(64),
                routeid      VARCHAR(64),
                openo        VARCHAR(64),
                equipmentid  VARCHAR(64),
                pass_flg_prc VARCHAR(64),
                chipbody     VARCHAR(64)
            )
            """
    duck_db.sql(sql)
    sql = """
        create table APS_TMP_ETL_PIRUN_INFO
            (
                apc_type  VARCHAR(64),
                prod_id   VARCHAR(64),
                lot_id    VARCHAR(64),
                c_op_no   VARCHAR(64),
                c_unit_id VARCHAR(64),
                op_no_1   VARCHAR(64),
                unit_id_1 VARCHAR(64),
                op_no_2   VARCHAR(64),
                unit_id_2 VARCHAR(64),
                mask_nm   VARCHAR(64)
            )
            """
    duck_db.sql(sql)
    sql = """
        create table APS_TMP_ETL_PIRUN_HIST
            (
                apc_type   VARCHAR(64),
                lot_id     VARCHAR(64),
                c_op_no    VARCHAR(64),
                c_unit_id  VARCHAR(64),
                op_no_1    VARCHAR(64),
                unit_id_1  VARCHAR(64),
                op_no_2    VARCHAR(64),
                unit_id_2  VARCHAR(64),
                mask_nm    VARCHAR(64),
                start_date VARCHAR(64),
                del_date   VARCHAR(64)
            )
                """
    duck_db.sql(sql)
    sql = """
        create table APS_TMP_ETL_PIRUN_RECOVER_TIME
            (
                apc_type     VARCHAR(64),
                prodspec_id  VARCHAR(64),
                c_op_no      VARCHAR(64),
                c_unit_id    VARCHAR(64),
                lot_id       VARCHAR(64),
                op_no_1      VARCHAR(64),
                unit_id_1    VARCHAR(64),
                op_no_2      VARCHAR(64),
                unit_id_2    VARCHAR(64),
                mask_nm      VARCHAR(64),
                start_date   VARCHAR(64),
                recover_time VARCHAR(64)
            )
                """
    duck_db.sql(sql)
    sql = """
        create table APS_TMP_ETL_PIRUN_RECOVER_TIME_8
            (
                recover_time VARCHAR(64),
                pa_type      VARCHAR(32),
                pb_type      VARCHAR(32)
            )
                """
    duck_db.sql(sql)
    sql = """
        create table APS_TMP_ETL_PIRUN_CSFRIHBT_3CASE_REWINFO
            (
                productid   VARCHAR(64),
                routeid     VARCHAR(64),
                openo       VARCHAR(64),
                equipmentid VARCHAR(64)
            )
                """
    duck_db.sql(sql)
    sql = """
        create table APS_TMP_ETL_PIRUN_CSFRIHBT_3CASE_NOTREWINFO
            (
                productid   VARCHAR(64),
                openo       VARCHAR(64),
                equipmentid VARCHAR(64)
            )
            """
    duck_db.sql(sql)
    sql = """
        create table APS_TMP_ETL_PIRUN_CSFRIHBT_4CASE_CSFINFO
            (
                productid    VARCHAR(64),
                routeid      VARCHAR(64),
                openo        VARCHAR(64),
                equipmentid  VARCHAR(64),
                pass_flg_prc VARCHAR(64),
                update_time  VARCHAR(64),
                chipbody     VARCHAR(64)
            )
                """
    duck_db.sql(sql)
    sql = """
        create table APS_TMP_ETL_PIRUN_CSFRIHBT_4CASE_RESULT
            (
                productid    VARCHAR(64),
                routeid      VARCHAR(64),
                openo        VARCHAR(64),
                equipmentid  VARCHAR(64),
                pass_flg_prc VARCHAR(64)
            )
                """
    duck_db.sql(sql)
    sql = """
        create table APS_TMP_ETL_PIRUN_CSFRIHBT_5CASE_SOURCE
            (
                productid    VARCHAR(64),
                routeid      VARCHAR(64),
                openo        VARCHAR(64),
                equipmentid  VARCHAR(64),
                pass_flg_prc VARCHAR(64),
                sgs_first_op VARCHAR(64),
                rn           VARCHAR(64)
            )
                """
    duck_db.sql(sql)
    sql = """
        create table APS_TMP_ETL_PIRUN_CSFRIHBT_5CASE_RESULT
            (
                productid   VARCHAR(64),
                routeid     VARCHAR(64),
                openo       VARCHAR(64),
                equipmentid VARCHAR(64)
            )
                """
    duck_db.sql(sql)
    sql = """
        create table APS_TMP_ETL_PIRUN_APS_WIP
            (
                plan_id  VARCHAR(64),
                prod_id  VARCHAR(64),
                ope_no   VARCHAR(64),
                chipbody VARCHAR(64)
            )
                """
    duck_db.sql(sql)
    sql = """
        create table APS_TMP_ETL_PIRUN_PATH_SETTING
            (
                use_flag_type VARCHAR(64),
                rs_hold_time  VARCHAR(64),
                tool_id       VARCHAR(64),
                toolg_id      VARCHAR(64)
            )
                    """
    duck_db.sql(sql)

    sql = """
        create table APS_TMP_ETL_PIRUN_PURGE_DATA
            (
                toolg_id     VARCHAR(64),
                equipment_id VARCHAR(64),
                val          decimal,
                report_time  VARCHAR(64),
                rtn          decimal,
                last_val     decimal
            )
                    """
    duck_db.sql(sql)

    sql = """
        create table APS_TMP_ETL_PIRUN_PURGE_MAX_BATCH
            (
                equipment_id VARCHAR(64),
                batch_spec   decimal,
                rtn2         decimal
            )
                    """
    duck_db.sql(sql)

    sql = """
         create table APS_TMP_ETL_PIRUN_PURGE_EQP_BATCH
             (
                equipment_id VARCHAR(64),
                val          decimal,
                rtn          decimal
             )
                     """
    duck_db.sql(sql)

    sql = """
       create table APS_TMP_ETL_PIRUN_PURGE_DEF_BATCH
           (
                eqp_g        VARCHAR(64),
                eqp_id       VARCHAR(64),
                unit_dc_item VARCHAR(64),
                unit_spec    decimal
           )
                       """
    duck_db.sql(sql)

    sql = """
         create table APS_TMP_ETL_PIRUN_PURGE_LAST
             (
                start_time VARCHAR(64),
                eqp_id     VARCHAR(64),
                rtn        DECIMAL
             )
                         """
    duck_db.sql(sql)


def getetApsEtlWipSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    sql = """
        INSERT INTO APS_TMP_ETL_PIRUN_APS_WIP(                                          
            PLAN_ID, PROD_ID, OPE_NO, CHIPBODY                                                       
            )                                                                         
            SELECT DISTINCT SUBSTRING(W.TARGET_PLAN_ID, 1, POSITION('.' IN W.TARGET_PLAN_ID)-1) AS PLAN_ID,                                    
                W.TARGET_PROD_ID AS PROD_ID,                                             
                W.TARGET_OPE_NO AS OPE_NO,                                              
                SUBSTRING(W.TARGET_PROD_ID, 1, POSITION('.' IN W.TARGET_PROD_ID)-1) AS CHIPBODY 
            FROM APS_ETL_WIP.APS_ETL_WIP W                                                                                                                                                   
        """.format()

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_PIRUN_APS_WIP",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_PIRUN_APS_WIP")


def GetCsfrinhibitSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    sql = """
         INSERT  /*+ append */  INTO APS_TMP_ETL_PIRUN_CSFRINHIBIT(      
            PRODUCTID, ROUTEID, OPENO, EQUIPMENTID, PASS_FLG_PRC, PASS_FLG_MFG, PRC_UPT_USER, UPDATE_TIME                                                 
         )                                                                     
          SELECT DISTINCT V.PRODUCTID,V.ROUTEID,                                
                 V.OPENO,V.EQUIPMENTID,                                         
                 V.PASS_FLG_PRC,V.PASS_FLG_MFG,                                 
                 V.PRC_UPT_USER, '{current_time}' as UPDATE_TIME                                   
          FROM CSFRINHIBIT.CSFRINHIBIT V,APS_TMP_ETL_PIRUN_APS_WIP W               
          WHERE                        
           W.PROD_ID = V.PRODUCTID                                          
          AND W.PLAN_ID = V.ROUTEID                                            
          AND W.OPE_NO = V.OPENO                                               
          AND (POSITION('F' IN V.EQUIPMENTID) = 1 OR POSITION('W' IN V.EQUIPMENTID) = 1 OR POSITION('P' IN V.EQUIPMENTID) = 1)                        
        """.format(current_time=current_time)

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_PIRUN_CSFRINHIBIT",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_PIRUN_CSFRINHIBIT")


def GetApcPb1DataSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    sql = """
         INSERT  /*+ append */  INTO APS_TMP_ETL_PIRUN_PB1(          
        PR_UNIT_ID, PRODSPEC_ID, PR_OP_NO, MASK, PB_FLAG, REMAIN_DAY, MAX_EFEC_DAY, SPLIT_COUNT                                                         
        )                                                                      
         SELECT PB.PR_UNIT_ID,PB.PRODSPEC_ID,                                  
               PB.PR_OP_NO,PB.MASK,PB.PB_FLAG,                                 
               PB.REMAIN_DAY,PB.MAX_EFEC_DAY,SC.SPLIT_COUNT                    
         FROM APS_SYNC_SCHE_APC_PB.APS_SYNC_SCHE_APC_PB PB                   
         LEFT JOIN APS_SYNC_APC_SPLIT_WAFER.APS_SYNC_APC_SPLIT_WAFER SC          
         ON SC.JOB_NO = PB.JOB_NO  
         --modify by xiecheng for version up  
         --FOURTH_PARM_VAL_FLAG ='Y'代表可用 
         WHERE PB.FOURTH_PARM_VAL_FLAG ='Y'
               and PB.PRODSPEC_ID IN (                                          
               SELECT DISTINCT W.PRODSPEC_ID                                   
               FROM APS_SYNC_WIP.APS_SYNC_WIP W  )                                                                                                                               
    """.format()

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_PIRUN_PB1",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_PIRUN_PB1")


def GetApcPa1DataSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    sql = """
        INSERT  /*+ append */  INTO APS_TMP_ETL_PIRUN_PA1(          
             PR_UNIT_ID, PRODSPEC_ID, PR_OP_NO, MASK_NM, OP_NO_1, UNIT_ID_1, OP_NO_2, UNIT_ID_2,
             PA_FLAG, REMAIN_DAY, MAX_EFCT_TIME, SPLIT_COUNT                                                         
             )                                                                      
              SELECT PA.PR_UNIT_ID,PA.PRODSPEC_ID,                                  
                    PA.PR_OP_NO,PA.MASK_NM,PA.OP_NO_1,                              
                    PA.UNIT_ID_1,PA.OP_NO_2,                                        
                    PA.UNIT_ID_2,PA.PA_FLAG,                                        
                    PA.REMAIN_DAY,PA.MAX_EFCT_TIME,SC.SPLIT_COUNT                   
              FROM APS_SYNC_SCHE_APC_PA.APS_SYNC_SCHE_APC_PA PA                  
              LEFT JOIN APS_SYNC_APC_SPLIT_WAFER.APS_SYNC_APC_SPLIT_WAFER SC            
              ON SC.JOB_NO = PA.JOB_NO     
                --modify by xiecheng for version up  
         --FOURTH_PARM_VAL_FLAG ='Y'代表可用     
              WHERE PA.FOURTH_PARM_VAL_FLAG ='Y'  
                   and PA.PRODSPEC_ID IN (                                           
                   SELECT DISTINCT W.PRODSPEC_ID                                    
                   FROM APS_SYNC_WIP.APS_SYNC_WIP W )                                                                                               
    """.format()

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_PIRUN_PA1",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_PIRUN_PA1")


def GetEtlToolDataSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    sql = """
        INSERT  /*+ append */  INTO APS_TMP_ETL_PIRUN_TOOL(         
                TOOL_ID, TOOLG_ID, MODULE, HOST_EQP_FLAG                                                         
           )                                                                     
            SELECT EQP_ID AS TOOL_ID,MAX(EQP_G) AS TOOLG_ID,                      
                   MAX(MODULE) AS MODULE, MAX(HOST_EQP_FLAG) AS HOST_EQP_FLAG 
            FROM APS_SYNC_ETL_TOOL.APS_SYNC_ETL_TOOL                                            
            GROUP BY EQP_ID                                                                                                                                                                                        
     """.format()

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_PIRUN_TOOL",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_PIRUN_TOOL")


def getPirunRunInfo(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    sql = """
        INSERT INTO APS_TMP_ETL_PIRUN_INFO(                                                   
            APC_TYPE,PROD_ID,LOT_ID,C_OP_NO,C_UNIT_ID,OP_NO_1,UNIT_ID_1,OP_NO_2,UNIT_ID_2,MASK_NM                                                                            
       )                                                                                        
        SELECT T.APC_TYPE,                                                                      
              MAX(B.PRODSPEC_ID) AS PROD_ID,                                                    
              REPLACE(T.LOT_KEY_NO,'.','') AS LOT_ID,                                           
              T.C_OP_NO,T.C_UNIT_ID,                                                            
              COALESCE(T.OP_NO_1,'*') AS OP_NO_1,COALESCE(T.UNIT_ID_1,'*') AS UNIT_ID_1,                  
              COALESCE(T.OP_NO_2,'*') AS OP_NO_2,COALESCE(T.UNIT_ID_2,'*') AS UNIT_ID_2,                  
              COALESCE(T.MASK_NM,'*') AS MASK_NM                                                     
        FROM APS_SYNC_RSPILOT_RUNING.APS_SYNC_RSPILOT_RUNING T                                  
        INNER JOIN APS_SYNC_WIP.APS_SYNC_WIP B                                   
        ON REPLACE(T.LOT_KEY_NO,'.','') = B.LOT_ID         
        WHERE T.APC_TYPE IN ('PA','PB')                    
        GROUP BY T.APC_TYPE,                                                                    
              T.LOT_KEY_NO,                                                                     
              T.C_OP_NO,T.C_UNIT_ID,                                                            
              T.OP_NO_1,T.UNIT_ID_1,                                                            
              T.OP_NO_2,T.UNIT_ID_2,                                                            
              T.MASK_NM                                                                             
    """.format()

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_PIRUN_INFO",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_PIRUN_INFO")


def getPirunHistData(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    sql = """
    INSERT INTO APS_TMP_ETL_PIRUN_HIST(                                                    
        APC_TYPE,LOT_ID,C_OP_NO,C_UNIT_ID,OP_NO_1,UNIT_ID_1, OP_NO_2, UNIT_ID_2, MASK_NM, START_DATE, DEL_DATE                                                                           
        )                                                                                         
         SELECT T.APC_TYPE,                                                                       
                REPLACE(T.LOT_KEY_NO,'.','') AS LOT_ID,                                           
                T.C_OP_NO,T.C_UNIT_ID,                                                            
                T.OP_NO_1,T.UNIT_ID_1,                                                            
                T.OP_NO_2,T.UNIT_ID_2,                                                            
                T.MASK_NM,                                                                        
                T.START_DATE,T.DEL_DATE                                                           
         FROM APS_MID_RSPILOT_RUN_HS.APS_MID_RSPILOT_RUN_HS T                                  
         WHERE T.START_DATE >= DATE_TRUNC('day', CURRENT_DATE) - INTERVAL '30 day'                                                          
         AND T.STATUS='COMP'                                                                                                                                                                                              
        """.format()

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_PIRUN_HIST",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_PIRUN_HIST")


def getRecoverTimeByLotHisData(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    sql = """
        INSERT INTO APS_TMP_ETL_PIRUN_RECOVER_TIME(                                                   
              APC_TYPE,PRODSPEC_ID,C_OP_NO,C_UNIT_ID,LOT_ID,OP_NO_1,
              UNIT_ID_1,OP_NO_2,UNIT_ID_2,MASK_NM,START_DATE,RECOVER_TIME
              )                                                                                        
               SELECT A.APC_TYPE,MAX(B.PRODSPEC_ID) AS PRODSPEC_ID,                                                   
                      MAX(A.C_OP_NO) AS C_OP_NO,                                                                      
                      MAX(A.C_UNIT_ID) AS C_UNIT_ID,                                                                  
                      A.LOT_ID,                                                                                       
                      COALESCE(MAX(A.OP_NO_1),'*') AS OP_NO_1,                                                             
                      COALESCE(MAX(A.UNIT_ID_1),'*') AS UNIT_ID_1,                                                         
                      COALESCE(MAX(A.OP_NO_2),'*') AS OP_NO_2,                                                             
                      COALESCE(MAX(A.UNIT_ID_2),'*') AS UNIT_ID_2,                                                         
                      COALESCE(MAX(A.MASK_NM), '*') AS MASK_NM,                                                            
                      A.START_DATE,                                                                                   
                      -- ROUND(CEIL((MAX(B.CLAIM_TIME) - MIN(B.CLAIM_TIME))*24*60*60)/3600,2) AS RECOVER_TIME 
                      ROUND((extract(epoch from(MAX(B.CLAIM_TIME) - MIN(B.CLAIM_TIME)))) / 3600.0, 2) AS RECOVER_TIME            
               FROM APS_TMP_ETL_PIRUN_HIST A                                                                         
               LEFT JOIN APS_TMP_LOTHISTORY.APS_TMP_LOTHISTORY B                                                
               ON A.LOT_ID = B.LOT_ID                                                                                 
               AND B.CLAIM_TIME >= A.START_DATE                                                                       
               AND B.CLAIM_TIME <= A.DEL_DATE  
               --modify by xiecheng for version up
               AND B.CLAIM_TIME >= DATE_TRUNC('day', CURRENT_DATE) - INTERVAL '30 day'                                                                        
               GROUP BY A.APC_TYPE,A.LOT_ID, A.START_DATE                                                                                   
    """.format()

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_PIRUN_RECOVER_TIME",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_PIRUN_RECOVER_TIME")


def getRecoverTimeByMedianData(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    sql = """
        INSERT INTO APS_TMP_ETL_PIRUN_RECOVER_TIME_8(                                                    
             RECOVER_TIME,PA_TYPE,PB_TYPE)                                                                                         
              WITH RECOVER_ALL_DATE AS (                                                                                                                          
                  SELECT 'APC_PA' AS PA_TYPE,                                                                                                                
                         '' AS PB_TYPE,                                                                                                                      
                         Z.RECOVER_TIME                                                                                                                      
                  FROM  APS_TMP_ETL_PIRUN_RECOVER_TIME Z,  APS_TMP_ETL_PIRUN_PA1  PA                                                                          
                  WHERE Z.APC_TYPE='PA'                                                                                                                      
                        AND Z.PRODSPEC_ID = PA.PRODSPEC_ID AND Z.C_OP_NO = PA.PR_OP_NO                                                                       
                        AND Z.C_UNIT_ID = PA.PR_UNIT_ID                                                                                                      
                       -- AND (DECODE(Z.MASK_NM, '*', '1', Z.MASK_NM) = DECODE(Z.MASK_NM, '*', '1', PA.MASK_NM)                                                
                       -- OR DECODE(PA.MASK_NM, '*', '1', Z.MASK_NM) = DECODE(PA.MASK_NM, '*', '1', PA.MASK_NM)) 
    
                           and ( ((Z.MASK_NM <> '*' AND Z.MASK_NM = PA.MASK_NM) OR (Z.MASK_NM = '*' and 1=1)) OR 
                          ((PA.MASK_NM <> '*' AND Z.MASK_NM =  PA.MASK_NM) OR (PA.MASK_NM  = '*' and 1=1)) )                
                                                                                             
                        --AND (DECODE(Z.OP_NO_1, '*', '1', Z.OP_NO_1) = DECODE(Z.OP_NO_1, '*', '1', PA.OP_NO_1)                                                
                        --OR DECODE(PA.OP_NO_1, '*', '1', PA.OP_NO_1) = DECODE(PA.OP_NO_1, '*', '1', Z.OP_NO_1)) 
                                              
                          and ( ((Z.OP_NO_1 <> '*' AND Z.OP_NO_1 = PA.OP_NO_1) OR (Z.OP_NO_1 = '*' and 1=1)) OR 
                          ((PA.OP_NO_1 <> '*' AND PA.OP_NO_1 =  Z.OP_NO_1) OR (PA.OP_NO_1  = '*' and 1=1)) )      
                                                                                             
                       -- AND (DECODE(Z.UNIT_ID_1, '*', '1', Z.UNIT_ID_1) = DECODE(Z.UNIT_ID_1, '*', '1', PA.UNIT_ID_1)                                        
                       -- OR DECODE(PA.UNIT_ID_1, '*', '1', PA.UNIT_ID_1) = DECODE(PA.UNIT_ID_1, '*', '1', Z.UNIT_ID_1)) 
                        
                        and ( ((Z.UNIT_ID_1 <> '*' AND Z.UNIT_ID_1 = PA.UNIT_ID_1) OR (Z.UNIT_ID_1 = '*' and 1=1)) OR 
                          ((PA.UNIT_ID_1 <> '*' AND PA.UNIT_ID_1 =  Z.UNIT_ID_1) OR (PA.UNIT_ID_1  = '*' and 1=1)) )  
                                                          
                       -- AND (DECODE(Z.OP_NO_2, '*', '1', Z.OP_NO_2) = DECODE(Z.OP_NO_2, '*', '1', PA.OP_NO_2)                                                
                        --OR DECODE(PA.OP_NO_2, '*', '1', PA.OP_NO_2) = DECODE(PA.OP_NO_2, '*', '1', Z.OP_NO_2))
                        
                         and ( ((Z.OP_NO_2 <> '*' AND Z.OP_NO_2 = PA.OP_NO_2) OR (Z.OP_NO_2 = '*' and 1=1)) OR 
                          ((PA.OP_NO_2 <> '*' AND PA.OP_NO_2 =  Z.OP_NO_2) OR (PA.OP_NO_2  = '*' and 1=1)) )  
                                                                                  
                       -- AND (DECODE(Z.UNIT_ID_2, '*', '1', Z.UNIT_ID_2) = DECODE(Z.UNIT_ID_2, '*', '1', PA.MASK_NM)                                          
                       -- OR DECODE(PA.UNIT_ID_2, '*', '1', PA.UNIT_ID_2) = DECODE(PA.UNIT_ID_2, '*', '1', Z.UNIT_ID_2))  
                          and ( ((Z.UNIT_ID_2 <> '*' AND Z.UNIT_ID_2 = PA.MASK_NM) OR (Z.UNIT_ID_2 = '*' and 1=1)) OR 
                          ((PA.UNIT_ID_2 <> '*' AND PA.UNIT_ID_2 =  Z.UNIT_ID_2) OR (PA.UNIT_ID_2  = '*' and 1=1)) )
                                                           
                  UNION ALL                                                                                                                                  
                  SELECT '' AS PA_TYPE,                                                                                                                      
                         'APC_PB' AS PB_TYPE,                                                                                                                
                         Z.RECOVER_TIME                                                                                                                      
                  FROM  APS_TMP_ETL_PIRUN_RECOVER_TIME Z, APS_TMP_ETL_PIRUN_PB1 PB                                                                          
                  WHERE Z.APC_TYPE='PB'                                                                                                                      
                        AND Z.PRODSPEC_ID = PB.PRODSPEC_ID                                                                                                   
                        AND Z.C_OP_NO = PB.PR_OP_NO                                                                                                          
                        --AND (DECODE(PB.MASK, '*', '1', PB.MASK) = DECODE(PB.MASK, '*', '1', Z.MASK_NM)                                                       
                       -- OR DECODE(Z.MASK_NM, '*', '1', Z.MASK_NM) = DECODE(Z.MASK_NM, '*', '1', PB.MASK))  
                        and ( ((PB.MASK <> '*' AND PB.MASK = Z.MASK_NM) OR (PB.MASK = '*' and 1=1)) OR 
                          ((Z.MASK_NM <> '*' AND Z.MASK_NM = PB.MASK) OR (Z.MASK_NM = '*' and 1=1)) )                                                               
                        AND Z.C_UNIT_ID = PB.PR_UNIT_ID                                                                                                      
              )                                                                                                                                              
              SELECT 
                     --PERCENTILE_CONT(0.8) WITHIN GROUP(ORDER BY RECOVER_TIME) AS RECOVER_TIME,   
                      round(approx_quantile(cast(RECOVER_TIME as decimal),0.8)  OVER(ORDER BY RECOVER_TIME), 3) AS RECOVER_TIME,                                                             
                     'APC_PA' AS PA_TYPE,                                                                                                                    
                     'APC_PB' AS PB_TYPE                                                                                                                     
              FROM RECOVER_ALL_DATE                                                                                                                          
              """.format()

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_PIRUN_RECOVER_TIME_8",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_PIRUN_RECOVER_TIME_8")


def GetPiRunSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    sql = """
         INSERT  /*+ append */  INTO APS_TMP_ETL_PIRUN(                                                                                      
         TOOLG_ID, TOOL_ID, CH_ID, PROD_ID, PLAN_ID, STEP_ID,RECIPE, PPID,LAYER,
         STAGE, TECH, CUSTOMER, LOT_ID, RETICLE_ID, PRE_TOOL_ID, RULE_NAME, REMAINING_COUNT,
         REMAINING_TIME, RECOVER_TIME, VALID_RECIPE, VALID_TIME, HOLD_TIME, VALID_LOT, SPLIT_QTY                                                                                                                                 
         )                                                                                                                                               
          WITH VALID_LOT_INFO AS (                                                                                                                           
              SELECT DISTINCT                                                                                                                           
                    REPLACE(SV.LOT_KEY_NO,'.','') AS LOT_ID,                                                                                            
                    SV.OP_NO,                                                                                                                           
                    SV.UNIT_ID, SV.APC_TYPE                                                                                                             
             FROM APS_SYNC_SCHE_APC_LOT_SPECIAL_VALUE.APS_SYNC_SCHE_APC_LOT_SPECIAL_VALUE SV                                                                                                       
             INNER JOIN APS_SYNC_WIP.APS_SYNC_WIP W                                                                                      
             ON  REPLACE(SV.LOT_KEY_NO,'.','') = W.LOT_ID                                                          
             WHERE  SV.APC_TYPE IN ('PA','PB')                                                                     
          )                                                                                                                                             
           SELECT DISTINCT TL.TOOLG_ID,                                                                                                                 
           AA.PR_UNIT_ID AS TOOL_ID,                                                                                                                    
           '' AS CH_ID, AA.PRODSPEC_ID AS PROD_ID,                                                                                                      
           '' AS PLAN_ID, '' AS STEP_ID,                                                                                                                
           '' AS RECIPE, '' AS PPID,                                                                                                                    
           SUBSTRING(AA.PR_OP_NO, 1, POSITION('.' IN AA.PR_OP_NO)-1) AS LAYER,                                                                                
           SUBSTRING(AA.PR_OP_NO, POSITION('.' IN AA.PR_OP_NO)+1) AS STAGE,                                                                                   
           '' AS TECH, '' AS CUSTOMER,                                                                                                                  
           PI.LOT_ID, 
           --DECODE(PA.MASK_NM,'*','',PA.MASK_NM) AS RETICLE_ID,    
           (CASE WHEN AA.MASK_NM = '*' THEN '' ELSE AA.MASK_NM END) AS RETICLE_ID,                                                                             
           CASE WHEN (AA.UNIT_ID_1 NOT IN ('*') AND AA.UNIT_ID_2 NOT IN ('*')) THEN AA.UNIT_ID_1 || ';' || AA.UNIT_ID_2 ELSE                            
             (CASE WHEN AA.UNIT_ID_1<>'*' THEN AA.UNIT_ID_1 ELSE (CASE WHEN AA.UNIT_ID_2 = '*' THEN '' ELSE AA.UNIT_ID_2 END) END)                                          
           END AS PRE_TOOL_ID,                                                                                                                          
           'APC_PA' AS RULE_NAME,                                                                                                                       
           '0' AS REMAINING_COUNT, 
           CASE WHEN (AA.PA_FLAG='Y' AND AA.REMAIN_DAY <=0) THEN 9999 ELSE CAST(cast(AA.REMAIN_DAY as decimal)*24 AS DECIMAL(18,2)) END  AS REMAINING_TIME,
           Z.RECOVER_TIME, '' AS VALID_RECIPE,                                                                                                          
           --ROUND(PA.MAX_EFCT_TIME * 24,2) AS VALID_TIME, 
           CAST(cast(AA.MAX_EFCT_TIME as decimal) *24 AS DECIMAL(18,2)) AS VALID_TIME,                                                                                                
           '' AS HOLD_TIME,                                                                                                                             
           LI.LOT_ID AS VALID_ID, AA.SPLIT_COUNT
           FROM APS_TMP_ETL_PIRUN_PA1 AA
           INNER JOIN APS_TMP_ETL_PIRUN_TOOL TL                                                                                                    
           ON TL.TOOL_ID = AA.PR_UNIT_ID                                                                                                                
           LEFT JOIN APS_TMP_ETL_PIRUN_RECOVER_TIME_8 Z                                                                                                                  
           ON Z.PA_TYPE='APC_PA'                                                                                                                        
           LEFT JOIN APS_TMP_ETL_PIRUN_INFO PI                                                                                                                      
           ON PI.APC_TYPE='PA'                                                                                                                          
              AND PI.PROD_ID = AA.PRODSPEC_ID AND PI.C_OP_NO = AA.PR_OP_NO                                                                              
              AND PI.C_UNIT_ID = AA.PR_UNIT_ID   
                                                                                                                     
              --AND (DECODE(PI.MASK_NM, '*', '1', PI.MASK_NM) = DECODE(PI.MASK_NM, '*', '1', PA.MASK_NM)                                                  
            --  OR DECODE(PA.MASK_NM, '*', '1', PI.MASK_NM) = DECODE(PA.MASK_NM, '*', '1', PA.MASK_NM))  
                  and ( ((PI.MASK_NM <> '*' AND PI.MASK_NM = AA.MASK_NM) OR (PI.MASK_NM = '*' and 1=1)) OR 
                      ((AA.MASK_NM <> '*' AND PI.MASK_NM =  AA.MASK_NM) OR (AA.MASK_NM  = '*' and 1=1)) )      
                     
                                                              
             -- AND (DECODE(PI.OP_NO_1, '*', '1', PI.OP_NO_1) = DECODE(PI.OP_NO_1, '*', '1', PA.OP_NO_1)                                                  
            --  OR DECODE(PA.OP_NO_1, '*', '1', PA.OP_NO_1) = DECODE(PA.OP_NO_1, '*', '1', PI.OP_NO_1))                                                               
               and ( ((PI.OP_NO_1 <> '*' AND PI.OP_NO_1 = AA.OP_NO_1) OR (PI.OP_NO_1 = '*' and 1=1)) OR 
                   ((AA.OP_NO_1 <> '*' AND AA.OP_NO_1 =  PI.OP_NO_1) OR (AA.OP_NO_1  = '*' and 1=1)) )  
             
            -- AND (DECODE(PI.UNIT_ID_1, '*', '1', PI.UNIT_ID_1) = DECODE(PI.UNIT_ID_1, '*', '1', PA.UNIT_ID_1)                                        
            --  OR DECODE(PA.UNIT_ID_1, '*', '1', PA.UNIT_ID_1) = DECODE(PA.UNIT_ID_1, '*', '1', PI.UNIT_ID_1))                                           
              and ( ((PI.UNIT_ID_1 <> '*' AND PI.UNIT_ID_1 = AA.UNIT_ID_1) OR (PI.UNIT_ID_1 = '*' and 1=1)) OR 
               ((AA.UNIT_ID_1 <> '*' AND AA.UNIT_ID_1 =  PI.UNIT_ID_1) OR (AA.UNIT_ID_1  = '*' and 1=1)) )  
                          
            --  AND (DECODE(PI.OP_NO_2, '*', '1', PI.OP_NO_2) = DECODE(PI.OP_NO_2, '*', '1', PA.OP_NO_2)                                                
            --  OR DECODE(PA.OP_NO_2, '*', '1', PA.OP_NO_2) = DECODE(PA.OP_NO_2, '*', '1', PI.OP_NO_2))                                                   
    
           and ( ((PI.OP_NO_2 <> '*' AND PI.OP_NO_2 = AA.OP_NO_2) OR (PI.OP_NO_2 = '*' and 1=1)) OR 
               ((AA.OP_NO_2 <> '*' AND AA.OP_NO_2 =  PI.OP_NO_2) OR (AA.OP_NO_2  = '*' and 1=1)) ) 
                  
            --  AND (DECODE(PI.UNIT_ID_2, '*', '1', PI.UNIT_ID_2) = DECODE(PI.UNIT_ID_2, '*', '1', PA.MASK_NM)                                          
            --  OR DECODE(PA.UNIT_ID_2, '*', '1', PA.UNIT_ID_2) = DECODE(PA.UNIT_ID_2, '*', '1', PI.UNIT_ID_2))   
              
             and ( ((PI.UNIT_ID_2 <> '*' AND PI.UNIT_ID_2 = AA.MASK_NM) OR (PI.UNIT_ID_2 = '*' and 1=1)) OR 
               ((AA.UNIT_ID_2 <> '*' AND AA.UNIT_ID_2 =  PI.UNIT_ID_2) OR (AA.UNIT_ID_2  = '*' and 1=1)) ) 
                                                      
           LEFT JOIN VALID_LOT_INFO LI                                                                                                                 
              ON LI.OP_NO = AA.PR_OP_NO                                                                                                                 
              AND LI.UNIT_ID = AA.PR_UNIT_ID                                                                                                            
              AND LI.APC_TYPE = 'PA'                                                                                                                    
           WHERE 1=1                                                                                                                                    
           AND AA.REMAIN_DAY IS NOT NULL                                                                                                                
           AND AA.MAX_EFCT_TIME IS NOT NULL                                                                                                             
          UNION ALL                                                                                                                                     
           SELECT DISTINCT TL.TOOLG_ID,                                                                                                                 
           PB.PR_UNIT_ID AS TOOL_ID,                                                                                                                    
           '' AS CH_ID, PB.PRODSPEC_ID AS PROD_ID,                                                                                                      
           '' AS PLAN_ID, '' AS STEP_ID,                                                                                                                
           '' AS RECIPE, '' AS PPID,                                                                                                                    
           SUBSTRING(PB.PR_OP_NO, 1, POSITION('.' IN PB.PR_OP_NO)-1) AS LAYER,                                                                                
           SUBSTRING(PB.PR_OP_NO, POSITION('.' IN PB.PR_OP_NO)+1) AS STAGE,                                                                                   
           '' AS TECH, '' AS CUSTOMER,                                                                                                                  
           PI.LOT_ID, 
          -- DECODE(PB.MASK,'*','',PB.MASK) AS RETICLE_ID,   
           (CASE WHEN PB.MASK = '*' THEN '' ELSE PB.MASK END)  AS RETICLE_ID,                                                                                 
           '' AS PRE_TOOL_ID,                                                                                                                           
           'APC_PB' AS RULE_NAME,                                                                                                                       
           '0' AS REMAINING_COUNT, CASE WHEN (PB.PB_FLAG = 'Y' AND PB.REMAIN_DAY <=0) THEN 9999 ELSE CAST(cast(PB.REMAIN_DAY as decimal) *24 AS DECIMAL(18,2)) END  AS REMAINING_TIME,
           Z.RECOVER_TIME, '' AS VALID_RECIPE,                                                                                                          
           --ROUND(PB.MAX_EFEC_DAY * 24,2) AS VALID_TIME,
           CAST(cast(PB.MAX_EFEC_DAY as decimal) *24 AS DECIMAL(18,2)) AS VALID_TIME,                                                                                      
           '' AS HOLD_TIME,                                                                                                                             
           LI.LOT_ID AS VALID_ID, PB.SPLIT_COUNT                                                                                                        
           FROM  APS_TMP_ETL_PIRUN_PB1  PB                                                                                                       
           INNER JOIN APS_TMP_ETL_PIRUN_TOOL TL                                                                                                    
           ON TL.TOOL_ID = PB.PR_UNIT_ID                                                                                                                
           LEFT JOIN APS_TMP_ETL_PIRUN_RECOVER_TIME_8 Z                                                                                                                  
           ON Z.PB_TYPE='APC_PB'                                                                                                                        
           LEFT JOIN APS_TMP_ETL_PIRUN_INFO PI                                                                                             
           ON PI.APC_TYPE='PB'                                                                                                                          
              AND PI.PROD_ID = PB.PRODSPEC_ID                                                                                                           
              AND PI.C_OP_NO = PB.PR_OP_NO                                                                                                              
             -- AND (DECODE(PB.MASK, '*', '1', PI.MASK_NM) = DECODE(PB.MASK, '*', '1', PB.MASK)                                                           
             -- OR DECODE(PI.MASK_NM, '*', '1', PI.MASK_NM) = DECODE(PI.MASK_NM, '*', '1', PB.MASK))   
               and ( ((PB.MASK <> '*' AND PI.MASK_NM = PB.MASK) OR (PB.MASK = '*' and 1=1)) OR 
                ((PI.MASK_NM <> '*' AND PI.MASK_NM =  PB.MASK) OR (PI.MASK_NM  = '*' and 1=1)) ) 
                                                    
              AND PI.C_UNIT_ID = PB.PR_UNIT_ID                                                                                                          
           LEFT JOIN VALID_LOT_INFO LI                                                                                                                  
              ON LI.OP_NO = PB.PR_OP_NO                                                                                                                 
              AND LI.UNIT_ID = PB.PR_UNIT_ID                                                                                                            
              AND LI.APC_TYPE = 'PB'                                                                                                                    
           WHERE 1=1                                                                                                                                    
           AND PB.REMAIN_DAY IS NOT NULL                                                                                                                
           AND PB.MAX_EFEC_DAY IS NOT NULL                                                                                                                                                                 
       """.format()

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_PIRUN",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_PIRUN")


def GetUserFlagIsActiveSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    sql = """
        INSERT INTO APS_TMP_ETL_PIRUN_PATH_SETTING(                  
             USE_FLAG_TYPE, RS_HOLD_TIME, TOOL_ID, TOOLG_ID                                                       
             )                                                                    
              SELECT S.USE_FLAG_TYPE,S.RS_HOLD_TIME,                              
                     T.TOOL_ID,T.TOOLG_ID                                         
              FROM APS_SYNC_UMT_PATH_CONVERT_SETTING.APS_SYNC_UMT_PATH_CONVERT_SETTING S,   
              APS_TMP_ETL_PIRUN_TOOL T                                     
              WHERE S.EQP_G = T.TOOLG_ID AND S.ACTIVE_FLAG = 'Y'                             
              AND S.MODULE = T.MODULE                                                                         
          """.format()

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_PIRUN_PATH_SETTING",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_PIRUN_PATH_SETTING")


def GetFirstRuleSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    sql = """      
       INSERT  /*+ append */  INTO APS_TMP_ETL_PIRUN1(                     
          TOOLG_ID, TOOL_ID, CH_ID, PROD_ID, PLAN_ID, STEP_ID,RECIPE, PPID,LAYER, 
          STAGE, TECH, CUSTOMER, LOT_ID, RETICLE_ID, PRE_TOOL_ID, RULE_NAME, REMAINING_COUNT, 
          REMAINING_TIME, RECOVER_TIME, VALID_RECIPE, VALID_TIME, HOLD_TIME, VALID_LOT, SPLIT_QTY                                                                   
         )                                                                                
          SELECT TL.TOOLG_ID,                                                             
              CT.EQUIPMENTID AS TOOL_ID,                                                  
              '' AS CH_ID,                                                                
              CT.PRODUCTID AS PROD_ID,                                                    
              CT.ROUTEID || '.%' AS PLAN_ID,                                              
              '' AS STEP_ID,                                                              
              '' AS RECIPE,                                                               
              '' AS PPID,                                                                 
              SUBSTRING(CT.OPENO, 1, POSITION('.' IN CT.OPENO)-1) AS LAYER,                                                                      
              SUBSTRING(CT.OPENO, POSITION('.' IN CT.OPENO) +1) AS STAGE,                        
              '' AS TECH,                                                                 
              '' AS CUSTOMER,                                                             
              '' AS LOT_ID,                                                               
              '' AS RETICLE_ID,                                                           
              '' AS PRE_TOOL_ID,                                                          
              TL.USE_FLAG_TYPE AS RULE_NAME,                                              
              '' AS REMAINING_COUNT,                                                      
              '-1' AS REMAINING_TIME,                                                     
              '' AS RECOVE_TIME,                                                          
              '' AS VALID_RECIPE,                                                         
              '' AS VALID_IMTE,                                                           
              TL.RS_HOLD_TIME AS HOLD_TIME,                                               
              '' AS VALID_LOT,                                                            
              '' AS SPLIT_QTY                                                             
              FROM APS_TMP_ETL_PIRUN_CSFRINHIBIT CT                                     
              INNER JOIN APS_TMP_ETL_PIRUN_PATH_SETTING TL                          
              ON TL.TOOL_ID = CT.EQUIPMENTID                                              
              AND TL.USE_FLAG_TYPE = 'Userflag(1)'  
              WHERE CT.PASS_FLG_PRC='N'                                                   
              AND CT.prc_upt_user ='SPC'                                                                                                                                   
          """.format()

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_PIRUN1",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_PIRUN1")


def GetSecondRuleSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    sql = """      
         INSERT  /*+ append */  INTO APS_TMP_ETL_PIRUN2(                       
          TOOLG_ID, TOOL_ID, CH_ID, PROD_ID, PLAN_ID, STEP_ID,RECIPE, PPID,LAYER, 
          STAGE, TECH, CUSTOMER, LOT_ID, RETICLE_ID, PRE_TOOL_ID, RULE_NAME, REMAINING_COUNT, 
          REMAINING_TIME, RECOVER_TIME, VALID_RECIPE, VALID_TIME, HOLD_TIME, VALID_LOT, SPLIT_QTY                                                                    
         )                                                                                                                                               
          SELECT TL.TOOLG_ID,                                                              
              CT.EQUIPMENTID AS TOOL_ID,                                                   
              '' AS CH_ID,                                                                 
              CT.PRODUCTID AS PROD_ID,                                                     
              CT.ROUTEID || '.%' AS PLAN_ID,                                               
              '' AS STEP_ID,                                                               
              '' AS RECIPE,                                                                
              '' AS PPID,                                                                  
              SUBSTRING(CT.OPENO, 1, POSITION('.' IN CT.OPENO)-1) AS LAYER,                                                                      
              SUBSTRING(CT.OPENO, POSITION('.' IN CT.OPENO) +1) AS STAGE,                       
              '' AS TECH,                                                                  
              '' AS CUSTOMER,                                                              
              '' AS LOT_ID,                                                                
              '' AS RETICLE_ID,                                                            
              '' AS PRE_TOOL_ID,                                                           
              TL.USE_FLAG_TYPE AS RULE_NAME,                                               
              '' AS REMAINING_COUNT,                                                       
              '-1' AS REMAINING_TIME,                                                      
              '' AS RECOVE_TIME,                                                           
              '' AS VALID_RECIPE,                                                          
              '' AS VALID_IMTE,                                                            
              TL.RS_HOLD_TIME AS HOLD_TIME,                                                
              '' AS VALID_LOT,                                                             
              '' AS SPLIT_QTY                                                              
              FROM APS_TMP_ETL_PIRUN_CSFRINHIBIT CT                                      
              INNER JOIN APS_TMP_ETL_PIRUN_PATH_SETTING TL                           
              ON TL.TOOL_ID = CT.EQUIPMENTID                                               
              AND TL.USE_FLAG_TYPE = 'Userflag(2)' 
              WHERE CT.PASS_FLG_PRC='N'                                                    
              AND CT.prc_upt_user ='ECMS'                                                                                                                                              
           """.format()

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_PIRUN2",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_PIRUN2")


def getInhibitCase3ReworkData(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    sql = """      
        INSERT INTO APS_TMP_ETL_PIRUN_CSFRIHBT_3CASE_REWINFO(                                   
             PRODUCTID, ROUTEID, OPENO, EQUIPMENTID                                                                   
            )                                                                                
                SELECT A.PRODUCTID,A.ROUTEID,                                           
                       A.OPENO,A.EQUIPMENTID                                            
                       FROM APS_TMP_ETL_PIRUN_CSFRINHIBIT A                                   
                       WHERE  1=1                                                            
                       AND SUBSTRING(A.ROUTEID,1,2)='YY'                                   
                       AND A.PASS_FLG_PRC = 'N'                                           
                       AND POSITION('P' IN A.EQUIPMENTID) = 1                                                                                                                                                   
           """.format()

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_PIRUN_CSFRIHBT_3CASE_REWINFO",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_PIRUN_CSFRIHBT_3CASE_REWINFO")


def getInhibitCase3NotReworkData(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    sql = """      
           INSERT INTO APS_TMP_ETL_PIRUN_CSFRIHBT_3CASE_NOTREWINFO(                                      
                PRODUCTID, OPENO, EQUIPMENTID                                                             
                )                                                                           
                 SELECT DISTINCT B.PRODUCTID,	                                            
                        B.OPENO,B.EQUIPMENTID 	                                            
                 FROM CSFRINHIBIT.CSFRINHIBIT B,APS_TMP_ETL_PIRUN_APS_WIP W                 
                 WHERE POSITION('P' IN B.EQUIPMENTID) = 1                 
                       AND SUBSTRING(B.ROUTEID,1,2)<>'YY'	                                    
                       AND B.PASS_FLG_PRC = 'Y'                                              
                       AND  B.PRODUCTID = W.PROD_ID AND B.OPENO = W.OPE_NO                                                                                                                                                                          
               """.format()

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_PIRUN_CSFRIHBT_3CASE_NOTREWINFO",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_PIRUN_CSFRIHBT_3CASE_NOTREWINFO")


def GetThirdRuleSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    sql = """      
       INSERT  /*+ append */  INTO APS_TMP_ETL_PIRUN3(                      
         TOOLG_ID, TOOL_ID, CH_ID, PROD_ID, PLAN_ID, STEP_ID,RECIPE, PPID,LAYER,
         STAGE, TECH, CUSTOMER, LOT_ID, RETICLE_ID, PRE_TOOL_ID, RULE_NAME, REMAINING_COUNT,
         REMAINING_TIME, RECOVER_TIME, VALID_RECIPE, VALID_TIME, HOLD_TIME, VALID_LOT, SPLIT_QTY                                                                   
        )                                                                                                                                              
         WITH CSFRINHIBIT AS(                                                            
              SELECT A.PRODUCTID,A.ROUTEID,                                            
                     A.OPENO,A.EQUIPMENTID                                             
                     FROM APS_TMP_ETL_PIRUN_CSFRIHBT_3CASE_REWINFO A,APS_TMP_ETL_PIRUN_CSFRIHBT_3CASE_NOTREWINFO B                    
                     WHERE 1=1                                                             
                     AND A.OPENO = B.OPENO                                             
                     AND A.PRODUCTID = B.PRODUCTID                                     
                     AND A.EQUIPMENTID = B.EQUIPMENTID                                     
         )                                                                             
         SELECT TL.TOOLG_ID,                                                             
             CT.EQUIPMENTID AS TOOL_ID,                                                    
             '' AS CH_ID,                                                            
             CT.PRODUCTID AS PROD_ID,                                                      
             CT.ROUTEID || '.%' AS PLAN_ID,                                            
             '' AS STEP_ID,                                                            
             '' AS RECIPE,                                                             
             '' AS PPID,                                                             
             --SUBSTR(CT.OPENO, 1, INSTR(CT.OPENO,'.',-1)-1) AS LAYER,                                                                      
             --SUBSTR(CT.OPENO, INSTR(CT.OPENO,'.',-1)+1) AS STAGE,       
              SUBSTRING(CT.OPENO, 1, POSITION('.' IN CT.OPENO)-1) AS LAYER,                                                                      
              SUBSTRING(CT.OPENO, POSITION('.' IN CT.OPENO) +1) AS STAGE,                   
             '' AS TECH,                                                             
             '' AS CUSTOMER,                                                             
             '' AS LOT_ID,                                                             
             '' AS RETICLE_ID,                                                             
             '' AS PRE_TOOL_ID,                                                            
             TL.USE_FLAG_TYPE AS RULE_NAME,                                                
             '' AS REMAINING_COUNT,                                                    
             '-1' AS REMAINING_TIME,                                                     
             '' AS RECOVE_TIME,                                                            
             '' AS VALID_RECIPE,                                                     
             '' AS VALID_IMTE,                                                             
             TL.RS_HOLD_TIME AS HOLD_TIME,                                                 
             '' AS VALID_LOT,                                                              
             '' AS SPLIT_QTY                                                               
             FROM CSFRINHIBIT CT                                                     
             INNER JOIN APS_TMP_ETL_PIRUN_PATH_SETTING TL                            
             ON TL.TOOL_ID = CT.EQUIPMENTID                                                
             AND TL.USE_FLAG_TYPE ='Userflag(3)'                                                                                                                                                                       
                   """.format()

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_PIRUN3",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_PIRUN3")


def getCase4InhibitData(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    sql = """      
         INSERT INTO APS_TMP_ETL_PIRUN_CSFRIHBT_4CASE_CSFINFO(                                        
            PRODUCTID, ROUTEID, OPENO, EQUIPMENTID, PASS_FLG_PRC, UPDATE_TIME, CHIPBODY                                                         
          )                                                                          
           SELECT DISTINCT B.PRODUCTID,B.ROUTEID,                                     
                  B.OPENO,B.EQUIPMENTID,                                              
                  B.PASS_FLG_PRC,'{current_time}' as UPDATE_TIME,                                       
                  SUBSTRING(B.PRODUCTID, 1, POSITION('.' IN B.PRODUCTID)-1) as CHIPBODY                                                         
           FROM CSFRINHIBIT.CSFRINHIBIT B,APS_TMP_ETL_PIRUN_APS_WIP W                
           WHERE POSITION('P' IN B.EQUIPMENTID) = 1                             
                 AND W.PLAN_ID = B.ROUTEID                                     
                 AND CHIPBODY = W.CHIPBODY                                         
                 AND B.OPENO = W.OPE_NO                                                                                                                                                                                                                         
               """.format(current_time=current_time)

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_PIRUN_CSFRIHBT_4CASE_CSFINFO",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_PIRUN_CSFRIHBT_4CASE_CSFINFO")


def GetFourthRuleByCSBSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    sql = """      
           INSERT  /*+ append */  INTO APS_TMP_ETL_PIRUN_FOUR_CSB(                                    
                PRODUCTID, ROUTEID, OPENO, EQUIPMENTID, PASS_FLG_PRC, CHIPBODY                                                                                         
               )                                                                                                                                                                    
                SELECT PRODUCTID,                                                                                                                                                           
                 ROUTEID,                                                                                       
                 OPENO,                                                                                         
                 EQUIPMENTID,                                                                                   
                 PASS_FLG_PRC,CHIPBODY                                                                          
                FROM (                                                                                                
                  SELECT B.PRODUCTID,                                                                           
                         B.ROUTEID,                                                                             
                         B.OPENO,                                                                               
                   B.EQUIPMENTID,                                                                         
                   B.PASS_FLG_PRC,                                                                        
                   CHIPBODY,                                                                              
                   ROW_NUMBER() OVER(PARTITION BY B.ROUTEID,B.OPENO,B.EQUIPMENTID,                        
                   CHIPBODY ORDER BY B.UPDATE_TIME DESC) AS RN,                                            
                   B.UPDATE_TIME                                                                          
                  FROM APS_TMP_ETL_PIRUN_CSFRIHBT_4CASE_CSFINFO B                                            
                     ) R                                                                                              
                WHERE R.RN = 1 AND R.PASS_FLG_PRC = 'Y'                                                                                                                                                                                                                                                              
           """.format()

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_PIRUN_FOUR_CSB",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_PIRUN_FOUR_CSB")


def getCase4InhibitResultData(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    sql = """      
            INSERT INTO APS_TMP_ETL_PIRUN_CSFRIHBT_4CASE_RESULT(                                        
         PRODUCTID, ROUTEID, OPENO, EQUIPMENTID, PASS_FLG_PRC                                                             
        )                                                                          
         SELECT  A.PRODUCTID,A.ROUTEID,                                            
                A.OPENO,A.EQUIPMENTID,A.PASS_FLG_PRC                               
                FROM APS_TMP_ETL_PIRUN_CSFRIHBT_4CASE_CSFINFO A, APS_TMP_ETL_PIRUN_FOUR_CSB B                    
                WHERE 1=1 AND A.PASS_FLG_PRC = 'N'                                 
                AND A.OPENO = B.OPENO                                              
                AND A.ROUTEID = B.ROUTEID                                          
                AND A.EQUIPMENTID = B.EQUIPMENTID                                  
                AND A.CHIPBODY = B.CHIPBODY                                                                                                                                                                                                      
               """.format()

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_PIRUN_CSFRIHBT_4CASE_RESULT",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_PIRUN_CSFRIHBT_4CASE_RESULT")


def GetFourthRuleSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    sql = """      
              INSERT  /*+ append */  INTO APS_TMP_ETL_PIRUN4(                                                                         
         TOOLG_ID, TOOL_ID, CH_ID, PROD_ID, PLAN_ID, STEP_ID,RECIPE, PPID,LAYER,
         STAGE, TECH, CUSTOMER, LOT_ID, RETICLE_ID, PRE_TOOL_ID, RULE_NAME, REMAINING_COUNT,
         REMAINING_TIME, RECOVER_TIME, VALID_RECIPE, VALID_TIME, HOLD_TIME, VALID_LOT, SPLIT_QTY                                                                                                                      
        )                                                                                                                                                                                                 
         SELECT TL.TOOLG_ID,                                                                                                               
             CT.EQUIPMENTID AS TOOL_ID,                                                                                                    
             '' AS CH_ID,                                                                                                                  
             CT.PRODUCTID AS PROD_ID,                                                                                                      
             CT.ROUTEID || '.%' AS PLAN_ID,                                                                                                
             '' AS STEP_ID,                                                                                                                
             '' AS RECIPE,                                                                                                                 
             '' AS PPID,                                                                                                                   
           --  SUBSTR(CT.OPENO, 1, INSTR(CT.OPENO,'.',-1)-1) AS LAYER,                                                                       
            -- SUBSTR(CT.OPENO, INSTR(CT.OPENO,'.',-1)+1) AS STAGE,
               SUBSTRING(CT.OPENO, 1, POSITION('.' IN CT.OPENO)-1) AS LAYER,                                                                      
              SUBSTRING(CT.OPENO, POSITION('.' IN CT.OPENO) +1) AS STAGE,                                                                               
             '' AS TECH,                                                                                                                   
             '' AS CUSTOMER,                                                                                                               
             '' AS LOT_ID,                                                                                                                 
             '' AS RETICLE_ID,                                                                                                             
             '' AS PRE_TOOL_ID,                                                                                                            
             TL.USE_FLAG_TYPE AS RULE_NAME,                                                                                                
             '' AS REMAINING_COUNT,                                                                                                        
             '-1' AS REMAINING_TIME,                                                                                                       
             '' AS RECOVE_TIME,                                                                                                            
             '' AS VALID_RECIPE,                                                                                                           
             '' AS VALID_IMTE,                                                                                                             
             TL.RS_HOLD_TIME AS HOLD_TIME,                                                                                                 
             '' AS VALID_LOT,                                                            
             '' AS SPLIT_QTY                                                             
             FROM APS_TMP_ETL_PIRUN_CSFRIHBT_4CASE_RESULT CT                                                   
             INNER JOIN APS_TMP_ETL_PIRUN_PATH_SETTING TL                            
             ON TL.TOOL_ID = CT.EQUIPMENTID                                                
             AND TL.USE_FLAG_TYPE ='Userflag(4)'                                                                                                                                                                                                                                           
                  """.format()

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_PIRUN4",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_PIRUN4")


def getCase5SourceData(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    sql = """      
             INSERT INTO APS_TMP_ETL_PIRUN_CSFRIHBT_5CASE_SOURCE(                                        
         PRODUCTID, ROUTEID, OPENO, EQUIPMENTID, PASS_FLG_PRC, SGS_FIRST_OP, RN                                                            
         )                                                                          
          SELECT T.PRODUCTID,T.ROUTEID,                                                                                  
           	    T.OPENO,T.EQUIPMENTID,T.PASS_FLG_PRC,                                                               
                 F.SGS_FIRST_OP,                                                                                         
           ROW_NUMBER() OVER(PARTITION BY T.PRODUCTID,T.ROUTEID,T.EQUIPMENTID,F.SGS_GROUP ORDER BY F.OPE_SEQ) AS RN      
           FROM CSFRINHIBIT.CSFRINHIBIT T                                                            
           INNER JOIN APS_SYNC_FLOW.APS_SYNC_FLOW F                                                          
           ON SUBSTRING(F.MNPD_ID, 1, POSITION('.' IN F.MNPD_ID)-1) = T.ROUTEID                                               
           AND F.OPE_NO = T.OPENO                                                                                        
           AND F.SGS_FLAG='Y'                                                                                            
           AND F.PRODSPEC_ID = T.PRODUCTID                                                                               
          WHERE POSITION('P' IN T.EQUIPMENTID) = 1                                                                                                                                                                                                                                                                          
                   """.format()

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_PIRUN_CSFRIHBT_5CASE_SOURCE",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_PIRUN_CSFRIHBT_5CASE_SOURCE")


def getCase5ResultData(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    sql = """      
          INSERT INTO APS_TMP_ETL_PIRUN_CSFRIHBT_5CASE_RESULT(                                         
             PRODUCTID, ROUTEID, OPENO, EQUIPMENTID                                                             
             )                                                                           
              WITH CSA AS (                                                              
                 SELECT D.PRODUCTID,D.ROUTEID,                                           
                        D.OPENO,D.EQUIPMENTID,D.RN                                       
                        FROM APS_TMP_ETL_PIRUN_CSFRIHBT_5CASE_SOURCE D                
                        WHERE (D.SGS_FIRST_OP <> 'Y' OR D.SGS_FIRST_OP IS NULL )                                             
                        AND D.PASS_FLG_PRC = 'N'                                                                             
              ),                                                                                                             
              CSB AS (                                                                                                       
                  SELECT D.PRODUCTID,D.ROUTEID,                                                                              
                     D.OPENO,D.EQUIPMENTID,D.RN                                                                              
                     FROM APS_TMP_ETL_PIRUN_CSFRIHBT_5CASE_SOURCE D                                                                                      
                     WHERE D.RN = 1                                                                                          
                     AND D.SGS_FIRST_OP = 'Y'                                                                                
                     AND D.PASS_FLG_PRC = 'Y'                                                                                
              )                                                                                                              
              SELECT  A.PRODUCTID,A.ROUTEID,                                                                            
                     A.OPENO,A.EQUIPMENTID                                                                              
                     FROM CSA A, CSB B                                                                                  
                     WHERE 1=1                                                                                             
                     AND A.ROUTEID = B.ROUTEID                                                                          
                     AND A.EQUIPMENTID = B.EQUIPMENTID                                                                  
                     AND A.PRODUCTID = B.PRODUCTID                                                                      
                     AND A.RN > B.RN                                                                                                                                                                                                                                                                                                                                                         
                       """.format()

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_PIRUN_CSFRIHBT_5CASE_RESULT",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_PIRUN_CSFRIHBT_5CASE_RESULT")


def GetFifthRuleSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    sql = """      
               INSERT  /*+ append */  INTO APS_TMP_ETL_PIRUN5(                                                      
         TOOLG_ID, TOOL_ID, CH_ID, PROD_ID, PLAN_ID, STEP_ID,RECIPE, PPID,LAYER,
         STAGE, TECH, CUSTOMER, LOT_ID, RETICLE_ID, PRE_TOOL_ID, RULE_NAME, REMAINING_COUNT,
         REMAINING_TIME, RECOVER_TIME, VALID_RECIPE, VALID_TIME, HOLD_TIME, VALID_LOT, SPLIT_QTY                                                                                                   
         )                                                                                                                                                                              
          SELECT TL.TOOLG_ID,                                                                                            
              CT.EQUIPMENTID AS TOOL_ID,                                                                                 
              '' AS CH_ID,                                                                                               
              CT.PRODUCTID AS PROD_ID,                                                                                   
              CT.ROUTEID || '.%' AS PLAN_ID,                                                                             
              '' AS STEP_ID,                                                                                             
              '' AS RECIPE,                                                                                              
              '' AS PPID,                                                                                                
             -- SUBSTR(CT.OPENO, 1, INSTR(CT.OPENO,'.',-1)-1) AS LAYER,                                                               
             -- SUBSTR(CT.OPENO, INSTR(CT.OPENO,'.',-1)+1) AS STAGE,  
               SUBSTRING(CT.OPENO, 1, POSITION('.' IN CT.OPENO)-1) AS LAYER,                                                                      
              SUBSTRING(CT.OPENO, POSITION('.' IN CT.OPENO) +1) AS STAGE,                                                      
              '' AS TECH,                                                                                                
              '' AS CUSTOMER,                                                                                            
              '' AS LOT_ID,                                                                                              
              '' AS RETICLE_ID,                                                                                          
              '' AS PRE_TOOL_ID,                                                                                         
              TL.USE_FLAG_TYPE AS RULE_NAME,                                                                             
              '' AS REMAINING_COUNT,                                                                                     
              '-1' AS REMAINING_TIME,                                                                                    
              '' AS RECOVE_TIME,                                                                                         
              '' AS VALID_RECIPE,                                                                                        
              '' AS VALID_IMTE,                                                                                          
              TL.RS_HOLD_TIME AS HOLD_TIME,                                                                              
              '' AS VALID_LOT,                                                               
              '' AS SPLIT_QTY                                                                
              FROM APS_TMP_ETL_PIRUN_CSFRIHBT_5CASE_RESULT CT                          
              INNER JOIN APS_TMP_ETL_PIRUN_PATH_SETTING TL                             
              ON TL.TOOL_ID = CT.EQUIPMENTID                                                 
              AND TL.USE_FLAG_TYPE ='Userflag(5)'                                                                                                                                                                                                                                                                                                                                                        
                           """.format()

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_PIRUN5",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_PIRUN5")


def GetSeventhRuleSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    sql = """      
            INSERT  /*+ append */  INTO APS_TMP_ETL_PIRUN7(                     
        TOOLG_ID, TOOL_ID, CH_ID, PROD_ID, PLAN_ID, STEP_ID,RECIPE, PPID,LAYER,
         STAGE, TECH, CUSTOMER, LOT_ID, RETICLE_ID, PRE_TOOL_ID, RULE_NAME, REMAINING_COUNT,
         REMAINING_TIME, RECOVER_TIME, VALID_RECIPE, VALID_TIME, HOLD_TIME, VALID_LOT, SPLIT_QTY                                                                           
       )                                                                                                                                              
        SELECT TL.TOOLG_ID,                                                            
            CT.EQUIPMENTID AS TOOL_ID,                                                 
            '' AS CH_ID,                                                               
            CT.PRODUCTID AS PROD_ID,                                                   
            CT.ROUTEID || '.%' AS PLAN_ID,                                             
            '' AS STEP_ID,                                                             
            '' AS RECIPE,                                                              
            '' AS PPID,                                                                
            --SUBSTR(CT.OPENO, 1, INSTR(CT.OPENO,'.',-1)-1) AS LAYER,                                                                    
            --SUBSTR(CT.OPENO, INSTR(CT.OPENO,'.',-1)+1) AS STAGE,         
                SUBSTRING(CT.OPENO, 1, POSITION('.' IN CT.OPENO)-1) AS LAYER,                                                                      
              SUBSTRING(CT.OPENO, POSITION('.' IN CT.OPENO) +1) AS STAGE,                    
            '' AS TECH,                                                                
            '' AS CUSTOMER,                                                            
            '' AS LOT_ID,                                                              
            '' AS RETICLE_ID,                                                          
            '' AS PRE_TOOL_ID,                                                         
            TL.USE_FLAG_TYPE AS RULE_NAME,                                             
            '' AS REMAINING_COUNT,                                                     
            '-1' AS REMAINING_TIME,                                                    
            '' AS RECOVE_TIME,                                                         
            '' AS VALID_RECIPE,                                                        
            '' AS VALID_IMTE,                                                          
            TL.RS_HOLD_TIME AS HOLD_TIME,                                              
            '' AS VALID_LOT,                                                           
            '' AS SPLIT_QTY                                                            
            FROM APS_TMP_ETL_PIRUN_CSFRINHIBIT CT                                    
            INNER JOIN APS_TMP_ETL_PIRUN_PATH_SETTING TL                         
            ON TL.TOOL_ID = CT.EQUIPMENTID                                             
            AND TL.USE_FLAG_TYPE ='Userflag(7)'
            WHERE CT.PASS_FLG_PRC='Y'                                                  
            AND CT.PASS_FLG_MFG='N'                                                    
            AND CT.PRC_UPT_USER='EIWatchDog'                                           
        -- 控片产品的站点.NPR10 PASS_FLG_PRC='Y'  代表已开PATH
            AND NOT REGEXP_MATCHES(CT.OPENO,'NPR10')                                                                                                                                                                                                                                                                                                                                                                                             
        """.format()

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_PIRUN7",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_PIRUN7")


def GetCoatRuleSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    sql = """      
        INSERT  /*+ append */  INTO APS_ETL_PIRUN(
          --modify by xiecheng for version up
              PARENTID,TOOLG_ID, TOOL_ID, CH_ID, RULE_NAME, COUNT_UNIT, CURRENT_COUNT, LSL, USL, PROCESS_TIME, PARAMETER, ALL_CH_FLAG, UPDATE_TIME, PARTCODE)                                                          
                 SELECT '{uuid}' AS PARENTID,                             
                        TL.TOOLG_ID,                                                   
                        TL.TOOL_ID,    
                        --modify by xiecheng for version up
                         CASE WHEN E.CHAMBER_NO>' ' AND EXISTS (SELECT 1 FROM APS_TMP_ETL_PIRUN_TOOL N WHERE N.TOOL_ID = TL.TOOL_ID||'.'||E.CHAMBER_NO ) THEN TL.TOOL_ID||'.'||E.CHAMBER_NO END AS CH_ID,                                                 
                        E.PM_TYPE AS RULE_NAME,                                        
                        E.SPEC_UNIT AS COUNT_UNIT,                                     
                        E.DC_ITEM_VALUE AS CURRENT_COUNT,                              
                        (CAST(E.PM_SPEC AS DECIMAL) - CAST(E.RANGE AS DECIMAL)) AS LSL,                                  
                        E.PM_SPEC AS USL,                                              
                        E.TARGET_TIME AS PROCESS_TIME, 
                         --modify by xiecheng for version up
                        E.DC_ITEM_NAME,     
                         --modify by xiecheng for version up
                         E.DOWN_FLAG,                         
                        '{current_time}' AS UPDATE_TIME,                          
                        '' AS PARTCODE               
                 FROM APS_SYNC_TMS_EQP_PARAMETER.APS_SYNC_TMS_EQP_PARAMETER E,             
                      APS_TMP_ETL_PIRUN_TOOL TL                                   
                 WHERE  E.EQUIPMENT_NO = TL.TOOL_ID 
                       --modify by xiecheng for version up                      
                       --AND TL.MODULE='DIFF'                                            
                       AND E.DC_ITEM_VALUE IS NOT NULL                                 
                       AND E.SPEC_UNIT NOT IN ('Days','Months')                                                                                                                                                                                                                                                                                                                                                                                                                   
           """.format(uuid=uuid, current_time=current_time)

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_ETL_PIRUN",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_ETL_PIRUN")


def GetDfByRecipeSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    sql = """      
            INSERT  /*+ append */  INTO APS_ETL_PIRUN(
                        PARENTID, TOOLG_ID, TOOL_ID, CH_ID, PROD_ID, PPID, LAYER, STAGE,
                          --modify by xiecheng for version up
                        RULE_NAME, COUNT_UNIT, CURRENT_COUNT, LSL, USL, PROCESS_TIME, PARAMETER, UPDATE_TIME, PARTCODE)                                                             
             SELECT '{uuid}' AS PARENTID,                              
                    E.TOOLG_ID,                                                     
                    S.EQP_ID,                                                       
                    '' AS CH_ID,                                                    
                    REPLACE(S.PRODUCT_ID,'*','%') AS PROD_ID,                       
                    S.RECIPE_ID AS PPID,                                            
                    --SUBSTR(S.OPER_NO, 1, INSTR(S.OPER_NO,'.',-1)-1) AS LAYER,       
                    --SUBSTR(S.OPER_NO, INSTR(S.OPER_NO,'.',-1)+1) AS STAGE,    
                    SUBSTRING(S.OPER_NO, 1, POSITION('.' IN S.OPER_NO)-1) AS LAYER,                                                                      
                    SUBSTRING(S.OPER_NO, POSITION('.' IN S.OPER_NO) +1) AS STAGE,       
                    P.PM_TYPE AS RULE_NAME,                                         
                    P.SPEC_UNIT AS COUNT_UNIT,                                      
                    P.DC_ITEM_VALUE AS CURRENT_COUNT,                               
                    S.LSL,                                                          
                    S.USL,                                                          
                    '' AS PROCESS_TIME,   
                     --modify by xiecheng for version up
                      S.ITEM_NAME,                                            
                    '{current_time}' AS UPDATE_TIME,                           
                    '' AS PARTCODE                
             FROM APS_SYNC_FUR_ED_CONTROL_SETTING.APS_SYNC_FUR_ED_CONTROL_SETTING S         
             INNER JOIN APS_TMP_ETL_PIRUN_TOOL E                               
             ON E.TOOL_ID = S.EQP_ID                                                
             INNER JOIN APS_SYNC_TMS_EQP_PARAMETER.APS_SYNC_TMS_EQP_PARAMETER P        
             ON P.EQUIPMENT_NO = S.EQP_ID     
             AND S.ITEM_NAME = P.DC_ITEM_NAME                                                                                                                                                                                                                                                                                                                                                                                                                  
              """.format(uuid=uuid, current_time=current_time)

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_ETL_PIRUN",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_ETL_PIRUN")


def GetWetByRecipeAcceptSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    sql = """      
        INSERT  /*+ append */  INTO APS_ETL_PIRUN(
                  PARENTID, TOOLG_ID, TOOL_ID, CH_ID, PROD_ID, PPID, LAYER, STAGE,
                    --modify by xiecheng for version up
                  RULE_NAME, COUNT_UNIT, CURRENT_COUNT, LSL, USL, PROCESS_TIME, PARAMETER, UPDATE_TIME, PARTCODE)                                                               
         SELECT '{uuid}' AS PARENTID,                                                  
               I.TOOLG_ID,                                                                          
               D.EQP_ID,                                                                            
               '' AS CH_ID,                                                                         
               REPLACE(S.PRODUCT_ID,'*','%') AS PROD_ID,                                            
               '' AS PPID,                                                                          
               --DECODE(S.OPER_NO,'*','',SUBSTRING(S.OPER_NO, 1, POSITION('.' IN S.OPER_NO)-1)) AS LAYER,  
               (CASE WHEN S.OPER_NO = '*' THEN '' ELSE SUBSTRING(S.OPER_NO, 1, POSITION('.' IN S.OPER_NO)-1) END) AS LAYER,
              -- DECODE(S.OPER_NO,'*','',SUBSTRING(S.OPER_NO, POSITION('.' IN S.OPER_NO)+1)) AS STAGE,     
                (CASE WHEN S.OPER_NO = '*' THEN '' ELSE SUBSTRING(S.OPER_NO, POSITION('.' IN S.OPER_NO)+1) END) AS STAGE, 
               'Acid Control' AS RULE_NAME,                                                         
               CASE WHEN SUBSTRING(S.ITEM_NAME,0,1) = 'K' THEN 'lifetime' ELSE 'Pieces' END AS COUNT_UNIT,   
               CASE WHEN SUBSTRING(S.ITEM_NAME,0,1) = 'K' THEN ROUND(cast(D.VALUE as decimal)/60,3) ELSE cast(D.VALUE as decimal) END  AS CURRENT_COUNT, 
               CASE WHEN SUBSTRING(S.ITEM_NAME,0,1) = 'K' THEN ROUND(cast(S.LSL as decimal)/60,3) ELSE S.LSL END AS LSL,           
               CASE WHEN SUBSTRING(S.ITEM_NAME,0,1) = 'K' THEN ROUND(cast(S.USL as decimal)/60,3) ELSE S.USL END AS USL,           
               '' AS PROCESS_TIME,   
                --modify by xiecheng for version up     
                S.ITEM_NAME,                                                            
               '{current_time}' AS UPDATE_TIME,                                               
                '' AS PARTCODE                                    
         FROM APS_SYNC_WET_ACID_CONTROL_SETTING.APS_SYNC_WET_ACID_CONTROL_SETTING S                           
         INNER JOIN APS_TMP_ETL_PIRUN_TOOL I                                                   
         ON I.TOOL_ID = S.EQP_ID                                                                    
         INNER JOIN APS_SYNC_WET_ACID_DATA.APS_SYNC_WET_ACID_DATA D                                  
         ON
         -- D.EQP_ID = DECODE(S.EQP_ID,'*',D.EQP_ID,S.EQP_ID) 
         ((S.EQP_ID <> 'ALL'
             AND
             S.EQP_ID = D.EQP_ID
            ) OR S.EQP_ID = 'ALL')                                      
         AND D.ITEM_NAME = S.ITEM_NAME                                                              
         WHERE S.SPEC_TYPE = 'Accept'                                                                                                                                                                                                                                                                                                                                                                                                                           
         """.format(uuid=uuid, current_time=current_time)

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_ETL_PIRUN",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_ETL_PIRUN")


def GetWetByRecipeRejectSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    sql = """      
        INSERT  /*+ append */  INTO APS_ETL_PIRUN(
                  PARENTID, TOOLG_ID, TOOL_ID, CH_ID, PROD_ID, PPID, LAYER, STAGE,
                   --modify by xiecheng for version up
                  RULE_NAME, COUNT_UNIT, CURRENT_COUNT, LSL, USL, PROCESS_TIME, PARAMETER,UPDATE_TIME, PARTCODE)                                                                  
        SELECT '{uuid}' AS PARENTID,                                                  
              I.TOOLG_ID,                                                                          
              D.EQP_ID,                                                                            
              '' AS CH_ID,                                                                         
              REPLACE(S.PRODUCT_ID,'*','%') AS PROD_ID,                                            
              '' AS PPID,                                                                           
               --DECODE(S.OPER_NO,'*','',SUBSTRING(S.OPER_NO, 1, POSITION('.' IN S.OPER_NO)-1)) AS LAYER,  
               (CASE WHEN S.OPER_NO = '*' THEN '' ELSE SUBSTRING(S.OPER_NO, 1, POSITION('.' IN S.OPER_NO)-1) END) AS LAYER,
              -- DECODE(S.OPER_NO,'*','',SUBSTRING(S.OPER_NO, POSITION('.' IN S.OPER_NO)+1)) AS STAGE,     
                (CASE WHEN S.OPER_NO = '*' THEN '' ELSE SUBSTRING(S.OPER_NO, POSITION('.' IN S.OPER_NO)+1) END) AS STAGE,     
              'Acid Control' AS RULE_NAME,                                                         
              CASE WHEN SUBSTRING(S.ITEM_NAME,0,1) = 'K' THEN 'lifetime' ELSE 'Pieces' END AS COUNT_UNIT,     
              CASE WHEN SUBSTRING(S.ITEM_NAME,0,1) = 'K' THEN ROUND(cast(D.VALUE as decimal)/60,3) ELSE cast(D.VALUE as decimal) END  AS CURRENT_COUNT,  
              0 AS LSL,                                                                            
              CASE WHEN SUBSTRING(S.ITEM_NAME,0,1) = 'K' THEN ROUND(cast(S.LSL as decimal)/60,3) ELSE S.LSL END AS USL,         
              '' AS PROCESS_TIME,    
                --modify by xiecheng for version up     
                S.ITEM_NAME,                                                                
              '{current_time}' AS UPDATE_TIME,                                               
              '' AS PARTCODE                                    
        FROM APS_SYNC_WET_ACID_CONTROL_SETTING.APS_SYNC_WET_ACID_CONTROL_SETTING S                           
        INNER JOIN APS_TMP_ETL_PIRUN_TOOL I                                                   
        ON I.TOOL_ID = S.EQP_ID                                                                    
        INNER JOIN APS_SYNC_WET_ACID_DATA.APS_SYNC_WET_ACID_DATA D                                
        ON 
        --D.EQP_ID = DECODE(S.EQP_ID,'*',D.EQP_ID,S.EQP_ID)     
          ((S.EQP_ID <> 'ALL'
             AND
             S.EQP_ID = D.EQP_ID
            ) OR S.EQP_ID = 'ALL')                                  
        AND D.ITEM_NAME = S.ITEM_NAME                                                              
        WHERE S.SPEC_TYPE = 'Reject'                                                                 
        AND S.LSL > 0                                                                              
        UNION ALL                                                                                  
        SELECT '{uuid}' AS PARENTID,                                                  
              I.TOOLG_ID,                                                                          
              D.EQP_ID,                                                                            
              '' AS CH_ID,                                                                         
              REPLACE(S.PRODUCT_ID,'*','%') AS PROD_ID,                                            
              '' AS PPID,                                                                          
               --DECODE(S.OPER_NO,'*','',SUBSTRING(S.OPER_NO, 1, POSITION('.' IN S.OPER_NO)-1)) AS LAYER,  
               (CASE WHEN S.OPER_NO = '*' THEN '' ELSE SUBSTRING(S.OPER_NO, 1, POSITION('.' IN S.OPER_NO)-1) END) AS LAYER,
              -- DECODE(S.OPER_NO,'*','',SUBSTRING(S.OPER_NO, POSITION('.' IN S.OPER_NO)+1)) AS STAGE,     
                (CASE WHEN S.OPER_NO = '*' THEN '' ELSE SUBSTRING(S.OPER_NO, POSITION('.' IN S.OPER_NO)+1) END) AS STAGE,
              'Acid Control' AS RULE_NAME,                                                         
              CASE WHEN SUBSTRING(S.ITEM_NAME,0,1) = 'K' THEN 'lifetime' ELSE 'Pieces' END AS COUNT_UNIT,     
              CASE WHEN SUBSTRING(S.ITEM_NAME,0,1) = 'K' THEN ROUND(cast(D.VALUE as decimal)/60,3) ELSE cast(D.VALUE as decimal) END  AS CURRENT_COUNT,  
              CASE WHEN SUBSTRING(S.ITEM_NAME,0,1) = 'K' THEN ROUND(cast(S.USL as decimal)/60,3) ELSE S.USL END AS LSL,         
              cast(99999 as varchar) AS USL,                                                                        
              '' AS PROCESS_TIME,    
               --modify by xiecheng for version up     
                S.ITEM_NAME,                                                                
              '{current_time}' AS UPDATE_TIME,                                               
               '' AS PARTCODE                                    
        FROM APS_SYNC_WET_ACID_CONTROL_SETTING.APS_SYNC_WET_ACID_CONTROL_SETTING S                                                          
        INNER JOIN APS_TMP_ETL_PIRUN_TOOL I                                                   
        ON I.TOOL_ID = S.EQP_ID                                                                    
        INNER JOIN APS_SYNC_WET_ACID_DATA.APS_SYNC_WET_ACID_DATA D                                
        ON
        -- D.EQP_ID = DECODE(S.EQP_ID,'*',D.EQP_ID,S.EQP_ID)  
         ((S.EQP_ID <> 'ALL'
             AND
             S.EQP_ID = D.EQP_ID
            ) OR S.EQP_ID = 'ALL')                                    
        AND D.ITEM_NAME = S.ITEM_NAME                                                              
        WHERE  S.SPEC_TYPE = 'Reject'                                                                                                                                                                                                                                                                                                                                                                                                                        
           """.format(uuid=uuid, current_time=current_time)

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_ETL_PIRUN",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_ETL_PIRUN")


def GetWaitTimeSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    sql = """      
        INSERT  /*+ append */  INTO APS_ETL_PIRUN(
                 PARENTID, TOOLG_ID, TOOL_ID, CH_ID, LAYER, STAGE,
                 RULE_NAME, HOLD_TIME, UPDATE_TIME, PARTCODE)                                                                
         SELECT DISTINCT '{uuid}' AS PARENTID,                                                                       
                S.EQP_G AS TOOLG_ID,                                                                             
                T.TOOL_ID,                                                                                       
                '' AS CH_ID,                                                                                     
                CASE WHEN S.OPE_NO='*' THEN ''                                                                   
                     WHEN S.OPE_NO LIKE '%*' THEN SUBSTRING(S.OPE_NO,1,2)                                           
                ELSE SUBSTRING(S.OPE_NO, 1, POSITION('.' IN S.OPE_NO)-1 ) END AS LAYER,                               
                CASE WHEN S.OPE_NO='*' THEN ''                                                                   
                     WHEN S.OPE_NO LIKE '%*' THEN ''                                                             
                ELSE SUBSTRING(S.OPE_NO, POSITION('.' IN S.OPE_NO)+1 ) END AS STAGE,                                  
                CASE WHEN S.MODULE='WET' THEN 'ChemicalChange' ELSE 'AccConstraint' END AS RULE_NAME,            
                S.WAIT_TIME AS HOLD_TIME,                                                                        
                '{current_time}' AS UPDATE_TIME,                                                            
                '' AS PARTCODE                                                 
         FROM APS_SYNC_EQP_STATUS_WAIT_TIME_SETTING.APS_SYNC_EQP_STATUS_WAIT_TIME_SETTING S,APS_TMP_ETL_PIRUN_TOOL T        
         WHERE S.MODULE IN ('DIFF','WET')                                                                                                                                                        
         AND T.TOOL_ID LIKE REPLACE(S.EQP_ID,'*','%')                                                            
         AND T.TOOLG_ID = S.EQP_G                                                                                
         AND T.MODULE IN ('DIFF','WET')                                                                                                                                                                                                                                                                                                                                                                                                                                
               """.format(uuid=uuid, current_time=current_time)

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_ETL_PIRUN",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_ETL_PIRUN")


def GetTestRunRecipeInfoSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    sql = """      
            INSERT  /*+ append */  INTO APS_TMP_ETL_PIRUN_TEST_RUN_RECIPE(
                 --modify by xiecheng for version up
                M_RECIPE,TOOLID,EXPIRETIME,JOBGROUPID,JOBSPECID,LIFETIME,SUBNAME,EQP_G,STATE)                                                             
             SELECT *                                                                    
             FROM (                                                                      
                 SELECT                                                                  
                       SUBSTRING(T.DKEY,POSITION('_' IN T.DKEY)+1,LENGTH(T.DKEY)) AS M_RECIPE,    
                       T.TOOLID,                                                         
                      -- TO_CHAR(T.EXPIRETIME, 'YYYY-MM-DD HH24:MI:SS') AS EXPIRETIME, 
                       STRFTIME(T.EXPIRETIME, '%Y-%m-%d %H:%M:%S') AS EXPIRETIME,    
                       T.JOBGROUPID,                                                     
                       T.JOBSPECID,                                                      
                       T.LIFETIME,                                                       
                       T.SUBNAME,                                                        
                       D.TOOLG_ID,  
                       --modify by xiecheng for version up
                       T.STATE                                                       
                 FROM APS_SYNC_RDS_RECIPEINFO.APS_SYNC_RDS_RECIPEINFO T                  
                 INNER JOIN APS_TMP_ETL_PIRUN_TOOL D                               
                 ON D.TOOL_ID = T.TOOLID AND D.HOST_EQP_FLAG = 'Y'                       
                 WHERE POSITION('F' IN T.TOOLID) = 1                                             
             )  WHERE  M_RECIPE IS NOT NULL                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                 """.format(uuid=uuid, current_time=current_time)

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_PIRUN_TEST_RUN_RECIPE",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_PIRUN_TEST_RUN_RECIPE")


def GetTestRunT21MedianInfoSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    sql = """      
          INSERT  /*+ append */  INTO APS_TMP_ETL_PIRUN_TEST_RUN_T21 (
               TOOLG_ID, TOOL_ID, PPID, PT)                                                             
             SELECT L.TOOLG_ID, L.TOOL_ID,                                    
                    L.PPID, L.PT                                          
             FROM APS_TMP_TYPE21_MEDIAN.APS_TMP_TYPE21_MEDIAN L                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                   """.format(uuid=uuid, current_time=current_time)

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_PIRUN_TEST_RUN_T21",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_PIRUN_TEST_RUN_T21")


def GetTestRunT22MedianInfoSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    sql = """      
        INSERT  /*+ append */  INTO APS_TMP_ETL_PIRUN_TEST_RUN_T22 (
                       TOOLG_ID, PPID, PT)                                                               
            SELECT L.TOOLG_ID,                                               
                   L.PPID, L.PT                                              
            FROM APS_TMP_TYPE22_MEDIAN.APS_TMP_TYPE22_MEDIAN L                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
            """.format(uuid=uuid, current_time=current_time)

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_PIRUN_TEST_RUN_T22",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_PIRUN_TEST_RUN_T22")


def GetTestRunT221MedianInfoSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    sql = """      
           INSERT  /*+ append */  INTO APS_TMP_ETL_PIRUN_TEST_RUN_T221(
                 TOOLG_ID, TOOL_ID, CH_CNT, PT)                                                               
                SELECT L.TOOLG_ID, L.TOOL_ID,                                   
                       L.CH_CNT, L.PT                                             
                FROM APS_TMP_TYPE221_MEDIAN.APS_TMP_TYPE221_MEDIAN L                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
              """.format(uuid=uuid, current_time=current_time)

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_PIRUN_TEST_RUN_T221",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_PIRUN_TEST_RUN_T221")


def GetRtdRunPStartSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    sql = """      
            INSERT  /*+ append */  INTO APS_TMP_ETL_PIRUN_RTDRUN_PS (
                 EQP_ID,OPE_NO,PRODSPEC_ID,CLAIM_TIME,OPE_CATEGORY,LOT_ID,CTRL_JOB)                                                                                                                            
                 SELECT S.EQP_ID,S.OPE_NO,S.PRODSPEC_ID,                                                                           
                     S.CLAIM_TIME,S.OPE_CATEGORY,                                                                      
                     S.LOT_ID,S.CTRL_JOB                                                                               
                 FROM APS_MID_FHOPEHS.APS_MID_FHOPEHS S                                                                                                 
                 WHERE S.OPE_CATEGORY ='OperationStart'                                                                               
                 AND (                                                                                                                
                  (STRFTIME(CURRENT_DATE, '%H:%M:%S')  >= '07:30:00'                                                                     
                  AND S.CLAIM_TIME >= CONCAT(STRFTIME(CURRENT_DATE, '%Y-%m-%d'), ' 07:30:00')       
                  AND S.CLAIM_TIME < CONCAT(STRFTIME(DATE_TRUNC('day', CURRENT_DATE) + INTERVAL '1 day', '%Y-%m-%d'), ' 07:30:00'))      
                  OR                                                                                                               
                  (STRFTIME(CURRENT_DATE, '%H:%M:%S') < '07:30:00'                                                                      
                  AND S.CLAIM_TIME >= CONCAT(STRFTIME(DATE_TRUNC('day', CURRENT_DATE) - INTERVAL '1 day', '%Y-%m-%d'), ' 07:30:00')     
                  AND S.CLAIM_TIME < CONCAT(STRFTIME(CURRENT_DATE, '%Y-%m-%d'), ' 07:30:00'))          
         )                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
        """.format(uuid=uuid, current_time=current_time)

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_PIRUN_RTDRUN_PS",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_PIRUN_RTDRUN_PS")


def GetRtdRunPEndSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    sql = """      
            INSERT  /*+ append */  INTO APS_TMP_ETL_PIRUN_RTDRUN_PE (
                EQP_ID,OPE_NO,PRODSPEC_ID,CLAIM_TIME,OPE_CATEGORY,LOT_ID,CTRL_JOB )                                                                                                                                                
              SELECT S.EQP_ID,S.OPE_NO,S.PRODSPEC_ID,                                                                           
                    S.CLAIM_TIME,S.OPE_CATEGORY,                                                                      
                    S.LOT_ID,S.CTRL_JOB                                                                               
              FROM APS_MID_FHOPEHS.APS_MID_FHOPEHS S                                                                                                 
              WHERE S.OPE_CATEGORY ='OperationStartCancle'                                                                         
              AND (                                                                                                                
              (STRFTIME(CURRENT_DATE, '%H:%M:%S')  >= '07:30:00'                                                                     
              AND S.CLAIM_TIME >= CONCAT(STRFTIME(CURRENT_DATE, '%Y-%m-%d'), ' 07:30:00')       
              AND S.CLAIM_TIME < CONCAT(STRFTIME(DATE_TRUNC('day', CURRENT_DATE) + INTERVAL '1 day', '%Y-%m-%d'), ' 07:30:00'))      
              OR                                                                                                                
              (STRFTIME(CURRENT_DATE, '%H:%M:%S') < '07:30:00'                                                                      
              AND S.CLAIM_TIME >= CONCAT(STRFTIME(DATE_TRUNC('day', CURRENT_DATE) - INTERVAL '1 day', '%Y-%m-%d'), ' 07:30:00')     
              AND S.CLAIM_TIME < CONCAT(STRFTIME(CURRENT_DATE, '%Y-%m-%d'), ' 07:30:00'))          
              )                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
          """.format(uuid=uuid, current_time=current_time)

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_PIRUN_RTDRUN_PE",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_PIRUN_RTDRUN_PE")


def GetRtdRunProcessStartSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    sql = """      
        INSERT  /*+ append */  INTO APS_TMP_ETL_PIRUN_RTDRUN_PSTART (
            EQP_ID,OPE_NO,PRODSPEC_ID,CLAIM_TIME,OPE_CATEGORY,LOT_ID,CTRL_JOB)                                                               
            SELECT D.EQP_ID,D.OPE_NO,D.PRODSPEC_ID,                                                 
                 D.CLAIM_TIME,D.OPE_CATEGORY,D.LOT_ID,D.CTRL_JOB                                  
            FROM APS_TMP_ETL_PIRUN_RTDRUN_PS D                                                 
            WHERE NOT EXISTS (                                                                      
             SELECT 1                                                                             
             FROM APS_TMP_ETL_PIRUN_RTDRUN_PE CD                                             
             WHERE CD.CTRL_JOB = D.CTRL_JOB                                                       
               AND CD.LOT_ID = D.LOT_ID                                                
            )                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
          """.format(uuid=uuid, current_time=current_time)

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_PIRUN_RTDRUN_PSTART",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_PIRUN_RTDRUN_PSTART")


def GetRtdRunCountSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    sql = """      
        INSERT  /*+ append */  INTO APS_TMP_ETL_PIRUN_RTDRUN_COUNT (
         EQP_ID,LAYER,PD_ID,LOT_COUNT)                                                                
         SELECT L.EQP_ID,L.LAYER,                 
                     L.PD_ID || '%' AS PD_ID,     
                     L.LOT_COUNT                  
         FROM APS_SYNC_RTD_RUN_LOTBYEQP_COUNT.APS_SYNC_RTD_RUN_LOTBYEQP_COUNT L          
         WHERE L.LOT_COUNT > 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
             """.format(uuid=uuid, current_time=current_time)

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_PIRUN_RTDRUN_COUNT",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_PIRUN_RTDRUN_COUNT")


def GetRtdRunLotCountSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    sql = """      
          INSERT  /*+ append */  INTO APS_TMP_ETL_PIRUN_RTDRUN_LOTCOUNT (EQP_ID,LAYER,PD_ID,RN)                                                              
         SELECT L.EQP_ID,L.LAYER,L.PD_ID,                          
                (cast(MAX(L.LOT_COUNT) as decimal) - cast(COUNT(*) as decimal)) AS RN                
         FROM APS_TMP_ETL_PIRUN_RTDRUN_COUNT L                
         INNER JOIN APS_TMP_ETL_PIRUN_RTDRUN_PSTART P   
         ON P.EQP_ID = L.EQP_ID                                    
         AND P.OPE_NO = L.LAYER                                    
         AND P.PRODSPEC_ID LIKE L.PD_ID                            
         GROUP BY L.EQP_ID,L.LAYER,L.PD_ID                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
              """.format(uuid=uuid, current_time=current_time)

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_PIRUN_RTDRUN_LOTCOUNT",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_PIRUN_RTDRUN_LOTCOUNT")


def GetRtdRunDataSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    sql = """      
         INSERT  /*+ append */  INTO APS_ETL_PIRUN(
                PARENTID, TOOLG_ID, TOOL_ID, CH_ID, PROD_ID, LAYER, STAGE, RULE_NAME, REMAINING_COUNT, UPDATE_TIME, PARTCODE)                                                            
         WITH RESULT_DATA AS (                                                         
             SELECT D.TOOLG_ID,                                                   
                    L.EQP_ID AS TOOL_ID,                                          
                    '' CH_ID,                                                     
                    L.PD_ID AS PROD_ID,                                           
                    SUBSTRING(L.LAYER, 1, POSITION('.' IN L.LAYER)-1) AS LAYER,         
                    SUBSTRING(L.LAYER, POSITION('.' IN L.LAYER)+1) AS STAGE,            
                    'RTD Lot Count Limit' AS RULE_NAME,                           
                    CASE WHEN C.EQP_ID IS NOT NULL THEN C.RN                      
                       ELSE L.LOT_COUNT END AS REMAINING_COUNT                    
             FROM APS_TMP_ETL_PIRUN_RTDRUN_COUNT L                         
             INNER JOIN APS_TMP_ETL_PIRUN_TOOL D                             
             ON D.TOOL_ID = L.EQP_ID                                               
             LEFT JOIN APS_TMP_ETL_PIRUN_RTDRUN_LOTCOUNT C                 
             ON C.EQP_ID = L.EQP_ID                                               
             AND C.LAYER = L.LAYER                                                
             AND C.PD_ID = L.PD_ID                                                
         )                                                                        
         SELECT DISTINCT '{uuid}' AS PARENTID,                       
                TOOLG_ID,                                                         
                TOOL_ID,                                                          
                CH_ID,                                                            
                PROD_ID,                                                          
                LAYER,                                                            
                STAGE,                                                            
                RULE_NAME,                                                        
                CASE WHEN REMAINING_COUNT < 0 THEN 0                              
                     ELSE REMAINING_COUNT END AS REMAINING_COUNT,                 
                '{current_time}' AS UPDATE_TIME,                             
                '' AS PARTCODE                  
         FROM RESULT_DATA D                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                  """.format(uuid=uuid, current_time=current_time)

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_ETL_PIRUN",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_ETL_PIRUN")


def GetTestRunInfoSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    sql = """      
         INSERT  /*+ append */  INTO APS_ETL_PIRUN(
                PARENTID, TOOLG_ID, TOOL_ID, CH_ID, STEP_ID,
                PPID, RULE_NAME, REMAINING_TIME, RECOVER_TIME,
                VALID_TIME, JOB_ID, PROCESS_TIME, UPDATE_TIME, PARTCODE)                                                                    
         WITH TEST_RUN_DATA AS(                                                                                    
              SELECT DISTINCT '{uuid}' AS PARENTID,                                                   
                 T.EQP_G,                                                                                          
                 T.TOOLID,                                                                                         
                 '' AS CH_ID,                                                                                      
                 '' AS STEP_ID,                                                                                    
                 SUBSTRING(REPLACE(T.M_RECIPE,'.AA',''),POSITION('.' IN REPLACE(T.M_RECIPE,'.AA',''))+1) AS M_RECIPE,   
                 'TestRun' AS RULE_NAME,     
                 -- CASE WHEN (TO_DATE(T.EXPIRETIME,'YYYY-MM-DD HH24:MI:SS') - SYSDATE) <= 0 AND T.STATE = 1 
                --  THEN 999 ELSE ROUND((TO_DATE(T.EXPIRETIME,'YYYY-MM-DD HH24:MI:SS') - SYSDATE)*24,2) END AS REMAINING_TIME,   
                  CASE WHEN (STRPTIME(T.EXPIRETIME,'%Y-%m-%d %H:%M:%S') - CURRENT_DATE) <= 0 AND T.STATE = 1  
                   THEN 999 ELSE  round((extract(epoch from(STRPTIME(T.EXPIRETIME,'%Y-%m-%d %H:%M:%S') - CURRENT_DATE))) / 3600.0, 2) END AS REMAINING_TIME,           
                 NULL AS RECOVER_TIME,                                                                             
                 T.LIFETIME AS VALID_TIME,                                                                         
                 T.JOBGROUPID || '(' || T.SUBNAME || ')'AS JOB_ID,                                                 
                 '{current_time}' AS UPDATE_TIME,                                                             
                 '' AS PARTCODE                                                  
              FROM APS_TMP_ETL_PIRUN_TEST_RUN_RECIPE T                                                       
         )                                                                                                         
         SELECT DISTINCT PARENTID,                                                                                 
          D.EQP_G,                                                                                           
          D.TOOLID,                                                                                          
          D.CH_ID,                                                                                           
          D.STEP_ID,                                                                                         
          D.M_RECIPE,                                                                                        
          D.RULE_NAME,                                                                                       
          D.REMAINING_TIME,                                                                                  
          D.RECOVER_TIME,                                                                                    
          D.VALID_TIME,                                                                                      
          D.JOB_ID,                                                                                          
          CASE WHEN T21.TOOL_ID IS NOT NULL THEN T21.PT ELSE COALESCE(COALESCE(T22.PT,T221.PT),0) END AS PROCESS_TIME,  
          UPDATE_TIME,                                                                                        
          PARTCODE                                                                                            
         FROM TEST_RUN_DATA D                                                                                       
         LEFT JOIN APS_TMP_ETL_PIRUN_TEST_RUN_T21 T21                                                                
         ON T21.TOOLG_ID = D.EQP_G AND T21.TOOL_ID = D.TOOLID AND T21.PPID = D.M_RECIPE                             
         LEFT JOIN APS_TMP_ETL_PIRUN_TEST_RUN_T22 T22                                                                
         ON T22.TOOLG_ID = D.EQP_G AND T22.PPID = D.M_RECIPE                                                        
         LEFT JOIN APS_TMP_ETL_PIRUN_TEST_RUN_T221 T221                                                              
         ON T221.TOOLG_ID = D.EQP_G AND T221.TOOL_ID = D.TOOLID AND T221.CH_CNT = 1                                 
         WHERE POSITION('-' IN SUBSTRING(D.M_RECIPE,-3,3)) =0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
         """.format(uuid=uuid, current_time=current_time)

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_ETL_PIRUN",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_ETL_PIRUN")


def GetTestRunApcResultSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    sql = """      
        INSERT INTO APS_ETL_PIRUN(                                                  
               PARENTID, TOOLG_ID, TOOL_ID, PPID, RULE_NAME, REMAINING_TIME,
               VALID_TIME, PROCESS_TIME, UPDATE_TIME, PARTCODE                                                            
        )                                                                            
         WITH APC_DATA AS(                                                                                                                                                                 
              SELECT DISTINCT '{uuid}' AS PARENTID,                                                   
                     T.TOOLG_ID,                                                                                   
                     R.TOOL_ID,                                                                                    
                     R.PPID,                                                                                       
                     'APC' AS RULE_NAME, 
                     --CASE WHEN R.LAST_RUN_TIME IS NULL THEN -999 ELSE ROUND((R.LAST_RUN_TIME+R.LIFE_TIME/24 - SYSDATE)*24,2) END AS REMAINING_TIME,                                                                                                   
                     CASE WHEN R.LAST_RUN_TIME IS NULL THEN -999 
                     ELSE round((extract(epoch from(STRPTIME(R.LAST_RUN_TIME,'%Y-%m-%d %H:%M:%S') + INTERVAL (CAST(R.LIFE_TIME AS DECIMAL)/24) HOUR- CURRENT_DATE))) / 3600.0, 2) END AS REMAINING_TIME,                                                                                         
                     R.LIFE_TIME AS VALID_TIME,                                                                    
                     '{current_time}' AS UPDATE_TIME,                                                         
                     ''  AS PARTCODE                                              
              FROM APS_ETL_APC_RESULT.APS_ETL_APC_RESULT R                                                   
              INNER JOIN APS_TMP_ETL_PIRUN_TOOL T                                                                  
              ON R.TOOL_ID = T.TOOL_ID                                                                                                                                      
         )                                                                                                           
         SELECT DISTINCT PARENTID,                                                                                   
          D.TOOLG_ID,                                                                                              
          D.TOOL_ID,                                                                                                                                                                                    
          D.PPID,                                                                                                  
          D.RULE_NAME,                                                                                             
          D.REMAINING_TIME,                                                                                                                                                                        
          D.VALID_TIME,                                                                                                                                                                                 
          CASE WHEN T21.TOOL_ID IS NOT NULL THEN T21.PT ELSE COALESCE(COALESCE(T22.PT,T221.PT),0) END AS PROCESS_TIME,       
          UPDATE_TIME,                                                                                             
          PARTCODE                                                                                                 
             FROM APC_DATA D                                                                                           
         LEFT JOIN APS_TMP_ETL_PIRUN_TEST_RUN_T21 T21                                                                  
         ON T21.TOOLG_ID = D.TOOLG_ID AND T21.TOOL_ID = D.TOOL_ID AND T21.PPID = D.PPID                               
         LEFT JOIN APS_TMP_ETL_PIRUN_TEST_RUN_T22 T22                                                                  
         ON T22.TOOLG_ID = D.TOOLG_ID AND T22.PPID = D.PPID                                                          
         LEFT JOIN APS_TMP_ETL_PIRUN_TEST_RUN_T221 T221                                                                
         ON T221.TOOLG_ID = D.TOOLG_ID AND T221.TOOL_ID = D.TOOL_ID AND T221.CH_CNT = 1                                   
         WHERE POSITION('-' IN SUBSTRING(D.PPID,-3,3)) =0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
         """.format(uuid=uuid, current_time=current_time)

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_ETL_PIRUN",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_ETL_PIRUN")


def GetInsertSqlFromPiRun(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    sql = """      
          INSERT  /*+ append */  INTO APS_ETL_PIRUN(
               PARENTID,  TOOLG_ID, TOOL_ID, CH_ID, PROD_ID, PLAN_ID, STEP_ID,RECIPE, PPID,LAYER,
               STAGE, TECH, CUSTOMER, LOT_ID, RETICLE_ID, PRE_TOOL_ID, RULE_NAME, REMAINING_COUNT,
               REMAINING_TIME, RECOVER_TIME, VALID_RECIPE, VALID_TIME, HOLD_TIME, VALID_LOT, SPLIT_QTY , UPDATE_TIME, PARTCODE)
          SELECT *  FROM ( 
          SELECT '{uuid}' AS PARENTID,  TOOLG_ID, TOOL_ID, CH_ID, PROD_ID, PLAN_ID, STEP_ID,RECIPE, PPID,LAYER,
               STAGE, TECH, CUSTOMER, LOT_ID, RETICLE_ID, PRE_TOOL_ID, RULE_NAME, REMAINING_COUNT,
               REMAINING_TIME, RECOVER_TIME, VALID_RECIPE, VALID_TIME, HOLD_TIME, VALID_LOT, SPLIT_QTY ,'{current_time}' AS UPDATE_TIME, '' AS PARTCODE
          FROM  APS_TMP_ETL_PIRUN 
          UNION ALL 
          SELECT '{uuid}' AS PARENTID, TOOLG_ID, TOOL_ID, CH_ID, PROD_ID, PLAN_ID, STEP_ID,RECIPE, PPID,LAYER,
               STAGE, TECH, CUSTOMER, LOT_ID, RETICLE_ID, PRE_TOOL_ID, RULE_NAME, REMAINING_COUNT,
               REMAINING_TIME, RECOVER_TIME, VALID_RECIPE, VALID_TIME, HOLD_TIME, VALID_LOT, SPLIT_QTY , '{current_time}' AS UPDATE_TIME,'' AS PARTCODE
          FROM  APS_TMP_ETL_PIRUN1 
          UNION ALL 
          SELECT '{uuid}'  AS PARENTID, TOOLG_ID, TOOL_ID, CH_ID, PROD_ID, PLAN_ID, STEP_ID,RECIPE, PPID,LAYER,
               STAGE, TECH, CUSTOMER, LOT_ID, RETICLE_ID, PRE_TOOL_ID, RULE_NAME, REMAINING_COUNT,
               REMAINING_TIME, RECOVER_TIME, VALID_RECIPE, VALID_TIME, HOLD_TIME, VALID_LOT, SPLIT_QTY , '{current_time}'  AS UPDATE_TIME, ''  AS PARTCODE
          FROM APS_TMP_ETL_PIRUN2
          UNION ALL 
          SELECT '{uuid}'  AS PARENTID, TOOLG_ID, TOOL_ID, CH_ID, PROD_ID, PLAN_ID, STEP_ID,RECIPE, PPID,LAYER,
               STAGE, TECH, CUSTOMER, LOT_ID, RETICLE_ID, PRE_TOOL_ID, RULE_NAME, REMAINING_COUNT,
               REMAINING_TIME, RECOVER_TIME, VALID_RECIPE, VALID_TIME, HOLD_TIME, VALID_LOT, SPLIT_QTY ,  '{current_time}' AS UPDATE_TIME, '' AS PARTCODE
          FROM  APS_TMP_ETL_PIRUN3
          UNION ALL 
          SELECT '{uuid}'  AS PARENTID, TOOLG_ID, TOOL_ID, CH_ID, PROD_ID, PLAN_ID, STEP_ID,RECIPE, PPID,LAYER,
               STAGE, TECH, CUSTOMER, LOT_ID, RETICLE_ID, PRE_TOOL_ID, RULE_NAME, REMAINING_COUNT,
               REMAINING_TIME, RECOVER_TIME, VALID_RECIPE, VALID_TIME, HOLD_TIME, VALID_LOT, SPLIT_QTY ,  '{current_time}'  AS UPDATE_TIME, '' AS PARTCODE
          FROM  APS_TMP_ETL_PIRUN4
          UNION ALL 
          SELECT '{uuid}'  AS PARENTID, TOOLG_ID, TOOL_ID, CH_ID, PROD_ID, PLAN_ID, STEP_ID,RECIPE, PPID,LAYER,
               STAGE, TECH, CUSTOMER, LOT_ID, RETICLE_ID, PRE_TOOL_ID, RULE_NAME, REMAINING_COUNT,
               REMAINING_TIME, RECOVER_TIME, VALID_RECIPE, VALID_TIME, HOLD_TIME, VALID_LOT, SPLIT_QTY ,  '{current_time}' AS UPDATE_TIME, '' AS PARTCODE
          FROM APS_TMP_ETL_PIRUN5
          UNION ALL 
          SELECT '{uuid}'  AS PARENTID, TOOLG_ID, TOOL_ID, CH_ID, PROD_ID, PLAN_ID, STEP_ID,RECIPE, PPID,LAYER,
               STAGE, TECH, CUSTOMER, LOT_ID, RETICLE_ID, PRE_TOOL_ID, RULE_NAME, REMAINING_COUNT,
               REMAINING_TIME, RECOVER_TIME, VALID_RECIPE, VALID_TIME, HOLD_TIME, VALID_LOT, SPLIT_QTY , '{current_time}'  AS UPDATE_TIME, '' AS PARTCODE
          FROM APS_TMP_ETL_PIRUN7
          ) T WHERE SUBSTRING(T.PROD_ID,LENGTH(T.PROD_ID)) <> '_'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
          """.format(uuid=uuid, current_time=current_time)

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_ETL_PIRUN",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_ETL_PIRUN")

def GetLastPurgeDataSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    sql = """ 
        INSERT INTO APS_TMP_ETL_PIRUN_PURGE_LAST(                          
            START_TIME, EQP_ID, RTN                                                       
         )                                                                    
          WITH PURGE_DATA AS (                                                                                        
             SELECT TO_DATE(TO_CHAR(EVENT_TIME_ST,'YYYY-MM-DD HH24:MI:SS'),'YYYY-MM-DD HH24:MI:SS') AS START_TIME,    
                    EQP_ID                                                                                            
             FROM APS_SYNC_OUT_DF_PURGE_COMBINE.APS_SYNC_OUT_DF_PURGE_COMBINE                                           
            -- WHERE PARTCODE = ' + lstCodes.get(27) + '                                                              
          )                                                                                                           
          SELECT  START_TIME,EQP_ID,                                                                                  
                  ROW_NUMBER() OVER(PARTITION BY EQP_ID ORDER BY START_TIME DESC) AS RTN                              
          FROM PURGE_DATA                                                                                             
          WHERE START_TIME > DATE_TRUNC('day', CURRENT_DATE) - INTERVAL '7 day'     
   """.format(uuid=uuid, current_time=current_time)

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_PIRUN_PURGE_LAST",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_PIRUN_PURGE_LAST")

def GetPurgeEqpDataSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    sql = """      
            INSERT INTO APS_TMP_ETL_PIRUN_PURGE_DATA(                         
               TOOLG_ID, EQUIPMENT_ID, VAL, REPORT_TIME, RTN, LAST_VAL                                                   
               )                                                                   
                WITH TOOL_DATA AS (                                                                                   
                     SELECT T.EQP_ID,                                                                                 
                            MAX(T.EQP_G) AS TOOLG_ID                                                                  
                     FROM APS_SYNC_ETL_TOOL.APS_SYNC_ETL_TOOL T                                                 
                     WHERE T.HOST_EQP_FLAG ='Y' 
                     --AND PARTCODE = ' + lstCodes.get(3) + '                              
                     GROUP BY EQP_ID                                                                                  
                )                                                                                                     
                SELECT                                                                                                
                    D.TOOLG_ID,                                                                                       
                    EQUIPMENT_ID,                                                                                     
                    CAST(VALUE AS decimal) AS VAL,                                                                    
                    REPORT_TIME,                                                                                      
                    ROW_NUMBER() OVER(PARTITION BY EQUIPMENT_ID ORDER BY REPORT_TIME DESC) AS RTN,                     
                    LAG(CAST(VALUE AS decimal)) OVER (PARTITION BY EQUIPMENT_ID ORDER BY REPORT_TIME) AS LAST_VAL     
                FROM APS_SYNC_EQP_ED_DATA_REPORT.APS_SYNC_EQP_ED_DATA_REPORT T                                            
                INNER JOIN TOOL_DATA D                                                                                
                ON D.EQP_ID = T.EQUIPMENT_ID                                                                          
                WHERE REPORT_TIME > DATE_TRUNC('day', CURRENT_DATE) - INTERVAL '7 day' AND ED_PARAMETER_ID = 'PGR0'                                            
                --AND T.PARTCODE = ' + lstCodes.get(23) + '                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
              """.format(uuid=uuid, current_time=current_time)

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_PIRUN_PURGE_DATA",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_PIRUN_PURGE_DATA")


def GetPurgeMaxBatchDataSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    sql = """      
        INSERT INTO APS_TMP_ETL_PIRUN_PURGE_MAX_BATCH(                                             
             EQUIPMENT_ID, BATCH_SPEC, RTN2                                                                               
             )                                                                                            
             SELECT EQUIPMENT_ID,LAST_VAL AS BATCH_SPEC,                                                 
                    ROW_NUMBER() OVER(PARTITION BY EQUIPMENT_ID ORDER BY REPORT_TIME DESC) AS RTN2        
             FROM APS_TMP_ETL_PIRUN_PURGE_DATA                                                        
             WHERE RTN > 1                                                                               
             AND VAL < LAST_VAL                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
              """.format(uuid=uuid, current_time=current_time)

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_PIRUN_PURGE_MAX_BATCH",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_PIRUN_PURGE_MAX_BATCH")


def GetPurgeEqpBatchDataSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    sql = """      
        INSERT INTO APS_TMP_ETL_PIRUN_PURGE_EQP_BATCH(                                          
             EQUIPMENT_ID, VAL, RTN                                                                           
             )                                                                                         
              SELECT EQUIPMENT_ID,                                                                     
                CAST(VALUE AS decimal) AS VAL,                                                    
                ROW_NUMBER() OVER(PARTITION BY EQUIPMENT_ID ORDER BY REPORT_TIME DESC) AS RTN      
              FROM APS_SYNC_EQP_ED_DATA_REPORT.APS_SYNC_EQP_ED_DATA_REPORT                                
              WHERE ED_PARAMETER_ID = 'PGS0' 
              --AND PARTCODE = ' + lstCodes.get(23) + '                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
              """.format(uuid=uuid, current_time=current_time)

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_PIRUN_PURGE_EQP_BATCH",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_PIRUN_PURGE_EQP_BATCH")


def GetPurgeDefBatchDataSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    sql = """      
        INSERT INTO APS_TMP_ETL_PIRUN_PURGE_DEF_BATCH(                          
            EQP_G, EQP_ID, UNIT_DC_ITEM, UNIT_SPEC                                                           
            )                                                                         
             SELECT EQP_G,EQP_ID,UNIT_DC_ITEM,                                        
                    CAST(UNIT_SPEC AS decimal) AS UNIT_SPEC                           
             FROM APS_SYNC_UMT_EQP_UNIT_PLAN_SETTING.APS_SYNC_UMT_EQP_UNIT_PLAN_SETTING          
             WHERE UNIT_DC_ITEM='PGS0'                                                
             --AND PARTCODE = ' + lstCodes.get(24) + '                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
              """.format(uuid=uuid, current_time=current_time)

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_PIRUN_PURGE_DEF_BATCH",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_PIRUN_PURGE_DEF_BATCH")


def GetPurgeReultDataSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    sql = """      
         INSERT INTO APS_ETL_PIRUN (                                       
             PARENTID,TOOLG_ID,TOOL_ID, RULE_NAME, COUNT_UNIT,VALID_COUNT,REMAINING_COUNT,
             PROCESS_TIME, UPDATE_TIME, PARTCODE                                                     
         )                                                                       
          SELECT DISTINCT '{uuid}' AS PARENTID,                                       
                 T1.TOOLG_ID,                                                                      
                 T1.EQUIPMENT_ID AS TOOL_ID,                                                       
                 'BatchPurge' AS RULE_NAME,                                                        
                 'BATCH' AS COUNT_UNIT,                                                            
                 COALESCE(T3.VAL,T2.BATCH_SPEC,T4.UNIT_SPEC) AS VALID_COUNT,      
                 CASE WHEN T1.REPORT_TIME >= COALESCE(T0.START_TIME, T1.REPORT_TIME) THEN COALESCE(T3.VAL,T2.BATCH_SPEC,T4.UNIT_SPEC) - T1.VAL 
                 ELSE (COALESCE(T3.VAL,T2.BATCH_SPEC,T4.UNIT_SPEC)) END AS REMAINING_COUNT,          
                 COALESCE(P11.PT,P12.PT) AS PROCESS_TIME,                                               
                '{current_time}' AS UPDATE_TIME,                                             
                  '' AS PARTCODE                                  
          FROM APS_TMP_ETL_PIRUN_PURGE_DATA T1                                                   
          LEFT JOIN APS_TMP_ETL_PIRUN_PURGE_MAX_BATCH T2 ON T2.RTN2 = 1 AND T1.EQUIPMENT_ID = T2.EQUIPMENT_ID                        
          LEFT JOIN APS_TMP_ETL_PIRUN_PURGE_EQP_BATCH T3 ON T3.RTN = 1 AND  T1.EQUIPMENT_ID = T3.EQUIPMENT_ID                        
          LEFT JOIN APS_TMP_ETL_PIRUN_PURGE_DEF_BATCH T4 ON T1.EQUIPMENT_ID = T4.EQP_ID 
          LEFT JOIN APS_TMP_ETL_PIRUN_PURGE_LAST T0 ON T1.EQUIPMENT_ID = T0.EQP_ID AND T0.RTN = 1                                             
          LEFT JOIN APS_MID_PURGE11.APS_MID_PURGE11 P11 ON T1.EQUIPMENT_ID = P11.TOOL_ID  
          LEFT JOIN APS_MID_PURGE12.APS_MID_PURGE12 P12 ON T1.TOOLG_ID = P12.TOOLG_ID     
          WHERE T1.RTN = 1                                                                         
          AND COALESCE( T3.VAL,T2.BATCH_SPEC,T4.UNIT_SPEC) IS NOT NULL                             
              """.format(uuid=uuid, current_time=current_time)

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_ETL_PIRUN",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_ETL_PIRUN")


def execute():
    ###############################################################
    ### 以下参数必须定义
    ### ETL_Proc_Name    : ETL 名称
    ### current_time     ：请直接拷贝
    ### current_time_short ：请直接拷贝
    ### uuid             ：请直接拷贝
    ### target_table     : 该ETL输出表名
    ### used_table_list  : 该ETL使用到的，参考到的表名(中间表不算)
    ### target_table_sql ： 该ETL输出表定义SQL
    ###############################################################
    ETL_Proc_Name = "APS_ETL_BR.APS_ETL_PIRUN_10M"
    current_time = my_date.date_time_second_str()
    current_time_short = my_date.date_time_second_short_str()
    uuid = my_oracle.UUID()

    target_table = "APS_ETL_PIRUN"
    used_table_list = ['CSFRINHIBIT',
                       'APS_MID_FHOPEHS',
                       'APS_MID_RSPILOT_RUN_HS',
                       'APS_TMP_LOTHISTORY',
                       'APS_SYNC_FLOW',
                       'APS_ETL_WIP',
                       'APS_ETL_APC_RESULT',
                       'APS_SYNC_SCHE_APC_PB',
                       'APS_SYNC_APC_SPLIT_WAFER',
                       'APS_SYNC_WIP',
                       'APS_SYNC_SCHE_APC_PA',
                       'APS_SYNC_ETL_TOOL',
                       'APS_SYNC_SCHE_APC_LOT_SPECIAL_VALUE',
                       'APS_SYNC_TMS_EQP_PARAMETER',
                       'APS_SYNC_FUR_ED_CONTROL_SETTING',
                       'APS_SYNC_WET_ACID_CONTROL_SETTING',
                       'APS_SYNC_WET_ACID_DATA',
                       'APS_SYNC_EQP_STATUS_WAIT_TIME_SETTING',
                       'APS_SYNC_RDS_RECIPEINFO',
                       'APS_SYNC_RTD_RUN_LOTBYEQP_COUNT',
                       'APS_SYNC_RSPILOT_RUNING',
                       'APS_SYNC_UMT_PATH_CONVERT_SETTING',
                       'APS_TMP_TYPE22_MEDIAN',
                       'APS_TMP_TYPE21_MEDIAN',
                       'APS_TMP_TYPE221_MEDIAN',
                       'APS_SYNC_EQP_ED_DATA_REPORT',
                       'APS_SYNC_UMT_EQP_UNIT_PLAN_SETTING',
                       'APS_MID_PURGE11',
                       'APS_MID_PURGE12',
                       'APS_SYNC_OUT_DF_PURGE_COMBINE'
                       ]
    target_table_sql = """
        create table {}APS_ETL_PIRUN
        (
            parentid        VARCHAR(60) not null,
            toolg_id        VARCHAR(60) not null,
            tool_id         VARCHAR(60) not null,
            ch_id           VARCHAR(60),
            prod_id         VARCHAR(60),
            plan_id         VARCHAR(60),
            step_id         VARCHAR(60),
            recipe          VARCHAR(60),
            ppid            VARCHAR(60),
            layer           VARCHAR(60),
            stage           VARCHAR(60),
            tech            VARCHAR(60),
            customer        VARCHAR(60),
            lot_id          VARCHAR(60),
            reticle_id      VARCHAR(60),
            pre_tool_id     VARCHAR(60),
            rule_name       VARCHAR(60) not null,
            remaining_count VARCHAR(60),
            remaining_time  VARCHAR(60),
            recover_time    VARCHAR(60),
            valid_recipe    VARCHAR(60),
            valid_time      VARCHAR(60),
            update_time     VARCHAR(60) not null,
            hold_time       VARCHAR(60),
            partcode        VARCHAR(60) not null,
            valid_lot       VARCHAR(60),
            count_unit      VARCHAR(60),
            current_count   VARCHAR(60),
            lsl             VARCHAR(60),
            usl             VARCHAR(60),
            process_time    VARCHAR(60),
            job_id          VARCHAR(64),
            split_qty       VARCHAR(60),
            parameter       VARCHAR(64),
            all_ch_flag     VARCHAR(2)
        )
    """.format("")  # 注意:这里一定要这么写 [create table 表名] => [create table {}表名]
    target_db_file = my_duck.get_target_file_name(target_table, current_time_short)

    oracle_conn = None
    try:
        oracle_conn = my_oracle.oracle_get_connection()
        # 开始日志
        my_oracle.StartCleanUpAndLog(oracle_conn, ETL_Proc_Name, current_time)
        # 创建DuckDB
        duck_db_memory = my_duck.create_duckdb_in_momory(target_table_sql)
        if config.g_thread_and_memory_limit:  # 是否手动管理内存和进程
            duck_db_memory.sql('SET threads TO 4')
            # 加上TMP目录:LQN:2023/08/21
            duck_db_memory.execute("SET temp_directory='{}'".format(os.path.join(config.g_mem_etl_output_path, 'duck_temp', uuid)))
        # 创建Temp表
        create_temp_table(duck_db_memory)
        # Attach用到的表
        my_duck.attach_used_table(oracle_conn, duck_db_memory, used_table_list)
        ################################################################################################################
        ## 以下为业务逻辑
        ################################################################################################################

        getetApsEtlWipSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name)
        GetCsfrinhibitSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name)
        GetApcPb1DataSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name)
        GetApcPa1DataSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name)
        GetEtlToolDataSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name)
        getPirunRunInfo(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name)
        getPirunHistData(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name)
        getRecoverTimeByLotHisData(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name)
        getRecoverTimeByMedianData(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name)
        GetPiRunSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name)
        GetUserFlagIsActiveSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name)
        GetFirstRuleSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name)
        GetSecondRuleSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name)
        getInhibitCase3ReworkData(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name)
        getInhibitCase3NotReworkData(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name)
        GetThirdRuleSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name)
        getCase4InhibitData(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name)
        GetFourthRuleByCSBSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name)
        getCase4InhibitResultData(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name)
        GetFourthRuleSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name)
        getCase5SourceData(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name)
        getCase5ResultData(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name)
        GetFifthRuleSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name)
        GetSeventhRuleSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name)
        GetCoatRuleSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name)
        GetDfByRecipeSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name)
        GetWetByRecipeAcceptSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name)
        GetWetByRecipeRejectSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name)
        GetWaitTimeSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name)
        GetTestRunRecipeInfoSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name)
        GetTestRunT21MedianInfoSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name)
        GetTestRunT22MedianInfoSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name)
        GetTestRunT221MedianInfoSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name)
        GetRtdRunPStartSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name)
        GetRtdRunPEndSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name)
        GetRtdRunProcessStartSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name)
        GetRtdRunCountSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name)
        GetRtdRunLotCountSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name)
        GetRtdRunDataSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name)
        GetTestRunInfoSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name)
        GetTestRunApcResultSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name)
        GetInsertSqlFromPiRun(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name)
        #  DF BATCH PURGE的相关逻辑
        # 最近一次的purge时间
        GetLastPurgeDataSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name)
        #  ①抓取机台累积Batch记录
        GetPurgeEqpDataSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name)
        # ②计算过去7天累积最大的Batch数
        GetPurgeMaxBatchDataSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name)
        # ④抓取机台Batch设定值
        GetPurgeEqpBatchDataSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name)
        # ⑤抓取Batch设定防呆值
        GetPurgeDefBatchDataSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name)
        # ⑥最终的Purge值
        GetPurgeReultDataSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name)
        ################################################################################################################
        ## 以上为业务逻辑
        ################################################################################################################
        if config.g_copy_to_pg:
            select_sql_in_duck = """select parentid,toolg_id,tool_id,ch_id,prod_id, plan_id,step_id,recipe,ppid,layer,stage,
                                           tech,customer,lot_id, reticle_id, pre_tool_id, rule_name,remaining_count,remaining_time,
                                           recover_time, valid_recipe, valid_time, hold_time, update_time, valid_lot,count_unit,current_count,
                                           lsl,usl,process_time,job_id,split_qty,parameter from APS_ETL_PIRUN
                                """
            postgres_table_define = """etl_pirun(parentid,toolg_id,tool_id,ch_id,prod_id, plan_id,step_id,recipe,ppid,layer,stage,
                                                 tech,customer,lot_id, reticle_id, pre_tool_id, rule_name,remaining_count,remaining_time,
                                                 recover_time, valid_recipe, valid_time, hold_time, update_time, valid_lot,count_unit,current_count,
                                                 lsl,usl,process_time,job_id,split_qty,parameter)
                                               """
            my_postgres.copy_duckdb_to_postgres(uuid=uuid,
                                                duckdb=duck_db_memory,
                                                table_name_in_duckdb=target_table,
                                                table_name_in_pg="etl_pirun",  # 要小写
                                                select_sql_in_duck=select_sql_in_duck,
                                                postgres_table_define=postgres_table_define)
        # 导出到目标文件中
        target_db_file = my_duck.export_result_duck_file_and_close_duck_db_memory(duck_db_memory,
                                                                                  target_table,
                                                                                  target_table_sql.format("file_db."),
                                                                                  current_time_short)
        # 写版本号
        my_oracle.HandlingVerControl(oracle_conn, uuid, target_table, target_db_file)
        # 写完成日志
        my_oracle.EndCleanUpAndLog(oracle_conn, ETL_Proc_Name, current_time)
    except Exception as e:
        # 写警告日志
        my_oracle.SaveAlarmLogData(oracle_conn, ETL_Proc_Name, e, target_db_file,
                                   cons_error_code.APS_ETL_PIRUN_CODE_XX_ETL)
        logging.exception("{ETL_Proc_Name} 處理出錯 : {e}".format(ETL_Proc_Name=ETL_Proc_Name, e=e))
        raise e
    finally:
        oracle_conn.commit()
        oracle_conn.close()
        if config.g_thread_and_memory_limit:  # 是否手动管理内存和进程
            # 删除TMP目录:LQN:2023/08/21
            if os.path.exists(os.path.join(config.g_mem_etl_output_path, 'duck_temp', uuid)):
                os.remove(os.path.join(config.g_mem_etl_output_path, 'duck_temp', uuid))
        gc.collect()  # 内存释放


if __name__ == '__main__':
    # 单JOB测试用
    print("start")
    execute()
