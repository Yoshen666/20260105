import logging

from xinxiang.util import my_duck, my_oracle, cons_error_code, cons


def InsertAnomayEwsLotData(duck_db_memory=None, uuid="", current_time="", oracle_conn=None, ETL_Proc_Name="",
                           used_table_dict=None):
    sql = """
    INSERT INTO APS_TMP_ETL_RLS_ANOMALY_EWS_LOT_DATA(   
             LOT_ID, OPE_NO, EQP_ID, PRODSPEC_ID                          
             )                                                                   
              SELECT L.LOT_ID,L.OPE_NO,L.EQP_ID,                                  
                     L.PRODSPEC_ID                                                
              FROM APS_SYNC_MAJOR_ANOMALY_EWS_LOT.APS_SYNC_MAJOR_ANOMALY_EWS_LOT L         
              WHERE L.CONTROL_ITEM='USER_FLAG'                                    
              AND STATUS='Waiting'  
     """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_ANOMALY_EWS_LOT_DATA",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_ANOMALY_EWS_LOT_DATA")


def InsertBoatConstraintsDataView2Temp(duck_db_memory=None, uuid="", current_time="", oracle_conn=None,
                                       ETL_Proc_Name="", used_table_dict=None):
    '''DF区管内位置限制'''
    sql = """
    INSERT INTO  APS_TMP_ETL_RLS_BOAT_CONSTRAINTS 
     WITH PROD_INFO AS (                                             
          SELECT PRODSPEC_ID AS PROD_ID,                             
                 MAX(PRODG1) AS PRODG1,                              
                 MAX(GROUP_TECH) AS PRODG_TECH                       
          FROM APS_SYNC_PRODUCT.APS_SYNC_PRODUCT                                         
          GROUP BY PRODSPEC_ID                                       
     )                                                               
     SELECT S.EQP_ID,S.PRODG1,S.TECH,S.OPE_NO,                       
            REPLACE(S.POINT_AREA,',',';')||';' AS CH_SET,            
            -- S.OTHER_MIN_CTRL,                                        
            CAST(S.OTHER_MIN_CTRL AS DECIMAL) AS OTHER_MIN_CTRL,
            I.PROD_ID                                                
     FROM APS_SYNC_UMT_BOAT_CONSTAINT_SETTING.APS_SYNC_UMT_BOAT_CONSTAINT_SETTING AS S                             
     INNER JOIN PROD_INFO AS I                                            
     ON I.PRODG1 = (select case S.PRODG1 when '*' then I.PRODG1 else S.PRODG1 end)  
     AND I.PRODG_TECH = (select case S.TECH when '*' then I.PRODG_TECH else S.TECH end) 
    """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_BOAT_CONSTRAINTS",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_BOAT_CONSTRAINTS")
    sql = """
    INSERT  INTO  APS_TMP_ETL_RLS_BOAT_CONSTRAINTS2 
    SELECT S.EQP_ID,                                                     
           MIN(S.BATCH_SIZE) AS FOUP_NUM,                                
           CASE WHEN MIN(S.BATCH_SIZE) = 1 THEN '1;'                     
                WHEN MIN(S.BATCH_SIZE) = 2 THEN '1;2;'                   
                WHEN MIN(S.BATCH_SIZE) = 3 THEN '1;2;3;'                 
                WHEN MIN(S.BATCH_SIZE) = 4 THEN '1;2;3;4;'               
                WHEN MIN(S.BATCH_SIZE) = 5 THEN '1;2;3;4;5;'             
                WHEN MIN(S.BATCH_SIZE) = 6 THEN '1;2;3;4;5;6;'           
            END AS CH_SET                                                
    FROM APS_SYNC_UMT_EQP_BATCH_SIZE_SETTING.APS_SYNC_UMT_EQP_BATCH_SIZE_SETTING AS S     
    WHERE POSITION('F' in S.EQP_ID) = 1                                          
    GROUP BY S.EQP_ID                                                    
    """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_BOAT_CONSTRAINTS2",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_BOAT_CONSTRAINTS2")
    sql = """
    INSERT INTO  APS_TMP_ETL_RLS_BOAT_CONSTRAINTS3 
    SELECT S.EQP_ID,                                                         
           MIN(S.BATCH_SIZE_MAX) AS FOUP_NUM,                                
           CASE WHEN MIN(S.BATCH_SIZE_MAX) = 1 THEN '1;'                     
                WHEN MIN(S.BATCH_SIZE_MAX) = 2 THEN '1;2;'                   
                WHEN MIN(S.BATCH_SIZE_MAX) = 3 THEN '1;2;3;'                 
                WHEN MIN(S.BATCH_SIZE_MAX) = 4 THEN '1;2;3;4;'               
                WHEN MIN(S.BATCH_SIZE_MAX) = 5 THEN '1;2;3;4;5;'             
                WHEN MIN(S.BATCH_SIZE_MAX) = 6 THEN '1;2;3;4;5;6;'           
            END AS CH_SET                                                    
    FROM APS_SYNC_FVEQP.APS_SYNC_FVEQP AS S                            
    INNER JOIN APS_SYNC_ETL_TOOL.APS_SYNC_ETL_TOOL AS T                   
    ON  T.REAL_MODULE = 'DIFF'          
    AND S.EQP_ID = T.EQP_ID                                                  
    WHERE 1= 1                                                               
    AND POSITION('F' in S.EQP_ID) = 1                                              
    GROUP BY S.EQP_ID                                                        
    """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_BOAT_CONSTRAINTS3",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_BOAT_CONSTRAINTS3")


def InsertRtdBatchInfoView2Temp(duck_db_memory=None, uuid="", current_time="", oracle_conn=None, ETL_Proc_Name="",
                                used_table_dict=None):
    '''RTD PATH卡控'''
    sql = """
    INSERT INTO APS_TMP_ETL_RLS_BATCH_INFO (
        BATCH_NAME, MAINPD_ID, OPE_NO, PRODSPEC_ID
    )
    SELECT I.BATCH_NAME,
           I.MAINPD_ID,
           I.OPE_NO,
           I.PRODSPEC_ID
    FROM APS_SYNC_UMT_RTD_BATCH_INFO.APS_SYNC_UMT_RTD_BATCH_INFO AS I
    WHERE I.BATCH_PATH_TARGET_FLAG ='0'
    AND I.PRODSPEC_ID IS NOT NULL
    """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_BOAT_CONSTRAINTS3",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_BATCH_INFO")


def InsertMultiLotDataView2Temp(duck_db_memory=None, uuid="", current_time="", oracle_conn=None, ETL_Proc_Name="",
                                used_table_dict=None):
    '''RTD MultiLot卡控'''
    sql = """
    INSERT INTO APS_TMP_ETL_RLS_MULTI_LOT (
        LOT_ID, CAST_ID, OPE_NO
    )
    SELECT REPLACE(L.LOT_ID,'.','') AS LOT_ID, 
            L.CAST_ID, 
            L.OPE_NO
    FROM APS_SYNC_MLIF_HOLD_LOT.APS_SYNC_MLIF_HOLD_LOT AS L
    WHERE L.MULTI_LOT_TYPE LIKE 'ML%'
    AND L.MLIF_ACTION ='STOP'
    """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_BOAT_CONSTRAINTS3",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_MULTI_LOT")


def InsertApcInhibitLotDataView2Temp(duck_db_memory=None, uuid="", current_time="", oracle_conn=None, ETL_Proc_Name="",
                                     used_table_dict=None):
    '''V_APC_INHIBIT_BATCH view的数据插入到 temp 表'''
    sql = """
    INSERT INTO  APS_TMP_ETL_RLS_APC_INHIBIT_LOT
    SELECT B.EQP_ID,  
           B.PHYSICAL_RECIPE
    FROM   APS_SYNC_APC_INHIBIT_BATCH.APS_SYNC_APC_INHIBIT_BATCH AS B
    """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_APC_INHIBIT_LOT",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_APC_INHIBIT_LOT")
    sql = """
         INSERT /*+ append */ INTO APS_TMP_ETL_RLS_APC_INHIBIT_LOT_GLOBAL  
             (PROD_ID,OPE_NO,EQP_ID)                                                         
             SELECT DISTINCT W.PRODSPEC_ID,                                         
                    T.OPE_NO,T.EQP_ID                                          
             FROM APS_SYNC_APC_INHIBIT_LOT.APS_SYNC_APC_INHIBIT_LOT T             
             INNER JOIN APS_SYNC_WIP.APS_SYNC_WIP W               
             ON T.LOT_ID = W.LOT_ID                                           
             WHERE position('.P' in T.OPE_NO) = 0                                          
      """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_APC_INHIBIT_LOT_GLOBAL",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_APC_INHIBIT_LOT_GLOBAL")


def InsertLotToEqpgDataView2Temp(duck_db_memory=None, uuid="", current_time="", oracle_conn=None, ETL_Proc_Name="",
                                 used_table_dict=None):
    '''V_SCHE_LOT_TO_EQPG view的数据插入到 temp 表'''
    sql = """
    INSERT INTO  APS_TMP_ETL_RLS_LOT_TO_EQPG
    (TOOLG_ID,LOT_ID,OPE_NO,PROD_ID,PLAN_ID,CSFR_PLAN_ID)
    SELECT G.EQP_G AS TOOLG_ID,
           G.LOT_ID,
           G.OPE_NO,
           G.PRODSPEC_ID AS PROD_ID,
           G.MAINPD_ID AS PLAN_ID,
           SUBSTRINGING(G.MAINPD_ID, 1, POSITION('.' in (G.MAINPD_ID)) -1) AS CSFR_PLAN_ID
    FROM   APS_SYNC_SCHE_LOT_TO_EQPG.APS_SYNC_SCHE_LOT_TO_EQPG AS G
    """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_LOT_TO_EQPG",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_LOT_TO_EQPG")


def InsertLotHistoryDataView2Temp(duck_db_memory=None, uuid="", current_time="", oracle_conn=None, ETL_Proc_Name="",
                                  used_table_dict=None):
    '''V_ETL_LOTHISTORY view的数据插入到 temp 表'''
    sql = """
    INSERT  INTO  APS_TMP_ETL_RLS_LOTHISTORY
    SELECT L.LOT_ID,L.EQP_ID,L.OPE_NO 
    FROM APS_TMP_LOTHISTORY.APS_TMP_LOTHISTORY AS L
    --modify by xiecheng for version up
    WHERE L.OPE_CATEGORY ='OperationComplete' 
      AND L.CLAIM_TIME > DATE_TRUNC('day', CURRENT_DATE) - INTERVAL '30 day'      
      --AND L.EQP_ID LIKE 'P%'  
      AND POSITION('P' IN L.EQP_ID) = 1  
    """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_LOTHISTORY",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_LOTHISTORY")


def InsertResourceFlagDataView2Temp(duck_db_memory=None, uuid="", current_time="", oracle_conn=None, ETL_Proc_Name="",
                                    used_table_dict=None):
    '''V_FRLOT_EQP_RESOURCE_FLAG view的数据插入到 temp 表'''
    sql = """
    INSERT INTO  APS_TMP_ETL_RLS_RESOURCE_FLAG 
     SELECT F.LOT_ID,                        
            F.EQP_ID,                        
            F.OPE_NO,                        
            F.MAINPD_ID,                     
            F.PRODSPEC_ID                    
     FROM APS_SYNC_FRLOT_EQP_RESOURCE_FLAG.APS_SYNC_FRLOT_EQP_RESOURCE_FLAG AS F        
    """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_RESOURCE_FLAG",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_RESOURCE_FLAG")


def InsertBatchDataView2Temp(duck_db_memory=None, uuid="", current_time="", oracle_conn=None, ETL_Proc_Name="",
                             used_table_dict=None):
    '''找到封Batch站点的数据插入到 temp 表'''
    sql = """
    INSERT INTO APS_TMP_ETL_RLS_BATCH_OPE
    (MAINPD_ID,OPE_NO)
    SELECT DISTINCT N.MAINPD_ID,N.OPE_NO
    FROM APS_SYNC_PF_PO_N1.APS_SYNC_PF_PO_N1 AS N
    WHERE  N.BATCH_NAME IS NOT NULL
    """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_BATCH_OPE",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_BATCH_OPE")


def InsertOnhandWip2Temp(duck_db_memory=None, uuid="", current_time="", oracle_conn=None, ETL_Proc_Name="",
                         used_table_dict=None):
    '''Onhand Wip 先插入到 wip temp 表'''
    # Onhand Wip 先插入到 wip temp 表
    sql = """
    INSERT  INTO APS_TMP_ETL_RLS_WIP_V 
    (	LOT_ID,                             
           PRODSPEC_ID,                    
           MAINPD_ID,                      
           OPE_NO,                         
           LOT_TYPE,                       
           LOT_FINISHED_STATE,             
           CASSETE_ID,                     
           WAFER_QTY,                      
           PRIORITY_CLASS,                 
           LOT_PROC_STATE,                 
           LAST_OPE_COMP_TIME,             
           EQP_ID,                         
           OPE_NO_START_TIME,              
           LAST_PROCESS_START_TIME,        
           TECH_ID,                        
           CUSTOMER_ID,                    
           PARENT_LOT_ID,                  
           TRANS_STATE,                    
           BATCH_ID,                       
           SUB_LOT_TYPE                    
    )                                      
    WITH PH_WIP AS(                                                                       
         SELECT * FROM APS_SYNC_WIP.APS_SYNC_WIP                                
         WHERE   OPE_NO LIKE '%.PP%' OR OPE_NO LIKE '%NPR10'     
    ),                                                                                    
    NOT_PH_WIP AS (                                                                       
         SELECT * FROM APS_SYNC_WIP.APS_SYNC_WIP                                
         WHERE  OPE_NO NOT LIKE '%.PP%' AND OPE_NO NOT LIKE '%NPR10'                       
    )                                                                                     
    SELECT W.LOT_ID,                                                                      
           W.PRODSPEC_ID,                                                                 
           W.MAINPD_ID,                                                                   
           W.OPE_NO,                                                                      
           W.LOT_TYPE,                                                                    
           W.LOT_FINISHED_STATE,                                                          
           W.CASSETE_ID,                                                                  
           W.WAFER_QTY,                                                                   
           W.PRIORITY_CLASS,                                                              
           W.LOT_PROC_STATE,                                                              
           W.LAST_OPE_COMP_TIME,                                                          
           W.EQP_ID,                                                                      
           W.OPE_NO_START_TIME,                                                           
           W.LAST_PROCESS_START_TIME,                                                     
           W.TECH_ID,                                                                     
           W.CUSTOMER_ID,                                                                 
           W.PARENT_LOT_ID,                                                               
           W.TRANS_STATE,                                                                 
           W.FLOWBATCH_ID,                                                                
           W.SUB_LOT_TYPE                                                                 
    FROM PH_WIP W                                                                         
    WHERE 1=1                                                                             
    and lot_inv_state <> 'NonProBank'                                                     
    and (SUBSTRING(lot_id,1,1)='N' or (SUBSTRING(lot_id,1,1)='R' AND ope_no='1R.NPR10'))        
    UNION ALL                                                                                 
    SELECT W.LOT_ID,                                                                      
           W.PRODSPEC_ID,                                                                 
           W.MAINPD_ID,                                                                   
           W.OPE_NO,                                                                      
           W.LOT_TYPE,                                                                    
           W.LOT_FINISHED_STATE,                                                          
           W.CASSETE_ID,                                                                  
           W.WAFER_QTY,                                                                   
           W.PRIORITY_CLASS,                                                              
           W.LOT_PROC_STATE,                                                              
           W.LAST_OPE_COMP_TIME,                                                          
           W.EQP_ID,                                                                      
           W.OPE_NO_START_TIME,                                                           
           W.LAST_PROCESS_START_TIME,                                                     
           W.TECH_ID,                                                                     
           W.CUSTOMER_ID,                                                                 
           W.PARENT_LOT_ID,                                                               
           W.TRANS_STATE,                                                                 
           W.FLOWBATCH_ID,                                                                
           W.SUB_LOT_TYPE                                                                 
    FROM NOT_PH_WIP W                                                                     
    """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_WIP_V",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_WIP_V")
    sql = """
    INSERT INTO APS_TMP_ETL_RLS_DYB_RETURN_LOT 
    (                                                                                                                                                   
       LOT_ID, PRODSPEC_ID, CURRENT_OPE_NO, OPENO, DYB_MAINPD_ID, RETURN_MAINPD_ID, RETURN_OPE_NO                                                       
      ,LOT_TYPE, CASSETE_ID, WAFER_QTY, PRIORITY_CLASS, LOT_PROC_STATE, LAST_OPE_COMP_TIME                                                              
      ,EQP_ID, OPE_NO_START_TIME, LAST_PROCESS_START_TIME, TECH_ID, CUSTOMER_ID, PARENT_LOT_ID, TRANS_STATE, BATCH_ID,SUB_LOT_TYPE                      
    )                                                                                                                                                   
    SELECT W.LOT_ID, W.PRODSPEC_ID, W.OPE_NO, A.OPENO, A.DYB_MAINPD_ID, A.MAINPD_ID, A.RETURN_OPE_NO                                                    
          ,W.LOT_TYPE, W.CASSETE_ID, W.WAFER_QTY, W.PRIORITY_CLASS, W.LOT_PROC_STATE, W.LAST_OPE_COMP_TIME                                              
          ,W.EQP_ID, W.OPE_NO_START_TIME, W.LAST_PROCESS_START_TIME, W.TECH_ID, W.CUSTOMER_ID, W.PARENT_LOT_ID, W.TRANS_STATE,W.BATCH_ID,SUB_LOT_TYPE   
    FROM APS_TMP_ETL_RLS_WIP_V W                                                                                                                     
    LEFT JOIN APS_SYNC_FLOW_DYB_RETURN.APS_SYNC_FLOW_DYB_RETURN AS A ON REPLACE(A.LOT_ID, '.', '') = W.LOT_ID AND A.DYB_MAINPD_ID = W.MAINPD_ID  
    WHERE W.MAINPD_ID LIKE 'DYB%'                                                                                                                       
    """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_DYB_RETURN_LOT",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_DYB_RETURN_LOT")
    # 对DYB RECIPE进行整理
    sql = """
         INSERT INTO APS_TMP_ETL_RLS_DYB_RCP_LOAD(                                                                 
        EQP_ID, LOT_ID, M_RECIPE, PF_PD_ID, PRODSPEC_ID, LCRECIPE_ID, OPE_NO, PHYSICAL_RECIPE_ID, RECIPE_ID_C                                                                               
       )                                                                                            
        WITH DYB_RESULT_DATA AS (                                                                   
          SELECT B.EQP_ID,B.LOT_ID,B.M_RECIPE,                                                      
                 B.PF_PD_ID,B.PRODSPEC_ID,                                                          
                 B.OPE_NO,B.LCRECIPE_ID,                                                            
                 SUBSTRING(SUBSTRING(B.M_RECIPE,0,LENGTH(B.M_RECIPE)-3),                                  
                 position('.' in SUBSTRING(B.M_RECIPE,0,LENGTH(B.M_RECIPE)-3))+1) AS PHYSICAL_RECIPE_ID   
          FROM APS_SYNC_PD_RECIPE_EQP_DYB.APS_SYNC_PD_RECIPE_EQP_DYB B                                                                 
        )                                                                                           
        SELECT D.EQP_ID,D.LOT_ID,D.M_RECIPE,                                                        
               D.PF_PD_ID,D.PRODSPEC_ID,D.LCRECIPE_ID,                                              
               D.OPE_NO,D.PHYSICAL_RECIPE_ID,                                                       
               REPLACE(SUBSTRING(D.PHYSICAL_RECIPE_ID,                                                 
                              position(';' in D.PHYSICAL_RECIPE_ID) + 1,                                 
                              LENGTH(D.PHYSICAL_RECIPE_ID) -                                        
                              position(';' in D.PHYSICAL_RECIPE_ID) ),                                    
                       '/',                                                                         
                       '') AS RECIPE_ID_C                                                           
        FROM DYB_RESULT_DATA D                                                                                                                                                                                          
        """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_DYB_RCP_LOAD",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_DYB_RCP_LOAD")
    sql = """
    INSERT INTO APS_TMP_ETL_RLS_DYB_LOT_PO_N1 (                                    
        LOT_ID, PRODSPEC_ID, CURRENT_OPE_NO, DYB_MAINPD_ID, POS_PDID, OPE_NO, OPE_SEQ,
        RETURN_MAINPD_ID, RETURN_OPE_NO, LOT_TYPE, CASSETE_ID, WAFER_QTY, PRIORITY_CLASS, LOT_PROC_STATE,
        LAST_OPE_COMP_TIME, EQP_ID, OPE_NO_START_TIME, LAST_PROCESS_START_TIME, TECH_ID, CUSTOMER_ID, PARENT_LOT_ID,
        TRANS_STATE,BATCH_ID,SUB_LOT_TYPE
        --modify by xiecheng for version up
        ,BATCH_NAME,MAX_BATCH_SIZE
    )                                                               
     SELECT  A.LOT_ID, A.PRODSPEC_ID, A.CURRENT_OPE_NO, A.DYB_MAINPD_ID, B.POS_PDID, B.OPE_NO, B.OPE_SEQ                                          
            , A.RETURN_MAINPD_ID, A.RETURN_OPE_NO, A.LOT_TYPE, A.CASSETE_ID, A.WAFER_QTY, A.PRIORITY_CLASS, A.LOT_PROC_STATE
            , A.LAST_OPE_COMP_TIME, A.EQP_ID, A.OPE_NO_START_TIME, A.LAST_PROCESS_START_TIME, A.TECH_ID, A.CUSTOMER_ID, A.PARENT_LOT_ID
            ,A.TRANS_STATE,A.BATCH_ID,A.SUB_LOT_TYPE
             --modify by xiecheng for version up
            ,B.BATCH_NAME,COALESCE(cast(B.MAX_BATCH_SIZE as decimal),0)*25 AS MAX_BATCH_SIZE                                                                                                                  
     FROM APS_TMP_ETL_RLS_DYB_RETURN_LOT A                                                                                                        
     INNER JOIN APS_SYNC_PF_PO_N1.APS_SYNC_PF_PO_N1 B ON B.OPE_NO = A.CURRENT_OPE_NO AND B.MAINPD_ID = A.DYB_MAINPD_ID
    """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_DYB_LOT_PO_N1",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_DYB_LOT_PO_N1")

    sql = """
    INSERT INTO APS_TMP_ETL_RLS_DYB_LOT_RCP_LOAD (
        LOT_ID, PRODSPEC_ID, CURRENT_OPE_NO, DYB_MAINPD_ID, POS_PDID, OPE_NO, OPE_SEQ,
        RETURN_MAINPD_ID, RETURN_OPE_NO, LOT_TYPE, CASSETE_ID, WAFER_QTY, PRIORITY_CLASS, LOT_PROC_STATE,
        LAST_OPE_COMP_TIME, EQP_ID, OPE_NO_START_TIME, LAST_PROCESS_START_TIME, TECH_ID, CUSTOMER_ID, PARENT_LOT_ID,
        LCRECIPE_ID ,TRANS_STATE ,BATCH_ID,SUB_LOT_TYPE 
        --modify by xiecheng for version up 
        ,BATCH_NAME,M_RECIPE,PHYSICAL_RECIPE_ID,RECIPE_ID_C,MAX_BATCH_SIZE
    )
    SELECT  A.LOT_ID, A.PRODSPEC_ID, A.CURRENT_OPE_NO, A.DYB_MAINPD_ID, A.POS_PDID, A.OPE_NO, A.OPE_SEQ
    , A.RETURN_MAINPD_ID, A.RETURN_OPE_NO, A.LOT_TYPE, A.CASSETE_ID, A.WAFER_QTY, A.PRIORITY_CLASS, A.LOT_PROC_STATE
    , A.LAST_OPE_COMP_TIME, C.EQP_ID, A.OPE_NO_START_TIME, A.LAST_PROCESS_START_TIME, A.TECH_ID, A.CUSTOMER_ID, A.PARENT_LOT_ID
    , C.LCRECIPE_ID ,A.TRANS_STATE ,A.BATCH_ID,A.SUB_LOT_TYPE
      --modify by xiecheng for version up
     ,A.BATCH_NAME,C.M_RECIPE, C.PHYSICAL_RECIPE_ID ,C.RECIPE_ID_C,A.MAX_BATCH_SIZE
    FROM APS_TMP_ETL_RLS_DYB_LOT_PO_N1 A 
    --modify by xiecheng for version up
    LEFT JOIN APS_TMP_ETL_RLS_DYB_RCP_LOAD AS C ON A.LOT_ID = C.LOT_ID
    AND A.POS_PDID = C.PF_PD_ID  AND C.OPE_NO = A.OPE_NO 
    """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_DYB_LOT_RCP_LOAD",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_DYB_LOT_RCP_LOAD")
    sql = """
    INSERT INTO APS_TMP_ETL_RLS_DYB_LOT_Tool (
        LOT_ID, PRODSPEC_ID, CURRENT_OPE_NO, DYB_MAINPD_ID, POS_PDID, OPE_NO,STEP_ID,
        RETURN_MAINPD_ID, RETURN_OPE_NO, LOT_TYPE, CASSETE_ID, WAFER_QTY, PRIORITY_CLASS, LOT_PROC_STATE,
        LAST_OPE_COMP_TIME, EQP_ID, OPE_NO_START_TIME, LAST_PROCESS_START_TIME, TECH_ID, CUSTOMER_ID, PARENT_LOT_ID,
        RECIPE,EQP_G, EQP_CATEGORY, TRANS_STATE,BATCH_ID,SUB_LOT_TYPE
         --modify by xiecheng for version up
        ,BATCH_NAME,M_RECIPE,PHYSICAL_RECIPE_ID,RECIPE_ID_C,LCRECIPE_ID,MAX_BATCH_SIZE
    )
    SELECT  DISTINCT A.LOT_ID, A.PRODSPEC_ID, A.CURRENT_OPE_NO, A.DYB_MAINPD_ID, A.POS_PDID, A.OPE_NO,
        CASE WHEN D.EQP_G IS NULL THEN '.9999.9999' ELSE  PRINTF('.%09.4f', CAST(A.OPE_SEQ AS FLOAT)) END AS STEP_ID
        , A.RETURN_MAINPD_ID, A.RETURN_OPE_NO, A.LOT_TYPE, A.CASSETE_ID, A.WAFER_QTY, A.PRIORITY_CLASS, A.LOT_PROC_STATE
        , A.LAST_OPE_COMP_TIME, A.EQP_ID, A.OPE_NO_START_TIME, A.LAST_PROCESS_START_TIME, A.TECH_ID, A.CUSTOMER_ID, A.PARENT_LOT_ID 
        , A.LCRECIPE_ID AS RECIPE
        ,COALESCE(D.EQP_G,'NoData') AS EQP_G, D.EQP_CATEGORY AS EQP_CATEGORY, A.TRANS_STATE AS TRANS_STATE
        ,A.BATCH_ID AS BATCH_ID,A.SUB_LOT_TYPE
          --modify by xiecheng for version up
        ,A.BATCH_NAME,A.M_RECIPE,A.PHYSICAL_RECIPE_ID,A.RECIPE_ID_C,A.LCRECIPE_ID,A.MAX_BATCH_SIZE
    FROM APS_TMP_ETL_RLS_DYB_LOT_RCP_LOAD A 
    INNER JOIN APS_SYNC_ETL_TOOL.APS_SYNC_ETL_TOOL AS D ON A.EQP_ID = D.EQP_ID
     --modify by xiecheng for version up
    --GROUP BY A.LOT_ID, A.PRODSPEC_ID, A.CURRENT_OPE_NO, A.DYB_MAINPD_ID, A.POS_PDID, A.OPE_NO, A.OPE_SEQ
    -- , A.RETURN_MAINPD_ID, A.RETURN_OPE_NO, A.LOT_TYPE, A.CASSETE_ID, A.WAFER_QTY, A.PRIORITY_CLASS, A.LOT_PROC_STATE
    --, A.LAST_OPE_COMP_TIME, A.EQP_ID, A.OPE_NO_START_TIME, A.LAST_PROCESS_START_TIME, A.TECH_ID, A.CUSTOMER_ID, A.PARENT_LOT_ID
    """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_DYB_LOT_Tool",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_DYB_LOT_Tool")
    sql = """ 
    INSERT INTO APS_TMP_ETL_RLS_DYB_LOT (
        LOT_ID, PRODSPEC_ID, CURRENT_OPE_NO, OPENO, DYB_MAINPD_ID, RETURN_MAINPD_ID, RETURN_OPE_NO,
        LOT_TYPE, CASSETE_ID, WAFER_QTY, PRIORITY_CLASS, LOT_PROC_STATE, LAST_OPE_COMP_TIME, EQP_ID ,
        OPE_NO_START_TIME, LAST_PROCESS_START_TIME, TECH_ID, CUSTOMER_ID, PARENT_LOT_ID, 
        POS_PDID, STEP_ID, EQP_G, PRODG_ID, PRODG_TECH, RECIPE, TOOLG_TYPE, TRANS_STATE,BATCH_ID,SUB_LOT_TYPE
         --modify by xiecheng for version up
         ,BATCH_NAME,M_RECIPE,PHYSICAL_RECIPE_ID,RECIPE_ID_C,LCRECIPE_ID,MAX_BATCH_SIZE
    )
    WITH PRODG AS (
        SELECT MAX(PRODG1) AS PRODG_ID, MAX(GROUP_TECH) AS PRODG_TECH, PRODSPEC_ID
        FROM APS_SYNC_PRODUCT.APS_SYNC_PRODUCT
        GROUP BY PRODSPEC_ID
    )
    SELECT D.LOT_ID, D.PRODSPEC_ID, D.CURRENT_OPE_NO, D.OPE_NO, D.DYB_MAINPD_ID, D.RETURN_MAINPD_ID, D.RETURN_OPE_NO
    ,D.LOT_TYPE, D.CASSETE_ID, D.WAFER_QTY, D.PRIORITY_CLASS, D.LOT_PROC_STATE, D.LAST_OPE_COMP_TIME, D.EQP_ID
    ,D.OPE_NO_START_TIME, D.LAST_PROCESS_START_TIME, D.TECH_ID, D.CUSTOMER_ID, D.PARENT_LOT_ID
    ,D.POS_PDID,  D.STEP_ID, D.EQP_G, P.PRODG_ID, P.PRODG_TECH, D.RECIPE
    ,   CASE WHEN (SUBSTRING(SUBSTRING(d.current_ope_no, POSITION('.' IN (d.current_ope_no))+1),2,1)='Q' AND d.EQP_G IN ('PK_KrF','PH_ArF','PU_I-Line'))
            THEN 'M'
        ELSE CASE WHEN D.EQP_CATEGORY IN ('Internal Buffer','Process','Wafer Bonding')  THEN 'P'
                  WHEN D.EQP_CATEGORY = 'Measurement' THEN 'M'
                  ELSE ''
             END
         END AS TOOLG_TYPE
    ,D.TRANS_STATE, D.BATCH_ID,D.SUB_LOT_TYPE
     --modify by xiecheng for version up
     ,D.BATCH_NAME,D.M_RECIPE,D.PHYSICAL_RECIPE_ID,D.RECIPE_ID_C,D.LCRECIPE_ID,D.MAX_BATCH_SIZE 
    FROM APS_TMP_ETL_RLS_DYB_LOT_Tool D
    LEFT JOIN PRODG P ON D.PRODSPEC_ID = P.PRODSPEC_ID 
    """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_DYB_LOT",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_DYB_LOT")
    sql = """
    INSERT INTO APS_TMP_ETL_RLS_WIP_FLOW (
        PROD_ID, PRODSPEC_ID,PLAN_ID,MAINPD_ID,PLAN_NO,WIP_OPE_NO,
        OPE_NO,STEP_ID,TOOLG_ID, PRODG_ID, PRODG_TECH,TOOLG_TYPE 
    )
    SELECT F.PROD_ID, V.PRODSPEC_ID,
           F.PLAN_ID,V.MAINPD_ID,
           F.PLAN_NO,
           F.OPE_NO AS WIP_OPE_NO,V.OPE_NO,
           F.STEP_ID,
           F.TOOLG_ID, F.PRODG_ID, F.PRODG_TECH,
           F.TOOLG_TYPE
    FROM APS_TMP_ETL_RLS_WIP_V  V 
    LEFT JOIN APS_ETL_FLOW.APS_ETL_FLOW AS F ON V.PRODSPEC_ID = F.PROD_ID
    AND V.MAINPD_ID = F.PLAN_ID
    AND V.OPE_NO = F.OPE_NO 
    WHERE V.MAINPD_ID NOT LIKE  'DYB%'
    """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_WIP_FLOW",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_WIP_FLOW")
    sql = """
    INSERT INTO APS_TMP_ETL_RLS_WIP_PO_N1 (
        PROD_ID, PRODSPEC_ID,PLAN_ID,MAINPD_ID,PLAN_NO,WIP_OPE_NO,
        OPE_NO,STEP_ID,TOOLG_ID, PRODG_ID, PRODG_TECH,TOOLG_TYPE,POS_PDID 
    )
    SELECT V.PROD_ID, 
            V.PRODSPEC_ID,
            V.PLAN_ID,V.MAINPD_ID,
            V.PLAN_NO,
            V.WIP_OPE_NO,V.OPE_NO,
            V.STEP_ID,
            V.TOOLG_ID, V.PRODG_ID, V.PRODG_TECH, 
            V.TOOLG_TYPE,B.POS_PDID
    FROM APS_TMP_ETL_RLS_WIP_FLOW  V 
    LEFT JOIN APS_SYNC_PF_PO_N1.APS_SYNC_PF_PO_N1 AS B ON B.OPE_NO = V.OPE_NO AND B.MAINPD_ID = V.MAINPD_ID
    """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_WIP_PO_N1",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_WIP_PO_N1")
    sql = """
    INSERT INTO APS_TMP_ETL_RLS_WIP_RCP_LOAD (
        PROD_ID, PLAN_ID, PLAN_NO, OPE_NO, STEP_ID, RECIPE,
        TOOLG_ID, PRODG_ID, PRODG_TECH, STEP_TYPE,TOOLG_TYPE
    )
    SELECT COALESCE(V.PROD_ID, V.PRODSPEC_ID) AS PROD_ID,
           COALESCE(V.PLAN_ID,V.MAINPD_ID) AS PLAN_ID,
           COALESCE(V.PLAN_NO,1) AS PLAN_NO,
           COALESCE(V.WIP_OPE_NO,V.OPE_NO) AS OPE_NO,
           COALESCE(V.STEP_ID,'.9999.9999') AS STEP_ID, C.LCRECIPE_ID AS RECIPE,
           COALESCE(V.TOOLG_ID,'NoData') AS TOOLG_ID, V.PRODG_ID, V.PRODG_TECH,
           CASE WHEN SUBSTRING(V.MAINPD_ID,1,1) = 'B' THEN 'I'
           ELSE (CASE WHEN SUBSTRING(V.MAINPD_ID,1,1) = 'Y'
            THEN 'R' ELSE 'N' END) END AS STEP_TYPE,
           V.TOOLG_TYPE
    FROM APS_TMP_ETL_RLS_WIP_PO_N1  V 
    LEFT JOIN APS_SYNC_PD_RECIPE_EQP_ALL.APS_SYNC_PD_RECIPE_EQP_ALL C ON V.POS_PDID = C.PD_ID AND C.PRODSPEC_ID = V.PRODSPEC_ID
    """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_WIP_RCP_LOAD",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_WIP_RCP_LOAD")

    sql = """
    INSERT INTO APS_TMP_ETL_RLS_WIP 
    (                                                                                        
       PARENT_ID,LOT_ID,PRODSPEC_ID ,PLAN_ID,TARGET_PLAN_ID,OPE_NO,OPE_SEQ,TARGET_OPE_NO,       
       TARGET_OPE_SEQ,TARGET_TOOLG_ID,LOT_TYPE,LOT_FINISHED_STATE,FOUP_ID,                   
       WAFER_QTY,LOT_STATUS,FLOW_RECIPE,TRANS_STATE,BATCH_ID,SUB_LOT_TYPE,CREATE_TIME        
    )                                                                                         
     WITH NORMAL_FLOW AS (                                                                                                           
        SELECT * FROM APS_TMP_ETL_RLS_WIP_RCP_LOAD LF WHERE LF.STEP_TYPE = 'N'                                                             
     ),                                                                                                                              
     REWORK_SUB_FLOW AS (                                                                                                            
        SELECT * FROM APS_TMP_ETL_RLS_WIP_RCP_LOAD LF WHERE LF.STEP_TYPE <> 'N'                                                            
     ),                                                                                                                              
     WIP AS (                                                                                                                        
          SELECT W.LOT_ID,                                                                                                           
              W.PRODSPEC_ID,                                                                                                         
              W.MAINPD_ID,                                                                                                           
              F.PLAN_ID AS TARGET_PLAN_ID,                                                                                           
              W.OPE_NO,                                                                                                              
              F.STEP_ID,                                                                                                             
              W.OPE_NO AS TARGET_OPE_NO,                                                                                             
              F.STEP_ID AS TARGET_STEP_ID,                                                                                           
              F.TOOLG_ID AS TARGET_TOOLG_ID,                                                                                         
              W.LOT_TYPE,                                                                                                            
              W.LOT_FINISHED_STATE,                                                                                                  
              W.CASSETE_ID,                                                                                                          
              W.WAFER_QTY,                                                                                                           
              W.LOT_PROC_STATE,                                                                                                      
              F.RECIPE,                                                                                                              
              W.TRANS_STATE, W.BATCH_ID,W.SUB_LOT_TYPE                                                                               
         FROM APS_TMP_ETL_RLS_WIP_V W                                                                                             
         INNER JOIN  NORMAL_FLOW F ON W.PRODSPEC_ID = F.PROD_ID                                                                      
                                  AND W.MAINPD_ID = F.PLAN_ID                                                                        
                                  AND W.OPE_NO = F.OPE_NO                                                                            
         UNION ALL                                                                                                                       
         SELECT W.LOT_ID,                                                                                                            
                W.PRODSPEC_ID,                                                                                                       
                W.MAINPD_ID,                                                                                                         
                RSF.PLAN_ID AS TARGET_PLAN_ID,                                                                                       
                W.OPE_NO,                                                                                                            
                RSF.STEP_ID,                                                                                                         
                W.OPE_NO AS TARGET_OPE_NO,                                                                                           
                RSF.STEP_ID AS TARGET_STEP_ID,                                                                                       
                RSF.TOOLG_ID AS TARGET_TOOLG_ID,                                                                                     
                W.LOT_TYPE,                                                                                                          
                W.LOT_FINISHED_STATE,                                                                                                
                W.CASSETE_ID,                                                                                                        
                W.WAFER_QTY,                                                                                                         
                W.LOT_PROC_STATE,                                                                                                    
                RSF.RECIPE,                                                                                                          
                W.TRANS_STATE, W.BATCH_ID,W.SUB_LOT_TYPE                                                                             
         FROM APS_TMP_ETL_RLS_WIP_V W                                                                                             
         INNER JOIN REWORK_SUB_FLOW RSF ON W.PRODSPEC_ID = RSF.PROD_ID                                                               
                                        AND W.MAINPD_ID = RSF.PLAN_ID                                                                
                                        AND W.OPE_NO = RSF.OPE_NO                                                                    
         UNION ALL                                                                                                                                                                                                                                          
          SELECT W.LOT_ID,                                                                                                            
                 W.PRODSPEC_ID,                                                                                                   
                 W.DYB_MAINPD_ID,                                                                                                 
                 LF.PLAN_ID AS TARGET_PLAN_ID,                                                                                    
                 W.CURRENT_OPE_NO,                                                                                                
                 W.STEP_ID,                                                                                                       
                 LF.OPE_NO AS TARGET_OPE_NO,                                                                                      
                 LF.STEP_ID AS TARGET_STEP_ID,                                                                                    
                 LF.TOOLG_ID AS TARGET_TOOLG_ID,                                                                                  
                 W.LOT_TYPE,                                                                                                      
                 '' AS LOT_FINISHED_STATE,                                                                                        
                    W.CASSETE_ID,                                                                                                    
                 W.WAFER_QTY,                                                                                                     
                 W.LOT_PROC_STATE,                                                                                                
                 LF.RECIPE,                                                                                                       
                    W.TRANS_STATE, W.BATCH_ID,W.SUB_LOT_TYPE                                                                         
          FROM APS_TMP_ETL_RLS_DYB_LOT W                                                                                           
          INNER JOIN APS_TMP_ETL_RLS_WIP_RCP_LOAD LF ON LF.PROD_ID = W.PRODSPEC_ID                                                          
                     AND LF.PLAN_ID = W.RETURN_MAINPD_ID                                                                  
                     AND LF.OPE_NO = W.RETURN_OPE_NO                                                                      
                     AND LF.TOOLG_TYPE = 'P'                                                                              
         WHERE W.EQP_G <> 'NoData'                                                                                                   
        )                                                                                                                            
        SELECT '{uuid}', W.*,                                                                                                  
               '{startTime}'                                                                                               
     FROM WIP W                                                                                                                      
    """.format(uuid=uuid, startTime=current_time)
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_WIP",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_WIP")


def InsertStockerStateDataView2Temp(duck_db_memory=None, uuid="", current_time="", oracle_conn=None, ETL_Proc_Name="",
                                    used_table_dict=None):
    sql = """
          INSERT INTO APS_TMP_ETL_RLS_TRANS_STATE(   
           LOT_ID, MAINPD_ID, PRODSPEC_ID, OPE_NO                   
           )                                         
            SELECT L.LOT_ID,                        
                   L.MAINPD_ID,                     
                   L.PRODSPEC_ID,                   
                   L.OPE_NO                         
            FROM APS_SYNC_MM_FRSTK.APS_SYNC_MM_FRSTK F                       
            INNER JOIN APS_SYNC_LOT_LOCATION.APS_SYNC_LOT_LOCATION L             
            ON L.FOUP_STATION_ID = F.STK_ID            
            --AND L.PARTCODE= ' + locationPartCode + '         
            INNER JOIN APS_TMP_ETL_RLS_WIP W         
            ON L.LOT_ID = W.LOT_ID                  
            WHERE F.E10_STATE NOT IN ('SBY','PRD')  
           -- AND F.PARTCODE= ' + frstkPartCode + '  
        """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_TRANS_STATE",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_TRANS_STATE")


def SummaryNormalFlowTragetWip(duck_db_memory=None, uuid="", current_time="", oracle_conn=None, ETL_Proc_Name="",
                               used_table_dict=None):
    sql = """
    INSERT INTO APS_TMP_ETL_RLS_WIP_COMING_DATE (
        PARENT_ID,LOT_ID,PRODSPEC_ID,PLAN_ID,TARGET_PLAN_ID,OPE_NO,OPE_SEQ,TARGET_OPE_NO,
        TARGET_OPE_SEQ,TARGET_TOOLG_ID ,LOT_TYPE,LOT_FINISHED_STATE,FOUP_ID,WAFER_QTY,
        LOT_STATUS,FLOW_RECIPE,CREATE_TIME,TRANS_STATE,BATCH_ID,SUB_LOT_TYPE
    )
    SELECT PARENT_ID,LOT_ID,PRODSPEC_ID,PLAN_ID,TARGET_PLAN_ID,OPE_NO,OPE_SEQ,TARGET_OPE_NO,
        TARGET_OPE_SEQ,TARGET_TOOLG_ID ,LOT_TYPE,LOT_FINISHED_STATE,FOUP_ID,WAFER_QTY,
        LOT_STATUS,FLOW_RECIPE,CREATE_TIME,TRANS_STATE,BATCH_ID,SUB_LOT_TYPE
    FROM APS_TMP_ETL_RLS_WIP W
    WHERE W.LOT_TYPE <> 'Equipment Monitor'  AND W.TARGET_TOOLG_ID <> 'NoData'
    """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_WIP_COMING_DATE",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_WIP_COMING_DATE")

    sql = """
    INSERT INTO APS_TMP_ETL_RLS_WIP_COMING_FLOW_DATE (                                         
        PARENT_ID,LOT_ID,STEP_ID,WIP_OPE_NO,TARGET_STEP_ID,TARGET_OPE_NO,TARGET_TOOLG_ID,
        PRODSPEC_ID,PLAN_ID,TARGET_PLAN_ID,LOT_TYPE,FOUP_ID,WAFER_QTY ,
        LOT_STATUS,FLOW_RECIPE,TRANS_STATE,BATCH_ID,SUB_LOT_TYPE ,RN                                                              
    )                                                                                    
     WITH WIP AS (                                                                                                               
            SELECT W.PARENT_ID                                                                                               
                  ,W.LOT_ID                                                                                                  
                  ,W.OPE_SEQ AS STEP_ID                                                                                      
                  ,W.OPE_NO AS WIP_OPE_NO                                                                                    
                  ,TF.STEP_ID AS TARGET_STEP_ID                                                                              
                  ,TF.OPE_NO  AS TARGET_OPE_NO                                                                               
                  ,TF.TOOLG_ID AS TARGET_TOOLG_ID                                                                            
                  ,W.PRODSPEC_ID                                                                                             
                  ,W.PLAN_ID                                                                                                 
                  ,TF.PLAN_ID AS TARGET_PLAN_ID                                                                              
                  ,W.LOT_TYPE                                                                                                
                  ,W.FOUP_ID                                                                                                 
                  ,W.WAFER_QTY                                                                                               
                  ,W.LOT_STATUS                                                                                              
                  ,TF.RECIPE AS FLOW_RECIPE                                                                                  
                  ,W.TRANS_STATE                                                                                             
                  ,MAX(W.BATCH_ID) AS BATCH_ID                                                                               
                  ,MAX(W.SUB_LOT_TYPE) AS SUB_LOT_TYPE                                                                       
            FROM  APS_TMP_ETL_RLS_WIP_COMING_DATE  W                                                                          
            INNER JOIN  APS_ETL_FLOW.APS_ETL_FLOW TF ON  W.PRODSPEC_ID = TF.PROD_ID    
                                               AND W.PLAN_ID = TF.PLAN_ID                                                    
                                               AND TF.TOOLG_TYPE = 'P'                                                       
            WHERE 1=1                                                                                                        
            GROUP BY W.PARENT_ID                                                                                             
                  ,W.LOT_ID                                                                                                  
                  ,W.OPE_SEQ                                                                                                 
                  ,W.OPE_NO                                                                                                  
                  ,TF.STEP_ID                                                                                                
                  ,TF.OPE_NO                                                                                                 
                  ,TF.TOOLG_ID                                                                                               
                  ,W.PRODSPEC_ID                                                                                             
                  ,W.PLAN_ID                                                                                                 
                  ,TF.PLAN_ID                                                                                                
                  ,W.LOT_TYPE                                                                                                
                  ,W.FOUP_ID                                                                                                 
                  ,W.WAFER_QTY                                                                                               
                  ,W.LOT_STATUS                                                                                                        
                  ,TF.RECIPE                                                                                                 
                  ,W.TRANS_STATE                                                                                                
      ),                                                                                                                     
      WIP_RESULT AS (                                                                                                        
            SELECT A.PARENT_ID,LOT_ID,STEP_ID,WIP_OPE_NO,TARGET_STEP_ID,TARGET_OPE_NO,TARGET_TOOLG_ID ,
        PRODSPEC_ID,PLAN_ID,TARGET_PLAN_ID,LOT_TYPE,FOUP_ID,WAFER_QTY ,
        LOT_STATUS,FLOW_RECIPE,TRANS_STATE,BATCH_ID,SUB_LOT_TYPE                                                                               
                    , ROW_NUMBER() OVER(PARTITION BY A.LOT_ID, A.PLAN_ID, A.PRODSPEC_ID, A.WIP_OPE_NO ORDER BY A.TARGET_STEP_ID) AS RN
            FROM  WIP A                                                                                                      
            WHERE A.TARGET_STEP_ID > A.STEP_ID                                                                               
      )                                                                                                                      
     SELECT A.PARENT_ID,LOT_ID,STEP_ID,WIP_OPE_NO,TARGET_STEP_ID,TARGET_OPE_NO,TARGET_TOOLG_ID ,
        PRODSPEC_ID,PLAN_ID,TARGET_PLAN_ID,LOT_TYPE,FOUP_ID,WAFER_QTY ,
        LOT_STATUS,FLOW_RECIPE,TRANS_STATE,BATCH_ID,SUB_LOT_TYPE, A.RN                                                                                
     FROM  WIP_RESULT A                                                                                                      
     WHERE A.RN < 7                                                                                                          
    """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_WIP_COMING_FLOW_DATE",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_WIP_COMING_FLOW_DATE")
    sql = """
    Insert  Into APS_TMP_ETL_RLS_WIP                                                                                           
     WITH TOOL_MODULE AS(                            
          SELECT EQP_G                          
          FROM APS_SYNC_ETL_TOOL.APS_SYNC_ETL_TOOL                       
          WHERE REAL_MODULE = 'WET'             
          GROUP BY EQP_G                        
     ),                                         
     THRID_DATA AS (                                                                                                                  
        SELECT  DISTINCT W.LOT_ID                                                                                                             
        FROM APS_TMP_ETL_RLS_WIP_COMING_FLOW_DATE W                                                                                   
        INNER JOIN TOOL_MODULE TM                                                                                                     
        ON TM.EQP_G = W.TARGET_TOOLG_ID                                                                                               
        WHERE 1=1                                                                                                                     
        AND W.RN = 1 OR W.RN = 2 OR W.RN = 3                                                                                          
     )                                                                                                                                
     SELECT  WIP.PARENT_ID                                                                                                            
         ,WIP.LOT_ID                                                                                                                  
         ,WIP.PRODSPEC_ID                                                                                                             
         ,WIP.PLAN_ID                                                                                                                 
         ,WIP.TARGET_PLAN_ID                                                                                                          
         ,WIP.WIP_OPE_NO                                                                                                              
         ,WIP.STEP_ID                                                                                                                 
         ,WIP.TARGET_OPE_NO                                                                                                           
         ,WIP.TARGET_STEP_ID                                                                                                          
         ,WIP.TARGET_TOOLG_ID                                                                                                         
         ,WIP.LOT_TYPE                                                                                                                
         ,'' AS LOT_FINISHED_STATE                                                                                                    
         ,WIP.FOUP_ID                                                                                                                 
         ,WIP.WAFER_QTY                                                                                                               
         ,WIP.LOT_STATUS                                                                                                              
         ,WIP.FLOW_RECIPE                                                                                                                         
         ,'{current_time}'                                                                                                     
         ,TRANS_STATE                                                                                                                 
         ,BATCH_ID,SUB_LOT_TYPE                                                                                                       
     FROM APS_TMP_ETL_RLS_WIP_COMING_FLOW_DATE WIP                                                                                    
     WHERE 1=1                                                                                                                        
     AND WIP.RN < 4                                                                                                                   
     UNION ALL                                                                                                                        
     SELECT  WIP.PARENT_ID                                                                                                            
         ,WIP.LOT_ID                                                                                                                  
         ,WIP.PRODSPEC_ID                                                                                                             
         ,WIP.PLAN_ID                                                                                                                 
         ,WIP.TARGET_PLAN_ID                                                                                                          
         ,WIP.WIP_OPE_NO                                                                                                              
         ,WIP.STEP_ID                                                                                                                 
         ,WIP.TARGET_OPE_NO                                                                                                           
         ,WIP.TARGET_STEP_ID                                                                                                          
         ,WIP.TARGET_TOOLG_ID                                                                                                         
         ,WIP.LOT_TYPE                                                                                                                
         ,'' AS LOT_FINISHED_STATE                                                                                                    
         ,WIP.FOUP_ID                                                                                                                 
         ,WIP.WAFER_QTY                                                                                                               
         ,WIP.LOT_STATUS                                                                                                              
         ,WIP.FLOW_RECIPE                                                                                                                         
         ,'{current_time}'                                                                                                  
         ,TRANS_STATE                                                                                                                 
         ,BATCH_ID,SUB_LOT_TYPE                                                                                                       
     FROM APS_TMP_ETL_RLS_WIP_COMING_FLOW_DATE WIP                                                                                    
     INNER JOIN THRID_DATA D                                                                                                          
     ON D.LOT_ID = WIP.LOT_ID                                                                                                         
     WHERE 1=1                                                                                                                        
     AND WIP.RN >= 4 AND WIP.RN <= 6                                                                                                  
    """.format(current_time=current_time)
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_WIP",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_WIP")


def InsertEqpRcpInhibit2Temp(duck_db_memory=None, uuid="", current_time="", oracle_conn=None, ETL_Proc_Name="",
                             used_table_dict=None):
    # 产品 + 机台 + RECIPE都不为 * ----总数量44124
    sql = """
          INSERT INTO APS_TMP_ETL_RLS_EQPRCP_INHIBIT1                       
             SELECT PRODUCT_ID,EQP_ID,RECIPE_ID,'*','*'                                 
             FROM APS_SYNC_EQP_RCP_INHIBIT.APS_SYNC_EQP_RCP_INHIBIT I                  
             WHERE I.PRODUCT_ID <> '*'                                                
             AND I.EQP_ID <> '*'                                                      
             AND I.RECIPE_ID <> '*'  
    """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_EQPRCP_INHIBIT1",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_EQPRCP_INHIBIT1")
    # 机台+RECIPE都不为*  ----总数量126724
    sql = """
            INSERT INTO APS_TMP_ETL_RLS_EQPRCP_INHIBIT2                       
             SELECT '*',EQP_ID,RECIPE_ID,'*','*'                                      
             FROM APS_SYNC_EQP_RCP_INHIBIT.APS_SYNC_EQP_RCP_INHIBIT I                  
             WHERE I.PRODUCT_ID = '*'                                                 
             AND I.EQP_ID <> '*'                                                      
             AND I.SUB_LOT_TYPE IS NULL                                               
             AND I.RECIPE_ID <> '*'   
       """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_EQPRCP_INHIBIT2",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_EQPRCP_INHIBIT2")

    # 除了1和2 case 还是512
    sql = """
              INSERT INTO APS_TMP_ETL_RLS_EQPRCP_INHIBIT3                               
              SELECT I.PRODUCT_ID,I.EQP_ID,I.RECIPE_ID,I.REASON_CODE,COALESCE(I.SUB_LOT_TYPE,'*') AS SUB_LOT_TYPE     
              FROM APS_SYNC_EQP_RCP_INHIBIT.APS_SYNC_EQP_RCP_INHIBIT I                         
              WHERE 1=1                                            
              AND NOT EXISTS (SELECT 1 FROM APS_TMP_ETL_RLS_EQPRCP_INHIBIT1 N      
              WHERE N.PRODUCT_ID = I.PRODUCT_ID AND N.EQP_ID = I.EQP_ID                       
              AND N.RECIPE_ID = I.RECIPE_ID)                                                  
              AND NOT EXISTS (SELECT 1 FROM APS_TMP_ETL_RLS_EQPRCP_INHIBIT2 N2     
              WHERE  N2.EQP_ID = I.EQP_ID                                                     
              AND N2.RECIPE_ID = I.RECIPE_ID)  
       """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_EQPRCP_INHIBIT3",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_EQPRCP_INHIBIT3")
    # 从case3再分出来
    sql = """
           INSERT INTO APS_TMP_ETL_RLS_EQPRCP_INHIBIT4                           
              SELECT '*',I.EQP_ID,'*','*',I.SUB_LOT_TYPE                                                
              FROM APS_TMP_ETL_RLS_EQPRCP_INHIBIT3 I                           
              WHERE EQP_ID <> '*' AND I.SUB_LOT_TYPE <> '*'                               
              AND I.PRODUCT_ID='*' AND I.RECIPE_ID='*'  
       """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_EQPRCP_INHIBIT4",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_EQPRCP_INHIBIT4")

    sql = """
                INSERT INTO APS_TMP_ETL_RLS_EQPRCP_INHIBIT5                           
              SELECT '*','*',I.RECIPE_ID,'*',I.SUB_LOT_TYPE                               
              FROM APS_TMP_ETL_RLS_EQPRCP_INHIBIT3 I                           
              WHERE EQP_ID = '*' AND I.SUB_LOT_TYPE <> '*'                                
              AND I.PRODUCT_ID='*' AND I.RECIPE_ID <> '*' 
       """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_EQPRCP_INHIBIT5",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_EQPRCP_INHIBIT5")

    sql = """
            INSERT INTO  APS_TMP_ETL_RLS_EQPRCP_INHIBIT6                           
              SELECT '*',I.EQP_ID,I.RECIPE_ID,'*',I.SUB_LOT_TYPE                          
              FROM APS_TMP_ETL_RLS_EQPRCP_INHIBIT3 I                           
              WHERE EQP_ID <> '*' AND I.SUB_LOT_TYPE <> '*'                               
              AND I.RECIPE_ID <> '*'                                                      
              AND I.PRODUCT_ID = '*'  
       """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_EQPRCP_INHIBIT6",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_EQPRCP_INHIBIT6")

    sql = """
              INSERT INTO APS_TMP_ETL_RLS_EQPRCP_INHIBIT7                               
              SELECT I.PRODUCT_ID,I.EQP_ID,I.RECIPE_ID,I.REASON_CODE,I.SUB_LOT_TYPE                              
              FROM APS_TMP_ETL_RLS_EQPRCP_INHIBIT3 I                               
              WHERE 1=1                                                                       
              AND NOT EXISTS (SELECT 1 FROM APS_TMP_ETL_RLS_EQPRCP_INHIBIT4 N4     
              WHERE N4.EQP_ID = I.EQP_ID                                                      
              AND N4.SUB_LOT_TYPE = I.SUB_LOT_TYPE)                                           
              AND NOT EXISTS (SELECT 1 FROM APS_TMP_ETL_RLS_EQPRCP_INHIBIT5 N5     
              WHERE  N5.SUB_LOT_TYPE = I.SUB_LOT_TYPE                                         
              AND N5.RECIPE_ID = I.RECIPE_ID)                                                 
              AND NOT EXISTS (SELECT 1 FROM APS_TMP_ETL_RLS_EQPRCP_INHIBIT6 N6     
              WHERE  N6.EQP_ID = I.EQP_ID AND N6.SUB_LOT_TYPE = I.SUB_LOT_TYPE                
              AND N6.RECIPE_ID = I.RECIPE_ID)    
       """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_EQPRCP_INHIBIT7",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_EQPRCP_INHIBIT7")


def getAllComingMeasureWipData(duck_db_memory=None, uuid="", current_time="", oracle_conn=None, ETL_Proc_Name="",
                               used_table_dict=None):
    sql = """
            INSERT INTO APS_TMP_ETL_RLS_WIP_MEASURE_COMING_DATE(                               
           PARENT_ID, LOT_ID, PRODSPEC_ID,PLAN_ID,TARGET_PLAN_ID,OPE_NO,OPE_SEQ,
                   TARGET_OPE_NO, TARGET_OPE_SEQ, TARGET_TOOLG_ID, LOT_TYPE, LOT_FINISHED_STATE, FOUP_ID,
                   WAFER_QTY, LOT_STATUS, FLOW_RECIPE, CREATE_TIME, TRANS_STATE, BATCH_ID, SUB_LOT_TYPE                                                  
          )                                                               
           WITH WIP_DATA AS (                                                                          
               SELECT W.*,                                                                             
                      ROW_NUMBER() OVER(PARTITION BY W.LOT_ID ORDER BY W.TARGET_OPE_SEQ DESC) RN       
               from APS_TMP_ETL_RLS_WIP W                                                              
           )                                                                                           
           SELECT D.PARENT_ID,                                                                         
                  D.LOT_ID,                                                                            
                  D.PRODSPEC_ID,                                                                       
                  D.PLAN_ID,                                                                           
                  D.TARGET_PLAN_ID,                                                                    
                  D.OPE_NO,                                                                            
                  D.OPE_SEQ,                                                                           
                  F.OPE_NO AS TARGET_OPE_NO,                                                           
                  F.STEP_ID AS TARGET_OPE_SEQ,                                                         
                  F.TOOLG_ID AS TARGET_TOOLG_ID,                                                       
                  D.LOT_TYPE,                                                                          
                  D.LOT_FINISHED_STATE,                                                                
                  D.FOUP_ID,                                                                           
                  D.WAFER_QTY,                                                                         
                  D.LOT_STATUS,                                                                        
                  D.FLOW_RECIPE,                                                                       
                  D.CREATE_TIME,                                                                       
                  D.TRANS_STATE,                                                                       
                  D.BATCH_ID,                                                                          
                  D.SUB_LOT_TYPE                                                                       
           FROM WIP_DATA D                                                                             
           INNER JOIN APS_ETL_FLOW.APS_ETL_FLOW F                                          
           ON F.TOOLG_TYPE ='M'                  
           AND F.PLAN_ID = D.PLAN_ID                                                                   
           AND F.PROD_ID = D.PRODSPEC_ID                                                               
           AND F.STEP_ID >= D.OPE_SEQ                                                                   
           AND F.STEP_ID < D.TARGET_OPE_SEQ                                                            
           WHERE D.RN = 1                                                                              
         """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_WIP_MEASURE_COMING_DATE",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_WIP_MEASURE_COMING_DATE")


def getWipDataToPoN1Data(duck_db_memory=None, uuid="", current_time="", oracle_conn=None, ETL_Proc_Name="",
                         used_table_dict=None):
    sql = """
              INSERT INTO APS_TMP_ETL_RLS_MEASURE_COMING_PO_N1(                                
                   PARENT_ID, LOT_ID, PRODSPEC_ID,PLAN_ID,TARGET_PLAN_ID,OPE_NO,OPE_SEQ,
                   TARGET_OPE_NO, TARGET_OPE_SEQ, TARGET_TOOLG_ID, LOT_TYPE, LOT_FINISHED_STATE, FOUP_ID,
                   WAFER_QTY, LOT_STATUS, FLOW_RECIPE, CREATE_TIME, TRANS_STATE, BATCH_ID, SUB_LOT_TYPE,POS_PDID,MPD_ID                                                  
            )                                                                
             SELECT D.PARENT_ID,                                                                                                      
                   D.LOT_ID,                                                                             
                   D.PRODSPEC_ID,                                                                        
                   D.PLAN_ID,                                                                            
                   D.TARGET_PLAN_ID,                                                                     
                   D.OPE_NO,                                                                             
                   D.OPE_SEQ,                                                                            
                   D.TARGET_OPE_NO,                                                            
                   D.TARGET_OPE_SEQ,                                                          
                   D.TARGET_TOOLG_ID,                                                        
                   D.LOT_TYPE,                                                                           
                   D.LOT_FINISHED_STATE,                                                                 
                   D.FOUP_ID,                                                                            
                   D.WAFER_QTY,                                                                          
                   D.LOT_STATUS,                                                                         
                   D.FLOW_RECIPE,                                                                        
                   D.CREATE_TIME,                                                                        
                   D.TRANS_STATE,                                                                        
                   D.BATCH_ID,                                           
                   D.SUB_LOT_TYPE,                                       
                   N.POS_PDID,                                           
                   SUBSTRING(D.PLAN_ID, 1, position('.' in D.PLAN_ID)-1) AS MPD_ID      
             FROM APS_TMP_ETL_RLS_WIP_MEASURE_COMING_DATE D                            
             INNER JOIN APS_SYNC_PF_PO_N1.APS_SYNC_PF_PO_N1 N       
             ON N.MAINPD_ID = D.PLAN_ID                                  
             AND N.OPE_NO = D.TARGET_OPE_NO                                                                                                                
       """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_WIP_MEASURE_COMING_DATE",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_MEASURE_COMING_PO_N1")


def getWipDataToPfRecipeEqpData(duck_db_memory=None, uuid="", current_time="", oracle_conn=None, ETL_Proc_Name="",
                                used_table_dict=None):
    sql = """
         INSERT INTO APS_TMP_ETL_RLS_MEASURE_COMING_RECIPE(                               
       PARENT_ID, LOT_ID, PRODSPEC_ID,PLAN_ID,TARGET_PLAN_ID,OPE_NO,OPE_SEQ,
             TARGET_OPE_NO, TARGET_OPE_SEQ, TARGET_TOOLG_ID, LOT_TYPE, LOT_FINISHED_STATE, FOUP_ID,
              WAFER_QTY, LOT_STATUS, FLOW_RECIPE, CREATE_TIME, TRANS_STATE, BATCH_ID, SUB_LOT_TYPE,MPD_ID,EQP_ID                                                 
       )                                                               
        SELECT D.PARENT_ID,                                                                                                     
              D.LOT_ID,                                                                            
              D.PRODSPEC_ID,                                                                       
              D.PLAN_ID,                                                                           
              D.TARGET_PLAN_ID,                                                                    
              D.OPE_NO,                                                                            
              D.OPE_SEQ,                                                                           
              D.TARGET_OPE_NO,                                                           
              D.TARGET_OPE_SEQ,                                                         
              D.TARGET_TOOLG_ID,                                                       
              D.LOT_TYPE,                                                                          
              D.LOT_FINISHED_STATE,                                                                
              D.FOUP_ID,                                                                           
              D.WAFER_QTY,                                                                         
              D.LOT_STATUS,                                                                        
              CASE WHEN M.PRODSPEC_ID IS NOT NULL THEN M.PHYSICAL_RECIPE_ID ELSE '' END FLOW_RECIPE,                                                                       
              D.CREATE_TIME,                                                                       
              D.TRANS_STATE,                                                                       
              D.BATCH_ID,                                          
              D.SUB_LOT_TYPE,                                      
              D.MPD_ID,                                            
              M.EQP_ID                                             
        FROM APS_TMP_ETL_RLS_MEASURE_COMING_PO_N1 D                              
        LEFT JOIN APS_SYNC_PD_RECIPE_EQP_ALL.APS_SYNC_PD_RECIPE_EQP_ALL M                           
        ON M.PD_ID = D.POS_PDID                                    
        AND M.PRODSPEC_ID = D.PRODSPEC_ID                                                                                                               
         """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_MEASURE_COMING_RECIPE",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_MEASURE_COMING_RECIPE")


def InsertWipDataToCsfrinbitTempTable(duck_db_memory=None, uuid="", current_time="", oracle_conn=None, ETL_Proc_Name="",
                                      used_table_dict=None):
    sql = """
        INSERT INTO APS_TMP_ETL_RLS_MEASURE_COMING_CSF(                                    
            PARENT_ID, LOT_ID, PRODSPEC_ID,PLAN_ID,TARGET_PLAN_ID,OPE_NO,OPE_SEQ,
                    TARGET_OPE_NO, TARGET_OPE_SEQ, TARGET_TOOLG_ID, LOT_TYPE, LOT_FINISHED_STATE, FOUP_ID,
                    WAFER_QTY, LOT_STATUS, FLOW_RECIPE, CREATE_TIME, TRANS_STATE, BATCH_ID, SUB_LOT_TYPE,
                    MPD_ID, USER_FLAG, RECIPE_FLAG, EQP_ID                                                 
            )                                                                                             
                SELECT D.PARENT_ID,                                                                        
                      D.LOT_ID,                                                                            
                      D.PRODSPEC_ID,                                                                       
                      D.PLAN_ID,                                                                           
                      D.TARGET_PLAN_ID,                                                                    
                      D.OPE_NO,                                                                            
                      D.OPE_SEQ,                                                                           
                      D.TARGET_OPE_NO,                                                                     
                      D.TARGET_OPE_SEQ,                                                                    
                      D.TARGET_TOOLG_ID,                                                                   
                      D.LOT_TYPE,                                                                          
                      D.LOT_FINISHED_STATE,                                                                
                      D.FOUP_ID,                                                                           
                      D.WAFER_QTY,                                                                         
                      D.LOT_STATUS,                                                                        
                      D.FLOW_RECIPE,                                                                       
                      D.CREATE_TIME,                                                                       
                      D.TRANS_STATE,                                                                       
                      D.BATCH_ID,                                                                          
                      D.SUB_LOT_TYPE,                                                                             
                      D.MPD_ID,                                                                            
                      CASE WHEN C.PRODUCTID IS NOT NULL THEN 'Y' ELSE 'N' END AS USER_FLAG,                
                      CASE WHEN D.FLOW_RECIPE IS NOT NULL THEN 'Y' ELSE 'N' END AS RECIPE_FLAG,            
                      D.EQP_ID                                                                             
                FROM APS_TMP_ETL_RLS_MEASURE_COMING_RECIPE D                                                            
                LEFT JOIN CSFRINHIBIT.CSFRINHIBIT C                                    
                --ON position('Q' in C.EQUIPMENTID) = 1   
                ON  1 = 1                                                          
                AND C.PASS_FLG_PRC ='Y' AND C.PASS_FLG_MFG='Y'                                                                              
                AND C.PRODUCTID = D.PRODSPEC_ID                                                            
                AND C.ROUTEID = D.MPD_ID                                                                   
                AND C.OPENO = D.TARGET_OPE_NO                                                              
                AND C.EQUIPMENTID = D.EQP_ID                                                                                                                                                                          
           """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_MEASURE_COMING_RECIPE",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_MEASURE_COMING_CSF")


def InsertWipDataToToolDownTempTable(duck_db_memory=None, uuid="", current_time="", oracle_conn=None, ETL_Proc_Name="",
                                     used_table_dict=None):
    sql = """
       INSERT INTO APS_TMP_ETL_RLS_MEASURE_COMING_TOOL(                                     
          PARENT_ID, LOT_ID, PRODSPEC_ID,PLAN_ID,TARGET_PLAN_ID,OPE_NO,OPE_SEQ,
                  TARGET_OPE_NO, TARGET_OPE_SEQ, TARGET_TOOLG_ID, LOT_TYPE, LOT_FINISHED_STATE, FOUP_ID,
                  WAFER_QTY, LOT_STATUS, FLOW_RECIPE, CREATE_TIME, TRANS_STATE, BATCH_ID, SUB_LOT_TYPE, 
                   MPD_ID, USER_FLAG, RECIPE_FLAG, EQP_ID, TOOL_FLAG, INHIBIT_FLAG                                                  
          )                                                                                              
           SELECT D.PARENT_ID,                                                                                                                                     
                     D.LOT_ID,                                                                              
                     D.PRODSPEC_ID,                                                                         
                     D.PLAN_ID,                                                                             
                     D.TARGET_PLAN_ID,                                                                      
                     D.OPE_NO,                                                                              
                     D.OPE_SEQ,                                                                             
                     D.TARGET_OPE_NO,                                                                       
                     D.TARGET_OPE_SEQ,                                                                      
                     D.TARGET_TOOLG_ID,                                                                     
                     D.LOT_TYPE,                                                                            
                     D.LOT_FINISHED_STATE,                                                                  
                     D.FOUP_ID,                                                                             
                     D.WAFER_QTY,                                                                           
                     D.LOT_STATUS,                                                                          
                     D.FLOW_RECIPE,                                                                         
                     D.CREATE_TIME,                                                                         
                     D.TRANS_STATE,                                                                         
                     D.BATCH_ID,                                                                            
                     D.SUB_LOT_TYPE,                                                                        
                     D.MPD_ID,                                                                              
                     D.USER_FLAG,                                                            
                     D.RECIPE_FLAG,                                                          
                     D.EQP_ID,                                                               
                     CASE WHEN T.EQP_ID IS NOT NULL THEN 'Y' ELSE 'N' END AS TOOL_FLAG,           
                     CASE WHEN D.RECIPE_FLAG ='N' THEN 'Y' ELSE (CASE WHEN D.USER_FLAG = 'N' OR T.EQP_ID IS NULL THEN 'Y' ELSE 'N' END) END AS INHIBIT_FLAG            
           FROM APS_TMP_ETL_RLS_MEASURE_COMING_CSF D                                                                           
           LEFT JOIN APS_SYNC_ETL_TOOL.APS_SYNC_ETL_TOOL T                             
           --ON position('Q' in T.EQP_ID) = 1
           ON  1 = 1                                                              
           AND T.PREV_E10_STATE_CODE IN ('SBY','PRD')                                        
           AND T.EQP_ID = D.EQP_ID                                                                                                                                                                          
      """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_MEASURE_COMING_TOOL",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_MEASURE_COMING_TOOL")


def InsertTargetMeasureWip2TempTable(duck_db_memory=None, uuid="", current_time="", oracle_conn=None, ETL_Proc_Name="",
                                     used_table_dict=None):
    sql = """
      INSERT INTO APS_TMP_ETL_RLS_MEASURE_LOT(                                     
           PARENT_ID, LOT_ID, PRODSPEC_ID,PLAN_ID,TARGET_PLAN_ID,OPE_NO,OPE_SEQ,
                 TARGET_OPE_NO, TARGET_OPE_SEQ, TARGET_TOOLG_ID, LOT_TYPE, LOT_FINISHED_STATE, FOUP_ID,
                 WAFER_QTY, LOT_STATUS, FLOW_RECIPE, CREATE_TIME, TRANS_STATE, BATCH_ID, SUB_LOT_TYPE                                                  
           )                                                                
            WITH RESULT_DATA AS (                                                                                                              
              SELECT D.PARENT_ID,                                                                      
                     D.LOT_ID,                                                                                 
               MAX(D.PRODSPEC_ID) AS PRODSPEC_ID,                                                                       
               MAX(D.PLAN_ID) AS PLAN_ID,                                                                           
               D.TARGET_PLAN_ID,                                                                         
               MAX(D.OPE_NO) AS OPE_NO,                                                                            
               MAX(D.OPE_SEQ) AS OPE_SEQ,                                                                           
               MAX(D.TARGET_OPE_NO) AS TARGET_OPE_NO,                                                                     
               D.TARGET_OPE_SEQ,                                                                          
               MAX(D.TARGET_TOOLG_ID) AS TARGET_TOOLG_ID,                                                                   
               MAX(D.LOT_TYPE) AS LOT_TYPE,                                                                          
               MAX(D.LOT_FINISHED_STATE) AS LOT_FINISHED_STATE,                                                                
               MAX(D.FOUP_ID) AS FOUP_ID,                                                                           
               MAX(D.WAFER_QTY) AS WAFER_QTY,                                                                         
               MAX(D.LOT_STATUS) AS LOT_STATUS,                                                                        
               MAX(D.FLOW_RECIPE) AS FLOW_RECIPE,                                                                       
               MAX(D.CREATE_TIME) AS CREATE_TIME,                                                                       
               MAX(D.TRANS_STATE) AS TRANS_STATE,                                                                       
               MAX(D.BATCH_ID) AS BATCH_ID,                                                                          
               MAX(D.SUB_LOT_TYPE) AS SUB_LOT_TYPE,                                 
               MIN(D.INHIBIT_FLAG) AS INHIBIT_FLAG                                                
              FROM APS_TMP_ETL_RLS_MEASURE_COMING_TOOL D                                                                                                                              
              GROUP BY D.PARENT_ID,D.LOT_ID,D.TARGET_OPE_SEQ,D.TARGET_PLAN_ID             
            )                                                                                   
            SELECT D.PARENT_ID,                                                                         
                  D.LOT_ID,                                                                                    
                  D.PRODSPEC_ID,                                                                          
                  D.PLAN_ID,                                                                              
                  D.TARGET_PLAN_ID,                                                                            
                  D.OPE_NO,                                                                               
                  D.OPE_SEQ,                                                                              
                  D.TARGET_OPE_NO,                                                                        
                  D.TARGET_OPE_SEQ,                                                                             
                  D.TARGET_TOOLG_ID,                                                                      
                  D.LOT_TYPE,                                                                             
                  D.LOT_FINISHED_STATE,                                                                   
                  D.FOUP_ID,                                                                              
                  D.WAFER_QTY,                                                                            
                  D.LOT_STATUS,                                                                           
                  D.FLOW_RECIPE,                                                                          
                  D.CREATE_TIME,                                                                          
                  D.TRANS_STATE,                                                                          
                  D.BATCH_ID,                                                                             
                  D.SUB_LOT_TYPE                                                                
            FROM RESULT_DATA D                                                                  
            WHERE D.INHIBIT_FLAG = 'Y'                                                                                                                                                                                                                                                                                         
      """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_MEASURE_LOT",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_MEASURE_LOT")


def GetAllMeasureOpeNoData(duck_db_memory=None, uuid="", current_time="", oracle_conn=None, ETL_Proc_Name="",
                           used_table_dict=None):
    # 先把不需要Coming Wip的数据进行过滤
    getAllComingMeasureWipData(duck_db_memory=duck_db_memory, uuid=uuid, current_time=current_time, oracle_conn=oracle_conn,
                               ETL_Proc_Name=ETL_Proc_Name, used_table_dict=used_table_dict)
    # 把PD_PO_N1串接
    getWipDataToPoN1Data(duck_db_memory=duck_db_memory, uuid=uuid, current_time=current_time,
                         oracle_conn=oracle_conn, ETL_Proc_Name=ETL_Proc_Name, used_table_dict=used_table_dict)
    # 把PF_RECIPE_EQP串接
    getWipDataToPfRecipeEqpData(duck_db_memory=duck_db_memory, uuid=uuid, current_time=current_time,
                                oracle_conn=oracle_conn, ETL_Proc_Name=ETL_Proc_Name, used_table_dict=used_table_dict)
    # 把CSFRINHIBIT串接出来
    InsertWipDataToCsfrinbitTempTable(duck_db_memory=duck_db_memory, uuid=uuid, current_time=current_time,
                                      oracle_conn=oracle_conn, ETL_Proc_Name=ETL_Proc_Name, used_table_dict=used_table_dict)
    # 机况（DYB、PRD）外都属于异常
    InsertWipDataToToolDownTempTable(duck_db_memory=duck_db_memory, uuid=uuid, current_time=current_time,
                                     oracle_conn=oracle_conn, ETL_Proc_Name=ETL_Proc_Name, used_table_dict=used_table_dict)

    InsertTargetMeasureWip2TempTable(duck_db_memory=duck_db_memory, uuid=uuid, current_time=current_time,
                                     oracle_conn=oracle_conn, ETL_Proc_Name=ETL_Proc_Name, used_table_dict=used_table_dict)


def InsertEQPRecipe2Temp(duck_db_memory=None, uuid="", current_time="", oracle_conn=None, ETL_Proc_Name="",
                         target_db_file="", used_table_dict=None):
    sql = """
        INSERT  INTO APS_TMP_ETL_RLS_LOT_TO_EQP
        (LOT_ID, OPE_NO, EQP_ID)
        SELECT REPLACE(E.LOT_ID,'.','') AS LOT_ID, E.OPE_NO, E.EQP_ID
        FROM APS_SYNC_LOT_TO_EQP.APS_SYNC_LOT_TO_EQP AS E
    """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_LOT_TO_EQP",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_LOT_TO_EQP")
    sql = """
    INSERT INTO APS_TMP_ETL_RLS_EQP_TOOL
    ( EQP_G, EQP_CHAMBER_FLAG, EQP_ID,MODULE, EQP_CATEGORY )
    SELECT E.EQP_G, E.EQP_CHAMBER_FLAG,  E.EQP_ID, E.REAL_MODULE, E.EQP_CATEGORY 
    FROM APS_SYNC_ETL_TOOL.APS_SYNC_ETL_TOOL AS E
    """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_EQP_TOOL",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_EQP_TOOL")
    sql = """
    INSERT  INTO APS_TMP_ETL_RLS_EQPRCP_RESULT1
        ( LOT_ID ,OPE_SEQ,OPE_NO,TARGET_OPE_SEQ,TARGET_OPE_NO,
        PLAN_ID,TARGET_PLAN_ID,PRODSPEC_ID,WAFER_QTY,FLOW_RECIPE,
        TRANS_STATE,BATCH_NAME,FOUP_ID,BATCH_ID,POS_PDID,SUB_LOT_TYPE,LOT_PROC_STATE
        --modify by xiecheng for version up
        ,MAX_BATCH_SIZE
         )
        SELECT
               W.LOT_ID
              ,W.OPE_SEQ
              ,W.OPE_NO
              ,W.TARGET_OPE_SEQ
              ,W.TARGET_OPE_NO
              ,W.PLAN_ID
              ,W.TARGET_PLAN_ID
              ,W.PRODSPEC_ID
              ,W.WAFER_QTY
              ,W.FLOW_RECIPE
              ,W.TRANS_STATE
              ,PD.BATCH_NAME
              ,W.FOUP_ID
              ,W.BATCH_ID,PD.POS_PDID,W.SUB_LOT_TYPE,W.LOT_STATUS
              ,COALESCE(cast(PD.MAX_BATCH_SIZE as decimal),0)*25 AS MAX_BATCH_SIZE
        FROM APS_TMP_ETL_RLS_WIP W
        INNER JOIN APS_SYNC_PF_PO_N1.APS_SYNC_PF_PO_N1 PD ON
        W.TARGET_PLAN_ID = PD.MAINPD_ID AND W.TARGET_OPE_NO = PD.OPE_NO
    """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_EQPRCP_RESULT1",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_EQPRCP_RESULT1")

    # TODO 最新版本追加了一个报警
    row_count1 = my_duck.get_row_count_in_duckdb(duck_db_memory, "APS_TMP_ETL_RLS_WIP")
    if row_count1 == 0:
        my_oracle.SaveAlarmLogData(oracle_conn, ETL_Proc_Name, "Lot没有找到匹配HandleWip的信息，请及时确认！！", target_db_file,
                                   cons_error_code.APS_ETL_SGS_RLS_CODE_XX_ETL)

    row_count2 = my_duck.get_row_count_in_duckdb(duck_db_memory, "APS_TMP_ETL_RLS_EQPRCP_RESULT1")
    if row_count2 == 0:
        my_oracle.SaveAlarmLogData(oracle_conn, ETL_Proc_Name, "Lot没有找到匹配FLOW(V_PF_PO_N1)的信息，请及时确认！！", target_db_file,
                                   cons_error_code.APS_ETL_SGS_RLS_CODE_XX_ETL)

    sql = """
    INSERT INTO  APS_TMP_ETL_RLS_EQPRCP_RESULT2
        ( LOT_ID,OPE_SEQ,OPE_NO,TARGET_OPE_SEQ,TARGET_OPE_NO,PLAN_ID,
        TARGET_PLAN_ID,PRODSPEC_ID,PD_ID,EQP_ID,WAFER_QTY,M_RECIPE,
        PHYSICAL_RECIPE_ID,RECIPE_ID_C ,FLOW_RECIPE,PPID,TRANS_STATE,
        BATCH_NAME,FOUP_ID ,LCRECIPE_ID,BATCH_ID,SUB_LOT_TYPE,LOT_PROC_STATE,
        max_batch_size
         )
        SELECT
               W.LOT_ID
              ,W.OPE_SEQ
              ,W.OPE_NO
              ,W.TARGET_OPE_SEQ
              ,W.TARGET_OPE_NO
              ,W.PLAN_ID
              ,W.TARGET_PLAN_ID
              ,W.PRODSPEC_ID
              ,ER.PD_ID
              ,ER.EQP_ID
              ,W.WAFER_QTY
              ,ER.M_RECIPE
              ,ER.PHYSICAL_RECIPE_ID
              ,ER.RECIPE_ID_C
              ,W.FLOW_RECIPE
              ,ER.M_RECIPE AS PPID
              ,W.TRANS_STATE
              ,W.BATCH_NAME
              ,W.FOUP_ID
              ,ER.LCRECIPE_ID
              ,W.BATCH_ID
              ,W.SUB_LOT_TYPE
              ,W.LOT_PROC_STATE
              --modify by xiecheng for version up
              ,W.MAX_BATCH_SIZE
        FROM  APS_TMP_ETL_RLS_EQPRCP_RESULT1  W
        INNER JOIN APS_SYNC_PD_RECIPE_EQP_ALL.APS_SYNC_PD_RECIPE_EQP_ALL  ER ON
        W.PRODSPEC_ID = ER.PRODSPEC_ID AND W.POS_PDID = ER.PD_ID
         --modify by xiecheng for version up
        AND position('DYB' in W.TARGET_PLAN_ID) = 0
             UNION ALL
             SELECT W.LOT_ID
                    ,W.STEP_ID
                    ,W.CURRENT_OPE_NO
                    ,W.STEP_ID AS TARGET_OPE_SEQ
                    ,W.CURRENT_OPE_NO AS TARGET_OPE_NO
                    ,W.DYB_MAINPD_ID
                    ,W.DYB_MAINPD_ID AS TARGET_PLAN_ID
                    ,W.PRODSPEC_ID
                    ,W.POS_PDID AS PD_ID
                    ,W.EQP_ID
                    ,W.WAFER_QTY
                    ,W.M_RECIPE
                    ,W.PHYSICAL_RECIPE_ID
                    ,W.RECIPE_ID_C
                    ,W.LCRECIPE_ID AS FLOW_RECIPE
                    ,W.M_RECIPE AS PPID
                    ,W.TRANS_STATE
                    ,W.BATCH_NAME
                    ,W.CASSETE_ID AS FOUP_ID
                    ,W.LCRECIPE_ID
                    ,W.BATCH_ID
                    ,W.SUB_LOT_TYPE,W.LOT_PROC_STATE
                    ,W.MAX_BATCH_SIZE
             FROM APS_TMP_ETL_RLS_DYB_LOT W
             WHERE position('DYB' in W.DYB_MAINPD_ID)=1
    """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_EQPRCP_RESULT2",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_EQPRCP_RESULT2")

    row_count = my_duck.get_row_count_in_duckdb(duck_db_memory, "APS_TMP_ETL_RLS_EQPRCP_RESULT2")
    if row_count == 0:
        logging.error("Lot没有找到匹配Recipe信息，请及时确认！！")
        my_oracle.SaveAlarmLogData(oracle_conn, ETL_Proc_Name, "Lot没有找到匹配Recipe信息，请及时确认！！", target_db_file,
                                   cons_error_code.APS_ETL_SGS_RLS_CODE_XX_ETL)

    sql = """
    INSERT INTO APS_TMP_ETL_RLS_EQPRCP_RESULT3
        ( LOT_ID,OPE_SEQ,OPE_NO,TARGET_OPE_SEQ,TARGET_OPE_NO,PLAN_ID,
            TARGET_PLAN_ID,PRODSPEC_ID,PD_ID,EQP_G,EQP_ID,WAFER_QTY,M_RECIPE,
            PHYSICAL_RECIPE_ID,RECIPE_ID_C ,FLOW_RECIPE,PPID,EQP_CHAMBER_FLAG,TRANS_STATE,
            BATCH_NAME,FOUP_ID ,LCRECIPE_ID,BATCH_ID,SUB_LOT_TYPE,MODULE,LOT_PROC_STATE
            --modify by xiecheng for version up
            ,MAX_BATCH_SIZE, MONITOR_FLAG
         )
        SELECT
               W.LOT_ID
              ,W.OPE_SEQ
              ,W.OPE_NO
              ,W.TARGET_OPE_SEQ
              ,W.TARGET_OPE_NO
              ,W.PLAN_ID
              ,W.TARGET_PLAN_ID
              ,W.PRODSPEC_ID
              ,W.PD_ID
              ,E.EQP_G
              ,W.EQP_ID
              ,W.WAFER_QTY
              ,W.M_RECIPE
              ,W.PHYSICAL_RECIPE_ID
              ,W.RECIPE_ID_C
              ,W.FLOW_RECIPE
              ,W.PPID
               ,E.EQP_CHAMBER_FLAG
              ,W.TRANS_STATE
              ,W.BATCH_NAME
              ,W.FOUP_ID
              ,W.LCRECIPE_ID
              ,W.BATCH_ID
              ,W.SUB_LOT_TYPE
              ,E.MODULE
              ,W.LOT_PROC_STATE
                --modify by xiecheng for version up
              ,W.MAX_BATCH_SIZE
              ,CASE WHEN P.LCRECIPE_ID IS NOT NULL THEN 'Y' ELSE 'N' END AS MONITOR_FLAG
        FROM APS_TMP_ETL_RLS_EQPRCP_RESULT2 W
        INNER JOIN  APS_TMP_ETL_RLS_EQP_TOOL E  ON  W.EQP_ID = E.EQP_ID
        --需要过滤掉量测机台的数据,因为量测机台不能只看Q开头的数据
        AND E.EQP_CATEGORY NOT IN ('Measurement','Wafer Sorter')  
        --找有对应monitor的recipe数据
        LEFT JOIN APS_SYNC_MES_FRLRCP.APS_SYNC_MES_FRLRCP P  ON P.LCRECIPE_ID = W.FLOW_RECIPE   
              AND P.MNTR_PRODSPEC_ID IS NOT NULL  
    """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_EQPRCP_RESULT3",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_EQPRCP_RESULT3")


    sql = """
     INSERT /*+ append */ INTO  APS_TMP_ETL_RLS_EQPRCP_RESULT 
     (PARENT_ID, LOT_ID, STEP_ID, OPE_NO, TARGET_STEP_ID, TARGET_OPE_NO, PLAN_ID, TARGET_PLAN_ID, PROD_ID, PD_ID,
     TARGET_TOOLG_ID, EQP_ID, QTY, M_RECIPE, PHYSICAL_RECIPE_ID, RECIPE_ID_C, FLOW_RECIPE, PPID, LOT_EQP_STATUS,EQP_CHAMBER_FLAG,
     CREATETIME, TRANS_STATE, BATCH_NAME, CASSETE_ID, LCRECIPE_ID, BATCH_ID,SUB_LOT_TYPE,MODULE,LOT_PROC_STATE
     --modify by xiecheng for version up 
     ,MAX_BATCH_SIZE,MONITOR_FLAG
      )                                                                                                    
     SELECT ''                                                                                                                   
           ,W.LOT_ID                                                                                                                         
           ,W.OPE_SEQ                                                                                                                        
           ,W.OPE_NO                                                                                                                         
           ,W.TARGET_OPE_SEQ                                                                                                                 
           ,W.TARGET_OPE_NO                                                                                                                  
           ,W.PLAN_ID                                                                                                                        
           ,W.TARGET_PLAN_ID                                                                                                                 
           ,W.PRODSPEC_ID                                                                                                                    
           ,W.PD_ID                                                                                                                          
           ,W.EQP_G AS TOOLG_ID                                                                                                              
           ,W.EQP_ID                                                                                                                         
           ,W.WAFER_QTY                                                                                                                      
           ,W.M_RECIPE                                                                                                                       
           ,W.PHYSICAL_RECIPE_ID                                                                                                                         
           ,W.RECIPE_ID_C                                                                                                                    
           ,W.FLOW_RECIPE                

           ,W.PPID                                                                                                               
           ,CASE WHEN LE.LOT_ID IS NOT NULL AND TRIM(W.EQP_ID) <> TRIM(LE.EQP_ID) THEN 'LOT_TO_EQP' END AS LOT_EQP_STATUS                                                                                                            
            ,W.EQP_CHAMBER_FLAG                                                                                                              
           ,'{current_time}'                                                                                                            
           ,W.TRANS_STATE                                                                                                                    
           ,W.BATCH_NAME                                                                                                                     
           ,W.FOUP_ID                                                                                                                        
           ,W.LCRECIPE_ID                                                                                                                    
           ,W.BATCH_ID                                                                                                                       
           ,W.SUB_LOT_TYPE                                                                                                                   
           ,W.MODULE,W.LOT_PROC_STATE    
            --modify by xiecheng for version up 
           ,(CASE WHEN W.MONITOR_FLAG='Y' THEN CAST(W.MAX_BATCH_SIZE AS DECIMAL) - 25 ELSE CAST(W.MAX_BATCH_SIZE AS DECIMAL) END ) AS MAX_BATCH_SIZE,W.MONITOR_FLAG                                                                                                                       
     FROM APS_TMP_ETL_RLS_EQPRCP_RESULT3  W                                                                                              
     LEFT JOIN APS_TMP_ETL_RLS_LOT_TO_EQP LE ON W.LOT_ID = LE.LOT_ID 
     AND W.TARGET_OPE_NO = LE.OPE_NO
    """.format(current_time=current_time)
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_EQPRCP_RESULT",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_EQPRCP_RESULT")

def InsertEQPRecipeReticle2Temp(duck_db_memory=None, uuid="", current_time="", oracle_conn=None, ETL_Proc_Name="",
                                used_table_dict=None):
    # 针对黄光区双光罩的问题，从V_RETICLE_PROD
    # 如果值对应一个光罩群且只有一个光罩，直接用；如果对应多个光罩群组且每个光罩群组只对应唯一光罩，则需要用：A光罩;B光罩
    sql = """
      INSERT /*+ append */ INTO  APS_TMP_ETL_RLS_MORE_RETICLE                                                                                             
             (  PROD_ID, OPE_NO, RTCL_ID  )                                                                                                           
             WITH RETICLE_DATA AS (                                                                                            
              SELECT P.PRODSPEC_ID,P.PRODG1,                                                                                 
                   P.MASK_GROUP,P.RTCL_ID,                                                                                 
                   P.OPE_NO,P.CHIP_BODY,                                                                                   
                   ROW_NUMBER() OVER (PARTITION BY P.PRODSPEC_ID,P.OPE_NO, P.MASK_GROUP ORDER BY P.RTCL_ID DESC) AS RN     
              FROM APS_SYNC_RETICLE_PROD.APS_SYNC_RETICLE_PROD P                                                                                                                         
             ),                                                                                                                
             GROUP_RECL AS (                                                                                                   
              SELECT P.PRODSPEC_ID,MAX(P.PRODG1) AS PRODG1,                                                                  
                   P.MASK_GROUP,MAX(P.RTCL_ID) AS RTCL_ID,                                                                 
                   P.OPE_NO,MAX(P.CHIP_BODY) AS CHIP_BODY,                                                                 
                   MAX(RN) AS RN                                                                                           
              FROM RETICLE_DATA P                                                                                            
              GROUP BY P.PRODSPEC_ID,P.OPE_NO, P.MASK_GROUP                                                                  
             ),                                                                                                                
             RESULT_DATA AS (                                                                                                  
              SELECT PRODSPEC_ID,PRODG1,                                                                                     
                   MASK_GROUP,RTCL_ID,                                                                                     
                   OPE_NO,CHIP_BODY                                                                                        
              FROM GROUP_RECL                                                                                                
              WHERE RN = 1                                                                                                   
             )                                                                                                                 
             SELECT DISTINCT PRODSPEC_ID,OPE_NO,                                                                               
                    STRING_AGG(RTCL_ID,';') OVER (PARTITION BY PRODSPEC_ID,OPE_NO ORDER BY RTCL_ID) AS RTCL_ID      
             FROM RESULT_DATA                                  
    """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_MORE_RETICLE",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_MORE_RETICLE")

    sql = """
     INSERT /*+ append */ INTO APS_TMP_ETL_RLS_EQPRCPRTC_RESULT                                                                                           
     ( PARENT_ID, LOT_ID, STEP_ID, OPE_NO, TARGET_STEP_ID, TARGET_OPE_NO, PLAN_ID, TARGET_PLAN_ID, PROD_ID, PD_ID, TARGET_TOOLG_ID, EQP_ID,
       QTY, M_RECIPE, PHYSICAL_RECIPE_ID, RECIPE_ID_C, FLOW_RECIPE, PPID, LOT_EQP_STATUS, CREATETIME, RETICLE_ID, RETICLE_RECIPE, CHAMBER_SET,
       BATCH_SIZE_MAX, BATCH_SIZE_MIN,EQP_CHAMBER_FLAG,TRANS_STATE,BATCH_NAME,CASSETE_ID,LCRECIPE_ID,BATCH_ID,CSFR_PLAN_ID,CHIPBODY,SUB_LOT_TYPE,
       MODULE,LOT_PROC_STATE
      )                                                                                                           
     WITH EQP AS                                                                                                                                            
      (SELECT E.EQP_ID,                                                                                                                                     
              CASE                                                                                                                                          
                WHEN E.EQP_CHAMBER_FLAG = 'Chamber' THEN                                                                                                      
                 SUBSTRINGING(STRING_AGG(E.CHAMBER_ID, ';') OVER (PARTITION BY 1 ORDER BY E.CHAMBER_ID), 2 )                                                                    
                ELSE                                                                                                                                        
                 ''                                                                                                                                         
              END AS CHAMBER_SET,                                                                                                                           
              E.EQP_CHAMBER_FLAG                                                                                                                            
     FROM (                                                                                                                                                 
            SELECT B.*                                                                                                                                  
                  ,MIN(B.EQP_CHAMBER_FLAG) OVER(PARTITION BY B.EQP_ID ORDER BY B.EQP_CHAMBER_FLAG) AS EQP_CHAMBER_FLAG2           
            FROM (                                                                                                                                      
                      SELECT CASE                                                                                                               
                              WHEN SUBSTRINGING(A.EQP_ID, 1, POSITION('.' IN (A.EQP_ID)) - 1) IS NULL THEN                                       
                               A.EQP_ID                                                                                                 
                              ELSE                                                                                                      
                               SUBSTRINGING(A.EQP_ID, 1, POSITION('.' IN (A.EQP_ID)) - 1)                                                        
                            END AS EQP_ID,                                                                                              
                            A.EQP_ID AS CHAMBER_ID,                                                                                     
                            A.EQP_CHAMBER_FLAG                                                                                          
                       FROM APS_SYNC_ETL_TOOL.APS_SYNC_ETL_TOOL A                                                                                                        
                      WHERE 1 = 1 AND A.MIN_UNIT_FLAG = 'Y'                                                                                           
                  ) B                                                                                                                               
          ) E                                                                                                                                               
     WHERE E.EQP_CHAMBER_FLAG = E.EQP_CHAMBER_FLAG2                                                                                                         
     GROUP BY E.EQP_ID, E.EQP_CHAMBER_FLAG),                                                                                                                            
     RTC AS                                                                                                                                                 
      (SELECT A.TOOLID,                                                                                                                                     
              A.RECIPE_ID,                                                                                                                                  
              A.RETICLE_ID,                                                                                                                                 
              REPLACE(A.RECIPE_ID, '/', '') AS RECIPE_ID_C,                                                                                                 
              CASE                                                                                                                                          
                WHEN SUBSTRING(A.TOOLID, 1, 3) = 'PVC' THEN                                                                                                    
                 REPLACE(A.TOOLID, 'PVC', 'PKC')                                                                                                            
                WHEN SUBSTRING(A.TOOLID, 1, 3) = 'PLN' THEN                                                                                                    
                 REPLACE(A.TOOLID, 'PLN', 'PHN')                                                                                                            
                WHEN SUBSTRING(A.TOOLID, 1, 3) = 'PAC' THEN                                                                                                    
                 REPLACE(A.TOOLID, 'PAC', 'PUC')                                                                                                            
                ELSE                                                                                                                                        
                 A.TOOLID                                                                                                                                   
              END AS EQP_ID                                                                                                                                 
         FROM APS_SYNC_RMS_RECIPE_RETICLE.APS_SYNC_RMS_RECIPE_RETICLE A                                                                                                                        
       ),                                                                                                                                                   
     RTC_NEW AS (                                                                                                                                           
         SELECT R.TOOLID, R.RECIPE_ID, R.RETICLE_ID,                                                                                                        
            R.EQP_ID, R.RECIPE_ID_C,                                                                                                                    
            ROW_NUMBER() OVER(PARTITION BY R.EQP_ID, R.RECIPE_ID_C ORDER BY R.RETICLE_ID) AS RN                                                         
         FROM RTC R                                                                                                                                         
        )                                                                                                                                                               
     SELECT      W.PARENT_ID                                                                                                                                     
            ,W.LOT_ID                                                                                                                                        
            ,W.STEP_ID                                                                                                                                       
            ,W.OPE_NO                                                                                                                                        
            ,W.TARGET_STEP_ID                                                                                                                                
            ,W.TARGET_OPE_NO                                                                                                                                 
            ,W.PLAN_ID                                                                                                                                       
            ,W.TARGET_PLAN_ID                                                                                                                                
            ,W.PROD_ID                                                                                                                                       
            ,W.PD_ID                                                                                                                                         
            ,W.TARGET_TOOLG_ID                                                                                                                               
            ,W.EQP_ID                                                                                                                                        
            ,W.QTY                                                                                                                                           
            ,W.M_RECIPE                                                                                                                                      
            ,W.PHYSICAL_RECIPE_ID                                                                                                                            
            ,W.RECIPE_ID_C                                                                                                                                   
            ,W.FLOW_RECIPE                                                                                                                                   
            ,W.PPID                                                                                                                                          
            ,W.LOT_EQP_STATUS                                                                                                                                
            ,W.CREATETIME  
              --modify by xiecheng for version up                                                                                                                                                         
           -- ,COALESCE(R.RETICLE_ID, ' ') AS RETICLE_ID
             ,CASE WHEN MRT.RTCL_ID IS NOT NULL THEN MRT.RTCL_ID ELSE COALESCE(R.RETICLE_ID, ' ') END AS RETICLE_ID                                                                                                           
            ,R.RECIPE_ID AS MASK_RECIPE                                                                                                                      
            ,E.CHAMBER_SET     
            --modify by xiecheng for version up                                                                                                                                                               
           -- BATCH_SIZE_MAX 取最小的那个设定（V_FVEQP、V_DIFF_BATCH_SIZE_MIX、V_PF_PO_N1）
                        ,CASE WHEN VDB.EQP_ID IS NOT NULL AND W.MAX_BATCH_SIZE = 0 THEN  cast(VDB.MAX_WAFER AS decimal)                                                                 
                              WHEN VDB.EQP_ID IS NOT NULL AND W.MAX_BATCH_SIZE > 0 AND cast(VDB.MAX_WAFER as decimal) <= W.MAX_BATCH_SIZE THEN VDB.MAX_WAFER                               
                              WHEN VDB.EQP_ID IS NOT NULL AND W.MAX_BATCH_SIZE > 0 AND cast(VDB.MAX_WAFER as decimal) >= W.MAX_BATCH_SIZE THEN W.MAX_BATCH_SIZE                       
                              WHEN FE.EQP_ID IS NOT NULL AND W.MAX_BATCH_SIZE = 0 THEN cast(COALESCE(FE.BATCH_SIZE_MAX_PROD, 0) as DECIMAL)* 25                                               
                              WHEN FE.EQP_ID IS NOT NULL AND W.MAX_BATCH_SIZE > 0 AND cast(COALESCE(FE.BATCH_SIZE_MAX_PROD, 0) as decimal) * 25  <= W.MAX_BATCH_SIZE THEN cast(COALESCE(FE.BATCH_SIZE_MAX_PROD, 0) as decimal) * 25        
                              WHEN FE.EQP_ID IS NOT NULL AND W.MAX_BATCH_SIZE > 0 AND cast(COALESCE(FE.BATCH_SIZE_MAX_PROD, 0) as decimal) * 25  >= W.MAX_BATCH_SIZE THEN W.MAX_BATCH_SIZE                           
                              WHEN VDB.EQP_ID IS NULL AND FE.EQP_ID IS NULL AND W.MAX_BATCH_SIZE > 0 THEN cast(W.MAX_BATCH_SIZE AS decimal)                                          
                         END AS BATCH_SIZE_MAX                                                                                                                           
            -- 只有DF会参考该值
            ,COALESCE(CAST(VDB.MIN_WAFER AS DECIMAL),1) AS BATCH_SIZE_MIN     
            ,W.EQP_CHAMBER_FLAG                                                                                                                              
            ,W.TRANS_STATE                                                                                                                                   
            ,W.BATCH_NAME                                                                                                                                    
            ,W.CASSETE_ID                                                                                                                                    
            ,W.LCRECIPE_ID                                                                                                                                   
            ,W.BATCH_ID                                                                                                                                      
            -- 方便在过滤csfrinhibit用到
            ,SUBSTRING(W.TARGET_PLAN_ID, 1, POSITION('.' IN (W.TARGET_PLAN_ID))-1) AS CSFR_PLAN_ID                                                                   
            ,SUBSTRING(W.PROD_ID, 1, POSITION('.' IN (W.PROD_ID))-1) AS CHIPBODY ,W.SUB_LOT_TYPE                                                                     
            ,W.MODULE,W.LOT_PROC_STATE                                                                                                                                        
     FROM APS_TMP_ETL_RLS_EQPRCP_RESULT W                                                                                                                          
     LEFT JOIN EQP E ON W.EQP_ID = E.EQP_ID                                                                                                                      
     LEFT JOIN RTC_NEW R ON W.EQP_ID = R.EQP_ID AND W.RECIPE_ID_C = R.RECIPE_ID_C AND R.RN = 1                                                                   
     LEFT JOIN APS_SYNC_FVEQP.APS_SYNC_FVEQP FE ON  W.EQP_ID = FE.EQP_ID AND FE.MLTRCP_CAPA='Batch'                                                                                 
     LEFT JOIN APS_SYNC_DIFF_BATCH_SIZE_MIX.APS_SYNC_DIFF_BATCH_SIZE_MIX VDB ON  W.EQP_ID = VDB.EQP_ID AND W.TARGET_OPE_NO = VDB.OPE_NO AND W.LCRECIPE_ID = VDB.LOGICAL_RECIPE       
     LEFT JOIN APS_TMP_ETL_RLS_MORE_RETICLE MRT ON W.TARGET_OPE_NO = MRT.OPE_NO AND W.PROD_ID = MRT.PROD_ID                
    """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_EQPRCPRTC_RESULT",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_EQPRCPRTC_RESULT")


def InsertSameFoupRecipeDataView2Temp(duck_db_memory=None, uuid="", current_time="", oracle_conn=None, ETL_Proc_Name="",
                                      used_table_dict=None):
    sql = """
    INSERT INTO APS_TMP_ETL_RLS_FOUP_RECIPE (   
         LOT_ID, TARGET_OPE_NO, TARGET_PLAN_ID, PROD_ID                           
        )                                         
        WITH FOUP_DATA AS (                                                 
              SELECT W.CASSETE_ID                                             
                 FROM APS_TMP_ETL_RLS_EQPRCPRTC_RESULT W                                                               
                 WHERE W.LCRECIPE_ID IS NOT NULL    
                       AND MODULE IN ('DIFF','WET')                           
                 GROUP BY W.CASSETE_ID                                       
                 HAVING COUNT(DISTINCT LOT_ID) >1                                  
         ),                                                                                                                                 
         SOU_DATA_A AS (                                                     
             SELECT W.CASSETE_ID,                                            
                    W.LCRECIPE_ID,                                           
                    W.LOT_ID,                                                
                    W.TARGET_OPE_NO,                                         
                    W.TARGET_PLAN_ID,                                        
                    W.PROD_ID,                                               
                    W.CASSETE_ID || W.TARGET_OPE_NO AS COM_NAME              
             FROM APS_TMP_ETL_RLS_EQPRCPRTC_RESULT W                                                              
             WHERE W.LCRECIPE_ID IS NOT NULL 
               AND W.MODULE IN ('DIFF','WET')                                 
               AND EXISTS (SELECT 1 FROM FOUP_DATA D WHERE W.CASSETE_ID = D.CASSETE_ID)          
         ),                                                                  
         SOU_DATA_B AS (                                                     
             SELECT *                                                        
             FROM SOU_DATA_A                                                 
         )                                                                   
         SELECT DISTINCT                                                     
                A.LOT_ID,                                                    
                A.TARGET_OPE_NO,                                             
                A.TARGET_PLAN_ID,                                            
                A.PROD_ID                                                    
         FROM SOU_DATA_A A,SOU_DATA_B B                                      
         WHERE A.COM_NAME = B.COM_NAME                                       
         AND A.LCRECIPE_ID <> B.LCRECIPE_ID                                  
    """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_FOUP_RECIPE",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_FOUP_RECIPE")


def InsertReworkComing2Temp(duck_db_memory=None, uuid="", current_time="", oracle_conn=None, ETL_Proc_Name="",
                            used_table_dict=None):
    sql = """
    insert into APS_TMP_ETL_RLS_SPLIT_INFO (
        LOT_MOTHER, LOT_SON
    ) 
    SELECT R.LOT_MOTHER, R.LOT_SON
    FROM APS_SYNC_RSSPLIT_INFO.APS_SYNC_RSSPLIT_INFO AS R
    """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_SPLIT_INFO",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_SPLIT_INFO")
    sql = """
    INSERT INTO  APS_TMP_ETL_RLS_REWORK_COMING (
        LOT_MOTHER, LOT_SON, OPE_NO, EQP_ID
    )
    SELECT DISTINCT LOT_MOTHER,LOT_SON,OPE_NO,EQP_ID
    FROM (
        SELECT H.FROM_LOT AS LOT_MOTHER,H.TO_LOT AS LOT_SON,
               HI.OPE_NO, HI.EQP_ID  
        FROM APS_SYNC_WP_SPLIT_MERGE_DETAIL_HISTORY.APS_SYNC_WP_SPLIT_MERGE_DETAIL_HISTORY AS H
        INNER JOIN APS_TMP_ETL_RLS_EQPRCPRTC_RESULT W
        ON W.LOT_ID = H.TO_LOT AND W.TARGET_PLAN_ID LIKE 'YY%'
        AND W.OPE_NO <> W.TARGET_OPE_NO
        AND (W.TARGET_OPE_NO LIKE '%.PPK%' OR W.TARGET_OPE_NO LIKE '%.PPU%' OR W.TARGET_OPE_NO LIKE '%.PPH%') 
        INNER JOIN APS_TMP_ETL_RLS_LOTHISTORY AS HI 
        ON HI.LOT_ID = H.FROM_LOT AND HI.OPE_NO = W.TARGET_OPE_NO
        WHERE H.ACTION_IND = 'Split'
        UNION ALL
        SELECT R.LOT_MOTHER, R.LOT_SON,  HI.OPE_NO, HI.EQP_ID
        FROM  APS_TMP_ETL_RLS_SPLIT_INFO  R
        INNER JOIN APS_TMP_ETL_RLS_EQPRCPRTC_RESULT W
        ON W.LOT_ID = R.LOT_SON AND W.TARGET_PLAN_ID LIKE 'YY%'
        AND W.OPE_NO <> W.TARGET_OPE_NO
        AND (W.TARGET_OPE_NO LIKE '%.PPK%' OR W.TARGET_OPE_NO LIKE '%.PPU%' OR W.TARGET_OPE_NO LIKE '%.PPH%') 
        INNER JOIN APS_TMP_ETL_RLS_LOTHISTORY AS HI
        ON HI.LOT_ID = R.LOT_MOTHER AND HI.OPE_NO = W.TARGET_OPE_NO
        WHERE R.LOT_MOTHER <> R.LOT_SON 
    )
    """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_REWORK_COMING",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_REWORK_COMING")

    sql = """
    INSERT  INTO APS_TMP_ETL_RLS_REWORK_COMING_SELF (
        LOT_MOTHER, LOT_SON, OPE_NO, EQP_ID
    )
    SELECT DISTINCT W.LOT_ID AS LOT_MOTHER,
                    W.LOT_ID AS LOT_SON,
                    HI.OPE_NO,HI.EQP_ID
    FROM APS_TMP_ETL_RLS_EQPRCPRTC_RESULT W
    INNER JOIN APS_TMP_ETL_RLS_LOTHISTORY HI
    ON HI.LOT_ID = W.LOT_ID
    AND HI.OPE_NO = W.TARGET_OPE_NO
    AND W.TARGET_PLAN_ID LIKE 'YY%'
    AND W.OPE_NO <> W.TARGET_OPE_NO 
    AND (W.TARGET_OPE_NO LIKE '%.PPK%' OR W.TARGET_OPE_NO LIKE '%.PPU%' OR W.TARGET_OPE_NO LIKE '%.PPH%')
    """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_REWORK_COMING_SELF",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_REWORK_COMING_SELF")


def InsertLotApcSplitInfo2Temp(duck_db_memory=None, uuid="", current_time="", oracle_conn=None, ETL_Proc_Name="",
                               used_table_dict=None):
    sql = """
     INSERT /*+ append */  INTO APS_TMP_ETL_RLS_APC_SPLIT_INFO                                                   
     (PARENT_ID, LOT_ID, STEP_ID, OPE_NO, TARGET_STEP_ID, TARGET_OPE_NO, PLAN_ID, TARGET_PLAN_ID,
        PROD_ID, EQP_ID, FLOW_RECIPE, PPID, RETICLE_ID, UNIT_ID, LOT_MOTHER, LOT_SON
      )                                                                            
     WITH APC_SPLIT_INFO AS (                                                                                               
         SELECT DISTINCT                                                                                                    
                REPLACE(A.LOT_MOTHER,'.', '') AS LOT_MOTHER, REPLACE(A.LOT_SON,'.','') AS LOT_SON                           
               ,A.SPLIT_OP_NO, COALESCE(A.UNIT_ID, B.C_UNIT_ID) AS UNIT_ID                                                  
         FROM APS_SYNC_RSSPLIT_INFO.APS_SYNC_RSSPLIT_INFO AS A                                                                                              
         LEFT JOIN APS_SYNC_RSPILOT_RUNING.APS_SYNC_RSPILOT_RUNING AS B ON                        
                            B.LOT_KEY_NO = A.LOT_SON AND B.C_OP_NO = A.SPLIT_OP_NO                             
     )                                                                                                                      
     SELECT R.PARENT_ID, R.LOT_ID, R.STEP_ID, R.OPE_NO, R.TARGET_STEP_ID                                                    
            ,R.TARGET_OPE_NO, R.PLAN_ID, R.TARGET_PLAN_ID, R.PROD_ID, R.EQP_ID                                              
            ,R.FLOW_RECIPE, R.PPID, R.RETICLE_ID                                                                            
           ,S.UNIT_ID                                                                                                       
           ,S.LOT_MOTHER, S.LOT_SON                                                                                         
     FROM APS_TMP_ETL_RLS_EQPRCPRTC_RESULT R                                                                                    
     INNER JOIN APC_SPLIT_INFO S ON (R.LOT_ID = S.LOT_MOTHER OR R.LOT_ID = S.LOT_SON )                                      
                                 AND R.TARGET_OPE_NO = S.SPLIT_OP_NO                                                        
                                 AND R.EQP_ID = S.UNIT_ID                                                                   
    """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_APC_SPLIT_INFO",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_APC_SPLIT_INFO")


def InsertLotSpecial2Temp(duck_db_memory=None, uuid="", current_time="", oracle_conn=None, ETL_Proc_Name="",
                          used_table_dict=None):
    sql = """
    INSERT /*+ append */ INTO APS_TMP_ETL_RLS_LOTSPECIAL_RESULT
    SELECT DISTINCT '{uuid}',
            REPLACE(A.LOT_KEY_NO,'.','') AS LOT_ID,
            A.OP_NO,A.UNIT_ID AS EQP_ID,   
            '{current_time}'
    FROM APS_SYNC_SCHE_APC_LOT_SPECIAL_VALUE.APS_SYNC_SCHE_APC_LOT_SPECIAL_VALUE AS A
    WHERE  A.APC_TYPE IN ('PA','PB') 
        AND (A.UNIT_ID IS NOT NULL AND A.UNIT_ID <> '*') 
    """.format(uuid=uuid, current_time=current_time)
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_LOTSPECIAL_RESULT",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_LOTSPECIAL_RESULT")


def InsertChamberRuleDataView2Temp(duck_db_memory=None, uuid="", current_time="", oracle_conn=None, ETL_Proc_Name="",
                                   used_table_dict=None):
    sql = """
            INSERT INTO APS_TMP_ETL_RLS_EQP_CHAMBER_RULE(
            EQP_ID, CH_ID
            ) 
            WITH EQP_CH_ID AS (                                                                                
                      SELECT SUBSTRING(T.EQP_ID, 1, position('.' in T.EQP_ID)-1) AS EQP_ID,                               
                      EQP_ID AS CH_ID                                                                               
                      FROM APS_SYNC_ETL_TOOL.APS_SYNC_ETL_TOOL T WHERE T.EQP_CHAMBER_FLAG='Chamber'           
                      AND T.HOST_EQP_FLAG ='N'                
                 )                                                                                                  
                 SELECT DISTINCT EQP_ID,                                                                            
                        STRING_AGG(CH_ID,';') OVER (PARTITION BY EQP_ID ORDER BY CH_ID) AS EQP_CH_ID    
                 FROM EQP_CH_ID                                                                                                     
           """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_EQP_CHAMBER_RULE",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_EQP_CHAMBER_RULE")
    sql = """
         INSERT INTO  APS_TMP_ETL_RLS_CHAMBER_RULE  
         WITH  CHAMBER_RULE_DATA AS (                                                                                                    
           SELECT CASE WHEN position('|' in CHAMBER_RULE)=0 AND position('&' in CHAMBER_RULE)=0 THEN CHAMBER_RULE                                   
                   ELSE REPLACE(REPLACE(REPLACE(REPLACE(CHAMBER_RULE,'(',''),')',''),'|',',@'),'&',';@')  
                       END AS RULE_NAME, R.LINE,R.EQP_ID,  R.RECIPE_ID                                                                                                      
            FROM APS_SYNC_CSCMBMRCPRULE.APS_SYNC_CSCMBMRCPRULE R                                                                                           

         ),                                                                                                                               
          ALL_DATA AS (                                                                                                                  
                   SELECT                                                                                                                      
                       R.LINE, R.EQP_ID,                                                                                                       
                       R.RECIPE_ID,                                                                                                            
                       R.EQP_ID||'.'|| REPLACE(RULE_NAME,'@',R.EQP_ID||'.') AS CH_ID                                                           
                   FROM                                                                                                                        
                   CHAMBER_RULE_DATA R                                                                                                         
                )                                                                                                                              
                SELECT                                                                                                                         
                      R.LINE,R.EQP_ID,                                                                                                         
                      R.RECIPE_ID,                                                                                                             
                      CASE WHEN LENGTH(R.CH_ID) > 512 THEN SUBSTRING(R.CH_ID,0,512) ELSE R.CH_ID END AS CH_ID                                     
                FROM                                                                                                                           
                ALL_DATA R                                                                                                              
        """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_CHAMBER_RULE",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_CHAMBER_RULE")

    sql = """
          INSERT INTO APS_TMP_ETL_RLS_ONLY_EQP_CHAMBER_RULE(                          
                 EQP_ID                                                           
                 )                                                                          
                  SELECT DISTINCT R.EQP_ID                                                                                      
                  FROM APS_TMP_ETL_RLS_CHAMBER_RULE R                                                                                                      
            """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_ONLY_EQP_CHAMBER_RULE",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_ONLY_EQP_CHAMBER_RULE")
    sql = """
         INSERT INTO APS_TMP_ETL_RLS_MFG_CHAMBER_RULE(                              
                 LINE,PROD_ID,PLAN_ID, OPE_NO, EQP_ID, RECIPE_ID, ACT_FLG                                                            
                 )                                                                          
                  SELECT M.LINE,M.PRODUCT_ID,                                                                                   
                         M.MAINPD_ID,M.OPERATION,                                           
                         M.EQP_ID,M.RECIPE_ID,                                              
                         CASE WHEN M.ACT_FLG_PRC = 'Y' AND M.ACT_FLG_MFG='Y' THEN 'Y'       
                           ELSE 'N' END AS ACT_FLG                                          
                  FROM APS_SYNC_CSCMBMRCPPRCFG_MFG.APS_SYNC_CSCMBMRCPPRCFG_MFG M                
                  INNER JOIN APS_TMP_ETL_RLS_CHAMBER_RULE R                             
                  ON R.RECIPE_ID = M.RECIPE_ID                                              
                  AND R.EQP_ID = M.EQP_ID                                                                                                             
            """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_MFG_CHAMBER_RULE",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_MFG_CHAMBER_RULE")


def InsertCsfrInhibit2Temp(duck_db_memory=None, uuid="", current_time="", oracle_conn=None, ETL_Proc_Name="",
                           used_table_dict=None):
    sql = """
     INSERT INTO APS_TMP_ETL_RLS_CSFR_IHBT
     (                                                                                                                               
      PROD_ID,PLAN_ID, OPE_NO, EQP_ID, PASS_FLG_PRC,                                                                                 
      PASS_FLG_MFG, PRC_UPT_USER, UPDATE_TIME                                                                                        
     )                                                                                                                               
     SELECT DISTINCT I.PRODUCTID, I.ROUTEID, I.OPENO, I.EQUIPMENTID, I.PASS_FLG_PRC, I.PASS_FLG_MFG, I.PRC_UPT_USER,                 
            I.UPDATE_TIME                                                                                                            
     FROM CSFRINHIBIT.CSFRINHIBIT AS I, 
          APS_TMP_ETL_RLS_EQPRCPRTC_RESULT AS  W                                              
     WHERE  W.PROD_ID = I.PRODUCTID                                                                                                    
     AND W.CSFR_PLAN_ID = I.ROUTEID                                                                                                 
     AND W.TARGET_OPE_NO = I.OPENO                                                                                                   
     AND W.EQP_ID = I.EQUIPMENTID                                                                                                    
    """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_CSFR_IHBT",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_CSFR_IHBT")
    row_num = my_duck.get_row_count_in_duckdb(duck_db_memory,
                                              "APS_SYNC_PHOTO_PATH_CONVERT.APS_SYNC_PHOTO_PATH_CONVERT",
                                              " ACTIVE_FLAG='Y'   AND USE_FLAG_TYPE = '{}'".format(cons.user_Flag7))
    if row_num > 0:
        sql = """
        INSERT /*+ append */ INTO  APS_TMP_ETL_RLS_CSFRIHBT_127CASE 
        (                                                                            
         PROD_ID, PLAN_ID, OPE_NO, EQP_ID, PASS_FLG_PRC,                             
         PASS_FLG_MFG, PRC_UPT_USER, SGS_FLAG, OPE_SEQ                               
        )                                                                            
        SELECT                                                                       
           I.PROD_ID,                                                                
           I.PLAN_ID,                                                                
           I.OPE_NO,                                                                 
           I.EQP_ID,                                                                 
           I.PASS_FLG_PRC,                                                           
           I.PASS_FLG_MFG,                                                           
           I.PRC_UPT_USER,'', ''                                                     
        FROM APS_TMP_ETL_RLS_CSFR_IHBT I                                          
        WHERE I.PASS_FLG_PRC = 'Y'                                                   
        AND I.PASS_FLG_MFG = 'N'                                                     
        AND I.PRC_UPT_USER='EIWatchDog'                                              
        """
        my_duck.exec_sql(oracle_conn=oracle_conn,
                         duck_db_memory=duck_db_memory,
                         ETL_Proc_Name=ETL_Proc_Name,
                         methodName="Insert Into APS_TMP_ETL_RLS_CSFRIHBT_127CASE",
                         sql=sql,
                         current_time=current_time,
                         update_table="APS_TMP_ETL_RLS_CSFRIHBT_127CASE")

    row_num = my_duck.get_row_count_in_duckdb(duck_db_memory,
                                              "APS_SYNC_PHOTO_PATH_CONVERT.APS_SYNC_PHOTO_PATH_CONVERT",
                                              " ACTIVE_FLAG='Y'   AND USE_FLAG_TYPE = '{}'".format(cons.user_Flag1))
    if row_num > 0:
        sql = """
        INSERT  INTO APS_TMP_ETL_RLS_CSFRIHBT_127CASE
            (                                                                             
             PROD_ID, PLAN_ID, OPE_NO, EQP_ID, PASS_FLG_PRC,                              
             PASS_FLG_MFG, PRC_UPT_USER, SGS_FLAG, OPE_SEQ                                
            )                                                                             
            SELECT I.PROD_ID,                                                           
                     I.PLAN_ID,                                                           
                     I.OPE_NO,                                                            
                     I.EQP_ID,                                                            
                     I.PASS_FLG_PRC,                                                      
                     I.PASS_FLG_MFG,                                                      
                     I.PRC_UPT_USER,'', ''                                                
            FROM APS_TMP_ETL_RLS_CSFR_IHBT I                                            
            WHERE I.PASS_FLG_PRC = 'N'                                                 
            AND I.PRC_UPT_USER= 'SPC'                                                  
        """
        my_duck.exec_sql(oracle_conn=oracle_conn,
                         duck_db_memory=duck_db_memory,
                         ETL_Proc_Name=ETL_Proc_Name,
                         methodName="Insert Into APS_TMP_ETL_RLS_CSFRIHBT_127CASE",
                         sql=sql,
                         current_time=current_time,
                         update_table="APS_TMP_ETL_RLS_CSFRIHBT_127CASE")

    row_num = my_duck.get_row_count_in_duckdb(duck_db_memory,
                                              "APS_SYNC_PHOTO_PATH_CONVERT.APS_SYNC_PHOTO_PATH_CONVERT",
                                              " ACTIVE_FLAG='Y'   AND USE_FLAG_TYPE = '{}'".format(cons.user_Flag2))
    if row_num > 0:
        sql = """
        INSERT INTO  APS_TMP_ETL_RLS_CSFRIHBT_127CASE
        (                                                                             
         PROD_ID, PLAN_ID, OPE_NO, EQP_ID, PASS_FLG_PRC,                              
         PASS_FLG_MFG, PRC_UPT_USER, SGS_FLAG, OPE_SEQ                                
        )                                                                             
        SELECT I.PROD_ID,                                                             
                 I.PLAN_ID,                                                           
                 I.OPE_NO,                                                            
                 I.EQP_ID,                                                            
                 I.PASS_FLG_PRC,                                                      
                 I.PASS_FLG_MFG,                                                      
                 I.PRC_UPT_USER,'', ''                                                
        FROM APS_TMP_ETL_RLS_CSFR_IHBT I                                            
        WHERE I.PASS_FLG_PRC = 'N'                                                 
        AND I.PRC_UPT_USER = 'ECMS'                                                
        """
        my_duck.exec_sql(oracle_conn=oracle_conn,
                         duck_db_memory=duck_db_memory,
                         ETL_Proc_Name=ETL_Proc_Name,
                         methodName="Insert Into APS_TMP_ETL_RLS_CSFRIHBT_127CASE",
                         sql=sql,
                         current_time=current_time,
                         update_table="APS_TMP_ETL_RLS_CSFRIHBT_127CASE")

    row_num = my_duck.get_row_count_in_duckdb(duck_db_memory,
                                              "APS_SYNC_PHOTO_PATH_CONVERT.APS_SYNC_PHOTO_PATH_CONVERT",
                                              " ACTIVE_FLAG='Y'   AND USE_FLAG_TYPE = '{}'".format(cons.user_Flag5))

    if row_num > 0:
        # 先把串接的中心数据移出来处理
        sql = """
        INSERT INTO APS_TMP_ETL_RLS_CSFRIHBT_5CASE_SOURCE (
            PROD_ID, PLAN_ID,OPE_NO, EQP_ID, PASS_FLG_PRC,SGS_FIRST_OP,PRC_UPT_USER,PASS_FLG_MFG, RN
        ) 
        SELECT T.PRODUCTID,
               T.ROUTEID,
               T.OPENO,
               T.EQUIPMENTID,
               T.PASS_FLG_PRC,
               F.SGS_FIRST_OP,
               T.PRC_UPT_USER,
               T.PASS_FLG_MFG,
               ROW_NUMBER() OVER(PARTITION BY T.PRODUCTID,T.ROUTEID,T.EQUIPMENTID,F.SGS_GROUP ORDER BY F.OPE_SEQ) AS RN
        FROM   CSFRINHIBIT.CSFRINHIBIT AS T
        INNER JOIN APS_SYNC_FLOW.APS_SYNC_FLOW AS F
        ON   F.PRODSPEC_ID = T.PRODUCTID
        AND SUBSTRINGING(F.MNPD_ID, 1, POSITION('.' IN (F.MNPD_ID))-1) = T.ROUTEID
        AND F.OPE_NO = T.OPENO
        AND F.SGS_FLAG='Y' 
        """
        my_duck.exec_sql(oracle_conn=oracle_conn,
                         duck_db_memory=duck_db_memory,
                         ETL_Proc_Name=ETL_Proc_Name,
                         methodName="Insert Into APS_TMP_ETL_RLS_CSFRIHBT_5CASE_SOURCE",
                         sql=sql,
                         current_time=current_time,
                         update_table="APS_TMP_ETL_RLS_CSFRIHBT_5CASE_SOURCE")

        # 把中心数据两两串接移出来处理
        sql = """
        INSERT INTO APS_TMP_ETL_RLS_CSFRIHBT_5CASE_INHIBIT(
            PROD_ID, PLAN_ID,OPE_NO, EQP_ID, PRC_UPT_USER,PASS_FLG_PRC,PASS_FLG_MFG
        )
         WITH CSA AS (                                                                                                 
            SELECT D.PROD_ID,D.PLAN_ID,                                                                                
                   D.OPE_NO,D.EQP_ID,D.RN,                                                                             
                   D.PRC_UPT_USER,D.PASS_FLG_PRC,D.PASS_FLG_MFG                                                        
                   FROM APS_TMP_ETL_RLS_CSFRIHBT_5CASE_SOURCE D                                                      
                   WHERE (D.SGS_FIRST_OP <> 'Y' OR D.SGS_FIRST_OP IS NULL )                                            
                   AND D.PASS_FLG_PRC = 'N'                                                                            
         ),                                                                                                            
         CSB AS (                                                                                                      
             SELECT D.PROD_ID,D.PLAN_ID,                                                                               
                D.OPE_NO,D.EQP_ID,D.RN                                                                                 
                FROM APS_TMP_ETL_RLS_CSFRIHBT_5CASE_SOURCE D                                                         
                WHERE D.RN = 1                                                                                         
                AND D.SGS_FIRST_OP = 'Y'                                                                               
                AND D.PASS_FLG_PRC = 'Y'                                                                               
         )                                                                                                            
         SELECT  A.PROD_ID,A.PLAN_ID,                                                                            
                 A.OPE_NO,A.EQP_ID,                                                                              
                 A.PRC_UPT_USER,A.PASS_FLG_PRC, A.PASS_FLG_MFG                                                   
         FROM CSA A, CSB B                                                                                       
         WHERE 1=1                                                                                               
               AND A.PLAN_ID = B.PLAN_ID                                                                         
               AND A.EQP_ID = B.EQP_ID                                                                           
               AND A.PROD_ID = B.PROD_ID                                                                         
               AND A.RN > B.RN                                                                                   
        """
        my_duck.exec_sql(oracle_conn=oracle_conn,
                         duck_db_memory=duck_db_memory,
                         ETL_Proc_Name=ETL_Proc_Name,
                         methodName="Insert Into APS_TMP_ETL_RLS_CSFRIHBT_5CASE_INHIBIT",
                         sql=sql,
                         current_time=current_time,
                         update_table="APS_TMP_ETL_RLS_CSFRIHBT_5CASE_INHIBIT")
        sql = """
            INSERT INTO APS_TMP_ETL_RLS_CSFRIHBT_5CASE 
            (                                                                                                            
             PROD_ID, PLAN_ID, OPE_NO, EQP_ID, PASS_FLG_PRC,                                                             
             PASS_FLG_MFG, PRC_UPT_USER                                                                                  
            )                                                                                                            
            WITH TOOLG AS (                                                                                              
                  SELECT EQP_ID AS TOOL_ID,MAX(EQP_G) AS TOOLG_ID                                                            
                  FROM APS_SYNC_ETL_TOOL.APS_SYNC_ETL_TOOL                   
                  GROUP BY EQP_ID                                                                                        
            )                                                                                                            
            SELECT CT.PROD_ID                                                                                            
                  ,CT.PLAN_ID                                                                                            
                  ,CT.OPE_NO                                                                                             
                  ,CT.EQP_ID                                                                                             
                  ,CT.PASS_FLG_PRC                                                                                       
                  ,CT.PASS_FLG_MFG                                                                                       
                  ,CT.PRC_UPT_USER                                                                                       
                FROM APS_TMP_ETL_RLS_CSFRIHBT_5CASE_INHIBIT CT                                                           
                INNER JOIN TOOLG TL                                                                                      
                ON TL.TOOL_ID = CT.EQP_ID                                                                                
        """
        my_duck.exec_sql(oracle_conn=oracle_conn,
                         duck_db_memory=duck_db_memory,
                         ETL_Proc_Name=ETL_Proc_Name,
                         methodName="Insert Into APS_TMP_ETL_RLS_CSFRIHBT_5CASE",
                         sql=sql,
                         current_time=current_time,
                         update_table="APS_TMP_ETL_RLS_CSFRIHBT_5CASE")
    row_num = my_duck.get_row_count_in_duckdb(duck_db_memory,
                                              "APS_SYNC_PHOTO_PATH_CONVERT.APS_SYNC_PHOTO_PATH_CONVERT",
                                              " ACTIVE_FLAG='Y'   AND USE_FLAG_TYPE = '{}'".format(cons.user_Flag4))
    if row_num > 0:
        # 针对ChipBody的过滤
        sql = """
        INSERT INTO APS_TMP_ETL_RLS_CSFRIHBT_4CASE_INHIB (
            PROD_ID,PLAN_ID, OPE_NO, EQP_ID, PASS_FLG_PRC, PASS_FLG_MFG, PRC_UPT_USER,UPDATE_TIME, CHIPBODY_PROD
        )
        SELECT DISTINCT I.PRODUCTID, I.ROUTEID, I.OPENO, I.EQUIPMENTID, I.PASS_FLG_PRC, I.PASS_FLG_MFG, I.PRC_UPT_USER,
                         '{current_time}' as UPDATE_TIME, I.CHIPBODY AS CHIPBODY_PROD
        FROM CSFRINHIBIT.CSFRINHIBIT AS I ,
             APS_TMP_ETL_RLS_EQPRCPRTC_RESULT AS W
        WHERE W.CHIPBODY =  I.CHIPBODY 
        AND W.CSFR_PLAN_ID = I.ROUTEID
        AND W.TARGET_OPE_NO = I.OPENO
        AND W.EQP_ID = I.EQUIPMENTID
        """
        my_duck.exec_sql(oracle_conn=oracle_conn,
                         duck_db_memory=duck_db_memory,
                         ETL_Proc_Name=ETL_Proc_Name,
                         methodName="Insert Into APS_TMP_ETL_RLS_CSFRIHBT_4CASE_INHIB",
                         sql=sql,
                         current_time=current_time,
                         update_table="APS_TMP_ETL_RLS_CSFRIHBT_4CASE_INHIB")

        # 先求 PassFlagPrc 为 Y 的
        sql = """
         INSERT INTO APS_TMP_ETL_RLS_CSFRIHBT_CHIPBODY                                  
         (                                                                                           
           PROD_ID,PLAN_ID, OPE_NO, EQP_ID, CHIPBODY, PASS_FLG_PRC                                   
         )                                                                                           
         WITH CHIP_DATA AS (                                                                                                                                                    
               SELECT C.PROD_ID,                                                                     
                  C.PLAN_ID,                                                                     
                  C.OPE_NO,                                                                      
                  C.EQP_ID,                                                                      
                  CHIPBODY_PROD AS CHIPBODY,                                                     
                          ROW_NUMBER() OVER(PARTITION BY C.PLAN_ID,C.OPE_NO,C.EQP_ID,            
                          C.CHIPBODY_PROD                                                
                                             ORDER BY C.UPDATE_TIME DESC) AS RN,                     
                  C.PASS_FLG_PRC                                                                 
              FROM APS_TMP_ETL_RLS_CSFRIHBT_4CASE_INHIB C                                             
         )                                                                                           
         SELECT PROD_ID,                                                                             
              PLAN_ID,                                                                               
              OPE_NO,                                                                                
              EQP_ID,                                                                                
              CHIPBODY,                                                                              
              PASS_FLG_PRC                                                                           
         FROM  CHIP_DATA                                                                             
         WHERE RN = 1 AND PASS_FLG_PRC = 'Y'                                                         
        """
        my_duck.exec_sql(oracle_conn=oracle_conn,
                         duck_db_memory=duck_db_memory,
                         ETL_Proc_Name=ETL_Proc_Name,
                         methodName="Insert Into APS_TMP_ETL_RLS_CSFRIHBT_CHIPBODY",
                         sql=sql,
                         current_time=current_time,
                         update_table="APS_TMP_ETL_RLS_CSFRIHBT_CHIPBODY")

        # 求 ChipBody Prc Flag 为 Y 的 所有其他 PrcFlag 为 N 的
        sql = """
        INSERT  INTO APS_TMP_ETL_RLS_CSFRIHBT_4CASE                          				    
        (                                                                                                              
         PROD_ID, PLAN_ID, OPE_NO, EQP_ID, PASS_FLG_PRC,                                                               
         PASS_FLG_MFG, PRC_UPT_USER, SGS_FLAG, OPE_SEQ                                                                 
        )                                                                                                              
        SELECT DISTINCT                                                                                                
               I.PROD_ID                                                                                               
              ,I.PLAN_ID                                                                                               
              ,I.OPE_NO                                                                                                
              ,I.EQP_ID                                                                                                
              ,I.PASS_FLG_PRC, '', '', '', ''                                                                          
        FROM APS_TMP_ETL_RLS_CSFR_IHBT I                                                                             
        INNER JOIN APS_TMP_ETL_RLS_CSFRIHBT_CHIPBODY C ON I.CHIPBODY_PROD = C.CHIPBODY                                  
                                                      AND I.PLAN_ID = C.PLAN_ID                                        
                                                      AND I.OPE_NO = C.OPE_NO                                          
                                                      AND I.EQP_ID = C.EQP_ID                                          
        WHERE I.PASS_FLG_PRC = 'N'                                                                                     
        """
        my_duck.exec_sql(oracle_conn=oracle_conn,
                         duck_db_memory=duck_db_memory,
                         ETL_Proc_Name=ETL_Proc_Name,
                         methodName="Insert Into APS_TMP_ETL_RLS_CSFRIHBT_4CASE",
                         sql=sql,
                         current_time=current_time,
                         update_table="APS_TMP_ETL_RLS_CSFRIHBT_4CASE")
    row_num = my_duck.get_row_count_in_duckdb(duck_db_memory,
                                              "APS_SYNC_PHOTO_PATH_CONVERT.APS_SYNC_PHOTO_PATH_CONVERT",
                                              " ACTIVE_FLAG='Y'   AND USE_FLAG_TYPE = '{}'".format(cons.user_Flag3))

    if row_num > 0:
        # 单独先把ReworkInhibit数据移出来处理
        sql = """
        INSERT INTO APS_TMP_ETL_RLS_CSFRIHBT_3CASE_INHIB (
            PROD_ID,PLAN_ID, REWORK_OPE_NO, EQP_ID, PASS_FLG_PRC, PASS_FLG_MFG 
        )
        SELECT A.PROD_ID, A.PLAN_ID, A.OPE_NO AS REWORK_OPE_NO, A.EQP_ID, A.PASS_FLG_PRC, A.PASS_FLG_MFG 
        FROM APS_TMP_ETL_RLS_CSFR_IHBT A
        WHERE  SUBSTRINGING(A.PLAN_ID,1,2)='YY'   
        AND A.PASS_FLG_PRC = 'N' 
        """
        my_duck.exec_sql(oracle_conn=oracle_conn,
                         duck_db_memory=duck_db_memory,
                         ETL_Proc_Name=ETL_Proc_Name,
                         methodName="Insert Into APS_TMP_ETL_RLS_CSFRIHBT_3CASE_INHIB",
                         sql=sql,
                         current_time=current_time,
                         update_table="APS_TMP_ETL_RLS_CSFRIHBT_3CASE_INHIB")


        sql = """
        INSERT INTO APS_TMP_ETL_RLS_CSFRIHBT_3CASE_NOTREW (
            PROD_ID, OPE_NO, EQP_ID 
        )
        SELECT DISTINCT B.PRODUCTID,B.OPENO,B.EQUIPMENTID 
        FROM CSFRINHIBIT.CSFRINHIBIT AS B, APS_TMP_ETL_RLS_EQPRCPRTC_RESULT AS W
        WHERE SUBSTRINGING(B.ROUTEID,1,2)<>'YY'	
        -- 因为case3 只有黄光用，避免执行超时。需要增加P机台的限制
            --AND INSTR(B.EQUIPMENTID,'P') = 1	
            AND POSITION('P' in B.EQUIPMENTID) = 1   
            AND B.PASS_FLG_PRC = 'Y'	    
            AND B.PRODUCTID = W.PROD_ID AND B.OPENO = W.TARGET_OPE_NO
            AND B.EQUIPMENTID = W.EQP_ID
        """
        my_duck.exec_sql(oracle_conn=oracle_conn,
                         duck_db_memory=duck_db_memory,
                         ETL_Proc_Name=ETL_Proc_Name,
                         methodName="Insert Into APS_TMP_ETL_RLS_CSFRIHBT_3CASE_NOTREW",
                         sql=sql,
                         current_time=current_time,
                         update_table="APS_TMP_ETL_RLS_CSFRIHBT_3CASE_NOTREW")

        # 相同的 Product, OpeNo, Equipment的 MainFlow的 Pass_flag_Prc = 'Y'的 视为 Active
        sql = """
         INSERT INTO APS_TMP_ETL_RLS_CSFRIHBT_3CASE 
         (                                               		  						       
           PROD_ID, PLAN_ID, OPE_NO, EQP_ID, PASS_FLG_PRC, PASS_FLG_MFG                                                        
         )                                                                                                                                 
         SELECT RI.PROD_ID, RI.PLAN_ID, RI.REWORK_OPE_NO, RI.EQP_ID, RI.PASS_FLG_PRC, RI.PASS_FLG_MFG                          
         FROM APS_TMP_ETL_RLS_CSFRIHBT_3CASE_INHIB  RI, APS_TMP_ETL_RLS_CSFRIHBT_3CASE_NOTREW MI                                       
         WHERE MI.PROD_ID = RI.PROD_ID                                                                                          
         AND MI.OPE_NO = RI.REWORK_OPE_NO AND MI.EQP_ID = RI.EQP_ID                                                             
        """
        my_duck.exec_sql(oracle_conn=oracle_conn,
                         duck_db_memory=duck_db_memory,
                         ETL_Proc_Name=ETL_Proc_Name,
                         methodName="Insert Into APS_TMP_ETL_RLS_CSFRIHBT_3CASE_NOTREW",
                         sql=sql,
                         current_time=current_time,
                         update_table="APS_TMP_ETL_RLS_CSFRIHBT_3CASE")

    # csfr Inhibit 最终结果merge(merge的数据是 Avtive 数据)
    sql = """
     INSERT  INTO APS_TMP_ETL_RLS_CSFRIHBT_RESULT
     (                                               		  			
       PROD_ID, PLAN_ID, OPE_NO, EQP_ID, PASS_FLG_PRC, PASS_FLG_MFG, PRC_UPT_USER  	
     )                                               					
     SELECT DISTINCT                                                                    
            A.PROD_ID                                                                   
          , A.PLAN_ID                                                                   
          , A.OPE_NO                                                                    
          , A.EQP_ID                                                                    
          , A.PASS_FLG_PRC                                                              
          , A.PASS_FLG_MFG                                                              
          , A.PRC_UPT_USER                                                              
      FROM (                                                                            
             SELECT * FROM APS_TMP_ETL_RLS_CSFRIHBT_127CASE
             UNION ALL                                                                     
             SELECT * FROM APS_TMP_ETL_RLS_CSFRIHBT_5CASE
             UNION ALL                                                                     
             SELECT * FROM APS_TMP_ETL_RLS_CSFRIHBT_4CASE
             UNION ALL                                                                     
             SELECT * FROM APS_TMP_ETL_RLS_CSFRIHBT_3CASE
     ) A                                                                                
    """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_CSFRIHBT_RESULT",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_CSFRIHBT_RESULT")


def InsertCsfrPath2Temp(duck_db_memory=None, uuid="", current_time="", oracle_conn=None, ETL_Proc_Name="",
                        used_table_dict=None):
    sql = """
     INSERT /*+ append */ INTO APS_TMP_ETL_RLS_CSFR_PATH 
     SELECT CT.PROD_ID,                 
            CT.PLAN_ID,                 
            CT.OPE_NO,                  
            CT.EQP_ID,                  
            CT.PASS_FLG_PRC,            
            CT.PASS_FLG_MFG,            
            CT.PRC_UPT_USER             
     FROM APS_TMP_ETL_RLS_CSFR_IHBT CT                                                                                                           
     WHERE CT.PASS_FLG_PRC='Y'                                                             
     AND (CT.PASS_FLG_MFG='Y' OR        
     (CT.PASS_FLG_MFG='N' AND CT.OPE_NO LIKE '%NPR10')) 
    """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_CSFR_PATH",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_CSFR_PATH")


def getReworkToEqpGActive(duck_db_memory=None, uuid="", current_time="", oracle_conn=None, ETL_Proc_Name="",
                          used_table_dict=None):
    sql = """
    INSERT INTO APS_TMP_ETL_RLS_LOT_TO_EQPG_INHIBIT(
        TOOLG_ID, LOT_ID, OPE_NO, PROD_ID, PLAN_ID, PASS_FLG_PRC,EQP_ID,ACTIVE_FLAG
    )
    SELECT DISTINCT F.TOOLG_ID,
                    F.LOT_ID,
                    F.OPE_NO,
                    F.PROD_ID,
                    F.PLAN_ID,
                   CASE WHEN C.OPE_NO IS NOT NULL THEN C.PASS_FLG_PRC ELSE 'N' END AS PASS_FLG_PRC,                                   
                   CASE WHEN C.OPE_NO IS NOT NULL THEN C.EQP_ID ELSE 'X' END AS EQP_ID,                                               
                   CASE WHEN C.OPE_NO IS NOT NULL AND C.PASS_FLG_PRC = 'Y'                                                            
                    AND EXISTS (SELECT 1 FROM APS_SYNC_ETL_TOOL.APS_SYNC_ETL_TOOL T WHERE T.EQP_ID = C.EQP_ID AND F.TOOLG_ID = T.EQP_G) THEN 'Y' ELSE 'N' END ACTIVE_FLAG 
    FROM APS_TMP_ETL_RLS_LOT_TO_EQPG F
    LEFT JOIN APS_TMP_ETL_RLS_CSFR_IHBT C
    ON F.CSFR_PLAN_ID = C.PLAN_ID 
    AND F.PROD_ID = C.PROD_ID
    AND F.OPE_NO = C.OPE_NO
    """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_LOT_TO_EQPG_INHIBIT",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_LOT_TO_EQPG_INHIBIT")

    sql = """
    INSERT INTO APS_TMP_ETL_RLS_LOT_TO_EQPG_RECIPE ( 
        --modify by xiecheng for version up
        --TOOLG_ID, LOT_ID, OPE_NO, PROD_ID, PLAN_ID, PASS_FLG_PRC,FLOW_RECIPE
        TOOLG_ID, LOT_ID, OPE_NO, PROD_ID, PLAN_ID, PASS_FLG_PRC,FLOW_RECIPE,EQP_ID,ACTIVE_FLAG
    )
    SELECT DISTINCT F.TOOLG_ID,
                    F.LOT_ID,
                    F.OPE_NO,
                    F.PROD_ID,
                    F.PLAN_ID,
                    F.PASS_FLG_PRC,
                    R.FLOW_RECIPE,
                     --modify by xiecheng for version up
                    F.EQP_ID, 
                    F.ACTIVE_FLAG
    FROM APS_TMP_ETL_RLS_LOT_TO_EQPG_INHIBIT  F
    LEFT JOIN APS_TMP_ETL_RLS_EQPRCPRTC_RESULT  R
    --modify by xiecheng for version up
    --ON F.TOOLG_ID = R.TARGET_TOOLG_ID 
    ON  F.EQP_ID = R.EQP_ID 
    AND F.PROD_ID = R.PROD_ID
    AND F.PLAN_ID = R.PLAN_ID 
    AND F.OPE_NO = R.TARGET_OPE_NO 
    """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_LOT_TO_EQPG_RECIPE",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_LOT_TO_EQPG_RECIPE")


def getTankRule(duck_db_memory=None, uuid="", current_time="", oracle_conn=None, ETL_Proc_Name="",
                used_table_dict=None):
    sql = """
        INSERT INTO  APS_TMP_ETL_RLS_SETTING_TANK_RULE (                         
            EQP_ID, CH_SET                                                             
            )                                                                           
            SELECT EQP_ID,                                                                                          
                   STRING_AGG(EQP_ID||'.'||TRIM(CHAMBER_NAME),';' ORDER BY CHAMBER_NAME) AS CH_SET       
            FROM APS_SYNC_UNIT_EQP_CHAMBER_SETTING.APS_SYNC_UNIT_EQP_CHAMBER_SETTING S                                                                       
            WHERE EXISTS                                                                                            
            (SELECT 1 FROM APS_SYNC_UMT_WET_RECIPE_TANK_RULE.APS_SYNC_UMT_WET_RECIPE_TANK_RULE R                                                             
             WHERE R.EQP_ID = S.EQP_ID)                                                                             
            GROUP BY EQP_ID       
       """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_SETTING_TANK_RULE",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_SETTING_TANK_RULE")
    sql = """
            INSERT INTO APS_TMP_ETL_RLS_TANK_RULE(                                
            EQP_ID, CHAR_TYPE, RECIPE, TANK_NAME, CH_SET                                                     
            )                                                                         
             SELECT DISTINCT R.EQP_ID,R.CHAR_TYPE,                                                                  
                             REPLACE(RECIPE,'*','') AS RECIPE,                                                      
                             R.TANK_NAME,                                                                           
                             EQP_ID ||'.' || REPLACE(TANK_NAME,'&',';'||EQP_ID||'.') AS CH_SET                      
             FROM APS_SYNC_UMT_WET_RECIPE_TANK_RULE.APS_SYNC_UMT_WET_RECIPE_TANK_RULE R                     
           """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_TANK_RULE",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_TANK_RULE")


def getLotSpecialInhibit(duck_db_memory=None, uuid="", current_time="", oracle_conn=None, ETL_Proc_Name="",
                         used_table_dict=None):
    sql = """
    INSERT INTO  APS_TMP_ETL_RLS_LOT_SPECIAL (                                                                              
    PARENT_ID, LOT_ID,OPE_NO,STEP_ID,TARGET_STEP_ID,TARGET_OPE_NO,PLAN_ID,TARGET_PLAN_ID,
    PROD_ID,PD_ID,TARGET_TOOLG_ID,EQP_ID,M_RECIPE,PHYSICAL_RECIPE_ID,PPID,
    RETICLE_ID,FLOW_RECIPE,SET_STATUS6,SET_STATUS5,BATCH_SIZE_MAX,BATCH_SIZE_MIN,QTY,
    BATCH_NAME,CASSETE_ID,BATCH_ID,EQP_CHAMBER_FLAG,SUB_LOT_TYPE,MODULE,LOT_PROC_STATE,TRANS_STATE
    )                                                                                                                   
     SELECT W.PARENT_ID                                                                                                                                                                  
          ,W.LOT_ID                                                                                                                                                                 
          ,W.OPE_NO                                                                                                                                                                 
          ,W.STEP_ID                                                                                                                                                                
          ,W.TARGET_STEP_ID                                                                                                                                                         
          ,W.TARGET_OPE_NO                                                                                                                                                          
          ,W.PLAN_ID                                                                                                                                                                
          ,W.TARGET_PLAN_ID                                                                                                                                                         
          ,W.PROD_ID                                                                                                                                                                
          ,W.PD_ID                                                                                                                                                                  
          ,W.TARGET_TOOLG_ID                                                                                                                                                        
          ,W.EQP_ID                                                                                                                                                                 
          ,W.M_RECIPE                                                                                                                                                               
          ,W.PHYSICAL_RECIPE_ID                                                                                                                                                     
          ,W.PPID                                                                                                                                                                   
          ,W.RETICLE_ID                                                                                         
          ,W.FLOW_RECIPE                                                                                                                                                            
          ,CASE WHEN LS.LOT_ID IS NOT NULL AND TRIM(LS.EQP_ID) <> TRIM(W.EQP_ID) THEN 'LotSpecial;' END AS SET_STATUS6                                                              
          ,W.LOT_EQP_STATUS AS SET_STATUS5                                                                                                                                          
          ,W.BATCH_SIZE_MAX                                                                                                                                                         
          ,W.BATCH_SIZE_MIN                                                                                                                                                         
          ,W.QTY                                                                                                                                                                    
          ,W.BATCH_NAME,W.CASSETE_ID,W.BATCH_ID,W.EQP_CHAMBER_FLAG,SUB_LOT_TYPE,W.MODULE,W.LOT_PROC_STATE,W.TRANS_STATE                                                                                                      
     FROM  APS_TMP_ETL_RLS_EQPRCPRTC_RESULT  W                                                                                                                                                
     LEFT JOIN APS_TMP_ETL_RLS_LOTSPECIAL_RESULT LS ON  LS.LOT_ID = W.LOT_ID  AND LS.OPE_NO = W.TARGET_OPE_NO                                                                                     
    """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_LOT_SPECIAL",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_LOT_SPECIAL")


def getApcPliotInhibit(duck_db_memory=None, uuid="", current_time="", oracle_conn=None, ETL_Proc_Name="",
                       used_table_dict=None):
    sql = """
    INSERT INTO APS_TMP_ETL_RLS_APC_PILOT (                                                                                  
           PARENT_ID, LOT_ID,OPE_NO,STEP_ID,TARGET_STEP_ID,TARGET_OPE_NO,PLAN_ID,TARGET_PLAN_ID,
           PROD_ID,PD_ID,TARGET_TOOLG_ID,EQP_ID,M_RECIPE,PHYSICAL_RECIPE_ID,PPID,
           RETICLE_ID,FLOW_RECIPE,SET_STATUS6,SET_STATUS7,SET_STATUS5,BATCH_SIZE_MAX,BATCH_SIZE_MIN,QTY,
           BATCH_NAME,CASSETE_ID,BATCH_ID,EQP_CHAMBER_FLAG,SUB_LOT_TYPE,MODULE
           --modify by xiecheng for verison up
           ,LOT_PROC_STATE,SET_STATUS20,TRANS_STATE 
        )                                                                                                                   
         SELECT W.PARENT_ID                                                                                                                                                                  
              ,W.LOT_ID                                                                                                                                                                 
              ,W.OPE_NO                                                                                                                                                                 
              ,W.STEP_ID                                                                                                                                                                
              ,W.TARGET_STEP_ID                                                                                                                                                         
              ,W.TARGET_OPE_NO                                                                                                                                                          
              ,W.PLAN_ID                                                                                                                                                                
              ,W.TARGET_PLAN_ID                                                                                                                                                         
              ,W.PROD_ID                                                                                                                                                                
              ,W.PD_ID                                                                                                                                                                  
              ,W.TARGET_TOOLG_ID                                                                                                                                                        
              ,W.EQP_ID                                                                                                                                                                 
              ,W.M_RECIPE                                                                                                                                                               
              ,W.PHYSICAL_RECIPE_ID                                                                                                                                                     
              ,W.PPID                                                                                                                                                                   
              ,W.RETICLE_ID                                                                                         
              ,W.FLOW_RECIPE                                                                                                                                                            
              ,W.SET_STATUS6                                                                                                                                               
              ,CASE WHEN SI.LOT_ID IS NOT NULL AND TRIM(SI.EQP_ID) <> TRIM(W.EQP_ID) THEN 'APC_Pilot;' END AS SET_STATUS7                                                               
              ,W.SET_STATUS5                                                                                                                                               
              ,W.BATCH_SIZE_MAX                                                                                                                                                         
              ,W.BATCH_SIZE_MIN                                                                                                                                                         
              ,W.QTY                                                                                                                                                                      
              ,W.BATCH_NAME,W.CASSETE_ID,W.BATCH_ID,W.EQP_CHAMBER_FLAG,W.SUB_LOT_TYPE, W.MODULE  
              --modify by xiecheng for version up
              ,W.LOT_PROC_STATE
              ,CASE WHEN PT.PRODUCT_ID IS NOT NULL AND NOT EXISTS (SELECT 1 FROM APS_SYNC_RTD_PREFER_TOOL PT1 WHERE PT1.PRODUCT_ID = W.PROD_ID AND PT1.OPE_NO = W.TARGET_OPE_NO
        	  AND TRIM(PT1.EQP_ID) = TRIM(W.EQP_ID) ) THEN 'PreferTool;' END AS SET_STATUS20  
        	  --modify by xiecheng for version up
        	  ,W.TRANS_STATE                                                                                                  
         FROM APS_TMP_ETL_RLS_LOT_SPECIAL  W                                                                                                                                                 
         LEFT JOIN APS_TMP_ETL_RLS_APC_SPLIT_INFO SI ON  SI.LOT_ID = W.LOT_ID                                                                                                                                 
                                                   AND SI.TARGET_OPE_NO = W.TARGET_OPE_NO 
         LEFT JOIN APS_SYNC_RTD_PREFER_TOOL.APS_SYNC_RTD_PREFER_TOOL PT ON  PT.PRODUCT_ID = W.PROD_ID           
                                      AND PT.OPE_NO = W.TARGET_OPE_NO                                                           

    """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_APC_PILOT",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_APC_PILOT")


def getRcpInhibit(duck_db_memory=None, uuid="", current_time="", oracle_conn=None, ETL_Proc_Name="",
                  used_table_dict=None):
    sql = """
    INSERT INTO APS_TMP_ETL_RLS_APC_PILOT_RCP (                                                                                                                                  
        PARENT_ID, LOT_ID,OPE_NO,STEP_ID,TARGET_STEP_ID,TARGET_OPE_NO,PLAN_ID,TARGET_PLAN_ID,
        PROD_ID,PD_ID,TARGET_TOOLG_ID,EQP_ID,M_RECIPE,PHYSICAL_RECIPE_ID,PPID,
        RETICLE_ID,FLOW_RECIPE,SET_STATUS6,SET_STATUS7,SET_STATUS5,BATCH_SIZE_MAX,BATCH_SIZE_MIN,QTY,
        BATCH_NAME,CASSETE_ID,BATCH_ID,EQP_CHAMBER_FLAG,SUB_LOT_TYPE,SET_STATUS2,MODULE
        --modify by xiecheng for version up
        ,LOT_PROC_STATE,SET_STATUS20,TRANS_STATE
    )                                                                                                                                                                                  
     SELECT   DISTINCT W.PARENT_ID                                                                                                                                                     
          ,W.LOT_ID                                                                                                                                                                
          ,W.OPE_NO                                                                                                                                                                
          ,W.STEP_ID                                                                                                                                                               
          ,W.TARGET_STEP_ID                                                                                                                                                        
          ,W.TARGET_OPE_NO                                                                                                                                                         
          ,W.PLAN_ID                                                                                                                                                               
          ,W.TARGET_PLAN_ID                                                                                                                                                        
          ,W.PROD_ID                                                                                                                                                               
          ,W.PD_ID                                                                                                                                                                 
          ,W.TARGET_TOOLG_ID                                                                                                                                                       
          ,W.EQP_ID                                                                                                                                                                
          ,W.M_RECIPE                                                                                                                                                              
          ,W.PHYSICAL_RECIPE_ID                                                                                                                                                    
          ,W.PPID                                                                                                                                                                  
          ,W.RETICLE_ID                                                                                                                                                            
          ,W.FLOW_RECIPE                                                                                                                                                           
          ,W.SET_STATUS6                                                                                                                                                           
          ,SET_STATUS7                                                                                                                                                               
          ,W.SET_STATUS5                                                                                                                                                           
          ,W.BATCH_SIZE_MAX                                                                                                                                                        
          ,W.BATCH_SIZE_MIN                                                                                                                                                        
          ,W.QTY                                                                                                                                                                     
          ,W.BATCH_NAME,W.CASSETE_ID,W.BATCH_ID,W.EQP_CHAMBER_FLAG,W.SUB_LOT_TYPE                                                                                                  
          ,CASE WHEN (ERI1.EQP_ID || ERI2.EQP_ID || ERI4.EQP_ID || ERI5.EQP_ID || ERI6.EQP_ID || ERI7.EQP_ID) IS NOT NULL  THEN 'EqpRcpInhibit;' END AS SET_STATUS2                                                                                              
          ,W.MODULE 
           --modify by xiecheng for version up
          ,W.LOT_PROC_STATE,W.SET_STATUS20 
          ,W.TRANS_STATE                                                                                                                                                                   
      FROM APS_TMP_ETL_RLS_APC_PILOT W                                                                                                                                                       
        LEFT JOIN APS_TMP_ETL_RLS_EQPRCP_INHIBIT1 ERI1 ON  ERI1.PRODUCT_ID = W.PROD_ID                                              
                                                     AND position(ERI1.RECIPE_ID in W.M_RECIPE)>0                                      
                                                     AND ERI1.EQP_ID = W.EQP_ID                                                  
        LEFT JOIN APS_TMP_ETL_RLS_EQPRCP_INHIBIT2 ERI2 ON ERI2.EQP_ID = W.EQP_ID                                                    
                                                     AND position(ERI2.RECIPE_ID in W.M_RECIPE)>0                                      
        LEFT JOIN APS_TMP_ETL_RLS_EQPRCP_INHIBIT4 ERI4 ON ERI4.SUB_LOT_TYPE = W.SUB_LOT_TYPE                                        
                                                     AND ERI4.EQP_ID = W.EQP_ID                                                  
        LEFT JOIN APS_TMP_ETL_RLS_EQPRCP_INHIBIT5 ERI5 ON ERI5.SUB_LOT_TYPE = W.SUB_LOT_TYPE                                        
                                                     AND position(ERI5.RECIPE_ID in W.M_RECIPE)>0                                      
        LEFT JOIN APS_TMP_ETL_RLS_EQPRCP_INHIBIT6 ERI6 ON ERI6.EQP_ID = W.EQP_ID                                                    
                                                     AND position(ERI6.RECIPE_ID in W.M_RECIPE)>0                                      
                                                     AND ERI6.SUB_LOT_TYPE = W.SUB_LOT_TYPE                                      
        LEFT JOIN APS_TMP_ETL_RLS_EQPRCP_INHIBIT7 ERI7 ON  ERI7.PRODUCT_ID = (case when ERI7.PRODUCT_ID = '*' then '*' else W.PROD_ID end)              
                                                     AND position(ERI7.RECIPE_ID in (case when ERI7.RECIPE_ID = '*' then '*' else W.M_RECIPE end))>0       
                                                     AND ERI7.EQP_ID = (case when ERI7.EQP_ID = '*' then '*' else W.EQP_ID end)                    
                                                     AND ERI7.SUB_LOT_TYPE =(case when ERI7.SUB_LOT_TYPE = '*' then '*' else W.SUB_LOT_TYPE end)    
    """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_APC_PILOT_RCP",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_APC_PILOT_RCP")


def getRtdQtimeInhibit(duck_db_memory=None, uuid="", current_time="", oracle_conn=None, ETL_Proc_Name="",
                       used_table_dict=None):
    sql = """
    INSERT INTO APS_TMP_ETL_RLS_RTD_QTIME (                                                                         
     PARENT_ID, LOT_ID,OPE_NO,STEP_ID,TARGET_STEP_ID,TARGET_OPE_NO,PLAN_ID,TARGET_PLAN_ID,  
     PROD_ID,PD_ID,TARGET_TOOLG_ID,EQP_ID,M_RECIPE,PHYSICAL_RECIPE_ID,PPID,
     RETICLE_ID,FLOW_RECIPE,SET_STATUS6,SET_STATUS7,SET_STATUS5,BATCH_SIZE_MAX,BATCH_SIZE_MIN,QTY,
     BATCH_NAME,CASSETE_ID,BATCH_ID,EQP_CHAMBER_FLAG,SUB_LOT_TYPE,MODULE,SET_STATUS2,SET_STATUS18,IS_BTATH_FLAG
     ,LOT_PROC_STATE,SET_STATUS20,TRANS_STATE 
    )                                                                                                                  
     SELECT W.PARENT_ID                                                                                                                                                                 
          ,W.LOT_ID                                                                                                                                                                
          ,W.OPE_NO                                                                                                                                                                
          ,W.STEP_ID                                                                                                                                                               
          ,W.TARGET_STEP_ID                                                                                                                                                        
          ,W.TARGET_OPE_NO                                                                                                                                                         
          ,W.PLAN_ID                                                                                                                                                               
          ,W.TARGET_PLAN_ID                                                                                                                                                        
          ,W.PROD_ID                                                                                                                                                               
          ,W.PD_ID                                                                                                                                                                 
          ,W.TARGET_TOOLG_ID                                                                                                                                                       
          ,W.EQP_ID                                                                                                                                                                
          ,W.M_RECIPE                                                                                                                                                              
          ,W.PHYSICAL_RECIPE_ID                                                                                                                                                    
          ,W.PPID                                                                                                                                                                  
          ,W.RETICLE_ID                                                                                                                                                            
          ,W.FLOW_RECIPE                                                                                                                                                           
          ,W.SET_STATUS6                                                                                                                                                           
          ,W.SET_STATUS7                                                                                                                                                           
          ,W.SET_STATUS5                                                                                                                                                           
          ,W.BATCH_SIZE_MAX                                                                                                                                                        
          ,W.BATCH_SIZE_MIN                                                                                                                                                        
          ,W.QTY                                                                                                                                                                     
          ,W.BATCH_NAME,W.CASSETE_ID,W.BATCH_ID,W.EQP_CHAMBER_FLAG,W.SUB_LOT_TYPE, W.MODULE                                                                                        
          ,W.SET_STATUS2                                                                                                                                                           
      -- // RQPI 为DIFF和Batch 的WET；RQWW 只针对WMT、WID机台；RQUN 非Batch的WET，不包含WMT、WID
          ,CASE WHEN (INSTR(W.EQP_ID,'WMT') = 1 OR INSTR(W.EQP_ID,'WID') = 1) AND RQWW.LOT_ID IS NOT NULL THEN RQWW.QTIME_ISSUE||';'                                               
                WHEN W.MODULE ='DIFF' AND RQPI.LOT_ID IS NOT NULL THEN RQPI.QTIME_ISSUE||';'                                                                                       
                WHEN W.MODULE ='WET' AND BATN.MAINPD_ID IS NOT NULL AND RQPI.LOT_ID IS NOT NULL THEN RQPI.QTIME_ISSUE||';'                                                         
                WHEN W.MODULE ='WET' AND BATN.MAINPD_ID IS NULL AND RQUN.LOT_ID IS NOT NULL THEN RQUN.QTIME_ISSUE||';'  END  SET_STATUS18                                          
          ,CASE WHEN BATN.MAINPD_ID IS NOT NULL THEN 'Y' ELSE 'N' END AS IS_BTATH_FLAG
          --modify by xiecheng for version up
           ,W.LOT_PROC_STATE,W.SET_STATUS20,W.TRANS_STATE                                                                                               
     FROM APS_TMP_ETL_RLS_APC_PILOT_RCP  W                                                                                                                                      
     LEFT JOIN APS_ETL_RTDQTTIME.APS_ETL_RTDQTTIME AS RQPI ON  RQPI.TARGET_PLAN_ID = W.TARGET_PLAN_ID AND RQPI.TARGET_OPE_NO = W.TARGET_OPE_NO                                   
                                                         AND RQPI.LOT_ID = W.LOT_ID  AND RQPI.TARGET_PROD_ID = W.PROD_ID                                                       
     LEFT JOIN APS_ETL_RTDQTTIME_UN_WMTWID.APS_ETL_RTDQTTIME_UN_WMTWID RQUN ON RQUN.TARGET_PLAN_ID = W.TARGET_PLAN_ID AND RQUN.TARGET_OPE_NO = W.TARGET_OPE_NO                                   
                                                         AND RQUN.LOT_ID = W.LOT_ID  AND RQUN.TARGET_PROD_ID = W.PROD_ID                                                       
     LEFT JOIN APS_ETL_RTDQTTIME_WMTWID.APS_ETL_RTDQTTIME_WMTWID RQWW ON RQWW.TARGET_PLAN_ID = W.TARGET_PLAN_ID AND RQWW.TARGET_OPE_NO = W.TARGET_OPE_NO                                   
                                                         AND RQWW.LOT_ID = W.LOT_ID  AND RQWW.TARGET_PROD_ID = W.PROD_ID                                                       
     LEFT JOIN APS_TMP_ETL_RLS_BATCH_OPE BATN ON  BATN.MAINPD_ID = W.TARGET_PLAN_ID AND BATN.OPE_NO = W.TARGET_OPE_NO                                                               
    """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_RTD_QTIME",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_RTD_QTIME")


def getPHRtdQtimeInhibit(duck_db_memory=None, uuid="", current_time="", oracle_conn=None, ETL_Proc_Name="",
                         used_table_dict=None):
    sql = """
        INSERT INTO APS_TMP_ETL_RLS_PH_RTD_QTIME(                                                                         
             PARENT_ID, LOT_ID,OPE_NO,STEP_ID,TARGET_STEP_ID,TARGET_OPE_NO,PLAN_ID,TARGET_PLAN_ID,
                    PROD_ID,PD_ID,TARGET_TOOLG_ID,EQP_ID,M_RECIPE,PHYSICAL_RECIPE_ID,PPID,
                    RETICLE_ID,FLOW_RECIPE,SET_STATUS6,SET_STATUS7,SET_STATUS5,BATCH_SIZE_MAX,BATCH_SIZE_MIN,QTY,
                    BATCH_NAME,CASSETE_ID,BATCH_ID,EQP_CHAMBER_FLAG,SUB_LOT_TYPE,MODULE,SET_STATUS2,SET_STATUS18,
                    IS_BTATH_FLAG,SET_STATUS19,SET_STATUS20, LOT_PROC_STATE ,TRANS_STATE                                                                                                 
            )                                                                                                                  
             SELECT W.PARENT_ID                                                                                                                                                                 
                ,W.LOT_ID                                                                                                                                                                
                ,W.OPE_NO                                                                                                                                                                
                ,W.STEP_ID                                                                                                                                                               
                ,W.TARGET_STEP_ID                                                                                                                                                        
                ,W.TARGET_OPE_NO                                                                                                                                                         
                ,W.PLAN_ID                                                                                                                                                               
                ,W.TARGET_PLAN_ID                                                                                                                                                        
                ,W.PROD_ID                                                                                                                                                               
                ,W.PD_ID                                                                                                                                                                 
                ,W.TARGET_TOOLG_ID                                                                                                                                                       
                ,W.EQP_ID                                                                                                                                                                
                ,W.M_RECIPE                                                                                                                                                              
                ,W.PHYSICAL_RECIPE_ID                                                                                                                                                    
                ,W.PPID                                                                                                                                                                  
                ,W.RETICLE_ID                                                                                                                                                            
                ,W.FLOW_RECIPE                                                                                                                                                           
                ,W.SET_STATUS6                                                                                                                                                           
                ,W.SET_STATUS7                                                                                                                                                           
                ,W.SET_STATUS5                                                                                                                                                           
                ,W.BATCH_SIZE_MAX                                                                                                                                                        
                ,W.BATCH_SIZE_MIN                                                                                                                                                        
                ,W.QTY                                                                                                                                                                     
                ,W.BATCH_NAME,W.CASSETE_ID,W.BATCH_ID,W.EQP_CHAMBER_FLAG,W.SUB_LOT_TYPE, W.MODULE                                                                                        
                ,W.SET_STATUS2                                                                                                                                                           
                ,CASE WHEN AMRD.LOT_ID IS NOT NULL THEN W.SET_STATUS18 ||AMRD.QTIME_ISSUE||';' ELSE W.SET_STATUS18 END AS SET_STATUS18                                                   
                ,W.IS_BTATH_FLAG                                                                                                                                                         
                ,CASE WHEN AEPR.PLAN_ID IS NOT NULL                                                                                                                                      
                           AND W.LOT_PROC_STATE <> 'Processing' THEN AEPR.RTD_QTIME||';' END AS SET_STATUS19                                                                             
                ,W.SET_STATUS20, W.LOT_PROC_STATE,W.TRANS_STATE                                                                                                                                       
             FROM APS_TMP_ETL_RLS_RTD_QTIME   W                                                                                                                                            
            -- 针对黄光区加的新版RTDQtime的逻辑
             LEFT JOIN APS_ETL_PH_RTDQTIME.APS_ETL_PH_RTDQTIME AEPR ON AEPR.PLAN_ID = W.TARGET_PLAN_ID AND AEPR.OPE_NO = W.TARGET_OPE_NO  AND AEPR.PROD_ID = W.PROD_ID                  
                                                                       AND W.LOT_ID = AEPR.LOT_ID                                  
             LEFT JOIN APS_MID_RTDQTIME_DATALOSS.APS_MID_RTDQTIME_DATALOSS  AMRD ON                                                
                                                            AMRD.TARGET_PLAN_ID = W.TARGET_PLAN_ID AND AMRD.TARGET_OPE_NO = W.TARGET_OPE_NO                                   
                                                             AND AMRD.LOT_ID = W.LOT_ID  AND AMRD.TARGET_PROD_ID = W.PROD_ID 
    """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_PH_RTD_QTIME",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_PH_RTD_QTIME")


def getChamberRuleInhibit(duck_db_memory=None, uuid="", current_time="", oracle_conn=None, ETL_Proc_Name="",
                          used_table_dict=None):
    sql = """
   INSERT INTO APS_TMP_ETL_RLS_CHAMBER_RULE_RESULT(                                                                 
         PARENT_ID, LOT_ID,OPE_NO,STEP_ID,TARGET_STEP_ID,TARGET_OPE_NO,PLAN_ID,TARGET_PLAN_ID,
                PROD_ID,PD_ID,TARGET_TOOLG_ID,EQP_ID,M_RECIPE,PHYSICAL_RECIPE_ID,PPID,
                RETICLE_ID,FLOW_RECIPE,SET_STATUS6,SET_STATUS7,SET_STATUS5,BATCH_SIZE_MAX,BATCH_SIZE_MIN,QTY,
                BATCH_NAME,CASSETE_ID,BATCH_ID,EQP_CHAMBER_FLAG,SUB_LOT_TYPE,MODULE,SET_STATUS2,SET_STATUS18,IS_BTATH_FLAG,
                CH_SET,SET_STATUS8,OTHER_MIN_BATCH_SIZE,SET_STATUS19,SET_STATUS20,LOT_PROC_STATE,TRANS_STATE                                                                                                
        )                                                                                                                   
         SELECT W.PARENT_ID                                                                                                                                                                  
            ,W.LOT_ID                                                                                                                                                                 
            ,W.OPE_NO                                                                                                                                                                 
            ,W.STEP_ID                                                                                                                                                                
            ,W.TARGET_STEP_ID                                                                                                                                                         
            ,W.TARGET_OPE_NO                                                                                                                                                          
            ,W.PLAN_ID                                                                                                                                                                
            ,W.TARGET_PLAN_ID                                                                                                                                                         
            ,W.PROD_ID                                                                                                                                                                
            ,W.PD_ID                                                                                                                                                                  
            ,W.TARGET_TOOLG_ID                                                                                                                                                        
            ,W.EQP_ID                                                                                                                                                                 
            ,W.M_RECIPE                                                                                                                                                               
            ,W.PHYSICAL_RECIPE_ID                                                                                                                                                     
            ,W.PPID                                                                                                                                                                   
            ,W.RETICLE_ID                                                                                                                                                             
            ,W.FLOW_RECIPE                                                                                                                                                            
            ,W.SET_STATUS6                                                                                                                                                            
            ,W.SET_STATUS7                                                                                                                                                            
            ,W.SET_STATUS5                                                                                                                                                            
            ,W.BATCH_SIZE_MAX                                                                                                                                                         
            ,W.BATCH_SIZE_MIN                                                                                                                                                         
            ,W.QTY                                                                                                                                                                      
            ,W.BATCH_NAME,W.CASSETE_ID,W.BATCH_ID,W.EQP_CHAMBER_FLAG,W.SUB_LOT_TYPE, W.MODULE                                                                                         
            ,W.SET_STATUS2,SET_STATUS18,IS_BTATH_FLAG                                                                                                                                 
            ,CASE WHEN W.EQP_CHAMBER_FLAG='Chamber' AND TRIM(TME.EQP_ID) IS NOT NULL THEN TM.CH_ID ELSE                                                                               
                  (CASE WHEN W.EQP_CHAMBER_FLAG='Chamber' AND TRIM(TME.EQP_ID) IS NULL THEN ETN.CH_ID ELSE                                                                                  
                  (CASE WHEN BTN.EQP_ID IS NOT NULL THEN BTN.CH_SET ELSE (CASE WHEN BTN2.EQP_ID IS NOT NULL THEN BTN2.CH_SET ELSE (CASE WHEN BTN3.EQP_ID IS NOT NULL THEN BTN3.CH_SET ELSE  
                  (CASE WHEN TTTI.EQP_ID IS NOT NULL THEN TTTI.CH_SET ELSE (CASE WHEN TTTN.EQP_ID IS NOT NULL THEN TTTN.CH_SET ELSE TST.CH_SET END) END) END) END) END) END)  END CHAMBER_SET               
                  ,CASE WHEN W.EQP_CHAMBER_FLAG='Chamber' AND TME.EQP_ID IS NOT NULL AND TM.EQP_ID IS NULL THEN 'NoChSet;'                                                                  
            ELSE (CASE WHEN W.EQP_CHAMBER_FLAG='Chamber' AND TM.EQP_ID IS NOT NULL AND MTN.EQP_ID IS NULL AND position('DYB' in W.TARGET_PLAN_ID)=0 THEN 'ChUserFlg;'                    
            ELSE (CASE WHEN W.EQP_CHAMBER_FLAG='Chamber' AND MTN.EQP_ID IS NOT NULL AND MTN.PROD_ID <> '*' AND MTN.ACT_FLG = 'N' THEN 'ChUserFlg;'                                 
            ELSE (CASE WHEN W.EQP_CHAMBER_FLAG='Chamber' AND MTN.EQP_ID IS NOT NULL AND MTN.PROD_ID = '*' AND MTN.ACT_FLG = 'N' THEN 'ChUserFlg;' END) END)END)END AS SET_STATUS8  
            ,COALESCE(BTN.OTHER_MIN_CTRL,0) AS OTHER_MIN_BATCH_SIZE,W.SET_STATUS19,W.SET_STATUS20                                                                                                                           
            ,W.LOT_PROC_STATE,W.TRANS_STATE                                                                                                                                
         FROM APS_TMP_ETL_RLS_PH_RTD_QTIME  W                                                                                                                                                
         LEFT JOIN APS_TMP_ETL_RLS_CHAMBER_RULE TM ON  TM.RECIPE_ID = W.M_RECIPE                                                                                                         
                                                          AND TM.EQP_ID = W.EQP_ID                                                                                                             
         LEFT JOIN  APS_TMP_ETL_RLS_ONLY_EQP_CHAMBER_RULE TME ON TME.EQP_ID = W.EQP_ID                                                                                                    
         LEFT JOIN  APS_TMP_ETL_RLS_EQP_CHAMBER_RULE  ETN ON ETN.EQP_ID = W.EQP_ID                                                                                                         
         LEFT JOIN APS_TMP_ETL_RLS_MFG_CHAMBER_RULE  MTN ON MTN.EQP_ID = W.EQP_ID                                                                                                         
                                                          AND MTN.RECIPE_ID = W.M_RECIPE                                                                                                       
                                                          AND MTN.OPE_NO = W.TARGET_OPE_NO                                                                                                     
                                                          --AND DECODE(MTN.PROD_ID,'*',W.PROD_ID, MTN.PROD_ID) = W.PROD_ID   
                                                          and ((MTN.PROD_ID <> '*'
                                                           AND
                                                           MTN.PROD_ID = W.PROD_ID
                                                          ) OR MTN.PROD_ID = '*')                                                                    
                                                          AND position((case when MTN.PLAN_ID = '*' then W.TARGET_PLAN_ID else MTN.PLAN_ID end) in W.TARGET_PLAN_ID) = 1                                                
         LEFT JOIN APS_TMP_ETL_RLS_BOAT_CONSTRAINTS  BTN ON  BTN.OPE_NO = W.TARGET_OPE_NO                                                                                                 
                                                          AND BTN.PROD_ID = W.PROD_ID                                                                                                          
                                                          AND BTN.EQP_ID = W.EQP_ID                                                                                                             
         LEFT JOIN APS_TMP_ETL_RLS_BOAT_CONSTRAINTS2  BTN2 ON  BTN2.EQP_ID = W.EQP_ID                                                                                                     
         LEFT JOIN APS_TMP_ETL_RLS_BOAT_CONSTRAINTS3  BTN3 ON  BTN3.EQP_ID = W.EQP_ID                                                                                                     
         LEFT JOIN APS_TMP_ETL_RLS_SETTING_TANK_RULE  TST ON  TST.EQP_ID = W.EQP_ID                                                                                                       
         LEFT JOIN APS_TMP_ETL_RLS_TANK_RULE  TTTI ON  TTTI.EQP_ID = W.EQP_ID                                                                                                             
                                                            AND TTTI.CHAR_TYPE = 'IN' AND position(TTTI.RECIPE in W.PPID) > 0                                                                           
         LEFT JOIN APS_TMP_ETL_RLS_TANK_RULE  TTTN ON  TTTN.EQP_ID = W.EQP_ID                                                                                                             
                                                            AND TTTN.CHAR_TYPE = 'NOT IN' AND position(TTTN.RECIPE in W.PPID) = 0   
    """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_CHAMBER_RULE_RESULT",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_CHAMBER_RULE_RESULT")


def getAnomalyEwsLot(duck_db_memory=None, uuid="", current_time="", oracle_conn=None, ETL_Proc_Name="",
                     used_table_dict=None):
    sql = """
          INSERT INTO APS_TMP_ETL_RLS_ANOMALY_EWS_LOT(                                                                  
         PARENT_ID, LOT_ID,OPE_NO,STEP_ID,TARGET_STEP_ID,TARGET_OPE_NO,PLAN_ID,TARGET_PLAN_ID,
               PROD_ID,PD_ID,TARGET_TOOLG_ID,EQP_ID,M_RECIPE,PHYSICAL_RECIPE_ID,PPID,
               RETICLE_ID,FLOW_RECIPE,SET_STATUS6,SET_STATUS7,SET_STATUS5,BATCH_SIZE_MAX,BATCH_SIZE_MIN,QTY,
               BATCH_NAME,CASSETE_ID,BATCH_ID,EQP_CHAMBER_FLAG,SUB_LOT_TYPE,MODULE,SET_STATUS2,SET_STATUS18,IS_BTATH_FLAG,
               CH_SET,SET_STATUS8,OTHER_MIN_BATCH_SIZE,SET_STATUS19,SET_STATUS20,SET_STATUS21,SET_STATUS22,LOT_PROC_STATE,TRANS_STATE                                                                                                      
         )                                                                                                                    
          SELECT W.PARENT_ID                                                                                                                                                                   
             ,W.LOT_ID                                                                                                                                                                  
             ,W.OPE_NO                                                                                                                                                                  
             ,W.STEP_ID                                                                                                                                                                 
             ,W.TARGET_STEP_ID                                                                                                                                                          
             ,W.TARGET_OPE_NO                                                                                                                                                           
             ,W.PLAN_ID                                                                                                                                                                 
             ,W.TARGET_PLAN_ID                                                                                                                                                          
             ,W.PROD_ID                                                                                                                                                                 
             ,W.PD_ID                                                                                                                                                                   
             ,W.TARGET_TOOLG_ID                                                                                                                                                         
             ,W.EQP_ID                                                                                                                                                                  
             ,W.M_RECIPE                                                                                                                                                                
             ,W.PHYSICAL_RECIPE_ID                                                                                                                                                      
             ,W.PPID                                                                                                                                                                    
             ,W.RETICLE_ID                                                                                                                                                              
             ,W.FLOW_RECIPE                                                                                                                                                             
             ,W.SET_STATUS6                                                                                                                                                             
             ,W.SET_STATUS7                                                                                                                                                             
             ,W.SET_STATUS5                                                                                                                                                             
             ,W.BATCH_SIZE_MAX                                                                                                                                                          
             ,W.BATCH_SIZE_MIN                                                                                                                                                          
             ,W.QTY                                                                                                                                                                       
             ,W.BATCH_NAME,W.CASSETE_ID,W.BATCH_ID,W.EQP_CHAMBER_FLAG,W.SUB_LOT_TYPE, W.MODULE                                                                                          
             ,W.SET_STATUS2,SET_STATUS18,IS_BTATH_FLAG                                                                                                                                  
             ,W.CH_SET                     
             ,W.SET_STATUS8                
             ,W.OTHER_MIN_BATCH_SIZE,W.SET_STATUS19,W.SET_STATUS20                                                                                                                              
             ,CASE WHEN LD.LOT_ID IS NOT NULL AND W.EQP_ID <> LD.EQP_ID THEN 'AnomalyLot;' END AS SET_STATUS21                                                                                                                             
             ,CASE WHEN LD2.EQP_ID IS NOT NULL AND W.LOT_ID <> LD2.LOT_ID THEN 'AnomalyProd;' END AS SET_STATUS22                                                                                                                             
             ,W.LOT_PROC_STATE,W.TRANS_STATE                                                                                                                              
          FROM APS_TMP_ETL_RLS_CHAMBER_RULE_RESULT  W                                                                                                                                            
          LEFT JOIN  APS_TMP_ETL_RLS_ANOMALY_EWS_LOT_DATA   LD ON  LD.LOT_ID = W.LOT_ID                                                                                                                         
                                                        AND LD.OPE_NO = W.TARGET_OPE_NO                                                                                                              
          LEFT JOIN  APS_TMP_ETL_RLS_ANOMALY_EWS_LOT_DATA   LD2 ON LD2.EQP_ID = W.EQP_ID                                                                                                                        
                                                        AND LD2.PRODSPEC_ID = W.PROD_ID
     """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_ANOMALY_EWS_LOT",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_ANOMALY_EWS_LOT")


def getMonitorRecipeInhibit(duck_db_memory=None, uuid="", current_time="", oracle_conn=None, ETL_Proc_Name="",
                            used_table_dict=None):
    sql = """
        INSERT INTO APS_TMP_ETL_RLS_MES_FRLRCP(                         
             LOT_ID, TARGET_OPE_NO, TARGET_PLAN_ID, PROD_ID, EQP_ID, FLOW_RECIPE,MNTR_PRODSPEC_ID                                                             
        )                                                                           
         SELECT DISTINCT                                                                                                                                                                               
             W.LOT_ID                                                                                                                                                                                                                                                                                                                    
            ,W.TARGET_OPE_NO                                                                                                                                                                                                                                                                                                                    
            ,W.TARGET_PLAN_ID                                                                                                                                                      
            ,W.PROD_ID                                                                                                                                                                                                                                                                                                                  
            ,W.EQP_ID                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
            ,W.FLOW_RECIPE                                                                                                                                                         
            ,P.MNTR_PRODSPEC_ID                                                                                                                        
         FROM APS_TMP_ETL_RLS_ANOMALY_EWS_LOT  W                    
         INNER JOIN APS_SYNC_MES_FRLRCP.APS_SYNC_MES_FRLRCP P                        
         ON P.LCRECIPE_ID = W.FLOW_RECIPE                 
         AND P.MNTR_PRODSPEC_ID IS NOT NULL               
        -- AND P.PARTCODE= ' + partCodeList.get(mesFrlrcp) + ' 
        --modify by xiecheng for version up
         AND W.MODULE <> 'WET'                          
     """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_MES_FRLRCP",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_MES_FRLRCP")
    sql = """
           INSERT INTO APS_TMP_ETL_RLS_MES_FRLRCP_CSF(                        
            LOT_ID, TARGET_OPE_NO, TARGET_PLAN_ID, PROD_ID, EQP_ID, FLOW_RECIPE,MNTR_PRODSPEC_ID,SET_STATUS23                                                        
            )                                                                          
            SELECT DISTINCT                                                                                                                                                                                                                            
                W.LOT_ID                                                                                                                                                                                                                                                                                                               
               ,W.TARGET_OPE_NO                                                                                                                                                                                                                                                                                                               
               ,W.TARGET_PLAN_ID                                                                                                                                                 
               ,W.PROD_ID                                                                                                                                                                                                                                                                                                             
               ,W.EQP_ID                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
               ,W.FLOW_RECIPE                                                                                                                                                    
               ,W.MNTR_PRODSPEC_ID                                                                    
               ,CASE WHEN P.EQUIPMENTID IS NULL THEN 'MonitorRecipeInhibit;' END AS SET_STATUS23                                                                                                                
            FROM APS_TMP_ETL_RLS_MES_FRLRCP  W                                                            
            LEFT JOIN CSFRINHIBIT.CSFRINHIBIT P                                   
            ON P.PRODUCTID = W.MNTR_PRODSPEC_ID                                                       
            AND P.EQUIPMENTID = W.EQP_ID                                                              
            AND P.OPENO = W.TARGET_OPE_NO                                                             
            AND P.PASS_FLG_PRC='Y'                                                                    
            AND P.PASS_FLG_MFG='Y'                                                                    
            --AND P.PARTCODE=' + partCodeList.get(csfrinhibit) + '                          
         """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_MES_FRLRCP_CSF",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_MES_FRLRCP_CSF")

    sql = """
       INSERT INTO APS_TMP_ETL_RLS_MONITOR_RECIPE(                                             
                 PARENT_ID, LOT_ID,OPE_NO,STEP_ID,TARGET_STEP_ID,TARGET_OPE_NO,PLAN_ID,TARGET_PLAN_ID, 
                 PROD_ID,PD_ID,TARGET_TOOLG_ID,EQP_ID,M_RECIPE,PHYSICAL_RECIPE_ID,PPID,
                 RETICLE_ID,FLOW_RECIPE,SET_STATUS6,SET_STATUS7,SET_STATUS5,BATCH_SIZE_MAX,BATCH_SIZE_MIN,QTY,
                 BATCH_NAME,CASSETE_ID,BATCH_ID,EQP_CHAMBER_FLAG,SUB_LOT_TYPE,MODULE,SET_STATUS2,SET_STATUS18,IS_BTATH_FLAG,
                 CH_SET,SET_STATUS8,OTHER_MIN_BATCH_SIZE,SET_STATUS19,SET_STATUS20,SET_STATUS21,SET_STATUS22,LOT_PROC_STATE,SET_STATUS23,TRANS_STATE                                                                        
        )                                                                                            
        SELECT DISTINCT W.PARENT_ID                                                                                                                                                                                                 
           ,W.LOT_ID                                                                                                                                                                 
           ,W.OPE_NO                                                                                                                                                                 
           ,W.STEP_ID                                                                                                                                                                
           ,W.TARGET_STEP_ID                                                                                                                                                         
           ,W.TARGET_OPE_NO                                                                                                                                                          
           ,W.PLAN_ID                                                                                                                                                                
           ,W.TARGET_PLAN_ID                                                                                                                                                         
           ,W.PROD_ID                                                                                                                                                                
           ,W.PD_ID                                                                                                                                                                  
           ,W.TARGET_TOOLG_ID                                                                                                                                                        
           ,W.EQP_ID                                                                                                                                                                 
           ,W.M_RECIPE                                                                                                                                                               
           ,W.PHYSICAL_RECIPE_ID                                                                                                                                                     
           ,W.PPID                                                                                                                                                                   
           ,W.RETICLE_ID                                                                                                                                                             
           ,W.FLOW_RECIPE                                                                                                                                                            
           ,W.SET_STATUS6                                                                                                                                                            
           ,W.SET_STATUS7                                                                                                                                                            
           ,W.SET_STATUS5                                                                                                                                                            
           ,W.BATCH_SIZE_MAX                                                                                                                                                         
           ,W.BATCH_SIZE_MIN                                                                                                                                                         
           ,W.QTY                                                                                                                                                                    
           ,W.BATCH_NAME,W.CASSETE_ID,W.BATCH_ID,W.EQP_CHAMBER_FLAG,W.SUB_LOT_TYPE, W.MODULE                                                                                         
           ,W.SET_STATUS2,SET_STATUS18,IS_BTATH_FLAG                                                                                                                                 
           ,W.CH_SET                                                                                 
           ,W.SET_STATUS8                                                                            
           ,W.OTHER_MIN_BATCH_SIZE,W.SET_STATUS19,W.SET_STATUS20                                                                                                                            
           ,W.SET_STATUS21                                                                                                                           
           ,W.SET_STATUS22                                                                                                                           
           ,W.LOT_PROC_STATE                                                                         
           ,C.SET_STATUS23,W.TRANS_STATE                                                                                                             
        FROM APS_TMP_ETL_RLS_ANOMALY_EWS_LOT  W                                                                
        LEFT JOIN APS_TMP_ETL_RLS_MES_FRLRCP_CSF C                                                       
        ON C.LOT_ID = W.LOT_ID                                                                       
        AND C.PROD_ID = W.PROD_ID                                                                    
        AND C.TARGET_PLAN_ID = W.TARGET_PLAN_ID                                                      
        AND C.TARGET_OPE_NO = W.TARGET_OPE_NO                                                        
        AND C.EQP_ID = W.EQP_ID                          
     """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_RLS_MONITOR_RECIPE",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_MONITOR_RECIPE")


def InsertRlsTempData2Temp(duck_db_memory=None, uuid="", current_time="", oracle_conn=None, ETL_Proc_Name="",
                           used_table_dict=None):
    sql = """
     INSERT /*+ append */ INTO APS_TMP_ETL_RLS
             (
                PARENT_ID, LOT_ID, STEP_ID, OPE_NO, TARGET_STEP_ID, TARGET_OPE_NO, PLAN_ID, TARGET_PLAN_ID, PROD_ID, PD_ID,
                TARGET_TOOLG_ID, EQP_ID, QTY, M_RECIPE, PHYSICAL_RECIPE_ID, PHOTO_FLAG, RETICLE_ID, ACTIVE_RTCL, CHAMBER_SET,
                SET_STATUS, BATCH_SIZE_MAX, BATCH_SIZE_MIN, FLOW_RECIPE,OTHER_MIN_BATCH_SIZE,NON_WET_BATCH,MODULE 
              )                                                                           
               WITH RLS_DATA AS (                                                                                                                                                                            
                    SELECT W.PARENT_ID                                                                                                                                                                   
                          ,W.LOT_ID                                                                                                                                                                  
                          ,W.OPE_NO                                                                                                                                                                  
                          ,W.STEP_ID                                                                                                                                                                 
                          ,W.TARGET_STEP_ID                                                                                                                                                          
                          ,W.TARGET_OPE_NO                                                                                                                                                           
                          ,W.PLAN_ID                                                                                                                                                                 
                          ,W.TARGET_PLAN_ID                                                                                                                                                          
                          ,W.PROD_ID                                                                                                                                                                 
                          ,W.PD_ID                                                                                                                                                                   
                          ,W.TARGET_TOOLG_ID                                                                                                                                                         
                          ,W.EQP_ID                                                                                                                                                                  
                          ,W.M_RECIPE                                                                                                                                                                
                          ,W.PHYSICAL_RECIPE_ID                                                                                                                                                      
                          ,W.PPID                                                                                                                                                                    
                          ,CASE WHEN SUBSTRING(                                                                                                                                                         
                                   SUBSTRING(W.TARGET_OPE_NO,                                                                                                                                   
                                          POSITION('.' IN W.TARGET_OPE_NO) + 1,                                                                                                           
                                          LENGTH(W.TARGET_OPE_NO) - POSITION('.' IN W.TARGET_OPE_NO)), 1, 2) = 'PP' THEN 'Y'                                                              
                                  ELSE 'N' END AS PHOTOFLAG                                                                                                                                  
                          ,CASE WHEN TRIM(W.RETICLE_ID) IS NOT NULL THEN W.RETICLE_ID ELSE (CASE WHEN TRIM(DY.DRBL_ID) IS NOT NULL THEN DY.DRBL_ID ELSE W.RETICLE_ID END)END AS RETICLE_ID          
                          ,W.FLOW_RECIPE                                                                                                                                                             
                          ,CASE WHEN W.EQP_CHAMBER_FLAG='Chamber' AND TRIM(TM.PROD_ID) IS NOT NULL THEN TM.CH_ID ELSE                                                                                
                                                (CASE WHEN BTN.EQP_ID IS NOT NULL THEN BTN.CH_SET ELSE (CASE WHEN BTN2.EQP_ID IS NOT NULL THEN BTN2.CH_SET ELSE BTN3.CH_SET END) END) END CHAMBER_SET        
                          ,CASE WHEN CP.EQP_ID IS NULL AND CI.EQP_ID IS NULL AND W.TARGET_PLAN_ID NOT LIKE 'DYB%' THEN 'CSFRInhibit;'                                                             
                               END AS SET_STATUS1                                                                                                                                                            
                          ,W.SET_STATUS2                                                                                                                                                             
                           -- 加入逻辑：黄光区域V_MASK_GROUP_MAPPLING如果没有设置对应的MASK_GROUP可以不需要RETCILE，可以正常跑（除了DYB）
                           --modify by xiecheng for version up
                          --,CASE WHEN W.TARGET_PLAN_ID NOT LIKE 'DYB%' AND TRIM(W.RETICLE_ID) IS NULL AND TRIM(GM.PRODSPEC_ID) IS NOT NULL AND W.TARGET_TOOLG_ID IN ('PK_KrF','PH_ArF','PU_I-Line')  THEN 'RMS_NoReticle;'   
                         --  ELSE (CASE WHEN W.TARGET_PLAN_ID LIKE 'DYB%' AND TRIM(DY.DRBL_ID) IS NULL AND W.TARGET_TOOLG_ID IN ('PK_KrF','PH_ArF','PU_I-Line') THEN 'RMS_NoReticle;' END)	   END AS SET_STATUS4     
                           ,CASE WHEN W.TARGET_PLAN_ID NOT LIKE 'DYB%' AND TRIM(W.RETICLE_ID) IS NULL AND TRIM(GM.PRODSPEC_ID) IS NOT NULL AND W.TARGET_TOOLG_ID IN ('PK_KrF','PH_ArF','PU_I-Line','PI_Immer')  THEN 'RMS_NoReticle;'   
                           ELSE (CASE WHEN W.TARGET_PLAN_ID LIKE 'DYB%' AND TRIM(DY.DRBL_ID) IS NULL AND W.TARGET_TOOLG_ID IN ('PK_KrF','PH_ArF','PU_I-Line','PI_Immer') THEN 'RMS_NoReticle;' END)	   END AS SET_STATUS4                            
                          ,W.SET_STATUS6                                                                                                                                                
                          ,W.SET_STATUS7                                                                                                                                                  
                          ,CASE WHEN W.EQP_CHAMBER_FLAG='Chamber' AND TRIM(TM.PROD_ID) IS NULL THEN 'NoChSet;'                                                                                       
                             ELSE (CASE WHEN W.EQP_CHAMBER_FLAG='Chamber' AND TRIM(TM.CHAMBER_USER_FLAG) ='N' THEN 'ChUserFlg;' END)  END AS SET_STATUS8                                                             
                           -- 如果封Batch站点的Batch_id 为null，则不需要限制
                          ,CASE WHEN W.OPE_NO = W.TARGET_OPE_NO AND RF.LOT_ID IS NULL AND W.IS_BTATH_FLAG = 'N' THEN 'ResourceFlag;'                                                                   
                            WHEN W.OPE_NO = W.TARGET_OPE_NO AND RF.LOT_ID IS NULL AND W.BATCH_ID IS NOT NULL AND W.IS_BTATH_FLAG = 'Y' THEN  'ResourceFlag;'                                   
                               END AS SET_STATUS9                                                                                                                                                
                           -- 特殊LOT指定机群
                          ,CASE WHEN LTN.LOT_ID IS NOT NULL AND LTN.TOOLG_ID <> W.TARGET_TOOLG_ID THEN 'LotEqpg;' END AS SET_STATUS10                                                                
                           -- 针对Rework Coming绑机的逻辑
                          ,CASE WHEN  RCT.OPE_NO IS NOT NULL AND RCT.EQP_ID <> W.EQP_ID  THEN 'ReworkComingInhibit;'                                                                                 
                          ELSE (CASE WHEN RCST.OPE_NO IS NOT NULL AND RCST.EQP_ID <> W.EQP_ID  THEN 'ReworkComingInhibit;' END)                                                                      
                          END AS SET_STATUS11   
                          --modify by xiecheng for version up                                                                                                                                                     
                         -- ,CASE WHEN ATN.EQP_ID IS NOT NULL THEN 'APC inhibit;'  END AS SET_STATUS12    
                         --如果是RUN状态，则不需要考量 
                           ,CASE WHEN W.OPE_NO = W.TARGET_OPE_NO AND W.LOT_PROC_STATE='RUN' THEN '' ELSE (CASE WHEN ATN.EQP_ID IS NOT NULL OR GATN.PROD_ID IS NOT NULL THEN 'APC inhibit;' END) END AS SET_STATUS12     
                          --modify by xiecheng for version up 
                          --,CASE WHEN (SUBSTRING(W.TRANS_STATE,2,1) <>'O' OR LENGTH(W.TRANS_STATE) < 2) AND TTN.LOT_ID IS NOT NULL THEN 'TransStateInhibit;' END AS SET_STATUS13                                                                                          
                          --,CASE WHEN W.TRANS_STATE NOT IN ('EO','SO','SI') AND TTN.LOT_ID IS NOT NULL THEN 'TransStateInhibit;' END AS SET_STATUS13  
                          ,CASE WHEN W.TRANS_STATE NOT IN ('EO','SO','SI','EI') THEN 'TransStateInhibit;' 
                                WHEN TTN.LOT_ID IS NOT NULL AND (LENGTH(W.TRANS_STATE) < 2 OR SUBSTRING(W.TRANS_STATE,2,1) <>'O') THEN 'TransStateInhibit;' END AS SET_STATUS13  
                          ,CASE WHEN W.FLOW_RECIPE IS NULL THEN 'LCRecipeNotExists;' END AS SET_STATUS14                                                                                             
                          ,CASE WHEN BTTN.BATCH_NAME IS NOT NULL THEN 'FlowBatchPathFlag;' END AS SET_STATUS15                                                                                       
                          ,CASE WHEN MTTN.LOT_ID IS NOT NULL THEN 'MultiLotInhibit;' END AS SET_STATUS16                                                                                             
                          ,CASE WHEN SFTN.LOT_ID IS NOT NULL THEN 'RTDFoupRecipe;' END AS SET_STATUS17                                                                                               
                           -- 目前只卡控DF、WET
                          ,W.SET_STATUS18 
                           --modify by xiecheng for version up 
                           ,W.SET_STATUS19
                           ,W.SET_STATUS20,W.SET_STATUS21,W.SET_STATUS22   
                          --modify by xiecheng for version up    
                          --,CASE WHEN VMF.LCRECIPE_ID IS NOT NULL THEN 'MonitorRecipeInhibit;' END AS SET_STATUS23  
                          ,W.SET_STATUS23                                                                                                                                                             
                          ,W.SET_STATUS5                                                                                                                                                             
                          ,W.BATCH_SIZE_MAX                                                                                                                                                          
                          ,W.BATCH_SIZE_MIN                                                                                                                                                          
                          ,W.QTY                                                                                                                                                                     
                          ,COALESCE(BTN.OTHER_MIN_CTRL,0) AS OTHER_MIN_BATCH_SIZE                                                                                                                         
                           -- 非Batch的WET机台(Y非Batch、N为Batch)
                          --,CASE WHEN W.MODULE='WET' AND W.IS_BTATH_FLAG = 'N' THEN 'Y' ELSE 'N' END AS NON_WET_BATCH  
                          ,CASE WHEN W.IS_BTATH_FLAG = 'N' THEN 'Y' ELSE 'N' END AS NON_WET_BATCH                                                                               
                          ,W.MODULE    
                    --modify by xiecheng for version up                                                                                                                                                              
                    FROM APS_TMP_ETL_RLS_MONITOR_RECIPE  W                                                                                                                                                 
                    LEFT JOIN APS_TMP_ETL_RLS_CSFR_PATH  CP ON W.PROD_ID = CP.PROD_ID                                                                                                                          
                                         AND SUBSTRINGING(W.TARGET_PLAN_ID, 1, POSITION('.' IN (W.TARGET_PLAN_ID))-1) = CP.PLAN_ID
                                         AND W.TARGET_OPE_NO = CP.OPE_NO                                                                                                                 
                                         AND W.EQP_ID = CP.EQP_ID                                                                                                                        
                    LEFT JOIN APS_TMP_ETL_RLS_CSFRIHBT_RESULT  CI ON W.PROD_ID = CI.PROD_ID                                                                                                                       
                                         AND SUBSTRINGING(W.TARGET_PLAN_ID, 1, POSITION('.' IN (W.TARGET_PLAN_ID))-1) = CI.PLAN_ID
                                         AND W.TARGET_OPE_NO = CI.OPE_NO                                                                                                                 
                                         AND W.EQP_ID = CI.EQP_ID                                                                                                                        
                    LEFT JOIN APS_TMP_ETL_RLS_APC_INHIBIT_LOT ATN ON  ATN.EQP_ID = W.EQP_ID AND ATN.PHYSICAL_RECIPE = W.PHYSICAL_RECIPE_ID
                    --modify by xiecheng for version up
                    LEFT JOIN APS_TMP_ETL_RLS_APC_INHIBIT_LOT_GLOBAL GATN ON  GATN.PROD_ID = W.PROD_ID AND GATN.OPE_NO = W.TARGET_OPE_NO AND ((GATN.EQP_ID <> '*' AND GATN.EQP_ID = W.EQP_ID) OR GATN.EQP_ID = '*')
                    LEFT JOIN APS_TMP_ETL_RLS_RESOURCE_FLAG RF ON RF.LOT_ID = W.LOT_ID AND RF.OPE_NO = W.TARGET_OPE_NO AND RF.EQP_ID = W.EQP_ID AND RF.PLAN_ID = W.TARGET_PLAN_ID  AND RF.PROD_ID = W.PROD_ID  
                    LEFT JOIN APS_TMP_ETL_RLS_LOT_TO_EQPG LTN ON LTN.LOT_ID = W.LOT_ID AND LTN.OPE_NO = W.TARGET_OPE_NO AND LTN.PLAN_ID = W.TARGET_PLAN_ID  AND LTN.PROD_ID = W.PROD_ID
                    LEFT JOIN APS_SYNC_MASK_GROUP_MAPPLING.APS_SYNC_MASK_GROUP_MAPPLING GM ON GM.OPE_NO = W.TARGET_OPE_NO AND GM.PRODSPEC_ID = W.PROD_ID
                    LEFT JOIN APS_TMP_ETL_RLS_REWORK_COMING RCT ON  RCT.OPE_NO = W.TARGET_OPE_NO AND RCT.LOT_SON = W.LOT_ID AND W.TARGET_PLAN_ID LIKE 'YY%' AND W.OPE_NO <> W.TARGET_OPE_NO
                    LEFT JOIN APS_TMP_ETL_RLS_REWORK_COMING_SELF RCST ON  RCST.OPE_NO = W.TARGET_OPE_NO AND RCST.LOT_SON = W.LOT_ID AND W.TARGET_PLAN_ID LIKE 'YY%' AND W.OPE_NO <> W.TARGET_OPE_NO  
                    LEFT JOIN APS_SYNC_FRDRBL_ID_DYB.APS_SYNC_FRDRBL_ID_DYB DY ON REPLACE(DY.LOT_ID,'.','') = W.LOT_ID AND DY.OPE_NO = W.TARGET_OPE_NO AND DY.MAINPD_ID = W.TARGET_PLAN_ID
                    LEFT JOIN APS_TMP_ETL_RLS_CHAMBER_RULE  TM ON  TM.OPE_NO = W.TARGET_OPE_NO                                                                                                      
                                                              AND TM.PROD_ID = W.PROD_ID                                                                                                                     
                                                              AND TM.RECIPE_ID = W.M_RECIPE                                                                                                                  
                                                              AND TM.EQP_ID = W.EQP_ID                                                                                                                       
                    LEFT JOIN APS_TMP_ETL_RLS_BOAT_CONSTRAINTS BTN ON  BTN.OPE_NO = W.TARGET_OPE_NO                                                                                                
                                                              AND BTN.PROD_ID = W.PROD_ID                                                                                                                    
                                                              AND BTN.EQP_ID = W.EQP_ID                                                                                                                       
                    LEFT JOIN APS_TMP_ETL_RLS_BOAT_CONSTRAINTS2 BTN2 ON  BTN2.EQP_ID = W.EQP_ID                                                                                                    
                    LEFT JOIN APS_TMP_ETL_RLS_BOAT_CONSTRAINTS3 BTN3 ON  BTN3.EQP_ID = W.EQP_ID                                                                                                    
                    LEFT JOIN APS_TMP_ETL_RLS_TRANS_STATE TTN ON  TTN.LOT_ID = W.LOT_ID AND TTN.OPE_NO = W.TARGET_OPE_NO                                                                           
                                                                        AND TTN.MAINPD_ID = W.TARGET_PLAN_ID  AND TTN.PRODSPEC_ID = W.PROD_ID                                                            
                    LEFT JOIN APS_TMP_ETL_RLS_BATCH_INFO BTTN ON  BTTN.BATCH_NAME = W.BATCH_NAME AND BTTN.OPE_NO = W.TARGET_OPE_NO                                                                 
                                                                        AND BTTN.MAINPD_ID = W.TARGET_PLAN_ID  AND BTTN.PRODSPEC_ID = W.PROD_ID                                                          
                    LEFT JOIN APS_TMP_ETL_RLS_MULTI_LOT MTTN ON  MTTN.CAST_ID = W.CASSETE_ID AND MTTN.OPE_NO = W.TARGET_OPE_NO                                                                     
                                                                        AND MTTN.LOT_ID = W.LOT_ID                                                                                                       
                    LEFT JOIN APS_TMP_ETL_RLS_FOUP_RECIPE SFTN ON  SFTN.TARGET_PLAN_ID = W.TARGET_PLAN_ID AND SFTN.TARGET_OPE_NO = W.TARGET_OPE_NO                                             
                                                                        AND SFTN.LOT_ID = W.LOT_ID  AND SFTN.PROD_ID = W.PROD_ID  
                    --modify by xiecheng for version up
                    --LEFT JOIN APS_SYNC_MES_FRLRCP.APS_SYNC_MES_FRLRCP VMF ON VMF.LCRECIPE_ID = W.FLOW_RECIPE AND VMF.MNTR_PRODSPEC_ID = W.PROD_ID                                                                       
             )                                                                                                                                                                                               
             SELECT DISTINCT                                                                                                                                                                                 
                   R.PARENT_ID                                                                                                                                                                               
                   ,R.LOT_ID                                                                                                                                                                                 
                   ,R.STEP_ID                                                                                                                                                                                
                   ,R.OPE_NO                                                                                                                                                                                 
                   ,R.TARGET_STEP_ID                                                                                                                                                                         
                   ,R.TARGET_OPE_NO                                                                                                                                                                          
                   ,R.PLAN_ID                                                                                                                                                                                
                   ,R.TARGET_PLAN_ID                                                                                                                                                                         
                   ,R.PROD_ID                                                                                                                                                                                
                   ,R.PD_ID                                                                                                                                                                                  
                   ,R.TARGET_TOOLG_ID                                                                                                                                                                        
                   ,R.EQP_ID                                                                                                                                                                                 
                   ,R.QTY                                                                                                                                                                                    
                   ,R.M_RECIPE                                                                                                                                                                               
                   ,R.PHYSICAL_RECIPE_ID                                                                                                                                                                                             
                   ,R.PHOTOFLAG                                                                                                                                                                              
                   ,R.RETICLE_ID                                                                                                                                                                             
                   ,'' AS ACTIVE_RTCL                                                                                                                                                                        
                   ,R.CHAMBER_SET                                                                                                                                                                            
                   ,CASE WHEN R.PHOTOFLAG = 'N' THEN  
                                --modify by xiecheng for version up                                                                                                                                                       
                                -- SET_STATUS5 值 没有分号(;) 所以若添加新的机限需添加到SET_STATUS5 前面。
                               CASE WHEN (COALESCE (R.SET_STATUS1, '') || COALESCE (R.SET_STATUS2, '') || COALESCE (R.SET_STATUS6, '') || COALESCE (SET_STATUS7, '') || COALESCE (SET_STATUS8, '') || COALESCE (SET_STATUS9, '') || COALESCE (SET_STATUS10, '') || COALESCE (SET_STATUS11, '') || COALESCE (SET_STATUS12, '') || COALESCE (SET_STATUS13, '') || COALESCE (SET_STATUS14, '') || COALESCE (SET_STATUS15, '') || COALESCE (SET_STATUS16, '') || COALESCE (SET_STATUS17, '') || COALESCE (SET_STATUS18, '') || COALESCE(SET_STATUS19, '') || COALESCE(SET_STATUS20, '') || COALESCE(SET_STATUS21, '')  || COALESCE(SET_STATUS22, '')  || COALESCE(SET_STATUS23, '') || COALESCE(R.SET_STATUS5, '')) IS NULL THEN 'ACTIVE'                                              
                                  ELSE                                                                                                                                                                       
                                       CASE WHEN POSITION(';' IN (COALESCE (R.SET_STATUS1, '') || COALESCE (R.SET_STATUS2, '') || COALESCE (R.SET_STATUS6, '') || COALESCE (SET_STATUS7, '') || COALESCE (SET_STATUS8, '') || COALESCE (SET_STATUS9, '') || COALESCE (SET_STATUS10, '') || COALESCE (SET_STATUS11, '') || COALESCE (SET_STATUS12, '') ||  COALESCE (SET_STATUS13, '') || COALESCE (SET_STATUS14, '') || COALESCE (SET_STATUS15, '') || COALESCE (SET_STATUS16, '') || COALESCE (SET_STATUS17, '') || COALESCE (SET_STATUS18, '') || COALESCE(SET_STATUS19, '') || COALESCE(SET_STATUS20, '') || COALESCE(SET_STATUS21, '')  || COALESCE(SET_STATUS22, '')  || COALESCE(SET_STATUS23, '') || COALESCE(R.SET_STATUS5, ''))) =                                            
                                                 LENGTH(COALESCE (R.SET_STATUS1, '') || COALESCE (R.SET_STATUS2, '') || COALESCE (R.SET_STATUS6, '') || COALESCE (SET_STATUS7, '') || COALESCE (SET_STATUS8, '') || COALESCE (SET_STATUS9, '') || COALESCE (SET_STATUS10, '') || COALESCE (SET_STATUS11, '') || COALESCE (SET_STATUS12, '') ||  COALESCE (SET_STATUS13, '') || COALESCE (SET_STATUS14, '') || COALESCE (SET_STATUS15, '') || COALESCE (SET_STATUS16, '') || COALESCE (SET_STATUS17, '') || COALESCE (SET_STATUS18, '') || COALESCE(SET_STATUS19, '') || COALESCE(SET_STATUS20, '') || COALESCE(SET_STATUS21, '')  || COALESCE(SET_STATUS22, '')  || COALESCE(SET_STATUS23, '') || COALESCE(R.SET_STATUS5, ''))                                                      
                                            THEN SUBSTRINGING(COALESCE (R.SET_STATUS1, '') || COALESCE (R.SET_STATUS2, '') || COALESCE (R.SET_STATUS6, '') || COALESCE (SET_STATUS7, '') || COALESCE (SET_STATUS8, '') || COALESCE (SET_STATUS9, '') || COALESCE (SET_STATUS10, '') || COALESCE (SET_STATUS11, '') || COALESCE (SET_STATUS12, '') ||  COALESCE (SET_STATUS13, '') || COALESCE (SET_STATUS14, '') || COALESCE (SET_STATUS15, '') || COALESCE (SET_STATUS16, '') || COALESCE (SET_STATUS17, '') || COALESCE (SET_STATUS18, '') || COALESCE(SET_STATUS19, '') || COALESCE(SET_STATUS20, '') || COALESCE(SET_STATUS21, '')  || COALESCE(SET_STATUS22, '')  || COALESCE(SET_STATUS23, '') || COALESCE(R.SET_STATUS5, ''), 1,                                                   
                                                        POSITION(';' IN (COALESCE (R.SET_STATUS1, '') || COALESCE (R.SET_STATUS2, '') || COALESCE (R.SET_STATUS6, '') || COALESCE (SET_STATUS7, '') || COALESCE (SET_STATUS8, '') || COALESCE (SET_STATUS9, '') || COALESCE (SET_STATUS10, '') || COALESCE (SET_STATUS11, '') || COALESCE (SET_STATUS12, '') ||  COALESCE (SET_STATUS13, '') || COALESCE (SET_STATUS14, '') || COALESCE (SET_STATUS15, '') || COALESCE (SET_STATUS16, '') || COALESCE (SET_STATUS17, '') || COALESCE (SET_STATUS18, '') || COALESCE(SET_STATUS19, '') || COALESCE(SET_STATUS20, '') || COALESCE(SET_STATUS21, '')  || COALESCE(SET_STATUS22, '')  || COALESCE(SET_STATUS23, '') || COALESCE(R.SET_STATUS5, '')))                                       
                                                     -1)                                                                                                                                                     
                                            ELSE COALESCE (R.SET_STATUS1, '') || COALESCE (R.SET_STATUS2, '') || COALESCE (R.SET_STATUS6, '') || COALESCE (SET_STATUS7, '') || COALESCE (SET_STATUS8, '') || COALESCE (SET_STATUS9, '') || COALESCE (SET_STATUS10, '') || COALESCE (SET_STATUS11, '') || COALESCE (SET_STATUS12, '') ||  COALESCE (SET_STATUS13, '') || COALESCE (SET_STATUS14, '') || COALESCE (SET_STATUS15, '') || COALESCE (SET_STATUS16, '') || COALESCE (SET_STATUS17, '') || COALESCE (SET_STATUS18, '') || COALESCE(SET_STATUS19, '') || COALESCE(SET_STATUS20, '') || COALESCE(SET_STATUS21, '')  || COALESCE(SET_STATUS22, '')  || COALESCE(SET_STATUS23, '') || COALESCE(R.SET_STATUS5, '')                                                              
                                       END                                                                                                                                                                   
                               END                                                                                                                                                                           
                         ELSE                                                                                                                                                                                
                              CASE WHEN (COALESCE (R.SET_STATUS1, '') || COALESCE (R.SET_STATUS2, '') || COALESCE (R.SET_STATUS6, '') || COALESCE (SET_STATUS7, '') || COALESCE (SET_STATUS8, '') || COALESCE (SET_STATUS9, '') || COALESCE (SET_STATUS10, '') || COALESCE (SET_STATUS11, '') || COALESCE (SET_STATUS12, '') ||  COALESCE (SET_STATUS13, '') || COALESCE (SET_STATUS14, '') || COALESCE (SET_STATUS15, '') || COALESCE (SET_STATUS16, '') || COALESCE (SET_STATUS17, '') || COALESCE (SET_STATUS18, '') || COALESCE(SET_STATUS19, '') || COALESCE(SET_STATUS20, '') || COALESCE(SET_STATUS21, '')  || COALESCE(SET_STATUS22, '')  || COALESCE(SET_STATUS23, '') || COALESCE(R.SET_STATUS5, '')) IS NULL THEN 'ACTIVE'  
                                ELSE                                                                                                                                                                         
                                    CASE WHEN POSITION(';' IN (COALESCE (R.SET_STATUS1, '') || COALESCE (R.SET_STATUS2, '') || COALESCE (R.SET_STATUS6, '') || COALESCE (SET_STATUS7, '') || COALESCE (SET_STATUS8, '') || COALESCE (SET_STATUS9, '') || COALESCE (SET_STATUS10, '') || COALESCE (SET_STATUS11, '') || COALESCE (SET_STATUS12, '') ||  COALESCE (SET_STATUS13, '') || COALESCE (SET_STATUS14, '') || COALESCE (SET_STATUS15, '') || COALESCE (SET_STATUS16, '') || COALESCE (SET_STATUS17, '') || COALESCE (SET_STATUS18, '') || COALESCE(SET_STATUS19, '') || COALESCE(SET_STATUS20, '') || COALESCE(SET_STATUS21, '')  || COALESCE(SET_STATUS22, '')  || COALESCE(SET_STATUS23, '') || COALESCE(R.SET_STATUS5, ''))) =                              
                                              LENGTH(COALESCE (R.SET_STATUS1, '') || COALESCE (R.SET_STATUS2, '') || COALESCE (R.SET_STATUS6, '') || COALESCE (SET_STATUS7, '') || COALESCE (SET_STATUS8, '') || COALESCE (SET_STATUS9, '') || COALESCE (SET_STATUS10, '') || COALESCE (SET_STATUS11, '') || COALESCE (SET_STATUS12, '') ||  COALESCE (SET_STATUS13, '') || COALESCE (SET_STATUS14, '') || COALESCE (SET_STATUS15, '') || COALESCE (SET_STATUS16, '') || COALESCE (SET_STATUS17, '') || COALESCE (SET_STATUS18, '') || COALESCE(SET_STATUS19, '') || COALESCE(SET_STATUS20, '') || COALESCE(SET_STATUS21, '')  || COALESCE(SET_STATUS22, '')  || COALESCE(SET_STATUS23, '') || COALESCE(R.SET_STATUS5, ''))                                        
                                         THEN SUBSTRINGING(COALESCE (R.SET_STATUS1, '') || COALESCE (R.SET_STATUS2, '') || COALESCE (R.SET_STATUS6, '') || COALESCE (SET_STATUS7, '') || COALESCE (SET_STATUS8, '') || COALESCE (SET_STATUS9, '') || COALESCE (SET_STATUS10, '') || COALESCE (SET_STATUS11, '') || COALESCE (SET_STATUS12, '') ||  COALESCE (SET_STATUS13, '') || COALESCE (SET_STATUS14, '') || COALESCE (SET_STATUS15, '') || COALESCE (SET_STATUS16, '') || COALESCE (SET_STATUS17, '') || COALESCE (SET_STATUS18, '') || COALESCE(SET_STATUS19, '') || COALESCE(SET_STATUS20, '') || COALESCE(SET_STATUS21, '')  || COALESCE(SET_STATUS22, '')  || COALESCE(SET_STATUS23, '') || COALESCE(R.SET_STATUS5, ''), 1,                                     
                                                    POSITION(';' IN (COALESCE (R.SET_STATUS1, '') || COALESCE (R.SET_STATUS2, '') || COALESCE (R.SET_STATUS6, '') || COALESCE (SET_STATUS7, '') || COALESCE (SET_STATUS8, '') || COALESCE (SET_STATUS9, '') || COALESCE (SET_STATUS10, '') || COALESCE (SET_STATUS11, '') || COALESCE (SET_STATUS12, '') ||  COALESCE (SET_STATUS13, '') || COALESCE (SET_STATUS14, '') || COALESCE (SET_STATUS15, '') || COALESCE (SET_STATUS16, '') || COALESCE (SET_STATUS17, '') || COALESCE (SET_STATUS18, '') || COALESCE(SET_STATUS19, '') || COALESCE(SET_STATUS20, '') || COALESCE(SET_STATUS21, '')  || COALESCE(SET_STATUS22, '')  || COALESCE(SET_STATUS23, '') || COALESCE(R.SET_STATUS5, '')))                          
                                                 -1)                                                                                                                                                         
                                         ELSE COALESCE (R.SET_STATUS1, '') || COALESCE (R.SET_STATUS2, '') || COALESCE (R.SET_STATUS6, '') || COALESCE (SET_STATUS7, '') || COALESCE (SET_STATUS8, '') || COALESCE (SET_STATUS9, '') || COALESCE (SET_STATUS10, '') || COALESCE (SET_STATUS11, '') || COALESCE (SET_STATUS12, '') ||  COALESCE (SET_STATUS13, '') || COALESCE (SET_STATUS14, '') || COALESCE (SET_STATUS15, '') || COALESCE (SET_STATUS16, '') || COALESCE (SET_STATUS17, '') || COALESCE (SET_STATUS18, '') || COALESCE(SET_STATUS19, '') || COALESCE(SET_STATUS20, '') || COALESCE(SET_STATUS21, '')  || COALESCE(SET_STATUS22, '')  || COALESCE(SET_STATUS23, '') || COALESCE(R.SET_STATUS5, '')    
                                     END                                                                                                                                                                     
                               END                                                                                                                                                                           
                      END                                                                                                                                                                                    
                     AS SET_STATUS                                                                                                                                                                           
                   ,R.BATCH_SIZE_MAX                                                                                                                                                                         
                   ,R.BATCH_SIZE_MIN                                                                                                                                                                         
                   ,R.FLOW_RECIPE                                                                                                                                                                            
                   ,R.OTHER_MIN_BATCH_SIZE                                                                                                                                                                   
                   ,R.NON_WET_BATCH                                                                                                                                                                   
                   ,R.MODULE                                                                                                                                                                   
             FROM RLS_DATA R                                                                                                                                                                                 
    """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into InsertRlsTempData2Temp",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS")


def InsertRlsTempByEqpgTemp(duck_db_memory=None, uuid="", current_time="", oracle_conn=None, ETL_Proc_Name="",
                            used_table_dict=None):
    sql = """
    INSERT INTO APS_TMP_ETL_RLS_EQPG (                        
          PARENT_ID, LOT_ID, STEP_ID, OPE_NO, TARGET_STEP_ID, TARGET_OPE_NO, PLAN_ID, TARGET_PLAN_ID, PROD_ID, PD_ID,
          TARGET_TOOLG_ID, EQP_ID, QTY, M_RECIPE, PHYSICAL_RECIPE_ID, PHOTO_FLAG, RETICLE_ID, ACTIVE_RTCL, CHAMBER_SET,
          SET_STATUS, BATCH_SIZE_MAX, BATCH_SIZE_MIN, FLOW_RECIPE,OTHER_MIN_BATCH_SIZE, NON_WET_BATCH, MODULE,CH_CNT
    )                                                                          
     SELECT                                                                                                                                                                                         
           R.PARENT_ID                                                                                                                                                                              
           ,R.LOT_ID                                                                                                                                                                                
           ,R.STEP_ID                                                                                                                                                                               
           ,R.OPE_NO                                                                                                                                                                                
           ,R.TARGET_STEP_ID                                                                                                                                                                        
           ,R.TARGET_OPE_NO                                                                                                                                                                         
           ,R.PLAN_ID                                                                                                                                                                               
           ,R.TARGET_PLAN_ID                                                                                                                                                                        
           ,R.PROD_ID                                                                                                                                                                               
           ,R.PD_ID                                                                                                                                                                                 
           ,R.TARGET_TOOLG_ID                                                                                                                                                                       
           ,R.EQP_ID                                                                                                                                                                                
           ,R.QTY                                                                                                                                                                                   
           ,R.M_RECIPE                                                                                                                                                                              
           ,R.PHYSICAL_RECIPE_ID                                                                                                                                                                                            
           ,R.PHOTO_FLAG                                                                                                                                                                             
           ,R.RETICLE_ID                                                                                                                                                                            
           ,R.ACTIVE_RTCL                                                                                                                                                                           
           ,R.CHAMBER_SET                                                                                                                                                                            
           ,CASE WHEN T.LOT_ID IS NULL THEN R.SET_STATUS                                                                                                                                            
                 --ELSE (CASE WHEN T.PASS_FLG_PRC='Y' AND T.FLOW_RECIPE IS NOT NULL THEN 'ACTIVE'                                                                            
                 --   ELSE (CASE WHEN T.PASS_FLG_PRC='Y' AND T.FLOW_RECIPE IS NULL THEN 'LCRecipeNotExists'                                                                  
                  --      ELSE (CASE WHEN T.PASS_FLG_PRC='N' AND T.FLOW_RECIPE IS NULL                                                                                      
                  --            THEN 'LCRecipeNotExists;EqpgPrcInhibit' ELSE 'EqpgPrcInhibit' END) END) END)END  AS SET_STATUS
                  --modify by xiecheng for version up   
                  ELSE (CASE WHEN EXISTS (SELECT 1 FROM APS_TMP_ETL_RLS_LOT_TO_EQPG_RECIPE RR                                                                                              
                                WHERE RR.LOT_ID = R.LOT_ID AND RR.OPE_NO = R.TARGET_OPE_NO AND ACTIVE_FLAG ='Y' AND RR.EQP_ID = R.EQP_ID                                                           
                                      AND RR.FLOW_RECIPE IS NOT NULL) THEN 'ACTIVE' ELSE                                                                                                   
                                     (CASE WHEN R.FLOW_RECIPE IS NULL THEN 'LCRecipeNotExists' ELSE 'EqpgPrcInhibit' END) END) END AS SET_STATUS               
           ,R.BATCH_SIZE_MAX                                                                                                                                                                        
           ,R.BATCH_SIZE_MIN                                                                                                                                                                        
           ,R.FLOW_RECIPE                                                                                                                                                                           
           ,R.OTHER_MIN_BATCH_SIZE                                                                                                                                                                  
           ,R.NON_WET_BATCH, R.MODULE
           --modify by xiecheng for version up    
           ,CASE WHEN R.CHAMBER_SET IS NULL OR position('F' in R.EQP_ID) = 1 THEN 1 ELSE LENGTH(R.CHAMBER_SET) - LENGTH(REPLACE(REPLACE(R.CHAMBER_SET,';',''),',',''))+1 END AS CH_CNT                                                                                                                                                   
     FROM APS_TMP_ETL_RLS R                                                                                                                                                                           
     LEFT JOIN  APS_TMP_ETL_RLS_LOT_TO_EQPG_RECIPE T    
     --modify by xiecheng for version up                                                                                                                                         
     --ON R.LOT_ID = T.LOT_ID AND R.TARGET_OPE_NO = T.OPE_NO AND R.TARGET_TOOLG_ID = T.TOOLG_ID       
      ON R.LOT_ID = T.LOT_ID AND R.TARGET_OPE_NO = T.OPE_NO                                                                                                    
     AND R.TARGET_PLAN_ID = T.PLAN_ID AND R.PROD_ID = T.PROD_ID                                                                                                        
    """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="InsertRlsTempByEqpgTemp",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_EQPG")


def InsertType21MedianTemp(duck_db_memory=None, uuid="", current_time="", oracle_conn=None, ETL_Proc_Name="",
                           used_table_dict=None):
    sql = """
    INSERT  /*+ append */  INTO APS_TMP_ETL_RLS_TYPE21_PT
    ( MODULE_ID, TOOLG_ID, TOOL_ID, PPID, PT )
    SELECT L.MODULE_ID, L.TOOLG_ID, L.TOOL_ID,L.PPID, L.PT
    FROM APS_TMP_TYPE21_MEDIAN.APS_TMP_TYPE21_MEDIAN AS L
    """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="InsertType21MedianTemp",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_TYPE21_PT")


def InsertType22MedianTemp(duck_db_memory=None, uuid="", current_time="", oracle_conn=None, ETL_Proc_Name="",
                           used_table_dict=None):
    sql = """
    INSERT  /*+ append */  INTO APS_TMP_ETL_RLS_TYPE22_PT
    ( MODULE_ID, TOOLG_ID, PPID, PT )
    SELECT L.MODULE_ID, L.TOOLG_ID, L.PPID, L.PT
    FROM APS_TMP_TYPE22_MEDIAN.APS_TMP_TYPE22_MEDIAN AS L
    """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="InsertType22MedianTemp",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_TYPE22_PT")


def InsertType221MedianTemp(duck_db_memory=None, uuid="", current_time="", oracle_conn=None, ETL_Proc_Name="",
                            used_table_dict=None):
    sql = """
    INSERT  /*+ append */  INTO APS_TMP_ETL_RLS_TYPE221_PT
    ( MODULE_ID, TOOLG_ID, TOOL_ID, CH_CNT, PT )
    SELECT L.MODULE_ID, L.TOOLG_ID, L.TOOL_ID, L.CH_CNT, L.PT
    FROM APS_TMP_TYPE221_MEDIAN.APS_TMP_TYPE221_MEDIAN AS L
    """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="InsertType221MedianTemp",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_TYPE221_PT")


def InsertTemChargeTimeTemp(duck_db_memory=None, uuid="", current_time="", oracle_conn=None, ETL_Proc_Name="",
                            used_table_dict=None):
    sql = """
    INSERT  /*+ append */  INTO APS_TMP_ETL_RLS_CHARGE_TIME
    ( TOOL_ID, CHARGE_TIME )
    SELECT V.TOOL_ID, V.CHARGE_TIME 
    FROM  APS_TMP_CHARGE_TIME.APS_TMP_CHARGE_TIME V
    """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="InsertTemChargeTimeTemp",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_CHARGE_TIME")


def RlsTrDataSQL(duck_db_memory=None, uuid="", current_time="", oracle_conn=None, ETL_Proc_Name="",
                 used_table_dict=None):

    sql = """
    INSERT /*+ append */ INTO   APS_TMP_ETL_RLS_TR_RESULT            
     ( PARENT_ID, LOT_ID, STEP_ID, OPE_NO, TARGET_STEP_ID, TARGET_OPE_NO, PLAN_ID, TARGET_PLAN_ID, TARGET_TOOLG_ID,
       EQP_ID, PROD_ID, FLOW_RECIPE, PPID, PHOTO_FLAG, RETICLE_ID, CHAMBER_SET, SET_STATUS, QTY, BATCH_SIZE_MAX, BATCH_SIZE_MIN,
       NPT, PT, OTHER_MIN_BATCH_SIZE, NON_WET_BATCH, MODULE,CH_CNT
      )                                                                                                                                         
     SELECT                                                                                                                                                         
            R.PARENT_ID                                                                                                                                             
           ,R.LOT_ID                                                                                                                                                
           ,R.STEP_ID                                                                                                                                               
           ,R.OPE_NO                                                                                                                                                
           ,R.TARGET_STEP_ID                                                                                                                                        
           ,R.TARGET_OPE_NO                                                                                                                                         
           ,R.PLAN_ID                                                                                                                                               
           ,R.TARGET_PLAN_ID                                                                                                                                        
           ,R.TARGET_TOOLG_ID                                                                                                                                       
           ,R.EQP_ID                                                                                                                                                
           ,R.PROD_ID                                                                                                                                               
           ,R.FLOW_RECIPE                                                                                                                                           
           ,R.PHYSICAL_RECIPE_ID AS PPID                                                                                                                            
           ,R.PHOTO_FLAG                                                                                                                                            
           ,R.RETICLE_ID                                                                                                                                            
           ,R.CHAMBER_SET                                                                                                                                           
           ,R.SET_STATUS                                                                                                                                            
           ,R.QTY                                                                                                                                                   
           ,R.BATCH_SIZE_MAX                                                                                                                                        
           ,R.BATCH_SIZE_MIN                                                                                                                                        
           ,CASE WHEN TRCT.TOOL_ID IS NOT NULL THEN TRCT.CHARGE_TIME ELSE ( CASE WHEN R.PHOTO_FLAG = 'Y' THEN                                                                                                                       
                 CASE WHEN (T21.TOOLG_ID || T21.TOOL_ID || T21.PPID) IS NOT NULL THEN                                                                               
                           CASE WHEN T21.LESSTHAN20_FLAG = 'Y' THEN                                                                                                 
                                     CASE WHEN (T22.TOOLG_ID || T22.PPID) IS NULL OR T22.LESSTHAN20_FLAG = 'Y' THEN                                                 
                                               CASE WHEN (T221.TOOLG_ID || T221.TOOL_ID) IS NULL THEN 0                                                             
                                                    WHEN T221.LESSTHAN20_FLAG = 'Y' THEN 0                                                                          
                                                    WHEN T221.PHOTO_TYPE = 'ETC' THEN 0                                                                             
                                                    -- WHEN T221.PHOTO_TYPE = 'TS' AND T221.TRACKER_ZWS_FLAG = 'Y' THEN ROUND(T221.ONE_WAFER_PT_TRACKER * R.QTY, 6)
                                                    WHEN T221.PHOTO_TYPE = 'TS' AND T221.TRACKER_ZWS_FLAG = 'Y' THEN ROUND(CAST(T221.ONE_WAFER_PT_TRACKER AS DECIMAL) * CAST(R.QTY AS DECIMAL), 6)
                                                    -- ELSE ROUND((T221.TRACKER_SLOPE_NEW * R.QTY) + T221.TRACKER_INTER_NEW, 6)
                                                    ELSE ROUND((CAST(T221.TRACKER_SLOPE_NEW AS DECIMAL) * CAST(R.QTY AS DECIMAL)) + CAST(T221.TRACKER_INTER_NEW AS DECIMAL), 6)
                                               END                                                                                                                  
                                          -- WHEN T22.PHOTO_TYPE = 'TS' AND T22.TRACKER_ZWS_FLAG = 'Y' THEN ROUND(T22.ONE_WAFER_PT_TRACKER * R.QTY, 6)
                                          WHEN T22.PHOTO_TYPE = 'TS' AND T22.TRACKER_ZWS_FLAG = 'Y' THEN ROUND(CAST(T22.ONE_WAFER_PT_TRACKER AS DECIMAL) * CAST(R.QTY AS DECIMAL), 6)
                                          WHEN T22.PHOTO_TYPE = 'ETC' THEN 0                                                                                        
                                          -- ELSE ROUND((T22.TRACKER_SLOPE_NEW * R.QTY) + T22.TRACKER_INTER_NEW, 6)                                                    
                                          ELSE ROUND((CAST(T22.TRACKER_SLOPE_NEW AS DECIMAL) * CAST(R.QTY AS DECIMAL)) + CAST(T22.TRACKER_INTER_NEW AS DECIMAL), 6)
                                     END                                                                                                                            
                                WHEN T21.PHOTO_TYPE = 'ETC' THEN 0                                                                                                  
                                --WHEN T21.PHOTO_TYPE = 'TS' AND T21.TRACKER_ZWS_FLAG = 'Y' THEN ROUND(T21.ONE_WAFER_PT_TRACKER * R.QTY, 6)                           
                                WHEN T21.PHOTO_TYPE = 'TS' AND T21.TRACKER_ZWS_FLAG = 'Y' THEN ROUND(CAST(T21.ONE_WAFER_PT_TRACKER AS DECIMAL) * CAST(R.QTY AS DECIMAL), 6)
                                --ELSE ROUND((T21.TRACKER_SLOPE_NEW * R.QTY) + T21.TRACKER_INTER_NEW, 6)                                                              
                                ELSE ROUND((CAST(T21.TRACKER_SLOPE_NEW AS DECIMAL) * CAST(R.QTY AS DECIMAL)) + CAST(T21.TRACKER_INTER_NEW AS DECIMAL), 6)
                           END                                                                                                                                      
                      WHEN (T21.TOOLG_ID || T21.TOOL_ID || T21.PPID) IS NULL THEN                                                                                   
                           CASE WHEN (T22.TOOLG_ID || T22.PPID) IS NULL OR T22.LESSTHAN20_FLAG = 'Y' THEN                                                           
                                               CASE WHEN (T221.TOOLG_ID || T221.TOOL_ID) IS NULL THEN 0                                                             
                                                    WHEN T221.LESSTHAN20_FLAG = 'Y' THEN 0                                                                          
                                                    WHEN T221.PHOTO_TYPE = 'ETC' THEN 0                                                                             
                                                    --WHEN T221.PHOTO_TYPE = 'TS' AND T221.TRACKER_ZWS_FLAG = 'Y' THEN ROUND(T221.ONE_WAFER_PT_TRACKER * R.QTY, 6)    
                                                    WHEN T221.PHOTO_TYPE = 'TS' AND T221.TRACKER_ZWS_FLAG = 'Y' THEN ROUND(CAST(T221.ONE_WAFER_PT_TRACKER AS DECIMAL) * CAST(R.QTY AS DECIMAL), 6)
                                                    -- ELSE ROUND((T221.TRACKER_SLOPE_NEW * R.QTY) + T221.TRACKER_INTER_NEW, 6)
                                                    ELSE ROUND((CAST(T221.TRACKER_SLOPE_NEW AS DECIMAL) * CAST(R.QTY AS DECIMAL)) + CAST(T221.TRACKER_INTER_NEW AS DECIMAL), 6)
                                               END                                                                                                                  
                                WHEN T22.PHOTO_TYPE = 'ETC' THEN 0                                                                                                  
                                WHEN T22.PHOTO_TYPE = 'TS' AND T22.TRACKER_ZWS_FLAG = 'Y' THEN ROUND(CAST(T22.ONE_WAFER_PT_TRACKER AS DECIMAL) * CAST(R.QTY AS DECIMAL), 6)
                                -- ELSE ROUND((T22.TRACKER_SLOPE_NEW * R.QTY) + T22.TRACKER_INTER_NEW, 6)
                                ELSE ROUND((CAST(T22.TRACKER_SLOPE_NEW AS DECIMAL) * CAST(R.QTY AS DECIMAL)) + CAST(T22.TRACKER_INTER_NEW AS DECIMAL), 6)
                           END                                                                                                                                      
                 END                                                                                                                                                
            ELSE 0                                                                                                                                                  
            END)END AS NPT                                                                                                                                              
            -- WET 非Batch的要用Global的线性回归
           ,CASE WHEN TR22.TOOLG_ID IS NOT NULL AND R.NON_WET_BATCH='N' THEN COALESCE(TR21.PT,TR22.PT) ELSE (CASE WHEN TR221.TOOLG_ID IS NOT NULL AND R.NON_WET_BATCH='N' THEN TR221.PT ELSE (CASE WHEN R.PHOTO_FLAG = 'Y' THEN   
                 CASE WHEN (T21.TOOLG_ID || T21.TOOL_ID || T21.PPID) IS NOT NULL THEN                                                                               
                           CASE WHEN T21.LESSTHAN20_FLAG = 'Y' THEN                                                                                                 
                                     CASE WHEN (T22.TOOLG_ID || T22.PPID) IS NULL OR T22.LESSTHAN20_FLAG = 'Y' THEN                                                 
                                               CASE WHEN (T221.TOOLG_ID || T221.TOOL_ID) IS NULL THEN 0                                                             
                                                    WHEN T221.LESSTHAN20_FLAG = 'Y' THEN 0                                                                          
                                                    -- WHEN T221.SCANNER_ZWS_FLAG = 'Y' THEN ROUND(T221.ONE_WAFER_PT_SCANNER * R.QTY, 6)
                                                    WHEN T221.SCANNER_ZWS_FLAG = 'Y' THEN ROUND(CAST(T221.ONE_WAFER_PT_SCANNER AS DECIMAL) * CAST(R.QTY AS DECIMAL), 6)
                                                    -- ELSE ROUND((T221.SCANNER_SLOPE_NEW * R.QTY) + T221.SCANNER_INTER_NEW, 6) 
                                                    ELSE ROUND((CAST(T221.SCANNER_SLOPE_NEW AS DECIMAL) * CAST(R.QTY AS DECIMAL)) + CAST(T221.SCANNER_INTER_NEW AS DECIMAL), 6)
                                               END                                                                                                                  
                                          -- WHEN T22.SCANNER_ZWS_FLAG = 'Y' THEN ROUND(T22.ONE_WAFER_PT_SCANNER * R.QTY, 6)
                                          WHEN T22.SCANNER_ZWS_FLAG = 'Y' THEN ROUND(CAST(T22.ONE_WAFER_PT_SCANNER AS DECIMAL) * CAST(R.QTY AS DECIMAL), 6)
                                          -- ELSE ROUND((T22.SCANNER_SLOPE_NEW * R.QTY) + T22.SCANNER_INTER_NEW, 6)
                                          ELSE ROUND((CAST(T22.SCANNER_SLOPE_NEW AS DECIMAL) * CAST(R.QTY AS DECIMAL)) + CAST(T22.SCANNER_INTER_NEW AS DECIMAL), 6)
                                     END                                                                                                                            
                                -- WHEN T21.SCANNER_ZWS_FLAG = 'Y' THEN ROUND(T21.ONE_WAFER_PT_SCANNER * R.QTY, 6)
                                WHEN T21.SCANNER_ZWS_FLAG = 'Y' THEN ROUND(CAST(T21.ONE_WAFER_PT_SCANNER AS DECIMAL) * CAST(R.QTY AS DECIMAL), 6)
                                -- ELSE ROUND((T21.SCANNER_SLOPE_NEW * R.QTY) + T21.SCANNER_INTER_NEW, 6)
                                ELSE ROUND((CAST(T21.SCANNER_SLOPE_NEW AS DECIMAL) * CAST(R.QTY AS DECIMAL)) + CAST(T21.SCANNER_INTER_NEW AS DECIMAL), 6)
                           END                                                                                                                                      
                      WHEN (T21.TOOLG_ID || T21.TOOL_ID || T21.PPID) IS NULL THEN                                                                                   
                           CASE WHEN (T22.TOOLG_ID || T22.PPID) IS NULL OR T22.LESSTHAN20_FLAG = 'Y' THEN                                                           
                                               CASE WHEN (T221.TOOLG_ID || T221.TOOL_ID) IS NULL THEN 0                                                             
                                                    WHEN T221.LESSTHAN20_FLAG = 'Y' THEN 0                                                                          
                                                    -- WHEN T221.SCANNER_ZWS_FLAG = 'Y' THEN ROUND(T221.ONE_WAFER_PT_SCANNER * R.QTY, 6)
                                                    WHEN T221.SCANNER_ZWS_FLAG = 'Y' THEN ROUND(CAST(T221.ONE_WAFER_PT_SCANNER AS DECIMAL) * CAST(R.QTY AS DECIMAL), 6)
                                                    -- ELSE ROUND((T221.SCANNER_SLOPE_NEW * R.QTY) + T221.SCANNER_INTER_NEW, 6)
                                                    ELSE ROUND((CAST(T221.SCANNER_SLOPE_NEW AS DECIMAL) * CAST(R.QTY AS DECIMAL)) + CAST(T221.SCANNER_INTER_NEW AS DECIMAL), 6)
                                               END                                                                                                                  
                                -- WHEN T22.SCANNER_ZWS_FLAG = 'Y' THEN ROUND(T22.ONE_WAFER_PT_SCANNER * R.QTY, 6)
                                WHEN T22.SCANNER_ZWS_FLAG = 'Y' THEN ROUND(CAST(T22.ONE_WAFER_PT_SCANNER AS DECIMAL) * CAST(R.QTY AS DECIMAL), 6)
                                -- ELSE ROUND((T22.SCANNER_SLOPE_NEW * R.QTY) + T22.SCANNER_INTER_NEW, 6)
                                ELSE ROUND((CAST(T22.SCANNER_SLOPE_NEW AS DECIMAL) * CAST(R.QTY AS DECIMAL)) + CAST(T22.SCANNER_INTER_NEW AS DECIMAL), 6)
                           END                                                                                                                                      
                 END                                                                                                                                                
            ELSE 0                                                                                                                                                  
            END) END) END AS PT                                                                                                                                     
           ,R.OTHER_MIN_BATCH_SIZE,R.NON_WET_BATCH,R.MODULE, R.CH_CNT                                                                                                                                 
     FROM   APS_TMP_ETL_RLS_EQPG  R                                                                                                                                        
     LEFT JOIN   APS_MID_TYPE21_RUNTIME_P_ALL.APS_MID_TYPE21_RUNTIME_P_ALL  T21 ON  R.TARGET_TOOLG_ID = T21.TOOLG_ID AND R.EQP_ID = T21.TOOL_ID AND R.PHYSICAL_RECIPE_ID = T21.PPID                         
     LEFT JOIN   APS_MID_TYPE22_RUNTIME_P_ALL.APS_MID_TYPE22_RUNTIME_P_ALL  T22 ON  R.TARGET_TOOLG_ID = T22.TOOLG_ID AND R.PHYSICAL_RECIPE_ID = T22.PPID                                                    
     LEFT JOIN   APS_MID_TYPE221_RUNTIME_P_ALL.APS_MID_TYPE221_RUNTIME_P_ALL T221 ON  R.TARGET_TOOLG_ID = T221.TOOLG_ID AND R.EQP_ID = T221.TOOL_ID AND T221.CH_CNT = 1                                     
     --modify by xiecheng for version up
     LEFT JOIN APS_TMP_TYPE21_MEDIAN TR21 ON  R.TARGET_TOOLG_ID = TR21.TOOLG_ID AND R.EQP_ID = TR21.TOOL_ID AND R.PHYSICAL_RECIPE_ID = TR21.PPID                  
     LEFT JOIN  APS_TMP_TYPE22_MEDIAN TR22 ON  R.TARGET_TOOLG_ID = TR22.TOOLG_ID AND R.PHYSICAL_RECIPE_ID = TR22.PPID                                              
     LEFT JOIN APS_TMP_TYPE221_MEDIAN TR221 ON  R.TARGET_TOOLG_ID = TR221.TOOLG_ID AND R.EQP_ID = TR221.TOOL_ID                                                   
                                            AND TR221.CH_CNT = R.CH_CNT                                                                                                
     LEFT JOIN APS_TMP_CHARGE_TIME.APS_TMP_CHARGE_TIME TRCT ON  R.EQP_ID = TRCT.TOOL_ID                                                                                        
    """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="RlsTrDataSQL",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_TR_RESULT")


def RlsTrGlobalDataSQL(duck_db_memory=None, uuid="", current_time="", oracle_conn=None, ETL_Proc_Name="",
                       used_table_dict=None):
    sql = """
     INSERT /*+ append */ INTO APS_TMP_ETL_RLS_TR_GLOBAL_RESULT                                                                                                                         
     (PARENT_ID, LOT_ID, STEP_ID, OPE_NO, TARGET_STEP_ID, TARGET_OPE_NO, PLAN_ID, TARGET_PLAN_ID, TARGET_TOOLG_ID,
     EQP_ID, PROD_ID, FLOW_RECIPE, PPID, PHOTO_FLAG, RETICLE_ID, CHAMBER_SET, SET_STATUS, QTY, BATCH_SIZE_MAX, BATCH_SIZE_MIN,
     NPT, PT, OTHER_MIN_BATCH_SIZE
     )
     SELECT                                                                                                                                                       
            R.PARENT_ID                                                                                                                                           
           ,R.LOT_ID                                                                                                                                              
           ,R.STEP_ID                                                                                                                                             
           ,R.OPE_NO                                                                                                                                              
           ,R.TARGET_STEP_ID                                                                                                                                      
           ,R.TARGET_OPE_NO                                                                                                                                       
           ,R.PLAN_ID                                                                                                                                             
           ,R.TARGET_PLAN_ID                                                                                                                                      
           ,R.TARGET_TOOLG_ID                                                                                                                                     
           ,R.EQP_ID                                                                                                                                              
           ,R.PROD_ID                                                                                                                                             
           ,R.FLOW_RECIPE                                                                                                                                         
           ,R.PPID                                                                                                                                                
           ,R.PHOTO_FLAG                                                                                                                                          
           ,R.RETICLE_ID                                                                                                                                          
           ,R.CHAMBER_SET                                                                                                                                         
           ,R.SET_STATUS                                                                                                                                          
           ,R.QTY                                                                                                                                                 
           ,R.BATCH_SIZE_MAX                                                                                                                                      
           ,R.BATCH_SIZE_MIN                                                                                                                                      
           ,R.NPT                                                                                                                                                 
           -- wet 非Batch的要用Global
          -- ,CASE WHEN (R.PT > 0 OR R.PHOTO_FLAG = 'Y' OR R.MODULE = 'DIFF') AND R.NON_WET_BATCH = 'N' THEN  R.PT  ELSE                          
           --          CASE WHEN (T21.TOOLG_ID || T21.TOOL_ID || T21.PPID) IS NOT NULL THEN                                                           
           --                 CASE WHEN T21.LESSTHAN20_FLAG = 'Y' THEN                                                                                                
            --                          CASE WHEN (T22.TOOLG_ID || T22.PPID) IS NULL OR T22.LESSTHAN20_FLAG = 'Y' THEN                                                
            --                                    CASE WHEN (T221.TOOLG_ID || T221.TOOL_ID) IS NULL THEN 0                                                            
            --                                         WHEN T221.LESSTHAN20_FLAG = 'Y' THEN 0                                                                         
                                                     -- WHEN T221.TRACKER_ZWS_FLAG = 'Y' THEN ROUND(T221.ONE_WAFER_PT_TRACKER * R.QTY, 6)
           --                                          WHEN T221.TRACKER_ZWS_FLAG = 'Y' THEN ROUND(CAST(T221.ONE_WAFER_PT_TRACKER AS DECIMAL) * CAST(R.QTY AS DECIMAL), 6)
                                                     -- ELSE ROUND((T221.TRACKER_SLOPE_NEW * R.QTY) + T221.TRACKER_INTER_NEW, 6)
           --                                          ELSE ROUND((CAST(T221.TRACKER_SLOPE_NEW AS DECIMAL) * CAST(R.QTY AS DECIMAL)) + CAST(T221.TRACKER_INTER_NEW AS DECIMAL), 6)
           --                                     END                                                                                                                 
                                           -- WHEN T22.TRACKER_ZWS_FLAG = 'Y' THEN ROUND(T22.ONE_WAFER_PT_TRACKER * R.QTY, 6)
           --                                WHEN T22.TRACKER_ZWS_FLAG = 'Y' THEN ROUND(CAST(T22.ONE_WAFER_PT_TRACKER AS DECIMAL) * CAST(R.QTY AS DECIMAL), 6)
                                           -- ELSE ROUND((T22.TRACKER_SLOPE_NEW * R.QTY) + T22.TRACKER_INTER_NEW, 6)         
           --                                ELSE ROUND((CAST(T22.TRACKER_SLOPE_NEW AS DECIMAL) * CAST(R.QTY AS DECIMAL)) + CAST(T22.TRACKER_INTER_NEW AS DECIMAL), 6)                                                                                     
           --                           END                                                                                                                           
                                 -- WHEN T21.TRACKER_ZWS_FLAG = 'Y' THEN ROUND(T21.ONE_WAFER_PT_TRACKER * R.QTY, 6)
            --                     WHEN T21.TRACKER_ZWS_FLAG = 'Y' THEN ROUND(CAST(T21.ONE_WAFER_PT_TRACKER AS DECIMAL) * CAST(R.QTY AS DECIMAL), 6)
                                 -- ELSE ROUND((T21.TRACKER_SLOPE_NEW * R.QTY) + T21.TRACKER_INTER_NEW, 6)
             --                    ELSE ROUND((CAST(T21.TRACKER_SLOPE_NEW AS DECIMAL) * CAST(R.QTY AS DECIMAL)) + CAST(T21.TRACKER_INTER_NEW AS DECIMAL), 6)                  
             --               END                                                                                                                                     
                --       WHEN (T21.TOOLG_ID || T21.TOOL_ID || T21.PPID) IS NULL THEN                                                                                  
                  --          CASE WHEN (T22.TOOLG_ID || T22.PPID) IS NULL OR T22.LESSTHAN20_FLAG = 'Y' THEN                                                          
                   --                             CASE WHEN (T221.TOOLG_ID || T221.TOOL_ID) IS NULL THEN 0                                                            
                    --                                 WHEN T221.LESSTHAN20_FLAG = 'Y' THEN 0                                                                         
                                                     -- WHEN T221.TRACKER_ZWS_FLAG = 'Y' THEN ROUND(T221.ONE_WAFER_PT_TRACKER * R.QTY, 6)
                      --                               WHEN T221.TRACKER_ZWS_FLAG = 'Y' THEN ROUND(CAST(T221.ONE_WAFER_PT_TRACKER AS DECIMAL) * CAST(R.QTY AS DECIMAL), 6)
                                                     -- ELSE ROUND((T221.TRACKER_SLOPE_NEW * R.QTY) + T221.TRACKER_INTER_NEW, 6)
                       --                              ELSE ROUND((CAST(T221.TRACKER_SLOPE_NEW AS DECIMAL) * CAST(R.QTY AS DECIMAL)) + CAST(T221.TRACKER_INTER_NEW AS DECIMAL), 6)
                        --                        END                                                                                                                 
                                 -- WHEN T22.TRACKER_ZWS_FLAG = 'Y' THEN ROUND(T22.ONE_WAFER_PT_TRACKER * R.QTY, 6)
                          --       WHEN T22.TRACKER_ZWS_FLAG = 'Y' THEN ROUND(CAST(T22.ONE_WAFER_PT_TRACKER AS DECIMAL) * CAST(R.QTY AS DECIMAL), 6)
                                 -- ELSE ROUND((T22.TRACKER_SLOPE_NEW * R.QTY) + T22.TRACKER_INTER_NEW, 6)                                                             
                           --      ELSE ROUND((CAST(T22.TRACKER_SLOPE_NEW AS DECIMAL) * CAST(R.QTY AS DECIMAL)) + CAST(T22.TRACKER_INTER_NEW AS DECIMAL), 6)
                          --  END                                                                                                                                     
           -- END END AS PT                                                                                                                      
           --,R.OTHER_MIN_BATCH_SIZE 
           --modify by xiecheng for version up
           --,CASE WHEN (R.PT > 0 OR (R.PHOTO_FLAG = 'Y' AND R.TARGET_TOOLG_ID <> 'PB_BARC') OR R.MODULE = 'DIFF') AND R.NON_WET_BATCH = 'N' THEN  R.PT  ELSE 
           ,CASE WHEN R.PT > 0 OR R.NON_WET_BATCH = 'N'THEN R.PT  ELSE
           COALESCE(ROUND(cast(T21.ONE_WAFER_PT_TRACKER as decimal) * cast(R.QTY as decimal), 6),   ROUND(cast(T22.ONE_WAFER_PT_TRACKER as decimal)* cast(R.QTY as decimal), 6),  ROUND(cast(T221.ONE_WAFER_PT_TRACKER as decimal) * cast(R.QTY as decimal), 6),0) 
            END AS PT ,R.OTHER_MIN_BATCH_SIZE                                                                                                                                   
     FROM APS_TMP_ETL_RLS_TR_RESULT R                                                                                                                                      
     LEFT JOIN APS_MID_TYPE21_RUNTIME_ALL.APS_MID_TYPE21_RUNTIME_ALL T21 ON  R.TARGET_TOOLG_ID = T21.TOOLG_ID AND R.EQP_ID = T21.TOOL_ID AND R.PPID = T21.PPID  AND T21.LESSTHAN20_FLAG = 'N'                      
     LEFT JOIN APS_MID_TYPE22_RUNTIME_ALL.APS_MID_TYPE22_RUNTIME_ALL T22 ON  R.TARGET_TOOLG_ID = T22.TOOLG_ID AND R.PPID = T22.PPID AND T22.LESSTHAN20_FLAG = 'N'                                                  
     LEFT JOIN APS_MID_TYPE221_RUNTIME_ALL.APS_MID_TYPE221_RUNTIME_ALL T221 ON  R.TARGET_TOOLG_ID = T221.TOOLG_ID AND R.EQP_ID = T221.TOOL_ID AND T221.CH_CNT = R.CH_CNT AND T221.LESSTHAN20_FLAG = 'N'                               
    """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="RlsTrGlobalDataSQL",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_TR_GLOBAL_RESULT")


def getNpwRecipeGroupData(duck_db_memory=None, uuid="", current_time="", oracle_conn=None, ETL_Proc_Name="",
                          used_table_dict=None):
    sql = """
       INSERT INTO APS_TMP_ETL_RLS_NPW_RECIPE_GROUP(                                 
        TOOL_ID, RECIPE_ID, GROUP_ID                                                      
        )                                                                   
         SELECT P.TOOL_ID,P.RECIPE_ID,                                  
                REPLACE(MAX(P.GROUP_ID),'%','*') AS GROUP_ID            
         FROM APS_SYNC_NPW_RECIPE_GROUP.APS_SYNC_NPW_RECIPE_GROUP P       
         WHERE P.GROUP_ID <> '*'                                           
         GROUP BY P.TOOL_ID,P.RECIPE_ID    
        """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="getNpwRecipeGroupData",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_NPW_RECIPE_GROUP")


def RlsResultDataSQL(duck_db_memory=None, uuid="", current_time="", oracle_conn=None, ETL_Proc_Name="",
                     used_table_dict=None):
    sql = """
     INSERT /*+ append */ INTO  APS_TMP_ETL_RLS_RESULT                                                                                                                  
        (     PARENTID, LOT_ID, STEP_ID, OPE_NO, TARGET_STEP_ID, TARGET_OPE_NO, PLAN_ID,
        TARGET_PLAN_ID, TOOLG_ID,TOOL_ID, RECIPE, PPID, RETICLE_ID, CH_SET, SET_STATUS,
       QTY, MAX_BATCH_SIZE, MIN_BATCH_SIZE, NON_PROCESS_RUNTIME, PROCESS_RUNTIME, UPDATE_TIME,
                PARTCODE, OTHER_MIN_BATCH_SIZE, RECIPE_SETUP)                                                                                                                                      
        WITH RTD_GROUPNAME_DATA AS (                                      
            SELECT TOOL_ID,PPID,                                     
                   MAX(RTD_GROUPNAME) AS RTD_GROUPNAME               
            FROM APS_SYNC_RTD_RECIPEGROUP.APS_SYNC_RTD_RECIPEGROUP              
            WHERE RTD_GROUPNAME <> '*'                               
            AND position('F' in TOOL_ID) = 1                               
            GROUP BY TOOL_ID,PPID                                    
        )                                                            
         SELECT                                                                                                                                                                
                R.PARENT_ID                                                                                                                                                    
               ,R.LOT_ID                                                                                                                                                       
               ,R.STEP_ID                                                                                                                                                      
               ,R.OPE_NO                                                                                                                                                       
               ,R.TARGET_STEP_ID                                                                                                                                               
               ,R.TARGET_OPE_NO                                                                                                                                                
               ,R.PLAN_ID                                                                                                                                                      
               ,R.TARGET_PLAN_ID                                                                                                                                               
               ,R.TARGET_TOOLG_ID                                                                                                                                              
               ,R.EQP_ID                                                                                                                                                       
               ,COALESCE(R.FLOW_RECIPE, ' ') AS RECIPE                                                                                                                              
               ,R.PPID                                                                                                                                                         
               ,R.RETICLE_ID                                                                                                                                                   
               ,R.CHAMBER_SET                                                                                                                                                  
               ,R.SET_STATUS                                                                                                                                                   
               ,R.QTY                                                                                                                                                          
               ,R.BATCH_SIZE_MAX                                                                                                                                               
               ,R.BATCH_SIZE_MIN                                                                                                                                               
               ,ROUND(R.NPT,2) AS NPT                                                                                                                                          
        --  增加逻辑，黄光区域如果某些批次不需要Reticle就可以直接RUN，那这些PT值改成0.001,除了DYB
               ,CASE WHEN R.TARGET_TOOLG_ID IN ('PK_KrF','PH_ArF','PU_I-Line')  AND  GM.PRODSPEC_ID IS NULL AND R.TARGET_PLAN_ID NOT LIKE 'DYB%' THEN 0.001 ELSE               
               ROUND(R.PT,2) END AS PT                                                                                                                                         
               ,'{current_time}'                                                                                                                                           
               ,''                                                                                                                                            
               ,R.OTHER_MIN_BATCH_SIZE                                                                                                                                         
        -- recipe_setup 优先顺序V_RTD_RECIPEGROUP >V_RTD_IMP_SOURCE>V_NPW_RECIPE_GROUP>V_RDS_RECIPEINFO
               ,CASE WHEN RGD.TOOL_ID IS NOT NULL THEN RGD.RTD_GROUPNAME                                                                                                        
                     WHEN RTS.MAINPD_ID IS NOT NULL THEN RTS.SOURCE                                                                                                             
                     WHEN NRG.TOOL_ID IS NOT NULL THEN NRG.GROUP_ID  
                     WHEN RRI.TOOL_ID IS NOT NULL THEN RRI.RUNTIMEGROUPNAME                                                                                                           
               END AS RECIPE_SETUP                                                                                                                                              
         FROM APS_TMP_ETL_RLS_TR_GLOBAL_RESULT R                                                                                                                                                   
         LEFT JOIN APS_SYNC_MASK_GROUP_MAPPLING.APS_SYNC_MASK_GROUP_MAPPLING GM ON R.TARGET_OPE_NO = GM.OPE_NO AND R.PROD_ID = GM.PRODSPEC_ID                                                                     
         LEFT JOIN  RTD_GROUPNAME_DATA RGD ON RGD.TOOL_ID = R.EQP_ID AND RGD.PPID = R.PPID                                                                                      
         LEFT JOIN  APS_TMP_ETL_RLS_NPW_RECIPE_GROUP NRG ON NRG.TOOL_ID = R.EQP_ID AND NRG.RECIPE_ID = R.PPID                                                                             
         LEFT JOIN  APS_TMP_ETL_RLS_RTD_IMP_SOURCE RTS ON RTS.MAINPD_ID = R.TARGET_PLAN_ID AND RTS.OPE_NO = R.TARGET_OPE_NO
         LEFT JOIN  APS_TMP_ETL_RLS_RDS_RECIPE_INFO RRI ON RRI.TOOL_ID = R.EQP_ID AND RRI.PPID = R.PPID     
    """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="RlsResultDataSQL",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_RESULT")


def RlsResultDataByRepeatSQL(duck_db_memory=None, uuid="", current_time="", oracle_conn=None, ETL_Proc_Name="",
                             used_table_dict=None):
    sql = """
     INSERT /*+ append */ INTO APS_ETL_RLS                                                                                                                       
     ( PARENTID, LOT_ID, STEP_ID, OPE_NO, TARGET_STEP_ID, TARGET_OPE_NO, PLAN_ID,
      TARGET_PLAN_ID, TOOLG_ID,TOOL_ID, RECIPE, PPID, RETICLE_ID, CH_SET, SET_STATUS,
      QTY, MAX_BATCH_SIZE, MIN_BATCH_SIZE, NON_PROCESS_RUNTIME, PROCESS_RUNTIME, UPDATE_TIME, 
      PARTCODE, OTHER_MIN_BATCH_SIZE, RECIPE_SETUP
      )                                                                                                                                         
      WITH RLS_DATA AS (                                                                                                                                                     
           SELECT R.*                                                                                                                                                        
                  ,ROW_NUMBER() OVER(PARTITION BY PARENTID, LOT_ID, TARGET_STEP_ID, TARGET_PLAN_ID, TOOL_ID, RECIPE, PPID, RETICLE_ID, PARTCODE ORDER BY STEP_ID) AS RN      
           FROM  APS_TMP_ETL_RLS_RESULT  R                                                                                                                                         
      )                                                                                                                                                                      
      SELECT                                                                                                                                                                 
             -- R.PARENTID
             '{uuid}'                                                                                                                                                      
            ,R.LOT_ID                                                                                                                                                        
            ,R.STEP_ID                                                                                                                                                       
            ,R.OPE_NO                                                                                                                                                        
            ,R.TARGET_STEP_ID                                                                                                                                                
            ,R.TARGET_OPE_NO                                                                                                                                                 
            ,R.PLAN_ID                                                                                                                                                       
            ,R.TARGET_PLAN_ID                                                                                                                                                
            ,R.TOOLG_ID                                                                                                                                                      
            ,R.TOOL_ID                                                                                                                                                       
            ,R.RECIPE                                                                                                                                                        
            ,R.PPID                                                                                                                                                          
            ,R.RETICLE_ID                                                                                                                                                    
            ,R.CH_SET                                                                                                                                                        
            ,R.SET_STATUS                                                                                                                                                    
            ,R.QTY                                                                                                                                                           
            ,CAST(R.MAX_BATCH_SIZE AS INTEGER)                                                                                                                                                
            ,CAST(R.MIN_BATCH_SIZE AS INTEGER)                                                                                                                                                
            ,CAST(R.NON_PROCESS_RUNTIME AS DECIMAL)                                                                                                                                           
            ,CAST(R.PROCESS_RUNTIME AS DECIMAL)                                                                                                                                                 
            -- ,R.UPDATE_TIME
            ,CAST('{current_time}' AS TIMESTAMP)                                                                                                                                                   
            ,R.PARTCODE                                                                                                                                                      
            ,CAST(R.OTHER_MIN_BATCH_SIZE AS INTEGER)                                                                                                                                         
            ,R.RECIPE_SETUP                                                                                                                                                  
      FROM RLS_DATA R                                                                                                                                                        
      WHERE R.RN = 1                                                                                                                                                         
    """.format(uuid=uuid, current_time=current_time)
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="RlsResultDataByRepeatSQL",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_ETL_RLS")


def getRtdImpSourceData(duck_db_memory=None, uuid="", current_time="", oracle_conn=None, ETL_Proc_Name="",
                        used_table_dict=None):
    sql = """
         INSERT INTO APS_TMP_ETL_RLS_RTD_IMP_SOURCE(                                
         MAINPD_ID, OPE_NO, SOURCE                                                  
         )                                                                
          SELECT S.MAINPD_ID,S.OPE_NO,                                    
                 MAX(S.SOURCE) AS SOURCE                                  
          FROM APS_SYNC_RTD_IMP_SOURCE.APS_SYNC_RTD_IMP_SOURCE S           
          GROUP BY S.MAINPD_ID,S.OPE_NO                                                                                                                                                                                     
    """.format(uuid=uuid, current_time=current_time)

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="getRtdImpSourceData",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_RTD_IMP_SOURCE")


def getRdsRecipeInfoData(duck_db_memory=None, uuid="", current_time="", oracle_conn=None, ETL_Proc_Name="",
                        used_table_dict=None):
    sql = """
          INSERT INTO APS_TMP_ETL_RLS_RDS_RECIPE_INFO(                           
         TOOL_ID, RUNTIMEGROUPNAME, PPID                                     
        )                                                               
         SELECT F.TOOLID,F.RUNTIMEGROUPNAME,                                                          
         SUBSTRING(REPLACE(F.DKEY,'.AA',''), POSITION('.' IN REPLACE(F.DKEY,'.AA',''))+1) AS PPID           
         FROM APS_SYNC_RDS_RECIPEINFO.APS_SYNC_RDS_RECIPEINFO F                                       
         WHERE F.RUNTIMEGROUPNAME IS NOT NULL AND POSITION('C' IN F.TOOLID)=1                                                                                                                                                                     
    """.format(uuid=uuid, current_time=current_time)

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="getRtdImpSourceData",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_RTD_IMP_SOURCE")


def RlsResultByMeasureDataSQL(duck_db_memory=None, uuid="", current_time="", oracle_conn=None, ETL_Proc_Name="",
                              used_table_dict=None):
    sql = """
        INSERT /*+ append */ INTO  APS_TMP_ETL_RLS_RESULT                                                                                                                         
         (PARENTID, LOT_ID, STEP_ID, OPE_NO, TARGET_STEP_ID, TARGET_OPE_NO, PLAN_ID,
          TARGET_PLAN_ID, TOOLG_ID,TOOL_ID, RECIPE, PPID, RETICLE_ID, CH_SET, SET_STATUS,
          QTY, MAX_BATCH_SIZE, MIN_BATCH_SIZE, NON_PROCESS_RUNTIME, PROCESS_RUNTIME, UPDATE_TIME,
          PARTCODE, OTHER_MIN_BATCH_SIZE, RECIPE_SETUP)                                                                                                                                   
          SELECT                                                                                                                                                                
                 R.PARENT_ID                                                                                                                                                     
                ,R.LOT_ID                                                                                                                                                       
                ,R.OPE_SEQ                                                                                                                                                      
                ,R.OPE_NO                                                                                                                                                       
                ,R.TARGET_OPE_SEQ                                                                                                                                               
                ,R.TARGET_OPE_NO                                                                                                                                                
                ,R.PLAN_ID                                                                                                                                                      
                ,R.TARGET_PLAN_ID                                                                                                                                               
                ,R.TARGET_TOOLG_ID                                                                                                                                                     
                ,' ' AS TOOL_ID                                                                                                                                                      
                ,' ' AS RECIPE                                                                                                                                                       
                ,' ' AS PPID                                                                                                                                                         
                ,' ' AS RETICLE_ID                                                                                                                                                   
                ,'' AS CH_SET                                                                                                                                                       
                ,'MEASURE_INHIBIT' AS SET_STATUS                                                                                                                                    
                ,R.WAFER_QTY                                                                                                                                                        
                ,'0' AS MAX_BATCH_SIZE                                                                                                                                               
                ,'0' AS MIN_BATCH_SIZE                                                                                                                                               
                ,'0' AS NON_PROCESS_RUNTIME                                                                                                                                          
                ,'0' AS PROCESS_RUNTIME                                                                                                                                              
                ,'{current_time}'  AS UPDATE_TIME                                                                                                                                                  
                ,'' AS PARTCODE                                                                                                                                                     
                ,'0' AS OTHER_MIN_BATCH_SIZE                                                                                                                                         
                ,'' AS RECIPE_SETUP                                                                                                                                                 
          FROM APS_TMP_ETL_RLS_MEASURE_LOT R                                                                                                                                                                                                       
    """.format(uuid=uuid, current_time=current_time)
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="RlsResultByMeasureDataSQL",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_RLS_RESULT")


def InsertRlsResultData(duck_db_memory=None, uuid="", current_time="", oracle_conn=None, ETL_Proc_Name="",
                        used_table_dict=None):
    # 先把串接线性回归的逻辑串接出来
    RlsTrDataSQL(duck_db_memory=duck_db_memory, uuid=uuid, current_time=current_time, oracle_conn=oracle_conn,
                 ETL_Proc_Name=ETL_Proc_Name, used_table_dict=used_table_dict)

    # 针对Global的线性回归
    RlsTrGlobalDataSQL(duck_db_memory=duck_db_memory, uuid=uuid, current_time=current_time, oracle_conn=oracle_conn,
                       ETL_Proc_Name=ETL_Proc_Name, used_table_dict=used_table_dict)
    # modify by xiecheng for version up
    # 把V_NPW_RECIPE_GROUP单独拿出来执行
    getNpwRecipeGroupData(duck_db_memory=duck_db_memory, uuid=uuid, current_time=current_time, oracle_conn=oracle_conn,
                          ETL_Proc_Name=ETL_Proc_Name, used_table_dict=used_table_dict)
    # modify by xiecheng for version up
    # 把V_RTD_IMP_SOURCE 单独拿出来执行
    getRtdImpSourceData(duck_db_memory=duck_db_memory, uuid=uuid, current_time=current_time, oracle_conn=oracle_conn,
                        ETL_Proc_Name=ETL_Proc_Name, used_table_dict=used_table_dict)
    # 把V_RDS_RECIPEINFO 单独拿出来执行
    getRdsRecipeInfoData(duck_db_memory=duck_db_memory, uuid=uuid, current_time=current_time, oracle_conn=oracle_conn,
                         ETL_Proc_Name=ETL_Proc_Name, used_table_dict=used_table_dict)

    RlsResultDataSQL(duck_db_memory=duck_db_memory, uuid=uuid, current_time=current_time, oracle_conn=oracle_conn,
                     ETL_Proc_Name=ETL_Proc_Name, used_table_dict=used_table_dict)
    # modify by xiecheng for version up
    # 把量测数据插入
    RlsResultByMeasureDataSQL(duck_db_memory=duck_db_memory, uuid=uuid, current_time=current_time,
                              oracle_conn=oracle_conn, ETL_Proc_Name=ETL_Proc_Name, used_table_dict=used_table_dict)

    RlsResultDataByRepeatSQL(duck_db_memory=duck_db_memory, uuid=uuid, current_time=current_time,
                             oracle_conn=oracle_conn, ETL_Proc_Name=ETL_Proc_Name, used_table_dict=used_table_dict)