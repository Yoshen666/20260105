from datetime import datetime

from xinxiang import config
from xinxiang.util import my_duck, my_date


def GetLastFlowData(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    # Last Flow data 单独放到 aps_tmp_etl_wip_last_flow temp 表
    sql = """
     INSERT INTO APS_TMP_ETL_WIP_LAST_FLOW
     (                                                                                            
       PARENTID,PROD_ID, PLAN_NO, PLAN_ID, STEP_ID, LAYER, STAGE, TOOLG_ID, RECIPE, RETICLE_GROUP 
      ,STEP_TYPE, TOOLG_TYPE, PROCESS_TIME, CYCLE_TIME, UPDATE_TIME, OPE_NO, CAPABILITY, SGS_FLAG 
      ,PRODG_ID, PRODG_TECH, PARTCODE, SGS_GROUP, MULTI_TARGET_FLAG,MULTI_GROUP                     
     )                                                                                            
    SELECT                                                                                        
      PARENTID,PROD_ID, PLAN_NO, PLAN_ID, STEP_ID, LAYER, STAGE, TOOLG_ID, RECIPE, RETICLE_GROUP  
     ,STEP_TYPE, TOOLG_TYPE, PROCESS_TIME, CYCLE_TIME, UPDATE_TIME, OPE_NO, CAPABILITY, SGS_FLAG  
     ,PRODG_ID, PRODG_TECH, PARTCODE, SGS_GROUP, MULTI_TARGET_FLAG,MULTI_GROUP                       
    FROM APS_ETL_FLOW.APS_ETL_FLOW                                                                             
    -- WHERE PARTCODE = '+ lastPartCode + "'                                                       
    -- AND PARENTID = '+ lastParentId + "'                                                         
    """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_WIP_LAST_FLOW",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_WIP_LAST_FLOW")


def InsertWip2Temp(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    # 区分出PH的WIP和非PH的WIP信息
    sql = """
     INSERT /*+ append */ INTO APS_TMP_ETL_WIP_V
     (	    LOT_ID,                         
            PRODSPEC_ID,                    
            MAINPD_ID,                      
            OPE_NO,                         
            LOT_TYPE,                       
            LOT_FINISHED_STATE,             
            CASSETE_ID,                     
            WAFER_QTY,                      
            PRIORITY_CLASS,                 
            LOT_PROC_STATE,                 
            LAST_OPE_COMP_TIME,             
            EQP_ID,                         
            OPE_NO_START_TIME,              
            LAST_PROCESS_START_TIME,        
            TECH_ID,                        
            CUSTOMER_ID,                    
            PARENT_LOT_ID,                  
            WHITE_FLAG,                     
            BATCH_ID,                       
            TRANS_STATE,                    
            PROCESS_START_TIME,             
            WIP_CLAIM_TIME                  
     )                                      
     SELECT W.LOT_ID,                                                                      
            W.PRODSPEC_ID,                                                                 
            W.MAINPD_ID,                                                                   
            W.OPE_NO,                                                                      
            W.LOT_TYPE,                                                                    
            W.LOT_FINISHED_STATE,                                                          
            W.CASSETE_ID,                                                                  
            W.WAFER_QTY,                                                                   
            W.PRIORITY_CLASS,  
            -- modify by xiecheng for version up                                                            
           -- W.LOT_PROC_STATE,  
            CASE WHEN W.LOT_PROC_STATE = 'Waiting' AND W.CTRL_JOB_ID is not null THEN 'JOBPREPARED'
            ELSE W.LOT_PROC_STATE END AS LOT_PROC_STATE,                                                                
            W.LAST_OPE_COMP_TIME,                                                          
            W.EQP_ID,                                                                      
            W.OPE_NO_START_TIME,                                                           
            W.LAST_PROCESS_START_TIME,                                                     
            W.TECH_ID,                                                                     
            W.CUSTOMER_ID,                                                                 
            W.PARENT_LOT_ID,                                                               
            W.WHITE_FLAG,                                                                  
            W.FLOWBATCH_ID,                                                                
            W.TRANS_STATE,                                                                 
            W.PROCESS_START_TIME,                                                            
            W.CLAIM_TIME                                                                     
      FROM APS_SYNC_WIP.APS_SYNC_WIP W                        
      WHERE 1=1 
      -- AND  W.PARTCODE='"+ wipPartCode+ 
      -- AND  INSTR(OPE_NO, '.PP') > 0 OR INSTR(OPE_NO, 'NPR10') > 0                       
      AND  POSITION('.PP' IN OPE_NO) > 0 OR POSITION('NPR10' IN OPE_NO) > 0
      and lot_inv_state <> 'NonProBank'                                                     
      and (SUBSTRING(lot_id,1,1)='N' or (SUBSTRING(lot_id,1,1)='R' AND ope_no='1R.NPR10'))        
    """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_WIP_V",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_WIP_V")

    sql = """
      INSERT /*+ append */ INTO APS_TMP_ETL_WIP_V
      (	    LOT_ID,                         
             PRODSPEC_ID,                    
             MAINPD_ID,                      
             OPE_NO,                         
             LOT_TYPE,                       
             LOT_FINISHED_STATE,             
             CASSETE_ID,                     
             WAFER_QTY,                      
             PRIORITY_CLASS,                 
             LOT_PROC_STATE,                 
             LAST_OPE_COMP_TIME,             
             EQP_ID,                         
             OPE_NO_START_TIME,              
             LAST_PROCESS_START_TIME,        
             TECH_ID,                        
             CUSTOMER_ID,                    
             PARENT_LOT_ID,                  
             WHITE_FLAG,                     
             BATCH_ID,                       
             TRANS_STATE,                    
             PROCESS_START_TIME,             
             WIP_CLAIM_TIME                  
      )                                      
      SELECT W.LOT_ID,                                                                      
             W.PRODSPEC_ID,                                                                 
             W.MAINPD_ID,                                                                   
             W.OPE_NO,                                                                      
             W.LOT_TYPE,                                                                    
             W.LOT_FINISHED_STATE,                                                          
             W.CASSETE_ID,                                                                  
             W.WAFER_QTY,                                                                   
             W.PRIORITY_CLASS, 
             --modify by xiecheng for version up                                                             
             --W.LOT_PROC_STATE,
             CASE WHEN W.LOT_PROC_STATE = 'Waiting' AND W.CTRL_JOB_ID is not null THEN 'JOBPREPARED' 
             ELSE W.LOT_PROC_STATE END AS LOT_PROC_STATE,                                                                
             W.LAST_OPE_COMP_TIME,                                                          
             W.EQP_ID,                                                                      
             W.OPE_NO_START_TIME,                                                           
             W.LAST_PROCESS_START_TIME,                                                     
             W.TECH_ID,                                                                     
             W.CUSTOMER_ID,                                                                 
             W.PARENT_LOT_ID,                                                               
             W.WHITE_FLAG,                                                                  
             W.FLOWBATCH_ID,                                                                
             W.TRANS_STATE,                                                                 
             W.PROCESS_START_TIME,                                                            
             W.CLAIM_TIME                                                                 
       FROM APS_SYNC_WIP.APS_SYNC_WIP W                        
       WHERE 1=1 
       -- AND  W.PARTCODE='"+ wipPartCode+ 
       -- AND INSTR(OPE_NO,'.PP')=0 AND INSTR(OPE_NO,'NPR10')=0                        
       AND  POSITION('.PP' IN OPE_NO) = 0 AND POSITION('NPR10' IN OPE_NO) = 0      
     """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_WIP_V",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_WIP_V")

    # 从Opehs OperationStart的 Recipe , Job, 时间 insert到 temp table
    # 为了获取状态信息OperationStart：RUN，OperationStartCancel为WAIT， 同时也列出TrackIn的时间
    # 更新：现在主要是为了找到站点recipe
    sql = """
    INSERT /*+ append */ INTO APS_TMP_ETL_WIP_OPER_START_HS                                               
    (LOT_ID, OPE_NO, RECIPE_ID, CLAIM_TIME, CTRL_JOB, EQP_ID, OPE_CATEGORY, PRODSPEC_ID, MAINPD_ID)            
    SELECT LOT_ID, OPE_NO, PH_RECIPE_ID, CLAIM_TIME, CTRL_JOB, EQP_ID, OPE_CATEGORY,PRODSPEC_ID,MAINPD_ID      
      FROM (SELECT OH.LOT_ID,                                                                                  
                   OH.OPE_NO,                                                                                  
                   OH.PH_RECIPE_ID,                                                                            
                   -- TO_CHAR(OH.CLAIM_TIME, 'yyyy-mm-dd hh24:mi:ss') AS CLAIM_TIME,   
                   STRFTIME(CAST(OH.CLAIM_TIME AS TIMESTAMP), '%Y-%m-%d %H:%M:%S') AS CLAIM_TIME,                          
                   OH.CTRL_JOB,                                                                                
                   OH.EQP_ID,                                                                                  
                   OH.OPE_CATEGORY,                                                                            
                   OH.PRODSPEC_ID,                                                                             
                   OH.MAINPD_ID,                                                                               
                   ROW_NUMBER() OVER(PARTITION BY OH.LOT_ID ORDER BY OH.CLAIM_TIME DESC) AS RN                 
              FROM APS_MID_FHOPEHS.APS_MID_FHOPEHS OH                                                                                
              INNER JOIN APS_TMP_ETL_WIP_V W ON OH.LOT_ID = W.LOT_ID                                  
                                                     AND OH.OPE_NO = W.OPE_NO                                  
                                                     AND OH.MAINPD_ID = W.MAINPD_ID                            
                                                     AND OH.PRODSPEC_ID = W.PRODSPEC_ID                                    
             WHERE OH.CTRL_JOB is not null                                                                           
               -- AND OH.PARTKEY >= SYSDATE - 3
               AND OH.CLAIM_TIME >= DATE_TRUNC('day', CURRENT_DATE) - INTERVAL '3 day'                                                                
               AND OH.OPE_CATEGORY IN ('OperationStart')) A                                                   
    WHERE A.RN = 1                                                                                             
    """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_WIP_OPER_START_HS",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_WIP_OPER_START_HS")

    # 从Opehs Reserve的 Recipe , Job, 时间 insert到 temp table
    # 为了获取状态信息Reserve：JOBPREPARED，ReserveCancel为WAIT， 同时也列出JOB_PREPARED的时间
    sql = """
    INSERT /*+ append */ INTO APS_TMP_ETL_WIP_OPER_RESERVE_HS                                               
     (LOT_ID, OPE_NO, RECIPE_ID, CLAIM_TIME, CTRL_JOB, EQP_ID, OPE_CATEGORY, RECIPE_ID_C, PRODSPEC_ID, MAINPD_ID)   
     WITH OPEHS_RESERVE AS (                                                                                        
           SELECT LOT_ID, OPE_NO, PH_RECIPE_ID, CLAIM_TIME, CTRL_JOB, EQP_ID, OPE_CATEGORY,PRODSPEC_ID,MAINPD_ID    
                 ,REPLACE(SUBSTRING(A.RECIPE_ID,                                                                       
                            -- INSTR(A.RECIPE_ID, ';') + 1,                                                            
                            POSITION(';' IN A.RECIPE_ID) + 1,
                            LENGTH(A.RECIPE_ID) -                                                                   
                            -- INSTR(A.RECIPE_ID, ';')),
                            POSITION(';' IN A.RECIPE_ID)),
                     '/',                                                                                           
                     '') AS RECIPE_ID_C                                                                             
            FROM (SELECT OH.LOT_ID,                                                                                 
                         OH.OPE_NO,                                                                                 
                         OH.PH_RECIPE_ID,                                                                           
                         OH.RECIPE_ID,                                                                              
                         -- TO_CHAR(OH.CLAIM_TIME, 'yyyy-mm-dd hh24:mi:ss') AS CLAIM_TIME,   
                         STRFTIME(CAST(OH.CLAIM_TIME AS TIMESTAMP), '%Y-%m-%d %H:%M:%S') AS CLAIM_TIME,                            
                         OH.CTRL_JOB,                                                                               
                         OH.EQP_ID,                                                                                 
                         OH.OPE_CATEGORY,                                                                           
                         OH.PRODSPEC_ID,                                                                            
                         OH.MAINPD_ID,                                                                              
                         ROW_NUMBER() OVER(PARTITION BY OH.LOT_ID ORDER BY OH.CLAIM_TIME DESC) AS RN                
                    FROM APS_MID_FHOPEHS.APS_MID_FHOPEHS OH                                                                               
                    INNER JOIN APS_TMP_ETL_WIP_V W ON OH.LOT_ID = W.LOT_ID                                 
                                                           AND OH.OPE_NO = W.OPE_NO                                 
                                                           AND OH.MAINPD_ID = W.MAINPD_ID                           
                                                           AND OH.PRODSPEC_ID = W.PRODSPEC_ID                        
                   WHERE OH.CTRL_JOB is not null                                                                          
                     -- AND OH.PARTKEY >= SYSDATE - 3
                     AND OH.CLAIM_TIME >= DATE_TRUNC('day', CURRENT_DATE) - INTERVAL '3 day'                                                                      
                     AND OH.OPE_CATEGORY IN ('Reserve')                                                             
                  ) A                                                                                               
           WHERE A.RN = 1                                                                                           
     )                                                                                                              
     SELECT R.LOT_ID, R.OPE_NO, R.PH_RECIPE_ID, R.CLAIM_TIME, R.CTRL_JOB, R.EQP_ID, R.OPE_CATEGORY                  
           -- ,SUBSTRING(R.RECIPE_ID_C, 1, INSTR(R.RECIPE_ID_C, '.', -1, 1) - 1) AS RECIPE_ID_C, PRODSPEC_ID, MAINPD_ID   
           ,SUBSTRING(R.RECIPE_ID_C, 1, POSITION('.' IN REVERSE(R.RECIPE_ID_C)) - 1) AS RECIPE_ID_C, PRODSPEC_ID, MAINPD_ID
     FROM OPEHS_RESERVE R    
    """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_WIP_OPER_RESERVE_HS",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_WIP_OPER_RESERVE_HS")

    # 为了获取状态信息BatchForming
    sql = """
     INSERT /*+ append */ INTO APS_TMP_ETL_WIP_OPER_BATCHFORMING_HS                        
     (LOT_ID, OPE_NO, CLAIM_TIME, CTRL_JOB, EQP_ID, OPE_CATEGORY, PRODSPEC_ID, MAINPD_ID,CLAIM_USER_ID)  
     SELECT LOT_ID, OPE_NO, CLAIM_TIME, CTRL_JOB, EQP_ID,                                            
            OPE_CATEGORY,PRODSPEC_ID,MAINPD_ID,CLAIM_USER_ID                                                               
     FROM (                                                                                          
              SELECT OH.LOT_ID,                                                                                  
                    OH.OPE_NO,                                                                                                                                         
                    -- TO_CHAR(OH.CLAIM_TIME, 'yyyy-mm-dd hh24:mi:ss') AS CLAIM_TIME,
                    STRFTIME(CAST(OH.CLAIM_TIME AS TIMESTAMP), '%Y-%m-%d %H:%M:%S') AS CLAIM_TIME,                               
                    OH.CTRL_JOB,                                                                                
                    OH.EQP_ID,                                                                                  
                    OH.OPE_CATEGORY,                                                                            
                    OH.PRODSPEC_ID,                                                                             
                    OH.MAINPD_ID,OH.CLAIM_USER_ID,                                                              
                    ROW_NUMBER() OVER(PARTITION BY OH.LOT_ID ORDER BY OH.CLAIM_TIME DESC) AS RN                 
               FROM APS_MID_FHOPEHS.APS_MID_FHOPEHS OH                                                                                
               INNER JOIN APS_TMP_ETL_WIP_V W ON OH.LOT_ID = W.LOT_ID                                            
                                                      AND OH.MAINPD_ID = W.MAINPD_ID                            
                                                      AND OH.PRODSPEC_ID = W.PRODSPEC_ID                        
               WHERE  1=1                                                                                        
               -- AND OH.PARTKEY >= SYSDATE - 3
               AND OH.CLAIM_TIME >= DATE_TRUNC('day', CURRENT_DATE) - INTERVAL '3 day'                                                                        
               AND OH.OPE_CATEGORY IN ('BatchForming','ReBatchForming')                                             
     ) A                                                                                                
     WHERE A.RN = 1                                                                                  
    """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_WIP_OPER_BATCHFORMING_HS",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_WIP_OPER_BATCHFORMING_HS")

    # 先获取BatchName的信息
    sql = """
     INSERT /*+ append */ INTO APS_TMP_ETL_WIP_PO_N1_BATCH_NAME                            
     (MAINPD_ID, OPE_NO, BATCH_NAME)                  
     SELECT N.MAINPD_ID,N.OPE_NO,N.BATCH_NAME         
     FROM APS_SYNC_PF_PO_N1.APS_SYNC_PF_PO_N1 N                                
     WHERE (N.BATCH_NAME IS NOT NULL and N.BATCH_NAME <> '')
     -- AND N.PARTCODE ='"+ poN1PartCode+"'                  
     AND EXISTS ( 
         SELECT 1 FROM APS_TMP_ETL_WIP_V W           
         WHERE W.MAINPD_ID = N.MAINPD_ID                  
     )  
    """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_WIP_PO_N1_BATCH_NAME",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_WIP_PO_N1_BATCH_NAME")

    # 获取封Batch的BatchName信息
    sql = """
     INSERT /*+ append */ INTO APS_TMP_ETL_WIP_FORMING_RESULT                             
        (LOT_ID, MAINPD_ID, BATCH_NAME, EQP_ID, CLAIM_TIME,CLAIM_USER_ID)                  
     SELECT DISTINCT H.LOT_ID,H.MAINPD_ID,                     
            N.BATCH_NAME,H.EQP_ID,H.CLAIM_TIME,                
            H.CLAIM_USER_ID                                    
     FROM APS_TMP_ETL_WIP_OPER_BATCHFORMING_HS H        
         INNER JOIN APS_TMP_ETL_WIP_PO_N1_BATCH_NAME N       
         ON H.MAINPD_ID = N.MAINPD_ID                              
         AND H.OPE_NO = N.OPE_NO 
    """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_WIP_FORMING_RESULT",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_WIP_FORMING_RESULT")

    # modify by xiecheng for version up
    # 针对黄光区双光罩的问题，从V_RETICLE_PROD 如果值对应一个光罩群且只有一个光罩，直接用；如果对应多个光罩群组且每个光罩群组只对应唯一光罩，则需要用：A光罩;B光罩
    sql = """
      INSERT /*+ append */ INTO APS_TMP_ETL_WIP_MORE_RETICLE                                                                                           
             ( PROD_ID, OPE_NO, RTCL_ID )                                                                                                       
             WITH RETICLE_DATA AS (                                                                                           
              SELECT P.PRODSPEC_ID,P.PRODG1,                                                                                
                   P.MASK_GROUP,P.RTCL_ID,                                                                                
                   P.OPE_NO,P.CHIP_BODY,                                                                                  
                   ROW_NUMBER() OVER (PARTITION BY P.PRODSPEC_ID,P.OPE_NO, P.MASK_GROUP ORDER BY P.RTCL_ID DESC) AS RN    
              FROM APS_SYNC_RETICLE_PROD.APS_SYNC_RETICLE_PROD P                                                                                                                                   
             ),                                                                                                               
             GROUP_RECL AS (                                                                                                  
              SELECT P.PRODSPEC_ID,MAX(P.PRODG1) AS PRODG1,                                                                 
                   P.MASK_GROUP,MAX(P.RTCL_ID) AS RTCL_ID,                                                            
                   P.OPE_NO,MAX(P.CHIP_BODY) AS CHIP_BODY,                                                            
                   MAX(RN) AS RN                                                                                      
              FROM RETICLE_DATA P                                                                                           
              GROUP BY P.PRODSPEC_ID,P.OPE_NO, P.MASK_GROUP                                                                 
             ),                                                                                                               
             RESULT_DATA AS (                                                                                                 
              SELECT PRODSPEC_ID,PRODG1,                                                                                    
                   MASK_GROUP,RTCL_ID,                                                                                
                   OPE_NO,CHIP_BODY                                                                                   
              FROM GROUP_RECL                                                                                               
              WHERE RN = 1                                                                                                  
             )                                                                                                                
              SELECT  PRODSPEC_ID,OPE_NO,                                                                              
                   STRING_AGG(RTCL_ID,';' ORDER BY RTCL_ID) AS RTCL_ID             
             FROM RESULT_DATA  
             group by PRODSPEC_ID,OPE_NO
      """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_WIP_MORE_RETICLE",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_WIP_MORE_RETICLE")

    # 为了获取Reserve状态的Reticle数据，串接RECIPE_ID_C
    sql = """
     INSERT /*+ append */ INTO APS_TMP_ETL_WIP_RECIPE_RETICLE
     (                                                                                                          
       TOOLID, RECIPE_ID, RETICLE_ID, MODIFY_TIME, MODIFY_USER, UPDATE_TIME, CONVERT_TOOL_ID, RECIPE_ID_C       
     )                                                                                                          
     WITH RECIPE_RETICLE AS (                                                                                   
          SELECT RR.TOOLID, RR.RECIPE_ID, RR.RETICLE_ID, RR.MODIFY_TIME, RR.MODIFY_USER, RR.UPDATE_TIME,    
             -- modify by xiecheng for version up    
             --REPLACE(REPLACE(REPLACE(RR.TOOLID, 'PAC', 'PUC'), 'PVC', 'PKC'), 'PLN', 'PHN') AS CONVERT_TOOL_ID, 
             REPLACE(REPLACE(REPLACE(REPLACE(RR.TOOLID, 'PAC', 'PUC'), 'PVC', 'PKC'), 'PLN', 'PHN'),'PNN','PIN') AS CONVERT_TOOL_ID, 
             REPLACE(RR.RECIPE_ID, '/', '')  AS RECIPE_C,                                                       
             ROW_NUMBER() OVER(PARTITION BY RR.TOOLID, RR.RECIPE_ID ORDER BY RR.RETICLE_ID) AS RN               
          FROM APS_SYNC_RMS_RECIPE_RETICLE.APS_SYNC_RMS_RECIPE_RETICLE RR                                            
          -- WHERE RR.PARTCODE='"+rcpPartCode 
          WHERE 1=1
     ),                                                                                                         
     RECIPE_RETICLE_NEW AS (                                                                                    
         SELECT R.TOOLID, R.RECIPE_ID, R.RETICLE_ID, R.MODIFY_TIME, R.MODIFY_USER, R.UPDATE_TIME,               
                R.CONVERT_TOOL_ID, R.RECIPE_C,                                                                  
                ROW_NUMBER() OVER(PARTITION BY R.CONVERT_TOOL_ID, R.RECIPE_C ORDER BY R.RETICLE_ID) AS RN       
         FROM RECIPE_RETICLE R                                                                                  
     )                                                                                                          
     SELECT TOOLID, RECIPE_ID, RETICLE_ID, MODIFY_TIME, MODIFY_USER, UPDATE_TIME, CONVERT_TOOL_ID, RECIPE_C     
     FROM RECIPE_RETICLE_NEW                                                                                    
     WHERE RN = 1
    """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_WIP_RECIPE_RETICLE",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_WIP_RECIPE_RETICLE")

    # 从Opehs Process Start的 Recipe , Job, 时间 insert到 temp table
    # 为了获取状态信息ProcessStart：RUN，OperationStartCancel为WAIT， 同时也列出ProcessStart的时间
    sql = """
     INSERT /*+ append */ INTO APS_TMP_ETL_WIP_OPER_PROCESS_START_HS
     (LOT_ID, OPE_NO, RECIPE_ID, CLAIM_TIME, CTRL_JOB, EQP_ID, OPE_CATEGORY,PRODSPEC_ID,MAINPD_ID)          
     SELECT LOT_ID, OPE_NO, PH_RECIPE_ID, CLAIM_TIME, CTRL_JOB, EQP_ID, OPE_CATEGORY,PRODSPEC_ID,MAINPD_ID  
       FROM (SELECT OH.LOT_ID,                                                                              
                    OH.OPE_NO,                                                                              
                    OH.PH_RECIPE_ID,                                                                        
                    -- TO_CHAR(OH.CLAIM_TIME, 'yyyy-mm-dd hh24:mi:ss') AS CLAIM_TIME,
                    STRFTIME(CAST(OH.CLAIM_TIME AS TIMESTAMP), '%Y-%m-%d %H:%M:%S') AS CLAIM_TIME,
                    OH.CTRL_JOB,                                                                            
                    OH.EQP_ID,                                                                              
                    OH.OPE_CATEGORY,                                                                        
                    OH.PRODSPEC_ID,                                                                         
                    OH.MAINPD_ID,                                                                           
                    ROW_NUMBER() OVER(PARTITION BY OH.LOT_ID ORDER BY OH.CLAIM_TIME DESC) AS RN             
               FROM APS_MID_FHOPEHS.APS_MID_FHOPEHS OH                                                                            
               INNER JOIN APS_TMP_ETL_WIP_V W ON OH.LOT_ID = W.LOT_ID                               
                                                      AND OH.OPE_NO = W.OPE_NO                              
                                                      AND OH.MAINPD_ID = W.MAINPD_ID                        
                                                      AND OH.PRODSPEC_ID = W.PRODSPEC_ID                                 
              WHERE OH.CTRL_JOB is not null                                                                       
                -- AND OH.PARTKEY >= SYSDATE - 3
                AND OH.CLAIM_TIME >= DATE_TRUNC('day', CURRENT_DATE) - INTERVAL '3 day'                                                             
                AND OH.OPE_CATEGORY IN ('ProcessStart')) A                                                  
     WHERE A.RN = 1 
    """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_WIP_OPER_PROCESS_START_HS",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_WIP_OPER_PROCESS_START_HS")

    # 从 V_FHOPEHS_RETICLE OperationStart的 Reticel insert到 temp table
    # 为了获取RUN状态的Reticle数据
    sql = """
     INSERT /*+ append */ INTO APS_TMP_ETL_WIP_OPEHS_RETICLE                                      
     (LOT_ID, MAINPD_ID, OPE_NO, RETICLE_ID, CLAIM_TIME, OPE_CATEGORY)  
     --modify by xiecheng for version up                          
     --SELECT A.LOT_ID, A.MAINPD_ID, A.OPE_NO, A.RETICLE_ID, A.CLAIM_TIME, A.OPE_CATEGORY           
     -- FROM (SELECT OHR.LOT_ID,
        --           OHR.MAINPD_ID,
        --           OHR.OPE_NO,
                   -- TO_CHAR(OHR.CLAIM_TIME, 'yyyy-mm-dd hh24:mi:ss') AS CLAIM_TIME,
                   -- STRFTIME(OHR.CLAIM_TIME, '%Y-%m-%d %H:%M:%S') AS CLAIM_TIME,    
          --         OHR.CLAIM_TIME AS CLAIM_TIME,
             --      OHR.RETICLE_ID,                                                                
             --      OHR.OPE_CATEGORY,                                                              
              --     ROW_NUMBER() OVER(PARTITION BY OHR.LOT_ID ORDER BY OHR.CLAIM_TIME DESC) AS RN  
            -- FROM APS_MID_FHOPEHS_RETICLE.APS_MID_FHOPEHS_RETICLE OHR                            
           --  WHERE 1 = 1                                                                          
             -- AND OHR.PARTKEY >=  SYSDATE - 5
           --  AND OHR.CLAIM_TIME >= DATE_TRUNC('day', CURRENT_DATE) - INTERVAL '5 day'                                                        
           --  AND OHR.OPE_CATEGORY = 'OperationStart'                                              
            -- ) A                                                                                  
     --WHERE A.RN = 1
     WITH GROUP_DATE AS (                                                                                                                         
                 SELECT OHR.LOT_ID,                                                                                                             
                        OHR.MAINPD_ID,                                                                                                                   
                        OHR.OPE_NO,                                                                                                                      
                        OHR.CLAIM_TIME AS CLAIM_TIME,                                                                              
                        OHR.OPE_CATEGORY,                                                                                                                
                        STRING_AGG(RETICLE_ID,';' ORDER BY RETICLE_ID) AS RETICLE_ID   
                 FROM APS_MID_FHOPEHS_RETICLE.APS_MID_FHOPEHS_RETICLE OHR                                                                               
                 WHERE 1 = 1                                                                                                                             
                 AND OHR.CLAIM_TIME >= DATE_TRUNC('day', CURRENT_DATE) - INTERVAL '5 day'                                                                                                         
                 AND OHR.OPE_CATEGORY = 'OperationStart'   
                 group by LOT_ID,OPE_NO,MAINPD_ID,CLAIM_TIME,OPE_CATEGORY                                                                                            
            ),                                                                                                                                           
            LASE_DATA AS (                                                                                                                               
                  SELECT LOT_ID,                                                                                                                         
                         MAINPD_ID,                                                                                                                      
                         OPE_NO,                                                                                                                         
                         CLAIM_TIME,                                                                                                                     
                         OPE_CATEGORY,                                                                                                                   
                         RETICLE_ID,                                                                                                                     
                         ROW_NUMBER() OVER(PARTITION BY LOT_ID ORDER BY CLAIM_TIME DESC) AS RN                                                           
                  FROM GROUP_DATE                                                                                                                        
            )                                                                                                                                            
            SELECT A.LOT_ID, A.MAINPD_ID, A.OPE_NO, A.RETICLE_ID, A.CLAIM_TIME, A.OPE_CATEGORY                                                           
            FROM LASE_DATA A                                                                                                                             
            WHERE RN = 1     
    """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_WIP_OPEHS_RETICLE",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_WIP_OPEHS_RETICLE")

    # V_LOT_PROCESS_MONITOR 数据insert 到 temp table
    # 获取critical_ratio字段信息
    sql = """
    INSERT /*+ append */ INTO APS_TMP_ETL_WIP_PROCESS_MONITOR
    (LOT_ID, CR)                                        
    SELECT A.LOT_ID, A.CR FROM APS_SYNC_LOT_PROCESS_MONITOR.APS_SYNC_LOT_PROCESS_MONITOR A  
    """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_WIP_PROCESS_MONITOR",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_WIP_PROCESS_MONITOR")

    # V_SHR_PRI 数据insert 到 temp table
    sql = """
     INSERT /*+ append */ INTO APS_TMP_ETL_WIP_SHR_PRI
     (LOT_ID, LOT_PURPOSE, PRI)                            
     SELECT A.LOT_ID, A.LOT_PURPOSE, A.PRI FROM APS_SYNC_SHR_PRI.APS_SYNC_SHR_PRI A  
     -- WHERE A.PARTCODE='"+shrPartCode+"'"
     WHERE 1=1
    """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_WIP_SHR_PRI",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_WIP_SHR_PRI")

    # V_SHL_LOT_FIRE_NUMBER 数据insert 到 temp table
    sql = """
    INSERT /*+ append */ INTO APS_TMP_ETL_WIP_LOT_FIRE                  
    (LINE, MODULE, LOT_ID, END_OPE_NO, SHL_FIRENUMBER, UPDATE_TIME)      
    SELECT LINE, MODULE, LOT_ID, END_OPE_NO, SHL_FIRENUMBER, UPDATE_TIME 
     FROM APS_SYNC_SHL_LOT_FIRE_NUMBER.APS_SYNC_SHL_LOT_FIRE_NUMBER A         
     -- WHERE A.PARTCODE='"+firePartCode
     WHERE 1=1
    """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_WIP_LOT_FIRE",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_WIP_LOT_FIRE")

    # V_LOT_PURPOSE 数据insert 到 temp table
    sql = """
     INSERT /*+ append */ INTO APS_TMP_ETL_WIP_LOT_PURPOSE 
     (LOT_ID, LOT_PURPOSE, PRODG1, ACCELARATE_FLAG)        
     SELECT LOT_ID, LOT_PURPOSE, PRODG1, ACCELARATE_FLAG   
      FROM APS_SYNC_LOT_PURPOSE.APS_SYNC_LOT_PURPOSE A  
      -- WHERE A.PARTCODE='"+purposePc+"'"
      WHERE 1=1
    """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_WIP_LOT_PURPOSE",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_WIP_LOT_PURPOSE")
    # V_CUT_LINE 数据insert 到 temp table
    sql = """
        INSERT /*+ append */ INTO APS_TMP_ETL_WIP_CUT_LINE                                                         
             (PRODG1, CUTLINE_OPE_NO, LOT_ID, WAFER_QTY, PRODUCT_STATUS)                                               
             SELECT L.PRODG1, L.CUTLINE_OPE_NO, REPLACE(L.LOT_ID, '.', '') AS LOT_ID, L.WAFER_QTY, L.PRODUCT_STATUS    
             FROM APS_SYNC_CUT_LINE.APS_SYNC_CUT_LINE L  
      """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_WIP_CUT_LINE",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_WIP_CUT_LINE")

    # // V_LOT_PURPOSE 数据insert 到 temp table
    sql = """
        INSERT /*+ append */ INTO APS_TMP_ETL_WIP_SELECT_LOT                                                                 
            (LOT_ID, FROM_OP, FROM_SEQ, TO_OP, TO_SEQ, RANK, PRODG_ID, EMPLOYEE)                                      
            SELECT L.LOTID, L.FROM_OP, L.FROM_SEQ, L.TO_OP, L.TO_SEQ, L.RANK, L.PRODG_ID, L.EMPLOYEE
            FROM APS_SYNC_SELECT_LOT.APS_SYNC_SELECT_LOT L
         """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_WIP_SELECT_LOT",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_WIP_SELECT_LOT")

    # V_LOT_LOCATION 数据insert 到 temp table
    sql = """
     INSERT /*+ append */ INTO APS_TMP_ETL_WIP_LOT_LOCATION                             
     (LOT_ID, FOUP_EQP_ID, FOUP_STATION_ID, FAB_PHASE)                                     
     SELECT A.LOT_ID, A.FOUP_EQP_ID, A.FOUP_STATION_ID, A.FAB_PHASE FROM APS_SYNC_LOT_LOCATION.APS_SYNC_LOT_LOCATION A  
     -- WHERE A.PARTCODE='"+lcPartCode+"'"
     WHERE 1=1
    """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_WIP_LOT_LOCATION",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_WIP_LOT_LOCATION")

    sql = """
    INSERT /*+ append */ INTO APS_TMP_ETL_WIP_LOCATION_INFO             
    (TOOL_ID, LOCATION_ID)                                                     
    SELECT TOOL_ID, LOCATION FROM APS_SYNC_MCS_SCHED_LOCATION_INFO.APS_SYNC_MCS_SCHED_LOCATION_INFO A                  
    -- WHERE A.PARTCODE='"+mclPartCode+"'"
    WHERE 1=1
    """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_WIP_LOCATION_INFO",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_WIP_LOCATION_INFO")

    # V_FLOW_DYB_RETURN 数据insert 到 temp table
    sql = """
     INSERT /*+ append */ INTO APS_TMP_ETL_WIP_DYB_RETURN_LOT                                                                                       
     (                                                                                                                                                   
        LOT_ID, PRODSPEC_ID, CURRENT_OPE_NO, OPENO, DYB_MAINPD_ID, RETURN_MAINPD_ID, RETURN_OPE_NO                                                       
       ,LOT_TYPE, CASSETE_ID, WAFER_QTY, PRIORITY_CLASS, LOT_PROC_STATE, LAST_OPE_COMP_TIME                                                              
       ,EQP_ID, OPE_NO_START_TIME, LAST_PROCESS_START_TIME, TECH_ID, CUSTOMER_ID, PARENT_LOT_ID, WHITE_FLAG, BATCH_ID                                    
       ,TRANS_STATE, PROCESS_START_TIME, WIP_CLAIM_TIME                                                                                                  
     )                                                                                                                                                   
     SELECT W.LOT_ID, W.PRODSPEC_ID, W.OPE_NO, A.OPENO, A.DYB_MAINPD_ID, A.MAINPD_ID, A.RETURN_OPE_NO                                                    
           ,W.LOT_TYPE, W.CASSETE_ID, W.WAFER_QTY, W.PRIORITY_CLASS, W.LOT_PROC_STATE, W.LAST_OPE_COMP_TIME                                              
           ,W.EQP_ID, W.OPE_NO_START_TIME, W.LAST_PROCESS_START_TIME, W.TECH_ID, W.CUSTOMER_ID, W.PARENT_LOT_ID, W.WHITE_FLAG, W.BATCH_ID
           ,W.TRANS_STATE, W.PROCESS_START_TIME,W.WIP_CLAIM_TIME                                                                                         
     FROM APS_TMP_ETL_WIP_V W                                                                                                                   
     LEFT JOIN APS_SYNC_FLOW_DYB_RETURN.APS_SYNC_FLOW_DYB_RETURN A ON REPLACE(A.LOT_ID, '.', '') = W.LOT_ID AND A.DYB_MAINPD_ID = W.MAINPD_ID
     -- AND A.PARTCODE='"+ dybPartCode + "'                                                                                                                 
     WHERE 1=1                                                                                                                                           
     AND W.MAINPD_ID LIKE 'DYB%' 
    """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_WIP_DYB_RETURN_LOT",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_WIP_DYB_RETURN_LOT")

    # V_PF_PO_N1 数据insert 到 temp table
    sql = """
     INSERT /*+ append */ INTO APS_TMP_ETL_WIP_PF_PO_N1                                                                
     (MAINPD_ID, POS_PDID, OPE_SEQ, OPE_NO, BATCH_NAME, BATCH_TARGET_FLAG)                                                                             
     SELECT N.MAINPD_ID, N.POS_PDID, N.OPE_SEQ, N.OPE_NO, N.BATCH_NAME,N.BATCH_TARGET_FLAG                              
     FROM APS_SYNC_PF_PO_N1.APS_SYNC_PF_PO_N1 N                                                                 
     INNER JOIN APS_TMP_ETL_WIP_DYB_RETURN_LOT L ON N.OPE_NO = L.CURRENT_OPE_NO AND N.MAINPD_ID = L.DYB_MAINPD_ID 
     -- WHERE N.PARTCODE='"+ poN1PartCode+"'";
     WHERE 1=1
    """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_WIP_PF_PO_N1",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_WIP_PF_PO_N1")

    # 生成Dyb Return Lot Info insert 到 temp table
    sql = """
    INSERT INTO APS_TMP_DYB_FLOW_LOT_V1
      (
           LOT_ID,PRODSPEC_ID,CURRENT_OPE_NO,DYB_MAINPD_ID,POS_PDID,OPE_NO,STEP_ID,RETURN_MAINPD_ID,
           RETURN_OPE_NO,LOT_TYPE,CASSETE_ID,WAFER_QTY,PRIORITY_CLASS,LOT_PROC_STATE,LAST_OPE_COMP_TIME,EQP_ID,OPE_NO_START_TIME,
           LAST_PROCESS_START_TIME,TECH_ID,CUSTOMER_ID,PARENT_LOT_ID,RECIPE,SUB_OPE_NO,EQP_G,EQP_CATEGORY,
           WHITE_FLAG,BATCH_ID,TRANS_STATE,PROCESS_START_TIME,WIP_CLAIM_TIME, MULTI_GROUP,MULTI_TARGET_FLAG
      )
         SELECT  
               A.LOT_ID, 
               A.PRODSPEC_ID, 
               A.CURRENT_OPE_NO, 
               A.DYB_MAINPD_ID, 
               B.POS_PDID, 
               B.OPE_NO,                                                              
               CASE WHEN (MAX(D.EQP_G) IS NULL OR MAX(D.EQP_G) = '')
                    THEN '.9999.9999' 
                    -- ELSE ('.'||TRIM(TO_CHAR(B.OPE_SEQ,'0000.0000')) ) END AS STEP_ID,
                    ELSE printf('.%09.4f',cast(B.OPE_SEQ as float)) END AS STEP_ID,                                 	
               A.RETURN_MAINPD_ID, 
               A.RETURN_OPE_NO, 
               A.LOT_TYPE, 
               A.CASSETE_ID, 
               A.WAFER_QTY, 
               A.PRIORITY_CLASS, 
               A.LOT_PROC_STATE, 
               A.LAST_OPE_COMP_TIME, 
               A.EQP_ID, 
               A.OPE_NO_START_TIME, 
               A.LAST_PROCESS_START_TIME, 
               A.TECH_ID, 
               A.CUSTOMER_ID, 
               A.PARENT_LOT_ID, 
               MAX(C.LCRECIPE_ID) AS RECIPE,
               -- SUBSTRING(SUBSTRING(A.CURRENT_OPE_NO, INSTR(A.CURRENT_OPE_NO,'.',-1)+1),2,1),
               SUBSTRING(SUBSTRING(A.CURRENT_OPE_NO, POSITION('.' IN A.CURRENT_OPE_NO)),3,1),
               -- NVL(MAX(D.EQP_G),'NoData') AS EQP_G, 
               COALESCE(MAX(D.EQP_G),'NoData') AS EQP_G,
               MAX(D.EQP_CATEGORY) AS EQP_CATEGORY, 
               WHITE_FLAG, BATCH_ID, MAX(A.TRANS_STATE) AS  TRANS_STATE,
               MAX(A.PROCESS_START_TIME) AS PROCESS_START_TIME,   
               MAX(A.WIP_CLAIM_TIME) AS WIP_CLAIM_TIME,
               MAX(B.BATCH_NAME) AS BATCH_NAME,
               MAX(B.BATCH_TARGET_FLAG) AS BATCH_TARGET_FLAG                                                        
         FROM APS_TMP_ETL_WIP_DYB_RETURN_LOT A                                                                                                 
         INNER JOIN APS_TMP_ETL_WIP_PF_PO_N1 B ON B.OPE_NO = A.CURRENT_OPE_NO AND B.MAINPD_ID = A.DYB_MAINPD_ID                                
         LEFT JOIN APS_SYNC_PD_RECIPE_EQP_DYB.APS_SYNC_PD_RECIPE_EQP_DYB C ON B.POS_PDID = C.PF_PD_ID AND B.OPE_NO = C.OPE_NO AND A.LOT_ID = C.LOT_ID 
         LEFT JOIN APS_SYNC_ETL_TOOL.APS_SYNC_ETL_TOOL D ON C.EQP_ID = D.EQP_ID  
         -- AND D.PARTCODE='"+ toolPartCode + "'                           
         GROUP BY A.LOT_ID, A.PRODSPEC_ID, A.CURRENT_OPE_NO, A.DYB_MAINPD_ID, B.POS_PDID, B.OPE_NO, B.OPE_SEQ                                        
              , A.RETURN_MAINPD_ID, A.RETURN_OPE_NO, A.LOT_TYPE, A.CASSETE_ID, A.WAFER_QTY, A.PRIORITY_CLASS, A.LOT_PROC_STATE
     , A.LAST_OPE_COMP_TIME, A.EQP_ID, A.OPE_NO_START_TIME, A.LAST_PROCESS_START_TIME, A.TECH_ID, A.CUSTOMER_ID, A.PARENT_LOT_ID
     , A.WHITE_FLAG, A.BATCH_ID  
    """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_DYB_FLOW_LOT_V1",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_DYB_FLOW_LOT_V1")

    sql = """
     INSERT INTO APS_TMP_ETL_WIP_DYB_LOT                                                                                                          
     (                                                                                                                                               
        LOT_ID, PRODSPEC_ID, CURRENT_OPE_NO, OPENO, DYB_MAINPD_ID, RETURN_MAINPD_ID, RETURN_OPE_NO                                                   
       ,LOT_TYPE, CASSETE_ID, WAFER_QTY, PRIORITY_CLASS, LOT_PROC_STATE, LAST_OPE_COMP_TIME, EQP_ID                                                  
       ,OPE_NO_START_TIME, LAST_PROCESS_START_TIME, TECH_ID, CUSTOMER_ID, PARENT_LOT_ID                                                              
       ,POS_PDID, STEP_ID, EQP_G, PRODG_ID, PRODG_TECH, RECIPE, TOOLG_TYPE, WHITE_FLAG, BATCH_ID, TRANS_STATE                                        
       ,PROCESS_START_TIME, WIP_CLAIM_TIME, MULTI_GROUP,MULTI_TARGET_FLAG                                                                                                           
     )                                                                                                                                               
    WITH PRODG AS                                                                                                                                    
     (                                                                                                                                               
       SELECT MAX(PRODG1) AS PRODG_ID, MAX(GROUP_TECH) AS PRODG_TECH, PRODSPEC_ID                                                                    
       FROM APS_SYNC_PRODUCT.APS_SYNC_PRODUCT                                                                                                
       -- WHERE PARTCODE='"+prodPartCode
       WHERE 1=1
       GROUP BY PRODSPEC_ID                                                                                                                          
     )                                                                                                                                               
     SELECT D.LOT_ID, D.PRODSPEC_ID, D.CURRENT_OPE_NO, D.OPE_NO, D.DYB_MAINPD_ID, D.RETURN_MAINPD_ID, D.RETURN_OPE_NO                                
           ,D.LOT_TYPE, D.CASSETE_ID, D.WAFER_QTY, D.PRIORITY_CLASS, D.LOT_PROC_STATE, D.LAST_OPE_COMP_TIME, D.EQP_ID                                
           ,D.OPE_NO_START_TIME, D.LAST_PROCESS_START_TIME, D.TECH_ID, D.CUSTOMER_ID, D.PARENT_LOT_ID                                                
           ,D.POS_PDID,  D.STEP_ID, D.EQP_G, P.PRODG_ID, P.PRODG_TECH, D.RECIPE                                                                      
           -- ,CASE WHEN (SUBSTRING(SUBSTRING(d.current_ope_no, INSTR(d.current_ope_no,'.',-1)+1),2,1)='Q' AND d.EQP_G IN ('PK_KrF','PH_ArF','PU_I-Line'))
           ,CASE WHEN (SUBSTRING(SUBSTRING(d.current_ope_no, POSITION('.' IN d.current_ope_no)),3,1)='Q' AND d.EQP_G IN ('PK_KrF','PH_ArF','PU_I-Line'))
                     THEN 'M'                                                                                                                        
                ELSE CASE WHEN D.EQP_CATEGORY IN ('Internal Buffer','Process','Wafer Bonding')  THEN 'P'                                             
                          WHEN D.EQP_CATEGORY = 'Measurement' THEN 'M'                                                                               
                          ELSE ''                                                                                                                    
                      END                                                                                                                            
                END AS TOOLG_TYPE, D.WHITE_FLAG, D.BATCH_ID, D.TRANS_STATE, D.PROCESS_START_TIME,D.WIP_CLAIM_TIME, D.MULTI_GROUP,D.MULTI_TARGET_FLAG
     FROM APS_TMP_DYB_FLOW_LOT_V1 D                                                                                                             
     LEFT JOIN PRODG P ON D.PRODSPEC_ID = P.PRODSPEC_ID  
    """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_WIP_DYB_LOT",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_WIP_DYB_LOT")

    # V_UMT_CONTROL_LOT insert to temp table
    sql = """
     INSERT /*+ append */ INTO APS_TMP_ETL_WIP_UMT_CONTROL_LOT
     (	    
        TECH,                                                             
        PRODG1,                                                           
        PRODUCT_ID,                                                       
        OPE_NO,                                                           
        MODULE                                                            
     )                                                                        
      SELECT CASE WHEN LENGTH(T.PRODG1) > 3 THEN 'ALL' ELSE                    
            -- DECODE(T.PRODG1,'*','ALL',T.PRODG1) END AS TECH,
            (CASE WHEN T.PRODG1 = '*' THEN 'ALL' ELSE T.PRODG1 END) END AS TECH,                
        CASE WHEN LENGTH(T.PRODG1) > 3 THEN T.PRODG1 ELSE                 
            'ALL' END AS PRODG1,                                          
        -- DECODE(T.PRODSPEC_ID,'*','ALL',T.PRODSPEC_ID) AS PRODUCT_ID,
       (CASE WHEN T.PRODSPEC_ID = '*' THEN 'ALL' ELSE T.PRODSPEC_ID END) AS PRODUCT_ID,      
        T.OPE_NO,                                                         
        T.MODULE                                                         
     FROM APS_SYNC_RTD_MOVE_TARGET.APS_SYNC_RTD_MOVE_TARGET T  
     WHERE 1=1
     -- AND T.PARTCODE='"+ rtdPartCode
     AND T.MAX_MOVE_FLAG='Y'                                        
     AND T.MOVE_TARGET='0'                                                    
     -- 防止user设置了卡控对应EQPID不生效的问题，在ETL_DEMAND进行卡控
     AND T.EQP_ID='*'                                                         
     AND (
            ( 
                -- TO_CHAR(SYSDATE,'HH24:MI:SS') < '07:30:00'
                STRPTIME(STRFTIME(CURRENT_timestamp,'%H:%M:%S'), '%H:%M:%S') < STRPTIME('07:30:00', '%H:%M:%S')
                -- AND SYSDATE <= TO_DATE(CONCAT(TO_CHAR(TO_DATE(T.END_DATE,'YYYY-MM-DD'),'YYYY-MM-DD'),' 07:30:00'),'YYYY-MM-DD HH24:MI:SS')
                AND STRPTIME(STRFTIME(CURRENT_timestamp,'%Y-%m-%d %H:%M:%S') , '%Y-%m-%d %H:%M:%S') <= STRPTIME(CONCAT(T.END_DATE,' 07:30:00'),'%Y-%m-%d %H:%M:%S')    
            )                                                                                                                            
            -- OR  TO_CHAR(SYSDATE,'HH24:MI:SS') >= '07:30:00'
            OR STRPTIME(STRFTIME(CURRENT_timestamp,'%H:%M:%S'), '%H:%M:%S') >= STRPTIME('07:30:00', '%H:%M:%S') 
            -- AND SYSDATE <= TO_DATE(CONCAT(TO_CHAR(TO_DATE(T.END_DATE,'YYYY-MM-DD')+1,'YYYY-MM-DD'),' 07:30:00'),'YYYY-MM-DD HH24:MI:SS')
            AND STRPTIME(STRFTIME(CURRENT_timestamp,'%Y-%m-%d %H:%M:%S'), '%Y-%m-%d %H:%M:%S') <= STRPTIME(CONCAT(STRFTIME(DATE_TRUNC('day', CAST(T.END_DATE AS DATE)) + INTERVAL '1 day', '%Y-%m-%d'),' 07:30:00'),'%Y-%m-%d %H:%M:%S') 
            )                    
    """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_WIP_UMT_CONTROL_LOT",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_WIP_UMT_CONTROL_LOT")

    # Normal / Rework / Sub / DYB Flow 的 Lot insert 到 temp table
    # Dyb Flow的 Return Flow & Oper 也一并填入
    # 拆分比较长SQL,先将LAST Flow 保存
    sql = """
    INSERT INTO APS_TMP_ETL_WIP_LASTFLOW_V1
        (PROD_ID,PLAN_ID,PLAN_NO,OPE_NO,STEP_ID,RECIPE,TOOLG_ID,PRODG_ID,PRODG_TECH,STEP_TYPE,TOOLG_TYPE,MULTI_GROUP,MULTI_TARGET_FLAG)
       SELECT 
           -- NVL(F.PROD_ID, V.PRODSPEC_ID) AS PROD_ID,
           COALESCE(F.PROD_ID, V.PRODSPEC_ID) AS PROD_ID,                                       
           -- NVL(F.PLAN_ID,V.MAINPD_ID) AS PLAN_ID,
           COALESCE(F.PLAN_ID,V.MAINPD_ID) AS PLAN_ID,
           -- NVL(F.PLAN_NO,1) AS PLAN_NO,
           COALESCE(F.PLAN_NO,1) AS PLAN_NO,
           -- NVL(F.OPE_NO,V.OPE_NO) AS OPE_NO,
           COALESCE(F.OPE_NO,V.OPE_NO) AS OPE_NO,
           -- NVL(F.STEP_ID,'.9999.9999') AS STEP_ID, F.RECIPE,
           COALESCE(F.STEP_ID,'.9999.9999') AS STEP_ID, F.RECIPE,
           -- NVL(F.TOOLG_ID,'NoData') AS TOOLG_ID, F.PRODG_ID, F.PRODG_TECH,
           COALESCE(F.TOOLG_ID,'NoData') AS TOOLG_ID, F.PRODG_ID, F.PRODG_TECH,
           CASE WHEN SUBSTRING(V.MAINPD_ID,1,1) = 'B' THEN 'I'                                   
             ELSE (CASE WHEN SUBSTRING(V.MAINPD_ID,1,1) = 'Y'                                    
               THEN 'R' ELSE 'N' END) END AS STEP_TYPE,                                       
           F.TOOLG_TYPE, F.MULTI_GROUP, F.MULTI_TARGET_FLAG                                   
      FROM APS_TMP_ETL_WIP_V V                                                                
      LEFT JOIN APS_TMP_ETL_WIP_LAST_FLOW F ON                                                    
      V.PRODSPEC_ID = F.PROD_ID                                                               
      AND V.MAINPD_ID = F.PLAN_ID                                                             
      AND V.OPE_NO = F.OPE_NO                                                                 
      WHERE V.MAINPD_ID NOT LIKE  'DYB%'  
    """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_WIP_LASTFLOW_V1",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_WIP_LASTFLOW_V1")

    # 保存NORMAL FLOW WIP 资料
    sql = """
    INSERT INTO APS_TMP_ETL_WIP_V5 
    (
        LOT_ID,PRODG_ID,PRODG_TECH,PRODSPEC_ID,MAINPD_ID,TARGET_PLAN_ID,OPE_NO,STEP_ID,TARGET_OPE_NO,
        TARGET_STEP_ID,TARGET_TOOLG_ID,LOT_TYPE,CASSETE_ID,WAFER_QTY,PRIORITY_CLASS,LOT_PROC_STATE,ARRIVAL,ST_LAYER,ST_STAGE,EQP_ID,
        TRACKIN_TIME,PROCESS_START,TECH_ID,CUSTOMER_ID,PARENT_LOT_ID,CR,RECIPE,WHITE_FLAG,BATCH_ID,TRANS_STATE,WIP_CLAIM_TIME,MULTI_GROUP,MULTI_TARGET_FLAG
    )
       SELECT W.LOT_ID,                                                                                                           
           F.PRODG_ID,                                                                                                            
           F.PRODG_TECH,                                                                                                          
           W.PRODSPEC_ID,                                                                                                         
           W.MAINPD_ID,                                                                                                           
           F.PLAN_ID AS TARGET_PLAN_ID,                                                                                           
           W.OPE_NO,                                                                                                              
           F.STEP_ID,                                                                                                             
           W.OPE_NO AS TARGET_OPE_NO,                                                                                             
           F.STEP_ID AS TARGET_STEP_ID,                                                                                           
           F.TOOLG_ID AS TARGET_TOOLG_ID,                                                                                         
           W.LOT_TYPE,                                                                                                            
           W.CASSETE_ID,                                                                                                          
           W.WAFER_QTY,                                                                                                           
           W.PRIORITY_CLASS,                                                                                                      
           W.LOT_PROC_STATE,                                                                                                      
           --TO_CHAR(W.LAST_OPE_COMP_TIME,'YYYY-MM-DD HH24:MI:SS') AS ARRIVAL,
           -- STRFTIME(W.LAST_OPE_COMP_TIME, '%Y-%m-%d %H:%M:%S') AS ARRIVAL, 
           W.LAST_OPE_COMP_TIME AS ARRIVAL, 
           -- SUBSTRING(W.OPE_NO, 1, INSTR(W.OPE_NO, '.') -1) ST_LAYER,
           SUBSTRING(W.OPE_NO, 1, POSITION('.' IN W.OPE_NO) -1) ST_LAYER,
           SUBSTRING(W.OPE_NO,                                                                                                       
                  -- INSTR(W.OPE_NO, '.') + 1,
                  POSITION('.' IN W.OPE_NO) + 1,
                  -- LENGTH(W.OPE_NO) - INSTR(W.OPE_NO, '.')) AS ST_STAGE,
                  LENGTH(W.OPE_NO) - POSITION('.' IN W.OPE_NO)) AS ST_STAGE,
           W.EQP_ID,                                                                                                              
           -- TO_CHAR(W.OPE_NO_START_TIME,'YYYY-MM-DD HH24:MI:SS') AS TRACKIN_TIME,
           -- STRFTIME(W.OPE_NO_START_TIME, '%Y-%m-%d %H:%M:%S') AS TRACKIN_TIME,
           W.OPE_NO_START_TIME AS TRACKIN_TIME,                                                 
           -- TO_CHAR(W.PROCESS_START_TIME,'YYYY-MM-DD HH24:MI:SS') PROCESS_START,
           -- STRFTIME(W.PROCESS_START_TIME, '%Y-%m-%d %H:%M:%S') AS PROCESS_START,   
           W.PROCESS_START_TIME AS PROCESS_START,                                                   
           W.TECH_ID,                                                                                                             
           W.CUSTOMER_ID,                                                                                                         
           W.PARENT_LOT_ID,                                                                                                       
           LM.CR,                                                                                                                 
           F.RECIPE, W.WHITE_FLAG, W.BATCH_ID, W.TRANS_STATE,                                                                     
           -- TO_CHAR(W.WIP_CLAIM_TIME,'YYYY-MM-DD HH24:MI:SS') AS WIP_CLAIM_TIME,    
           -- STRFTIME(W.WIP_CLAIM_TIME, '%Y-%m-%d %H:%M:%S') AS WIP_CLAIM_TIME,  
           W.WIP_CLAIM_TIME AS WIP_CLAIM_TIME,                                                
           F.MULTI_GROUP, F.MULTI_TARGET_FLAG                                                                                     
      FROM APS_TMP_ETL_WIP_V W                                                                                           
      INNER JOIN APS_TMP_ETL_WIP_LASTFLOW_V1 F ON W.PRODSPEC_ID = F.PROD_ID                                                   
                               AND W.MAINPD_ID = F.PLAN_ID                                                                        
                               AND W.OPE_NO = F.OPE_NO                                                                            
                               AND F.STEP_TYPE = 'N'                                                                              
      LEFT JOIN APS_TMP_ETL_WIP_PROCESS_MONITOR LM ON W.LOT_ID = LM.LOT_ID
    """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_WIP_V5.NORMAL",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_WIP_V5")

    # 保存非正常Flow WIP资料
    sql = """
       INSERT INTO APS_TMP_ETL_WIP_V5 
    (
        LOT_ID,PRODG_ID,PRODG_TECH,PRODSPEC_ID,MAINPD_ID,TARGET_PLAN_ID,OPE_NO,STEP_ID,TARGET_OPE_NO,
        TARGET_STEP_ID,TARGET_TOOLG_ID,LOT_TYPE,CASSETE_ID,WAFER_QTY,PRIORITY_CLASS,LOT_PROC_STATE,ARRIVAL,ST_LAYER,ST_STAGE,EQP_ID,
        TRACKIN_TIME,PROCESS_START,TECH_ID,CUSTOMER_ID,PARENT_LOT_ID,CR,RECIPE,WHITE_FLAG,BATCH_ID,TRANS_STATE,WIP_CLAIM_TIME,MULTI_GROUP,MULTI_TARGET_FLAG
    )
     SELECT W.LOT_ID,                                                                                                            
            RSF.PRODG_ID,                                                                                                        
            RSF.PRODG_TECH,                                                                                                      
            W.PRODSPEC_ID,                                                                                                       
            W.MAINPD_ID,                                                                                                         
            RSF.PLAN_ID AS TARGET_PLAN_ID,                                                                                       
            W.OPE_NO,                                                                                                            
            RSF.STEP_ID,                                                                                                         
            W.OPE_NO AS TARGET_OPE_NO,                                                                                           
            RSF.STEP_ID AS TARGET_STEP_ID,                                                                                       
            RSF.TOOLG_ID AS TARGET_TOOLG_ID,                                                                                     
            W.LOT_TYPE,                                                                                                          
            W.CASSETE_ID,                                                                                                        
            W.WAFER_QTY,                                                                                                         
            W.PRIORITY_CLASS,                                                                                                    
            W.LOT_PROC_STATE,                                                                                                    
            -- TO_CHAR(W.LAST_OPE_COMP_TIME,'YYYY-MM-DD HH24:MI:SS') AS ARRIVAL,   
            -- STRFTIME(W.LAST_OPE_COMP_TIME, '%Y-%m-%d %H:%M:%S') AS ARRIVAL,
            W.LAST_OPE_COMP_TIME  AS ARRIVAL,                                                
            -- SUBSTRING(W.OPE_NO, 1, INSTR(W.OPE_NO, '.') -1) ST_LAYER,
            SUBSTRING(W.OPE_NO, 1, POSITION('.' IN W.OPE_NO) -1) ST_LAYER,
            SUBSTRING(W.OPE_NO,                                                                                                     
                 -- INSTR(W.OPE_NO, '.') + 1,
                 POSITION('.' IN W.OPE_NO) + 1,
                 -- LENGTH(W.OPE_NO) - INSTR(W.OPE_NO, '.')) AS ST_STAGE,
                 LENGTH(W.OPE_NO) - POSITION('.' IN W.OPE_NO)) AS ST_STAGE,
            W.EQP_ID,                                                                                                            
            -- TO_CHAR(W.OPE_NO_START_TIME,'YYYY-MM-DD HH24:MI:SS') AS TRACKIN_TIME,
            -- STRFTIME(W.OPE_NO_START_TIME, '%Y-%m-%d %H:%M:%S') AS TRACKIN_TIME,
            W.OPE_NO_START_TIME AS TRACKIN_TIME,                                                  
            -- TO_CHAR(W.PROCESS_START_TIME,'YYYY-MM-DD HH24:MI:SS') PROCESS_START,
            -- STRFTIME(W.PROCESS_START_TIME, '%Y-%m-%d %H:%M:%S') AS PROCESS_START,
            W.PROCESS_START_TIME AS PROCESS_START,                                                
            W.TECH_ID,                                                                                                           
            W.CUSTOMER_ID,                                                                                                       
            W.PARENT_LOT_ID,                                                                                                     
            LM.CR,                                                                                                               
            RSF.RECIPE, W.WHITE_FLAG, W.BATCH_ID, W.TRANS_STATE,                                                                 
            -- TO_CHAR(W.WIP_CLAIM_TIME,'YYYY-MM-DD HH24:MI:SS') AS WIP_CLAIM_TIME,
            -- STRFTIME(W.WIP_CLAIM_TIME, '%Y-%m-%d %H:%M:%S') AS WIP_CLAIM_TIME,
            W.WIP_CLAIM_TIME AS WIP_CLAIM_TIME,                                                 
            RSF.MULTI_GROUP, RSF.MULTI_TARGET_FLAG                                                                               
     FROM APS_TMP_ETL_WIP_V W                                                                                           
     INNER JOIN APS_TMP_ETL_WIP_LASTFLOW_V1 RSF ON W.PRODSPEC_ID = RSF.PROD_ID                                                
                                    AND W.MAINPD_ID = RSF.PLAN_ID                                                                
                                    AND W.OPE_NO = RSF.OPE_NO AND RSF.STEP_TYPE <> 'N'                                           
     LEFT JOIN APS_TMP_ETL_WIP_PROCESS_MONITOR LM ON W.LOT_ID = LM.LOT_ID  
    """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_WIP_V5.UNNORMAL",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_WIP_V5")

    # 保存DYB Flow Wip资料
    sql = """
      INSERT INTO APS_TMP_ETL_WIP_V5 
    (
        LOT_ID,PRODG_ID,PRODG_TECH,PRODSPEC_ID,MAINPD_ID,TARGET_PLAN_ID,OPE_NO,STEP_ID,TARGET_OPE_NO,
        TARGET_STEP_ID,TARGET_TOOLG_ID,LOT_TYPE,CASSETE_ID,WAFER_QTY,PRIORITY_CLASS,LOT_PROC_STATE,ARRIVAL,ST_LAYER,ST_STAGE,EQP_ID,
        TRACKIN_TIME,PROCESS_START,TECH_ID,CUSTOMER_ID,PARENT_LOT_ID,CR,RECIPE,WHITE_FLAG,BATCH_ID,TRANS_STATE,WIP_CLAIM_TIME,MULTI_GROUP,MULTI_TARGET_FLAG
    )
      SELECT W.LOT_ID,                                                                                                            
             W.PRODG_ID,                                                                                                          
             W.PRODG_TECH,                                                                                                        
             W.PRODSPEC_ID,                                                                                                       
             W.DYB_MAINPD_ID,                                                                                                     
             W.DYB_MAINPD_ID AS TARGET_PLAN_ID,                                                                                   
             W.CURRENT_OPE_NO,                                                                                                    
             W.STEP_ID,                                                                                                           
             W.CURRENT_OPE_NO AS TARGET_OPE_NO,                                                                                   
             W.STEP_ID AS TARGET_STEP_ID,                                                                                         
             W.EQP_G AS TARGET_TOOLG_ID,                                                                                          
             W.LOT_TYPE,                                                                                                          
             W.CASSETE_ID,                                                                                                        
             W.WAFER_QTY,                                                                                                         
             W.PRIORITY_CLASS,                                                                                                    
             W.LOT_PROC_STATE,                                                                                                    
             -- TO_CHAR(W.LAST_OPE_COMP_TIME,'YYYY-MM-DD HH24:MI:SS') AS ARRIVAL,    
             W.LAST_OPE_COMP_TIME AS ARRIVAL,                                                   
             -- SUBSTRING(W.CURRENT_OPE_NO, 1, INSTR(W.CURRENT_OPE_NO, '.') -1) ST_LAYER,
             SUBSTRING(W.CURRENT_OPE_NO, 1, POSITION('.' IN W.CURRENT_OPE_NO) -1) ST_LAYER,                                               
             SUBSTRING(W.CURRENT_OPE_NO,                                                                                             
                  -- INSTR(W.CURRENT_OPE_NO, '.') + 1,
                  POSITION('.' IN W.CURRENT_OPE_NO) + 1,                                                                               
                  -- LENGTH(W.CURRENT_OPE_NO) - INSTR(W.CURRENT_OPE_NO, '.')) AS ST_STAGE,
                  LENGTH(W.CURRENT_OPE_NO) - POSITION('.' IN W.CURRENT_OPE_NO)) AS ST_STAGE,                                           
             W.EQP_ID,                                                                                                            
             -- TO_CHAR(W.OPE_NO_START_TIME,'YYYY-MM-DD HH24:MI:SS') AS TRACKIN_TIME,
             W.OPE_NO_START_TIME AS TRACKIN_TIME,                                               
             -- TO_CHAR(W.PROCESS_START_TIME,'YYYY-MM-DD HH24:MI:SS') PROCESS_START,
             W.PROCESS_START_TIME AS PROCESS_START,                                                
             W.TECH_ID,                                                                                                           
             W.CUSTOMER_ID,                                                                                                       
             W.PARENT_LOT_ID,                                                                                                     
             LM.CR,                                                                                                               
             W.RECIPE, W.WHITE_FLAG, W.BATCH_ID, W.TRANS_STATE,                                                                   
             -- TO_CHAR(W.WIP_CLAIM_TIME,'YYYY-MM-DD HH24:MI:SS') AS WIP_CLAIM_TIME,
             W.WIP_CLAIM_TIME AS WIP_CLAIM_TIME,                                                 
             W.MULTI_GROUP, W.MULTI_TARGET_FLAG                                                                                     
      FROM APS_TMP_ETL_WIP_DYB_LOT W                                                                                        
      LEFT JOIN APS_TMP_ETL_WIP_PROCESS_MONITOR LM ON W.LOT_ID = LM.LOT_ID
    """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_WIP_V5.DYB",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_WIP_V5")

    # 保存指定EQP_G（机群）且Nodata Wip
    sql = """
      INSERT INTO APS_TMP_ETL_WIP_V5 
    (
        LOT_ID,PRODG_ID,PRODG_TECH,PRODSPEC_ID,MAINPD_ID,TARGET_PLAN_ID,OPE_NO,STEP_ID,TARGET_OPE_NO,
        TARGET_STEP_ID,TARGET_TOOLG_ID,LOT_TYPE,CASSETE_ID,WAFER_QTY,PRIORITY_CLASS,LOT_PROC_STATE,ARRIVAL,ST_LAYER,ST_STAGE,EQP_ID,
        TRACKIN_TIME,PROCESS_START,TECH_ID,CUSTOMER_ID,PARENT_LOT_ID,CR,RECIPE,WHITE_FLAG,BATCH_ID,TRANS_STATE,WIP_CLAIM_TIME,MULTI_GROUP,MULTI_TARGET_FLAG
    )
      SELECT W.LOT_ID,                                                                                                        
             LF.PRODG_ID,                                                                                                     
             LF.PRODG_TECH,                                                                                                   
             W.PRODSPEC_ID,                                                                                                   
             W.DYB_MAINPD_ID,                                                                                                 
             LF.PLAN_ID AS TARGET_PLAN_ID,                                                                                    
             W.CURRENT_OPE_NO,                                                                                                
             W.STEP_ID,                                                                                                       
             LF.OPE_NO AS TARGET_OPE_NO,                                                                                      
             LF.STEP_ID AS TARGET_STEP_ID,                                                                                    
             LF.TOOLG_ID AS TARGET_TOOLG_ID,                                                                                  
             W.LOT_TYPE,                                                                                                      
             W.CASSETE_ID,                                                                                                    
             W.WAFER_QTY,                                                                                                     
             W.PRIORITY_CLASS,                                                                                                
             W.LOT_PROC_STATE,                                                                                                
             -- TO_CHAR(W.LAST_OPE_COMP_TIME,'YYYY-MM-DD HH24:MI:SS') AS ARRIVAL, 
             W.LAST_OPE_COMP_TIME AS ARRIVAL,                                               
             -- SUBSTRING(W.CURRENT_OPE_NO, 1, INSTR(W.CURRENT_OPE_NO, '.') -1) ST_LAYER,
             SUBSTRING(W.CURRENT_OPE_NO, 1, POSITION('.' IN W.CURRENT_OPE_NO) -1) ST_LAYER,                                           
             SUBSTRING(W.CURRENT_OPE_NO,                                                                                         
                -- INSTR(W.CURRENT_OPE_NO, '.') + 1,
                POSITION('.' IN W.CURRENT_OPE_NO) + 1,                                                                     
                -- LENGTH(W.CURRENT_OPE_NO) - INSTR(W.CURRENT_OPE_NO, '.')) AS ST_STAGE,
                LENGTH(W.CURRENT_OPE_NO) - POSITION('.' IN W.CURRENT_OPE_NO)) AS ST_STAGE,                                 
             W.EQP_ID,                                                                                                        
             -- TO_CHAR(W.OPE_NO_START_TIME,'YYYY-MM-DD HH24:MI:SS') AS TRACKIN_TIME,
             W.OPE_NO_START_TIME AS TRACKIN_TIME,                                           
             -- TO_CHAR(W.PROCESS_START_TIME,'YYYY-MM-DD HH24:MI:SS') PROCESS_START,  
             W.PROCESS_START_TIME AS PROCESS_START,                                          
             W.TECH_ID,                                                                                                       
             W.CUSTOMER_ID,                                                                                                   
             W.PARENT_LOT_ID,                                                                                                 
             LM.CR,                                                                                                           
             LF.RECIPE, W.WHITE_FLAG, W.BATCH_ID, W.TRANS_STATE,                                                              
             -- TO_CHAR(W.WIP_CLAIM_TIME,'YYYY-MM-DD HH24:MI:SS') AS WIP_CLAIM_TIME, 
             W.WIP_CLAIM_TIME AS WIP_CLAIM_TIME,                                            
             W.MULTI_GROUP, W.MULTI_TARGET_FLAG                                                                               
      FROM APS_TMP_ETL_WIP_DYB_LOT W                                                                                        
      INNER JOIN APS_TMP_ETL_WIP_LASTFLOW_V1 LF ON LF.PROD_ID = W.PRODSPEC_ID                                               
                 AND LF.PLAN_ID = W.RETURN_MAINPD_ID                                                                  
                 AND LF.OPE_NO = W.RETURN_OPE_NO                                                                      
                 AND LF.TOOLG_TYPE = 'P'                                                                              
      LEFT JOIN APS_TMP_ETL_WIP_PROCESS_MONITOR LM ON W.LOT_ID = LM.LOT_ID                                                  
        WHERE W.EQP_G <> 'NoData' 
    """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_WIP_V5.EQP_TO_LOT",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_WIP_V5")

    # 单独剥离CTRL_JOB信息
    sql = """
     -- INSERT INTO APS_TMP_ETL_WIP_CTL_JOB(LOT_ID,OPE_NO,MAINPD_ID,PRODSPEC_ID,CTRL_JOB)                                     
     -- SELECT LOT_ID, OPE_NO, MAINPD_ID , PRODSPEC_ID, 
     --       MAX(CTRL_JOB) KEEP(DENSE_RANK FIRST ORDER BY CLAIM_TIME DESC) AS CTRL_JOB                                
     -- FROM (                                                                                                                       
     --        SELECT PS.LOT_ID, PS.OPE_NO, PS.RECIPE_ID, PS.CLAIM_TIME, PS.CTRL_JOB, PS.OPE_CATEGORY, PS.EQP_ID,                    
     --               PS.MAINPD_ID, PS.PRODSPEC_ID                                                                                   
     --        FROM APS_TMP_ETL_WIP_OPER_PROCESS_START_HS PS                                                                     
     --        UNION                                                                                                                 
     --        SELECT RH.LOT_ID, RH.OPE_NO, RH.RECIPE_ID, RH.CLAIM_TIME, RH.CTRL_JOB, RH.OPE_CATEGORY, RH.EQP_ID,                    
     --               RH.MAINPD_ID, RH.PRODSPEC_ID                                                                                   
     --        FROM APS_TMP_ETL_WIP_OPER_RESERVE_HS RH                                                                      
     --        UNION                                                                                                                 
     --        SELECT OS.LOT_ID, OS.OPE_NO, OS.RECIPE_ID, OS.CLAIM_TIME, OS.CTRL_JOB, OS.OPE_CATEGORY, OS.EQP_ID,                    
     --               OS.MAINPD_ID, OS.PRODSPEC_ID                                                                                   
     --        FROM APS_TMP_ETL_WIP_OPER_START_HS OS                                                                         
     -- ) B                                                                                                                           
     -- GROUP BY LOT_ID, OPE_NO, MAINPD_ID, PRODSPEC_ID

    INSERT INTO APS_TMP_ETL_WIP_CTL_JOB(LOT_ID,OPE_NO,MAINPD_ID,PRODSPEC_ID,CTRL_JOB)  
    SELECT LOT_ID, OPE_NO, MAINPD_ID , PRODSPEC_ID, MAX(CTRL_JOB) AS CTRL_JOB                                
    FROM (
        SELECT LOT_ID, OPE_NO, MAINPD_ID, PRODSPEC_ID, CTRL_JOB, 
        RANK() OVER (PARTITION BY LOT_ID, OPE_NO, MAINPD_ID, PRODSPEC_ID ORDER BY CLAIM_TIME DESC) AS rnk
        FROM (
            SELECT PS.LOT_ID, PS.OPE_NO, PS.RECIPE_ID, PS.CLAIM_TIME, PS.CTRL_JOB, PS.OPE_CATEGORY, PS.EQP_ID,                    
                   PS.MAINPD_ID, PS.PRODSPEC_ID                                                                                   
            FROM APS_TMP_ETL_WIP_OPER_PROCESS_START_HS PS                                                                     
            UNION                                                                                                                 
            SELECT RH.LOT_ID, RH.OPE_NO, RH.RECIPE_ID, RH.CLAIM_TIME, RH.CTRL_JOB, RH.OPE_CATEGORY, RH.EQP_ID,                    
                   RH.MAINPD_ID, RH.PRODSPEC_ID                                                                                   
            FROM APS_TMP_ETL_WIP_OPER_RESERVE_HS RH                                                                      
            UNION                                                                                                                 
            SELECT OS.LOT_ID, OS.OPE_NO, OS.RECIPE_ID, OS.CLAIM_TIME, OS.CTRL_JOB, OS.OPE_CATEGORY, OS.EQP_ID,                    
                   OS.MAINPD_ID, OS.PRODSPEC_ID                                                                                   
            FROM APS_TMP_ETL_WIP_OPER_START_HS OS 
        )
    ) WHERE rnk = 1                                                                                                                       
    GROUP BY LOT_ID, OPE_NO, MAINPD_ID, PRODSPEC_ID
    """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_WIP_CTL_JOB",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_WIP_CTL_JOB")

    sql = """
     INSERT /*+ append */ INTO APS_TMP_ETL_WIP                                                                                    
     (                                                                                                                                
       LOT_ID, PRODG_ID, PRODG_TECH, PRODSPEC_ID, PLAN_ID, TARGET_PLAN_ID, OPE_NO,OPE_SEQ,                                            
       TARGET_OPE_NO, TARGET_OPE_SEQ, TARGET_TOOLG_ID, LOT_TYPE, FOUP_ID, WAFER_QTY, PRIORITY,                                        
       LOT_STATUS, ARRIVAL, LAYER, STAGE, EQP_ID, TRACKIN_TIME, PROCESS_START_TIME, TECH_ID,CUSTOMER_ID, PARENT_LOT_ID,               
       CRITICAL_RATIO, FLOW_RECIPE, SHR_FLAG, RECIPE_ID,RETICLE_ID, LOCATION_ID, JOB_PREPARE, FAB_PHASE, WHITE_FLAG,                  
       BATCH_ID,FROMBATCH_TIME,FROMBATCH_TOOL, TRANS_STATE, FOUP_STATION_ID, MULTI_GROUP, MULTI_TARGET_FLAG                           
     )                                                                                                                                             
        SELECT DISTINCT W.LOT_ID,                                                                                                     
               W.PRODG_ID,                                                                                                            
               W.PRODG_TECH,                                                                                                          
               W.PRODSPEC_ID,                                                                                                         
               W.MAINPD_ID,                                                                                                           
               W.TARGET_PLAN_ID,                                                                                                      
               W.OPE_NO,                                                                                                              
               W.STEP_ID,                                                                                                             
               W.TARGET_OPE_NO,                                                                                                       
               W.TARGET_STEP_ID,                                                                                                      
               W.TARGET_TOOLG_ID,                                                                                                     
               W.LOT_TYPE,                                                                                                            
               W.CASSETE_ID,                                                                                                          
               W.WAFER_QTY,                                                                                                           
               W.PRIORITY_CLASS,                                                                                                      
               -- DECODE(W.LOT_PROC_STATE,'Processing','RUN','Waiting','WAIT',W.LOT_PROC_STATE) AS LOT_STATUS,  
               CASE WHEN W.LOT_PROC_STATE = 'Processing' THEN 'RUN'
                    WHEN W.LOT_PROC_STATE = 'Waiting' THEN 'WAIT'
                    ELSE W.LOT_PROC_STATE END AS LOT_STATUS ,                         
               -- 如果为1901 则取WIP的CLAIM_TIME来防呆
               CASE WHEN W.ARRIVAL = '1901-01-01 00:00:00' THEN W.WIP_CLAIM_TIME 
               --modify by xiecheng for version up                                                     
               -- ELSE W.ARRIVAL END ARRIVAL,   
               ELSE COALESCE(W.ARRIVAL,W.WIP_CLAIM_TIME) END ARRIVAL,                                                                                         
               W.ST_LAYER,                                                                                                            
               W.ST_STAGE,                                                                                                                        
               CASE WHEN W.LOT_PROC_STATE='Processing' THEN W.EQP_ID                                                                  
                    WHEN LOT_PROC_STATE='JOBPREPARED' THEN RH.EQP_ID                                                                  
                END AS EQP_ID,                                                                                                             
               -- CASE WHEN W.LOT_PROC_STATE='Processing' THEN NVL(NVL(W.TRACKIN_TIME,OS.CLAIM_TIME),W.WIP_CLAIM_TIME) END AS TRACK_IN,
               CASE WHEN W.LOT_PROC_STATE='Processing' THEN COALESCE(COALESCE(W.TRACKIN_TIME,OS.CLAIM_TIME),W.WIP_CLAIM_TIME) END AS TRACK_IN,  
               CASE WHEN W.LOT_PROC_STATE='Processing' AND (W.PROCESS_START IS NOT NULL and W.PROCESS_START <> '') THEN W.PROCESS_START ELSE                      
              (CASE WHEN W.LOT_PROC_STATE='Processing' AND (W.TRACKIN_TIME IS NOT NULL and W.TRACKIN_TIME <> '') AND PS.CLAIM_TIME > W.TRACKIN_TIME THEN PS.CLAIM_TIME END) END AS PROCESS_START,  
               W.TECH_ID,                                                                                                             
               W.CUSTOMER_ID,                                                                                                         
               W.PARENT_LOT_ID,                                                                                                       
               W.CR,                                                                                                                  
               W.RECIPE AS FLOW_RECIPE,                                                                                                
               CASE WHEN F.SHL_FIRENUMBER >= 3          THEN '0'                                                                      
                    WHEN F.SHL_FIRENUMBER = 2 	        THEN '1'                                                                      
                    WHEN F.SHL_FIRENUMBER = 1           THEN '2'                                                                      
                    WHEN S.LOT_PURPOSE = 'Golden Lot'   THEN '3'                                                                                  
                    WHEN (P.LOT_ID IS NOT NULL and P.LOT_ID <> '')           THEN '4'                                                                      
                    WHEN (S.LOT_ID IS NOT NULL and S.LOT_ID <> '')            THEN '4'                                                                      
                    WHEN (C.LOT_ID IS NOT NULL and C.LOT_ID <> '')           THEN '4'                                                                      
                    WHEN (SL.LOT_ID IS NOT NULL and SL.LOT_ID <> '')          THEN '4'                                                                      
                    ELSE '-1'                                                                                                         
                END AS SHR_FLAG,                                                                                                      
                CASE WHEN W.LOT_PROC_STATE='Processing' OR                                                                            
                          -- LOT_PROC_STATE='JOBPREPARED'  THEN NVL(OS.RECIPE_ID,RH.RECIPE_ID)
                          LOT_PROC_STATE='JOBPREPARED'  THEN COALESCE(OS.RECIPE_ID,RH.RECIPE_ID)                                           
                END AS RECIPE_ID,                                                                                                     
                CASE WHEN (OHR.RETICLE_ID IS NOT NULL and OHR.RETICLE_ID <> '') THEN OHR.RETICLE_ID                                                                          
                     WHEN W.LOT_PROC_STATE='Processing'  THEN RR.RETICLE_ID                                                                     
                END AS RETICLE_ID,                                                                                                                        
                CASE    WHEN (LI.LOCATION_ID IS NOT NULL and LI.LOCATION_ID <> '')      THEN LI.LOCATION_ID                                                    
                        WHEN (LI.LOCATION_ID IS NULL OR LI.LOCATION_ID = '')  THEN L.FOUP_STATION_ID                                                           
                 END AS LOCATION,                                                                                                     
                CASE WHEN  W.LOT_PROC_STATE='Processing'  OR                                                                          
                        -- LOT_PROC_STATE='JOBPREPARED'   THEN NVL(RH.CLAIM_TIME, W.WIP_CLAIM_TIME)                                      
                        LOT_PROC_STATE='JOBPREPARED'   THEN COALESCE(RH.CLAIM_TIME, W.WIP_CLAIM_TIME)
                END AS JOB_PREPARE,                                                                                                   
                L.FAB_PHASE, W.WHITE_FLAG, W.BATCH_ID,                                                                                
                NULL AS FROMBATCH_TIME,                                                                                               
                NULL AS FROMBATCH_TOOL,W.TRANS_STATE, L.FOUP_STATION_ID,W.MULTI_GROUP, W.MULTI_TARGET_FLAG                            
      FROM APS_TMP_ETL_WIP_V5 W                                                                                                 
      LEFT JOIN APS_TMP_ETL_WIP_SHR_PRI S ON W.LOT_ID =  S.LOT_ID                                                               
      LEFT JOIN APS_TMP_ETL_WIP_LOT_FIRE F ON W.LOT_ID = F.LOT_ID                                                               
      LEFT JOIN APS_TMP_ETL_WIP_LOT_PURPOSE P ON W.LOT_ID = P.LOT_ID                                                            
      LEFT JOIN APS_TMP_ETL_WIP_CUT_LINE C ON W.LOT_ID = C.LOT_ID                                                               
      LEFT JOIN APS_TMP_ETL_WIP_SELECT_LOT SL ON W.LOT_ID = SL.LOT_ID                                                            
      LEFT JOIN APS_TMP_ETL_WIP_CTL_JOB LJ    ON W.LOT_ID = LJ.LOT_ID AND W.OPE_NO = LJ.OPE_NO                                  
      LEFT JOIN APS_TMP_ETL_WIP_OPER_RESERVE_HS RH ON  LJ.LOT_ID = RH.LOT_ID                                                 
                                                         AND LJ.OPE_NO = RH.OPE_NO                                                    
                                                         AND LJ.MAINPD_ID = RH.MAINPD_ID                                              
                                                         AND LJ.PRODSPEC_ID = RH.PRODSPEC_ID                                           
                                                         AND LJ.CTRL_JOB = RH.CTRL_JOB   
      --modify by xiecheng for version up                                                                                                
      --LEFT JOIN APS_TMP_ETL_WIP_RECIPE_RETICLE RR  ON RH.EQP_ID = RR.CONVERT_TOOL_ID                                            
       --                                                 AND RH.RECIPE_ID_C = RR.RECIPE_ID_C                                           
      LEFT JOIN APS_TMP_ETL_WIP_OPER_START_HS OS ON  LJ.LOT_ID = OS.LOT_ID                                                   
                                                         AND  LJ.OPE_NO = OS.OPE_NO                                                   
                                                         AND  LJ.MAINPD_ID = OS.MAINPD_ID                                             
                                                         AND  LJ.PRODSPEC_ID = OS.PRODSPEC_ID                                          
                                                         AND  LJ.CTRL_JOB = OS.CTRL_JOB
       --modify by xiecheng for version up                                                   
       LEFT JOIN APS_TMP_ETL_WIP_RECIPE_RETICLE RR  ON RH.EQP_ID = RR.CONVERT_TOOL_ID                                            
                                                        AND RH.RECIPE_ID_C = RR.RECIPE_ID_C                                                                                                  
      LEFT JOIN APS_TMP_ETL_WIP_OPEHS_RETICLE OHR ON W.LOT_ID = OHR.LOT_ID                                                      
                                                       AND W.MAINPD_ID = OHR.MAINPD_ID                                                
                                                       AND W.OPE_NO = OHR.OPE_NO                                                      
                                                       AND OS.CLAIM_TIME = OHR.CLAIM_TIME    
                                                         --modify by xiecheng for version up                                           
                                                       --AND OHR.OPE_CATEGORY = 'OperationStart'                                        
      LEFT JOIN APS_TMP_ETL_WIP_OPER_PROCESS_START_HS PS ON   LJ.LOT_ID = PS.LOT_ID                                               
                                                             AND  LJ.OPE_NO = PS.OPE_NO                                               
                                                             AND  LJ.MAINPD_ID = OS.MAINPD_ID                                         
                                                             AND  LJ.PRODSPEC_ID = OS.PRODSPEC_ID                                      
                                                             AND  LJ.CTRL_JOB = PS.CTRL_JOB                                           
      LEFT JOIN APS_TMP_ETL_WIP_LOT_LOCATION L ON W.LOT_ID = L.LOT_ID                                                           
      LEFT JOIN APS_TMP_ETL_WIP_LOCATION_INFO LI ON L.FOUP_STATION_ID = LI.TOOL_ID  
    """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_WIP",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_WIP")


def InsertWipHoldCode2Temp(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    # V_HOLD_DETAIL_HISTORY 串接时 只串 LotID和 OPE_NO，不串ProductSpecId
    # (因ScheduleChange case, prodspecId 和 Flow 会被change)
    sql = """
    INSERT /*+ append */ INTO APS_TMP_ETL_WIP_HC                                                                         
     (LOT_ID, PRODSPEC_ID, PLAN_ID, OPE_NO, HOLD_CODE, LOT_HOLD_STATUS, HOLD_TIME)                                                     
     WITH HOLD_HIST AS (                                                                                                               
          SELECT H.LOT_ID, H.HOLD_OPE_NO, 
          -- MIN(ROUND((SYSDATE - H.CLAIM_TIME) * 24)) AS HOLD_TIME 
             MIN( ROUND((extract(epoch from(CAST(CURRENT_TIMESTAMP AS TIMESTAMP) - H.CLAIM_TIME))) / 3600.0) ) AS HOLD_TIME,
          -- SUBSTRING(XMLAGG(XMLELEMENT(A, ';' || H.HOLD_REASON_CODE || '-' || H.HOLD_TYPE) ).EXTRACT('//text()'), 2) AS HOLD_CODE
          --TODO
          SUBSTRING(STRING_AGG(concat(';', H.HOLD_REASON_CODE, '-' , H.HOLD_TYPE), ''), 2) AS HOLD_CODE    
          FROM APS_SYNC_HOLD_DETAIL_HISTORY.APS_SYNC_HOLD_DETAIL_HISTORY H                                                                                                 
          -- WHERE H.PARTCODE='"+holdhsPartCode
          WHERE 1=1
          GROUP BY H.LOT_ID, H.HOLD_OPE_NO                                                                                             
     )                                                                                                                                
     SELECT W.LOT_ID                                                                                                                   
           ,W.PRODSPEC_ID                                                                                                              
           ,W.PLAN_ID                                                                                                                  
           ,W.OPE_NO                                                                                                                   
           ,H.HOLD_CODE                                                                                                                
           ,W.LOT_STATUS AS LOT_HOLD_STATUS                                                                                            
           ,H.HOLD_TIME                                                                                                                
     FROM APS_TMP_ETL_WIP W                                                                                                            
     INNER JOIN HOLD_HIST H ON W.LOT_ID = H.LOT_ID AND W.OPE_NO = H.HOLD_OPE_NO                                                        
     WHERE 1=1                                                                                                                         
     AND W.OPE_NO = W.TARGET_OPE_NO                                                                                                    
     AND W.LOT_STATUS = 'OnHold'
    """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_WIP_HC",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_WIP_HC")


def InsertWipMergeHoldCode2Temp(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    sql = """
    INSERT /*+ append */ INTO APS_TMP_ETL_WIP_MERGE_HC                                                                      
     (LOT_ID, OPE_NO, PRODSPEC_ID, HOLD_TIME, HOLD_REASON_CODE, HOLD_TYPE)                                                              
     SELECT LOT_ID,HOLD_OPE_NO,PRODSPEC_ID,                                                                                             
            CLAIM_TIME,HOLD_REASON_CODE,HOLD_TYPE                                                                                       
     FROM APS_SYNC_HOLD_DETAIL_HISTORY.APS_SYNC_HOLD_DETAIL_HISTORY                                                                           
     WHERE 1=1
     AND HOLD_TYPE='MergeHold'  
    """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_WIP_MERGE_HC",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_WIP_MERGE_HC")


def getPreferToolData(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    sql = """
      INSERT INTO APS_TMP_ETL_WIP_PREFER_TOOL (                 
         TECH,PRODUCT_ID,OPE_NO                                                  
        )                                                               
         WITH EQP_DATA AS (                             
              SELECT DISTINCT EQP_ID                    
              FROM APS_SYNC_ETL_TOOL.APS_SYNC_ETL_TOOL T                         
              WHERE T.REAL_MODULE IN ('DIFF','WET')     
              AND T.HOST_EQP_FLAG = 'Y'                             
         )                                              
         SELECT DISTINCT T.TECH,T.PRODUCT_ID,           
                T.OPE_NO                                
         FROM APS_SYNC_RTD_PREFER_TOOL.APS_SYNC_RTD_PREFER_TOOL T                       
         INNER JOIN EQP_DATA E                          
         ON E.EQP_ID = T.EQP_ID                                  
    """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_WIP_PREFER_TOOL",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_WIP_PREFER_TOOL")


def getPreOHBData(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    sql = """
     INSERT INTO APS_TMP_ETL_WIP_PRE_OHB(                    
    EQP_ID,STK_ID                                                  
    )                                                               
     WITH STK_DATA AS (                                                                    
         SELECT ROW_NUMBER() OVER(PARTITION BY STK_ID ORDER BY EQP_ID) AS RN,EQP_ID,STK_ID 
         FROM APS_SYNC_FREQP_UTS.APS_SYNC_FREQP_UTS                                                                             
     ),                                                                                    
     RESULT_DATA AS (                                                                      
         SELECT MAX(RN) AS RN,                                                             
                MAX(EQP_ID) AS EQP_ID,                                                     
                STK_ID                                                                     
         FROM STK_DATA                                                                     
         GROUP BY STK_ID                                                                   
     )                                                                                     
     SELECT EQP_ID,STK_ID                                                                  
     FROM RESULT_DATA                                                                      
     WHERE RN = 1                                
    """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_WIP_PRE_OHB",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_WIP_PRE_OHB")


def getRetFlowData(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    sql = """
         INSERT INTO APS_TMP_WIP_RET_FLOW(                
        RETN_MAINPD_ID, RETN_OPE_NO, TARGET_OP_NO, REMAIN_QTIME,
        LOT_ID, OPE_NO, PRODSPEC_ID, MAINPD_ID                                                   
        )                                                                   
         SELECT  B.RETN_MAINPD_ID, B.RETN_OPE_NO,                                         
                 C.TARGET_OP_NO,C.REMAIN_QTIME,                            
                 A.LOT_ID,A.OPE_NO,A.PRODSPEC_ID,A.MAINPD_ID               
         FROM APS_SYNC_WIP.APS_SYNC_WIP A                   
         LEFT JOIN APS_SYNC_MES_FRLOT_RETNLIST.APS_SYNC_MES_FRLOT_RETNLIST B   
         ON A.LOT_ID=B.LOT_ID                                              
         AND A.OPE_NO = B.OPE_NO                                           
         AND A.MAINPD_ID = B.MAINPD_ID                                             
         LEFT JOIN APS_SYNC_FVLOT_QTIME.APS_SYNC_FVLOT_QTIME C          
         ON A.LOT_ID= C.LOT_ID                                                      
         WHERE (B.LOT_ID IS NOT NULL and B.LOT_ID <> '')                                       
         AND B.D_SEQNO = '0'                                                 
         AND A.LOT_TYPE IN ('Production','Engineering')                                              
        """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_WIP_RET_FLOW",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_WIP_RET_FLOW")


def getRetFlowStepData(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    sql = """
       INSERT INTO APS_TMP_WIP_RET_FLOW_STEP(                                                                   
       TOOLG_ID, RETN_MAINPD_ID, RETN_OPE_NO, RETN_STEP_ID,TARGET_OP_NO, REMAIN_QTIME,
        TARGET_STEP_ID, LOT_ID, OPE_NO, STEP_ID, PRODSPEC_ID, MAINPD_ID                                                                                       
       )                                                                                                      
        SELECT CASE WHEN F.OPE_NO = D.RETN_OPE_NO THEN F.TOOLG_ID END TOOLG_ID,                              
            D.RETN_MAINPD_ID,D.RETN_OPE_NO,                                                            
            CASE WHEN F.OPE_NO = D.RETN_OPE_NO THEN F.STEP_ID END RETN_STEP_ID,                        
            D.TARGET_OP_NO,D.REMAIN_QTIME,                                                             
            CASE WHEN F.OPE_NO = D.TARGET_OP_NO THEN F.STEP_ID END TARGET_STEP_ID,                     
            D.LOT_ID,D.OPE_NO,                                                                         
            CASE WHEN F.OPE_NO = D.OPE_NO THEN F.STEP_ID END STEP_ID,                                  
            D.PRODSPEC_ID,D.MAINPD_ID                                                                  
        FROM APS_TMP_WIP_RET_FLOW D                                                               
        INNER JOIN APS_ETL_FLOW.APS_ETL_FLOW F                                                   
        ON                                                
         F.PROD_ID = D.PRODSPEC_ID                                                                        
        AND (CASE WHEN F.PLAN_ID = D.MAINPD_ID AND F.OPE_NO = D.OPE_NO THEN 1                                
             WHEN F.PLAN_ID = D.RETN_MAINPD_ID AND F.OPE_NO = D.TARGET_OP_NO THEN 1              
             WHEN F.PLAN_ID = D.RETN_MAINPD_ID AND F.OPE_NO = D.RETN_OPE_NO THEN 1               
             ELSE 0 END = 1)                                                                                                               
        """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_WIP_RET_FLOW_STEP",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_WIP_RET_FLOW_STEP")


def getRetFlowResultData(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    sql = """
      INSERT INTO APS_TMP_WIP_RET_FLOW_RESULT(                                                                   
        TOOLG_ID, RETN_MAINPD_ID, RETN_OPE_NO, RETN_STEP_ID,TARGET_OP_NO, REMAIN_QTIME,
        TARGET_STEP_ID, LOT_ID, OPE_NO, STEP_ID, PRODSPEC_ID, MAINPD_ID, DZ                                                                                        
       )                                                                                                      
         WITH REULT_DATA AS (                                                                            
             SELECT MAX(TOOLG_ID) AS TOOLG_ID,                                                           
                    RETN_MAINPD_ID,RETN_OPE_NO,                                                          
                    MAX(RETN_STEP_ID) AS RETN_STEP_ID,                                                   
                    TARGET_OP_NO,REMAIN_QTIME,                                                           
                    MAX(TARGET_STEP_ID) AS TARGET_STEP_ID,                                               
                    LOT_ID,OPE_NO,                                                                       
                    MAX(STEP_ID) AS STEP_ID,                                                             
                    PRODSPEC_ID,MAINPD_ID                                                                
             FROM APS_TMP_WIP_RET_FLOW_STEP                                                       
             GROUP BY RETN_MAINPD_ID,RETN_OPE_NO,TARGET_OP_NO,                                           
                      REMAIN_QTIME,LOT_ID,OPE_NO,PRODSPEC_ID,MAINPD_ID                                   
         )                                                                                               
         SELECT TOOLG_ID,                                                                                
                RETN_MAINPD_ID,RETN_OPE_NO,                                                              
                RETN_STEP_ID,TARGET_OP_NO,                                                               
                CASE WHEN (TARGET_STEP_ID IS NOT NULL  and TARGET_STEP_ID <> '')                                                   
                      THEN REMAIN_QTIME END AS REMAIN_QTIME,                                             
                TARGET_STEP_ID,                                                                          
                LOT_ID,OPE_NO,STEP_ID,                                                                   
                PRODSPEC_ID,MAINPD_ID,                                                                   
                T.DZ                                                                                     
         FROM REULT_DATA                                                                                 
         --INNER JOIN (SELECT LEVEL DZ FROM DUAL CONNECT BY LEVEL <= 2) T                                  
         --ON T.DZ >= 1 AND T.DZ <=2           
         INNER JOIN (WITH RECURSIVE cte(DZ) as ( select 1 as dz union all select dz + 1 from cte where dz < 2) select dz from cte ) T 
         ON T.DZ >= 1 AND T.DZ <= 2                                                          
         WHERE (TOOLG_ID IS NOT NULL  and TOOLG_ID <> '')                                                                                                                                                                                 
        """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_WIP_RET_FLOW_RESULT",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_WIP_RET_FLOW_RESULT")


def InsertNormalFlowTargetWip2HandleTable(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    sql = """
    INSERT INTO /*+ append */ APS_TMP_ETL_WIP_V3 (
    LOT_ID,OPE_SEQ,OPE_NO,PRODSPEC_ID,PLAN_ID,LOT_TYPE,FOUP_ID,WAFER_QTY,PRIORITY,SHR_FLAG,LOT_STATUS,ARRIVAL,LAYER,STAGE,EQP_ID,RETICLE_ID,FLOW_RECIPE,RECIPE_ID,      
    TRACKIN_TIME,PROCESS_START_TIME,TECH_ID,CUSTOMER_ID,LOCATION_ID,PARENT_LOT_ID,CRITICAL_RATIO,JOB_PREPARE,FAB_PHASE,HOLD_CODE,WHITE_FLAG,BATCH_ID,FROMBATCH_TIME,    
    FROMBATCH_TOOL,TRANS_STATE,FOUP_STATION_ID)                                                                                                                         
          SELECT * FROM (                                                                                                                                               
              SELECT A.*  FROM (                                                                                                                                                    
                  SELECT W.LOT_ID                                                                                                                                       
                        ,W.OPE_SEQ                                                                                                                                      
                        ,W.OPE_NO                                                                                                                                                   
                        ,W.PRODSPEC_ID                                                                                                                                  
                        ,W.PLAN_ID                                                                                                                                      
                        ,W.LOT_TYPE                                                                                                                                     
                        ,W.FOUP_ID                                                                                                                                      
                        ,W.WAFER_QTY                                                                                                                                    
                        ,W.PRIORITY                                                                                                                                     
                        ,W.SHR_FLAG                                                                                                                                     
                        ,CASE WHEN (H.LOT_ID IS NOT NULL and H.LOT_ID <> '') THEN H.LOT_HOLD_STATUS                                                                                          
                              ELSE W.LOT_STATUS                                                                                                                         
                         END AS  LOT_STATUS                                                                                                                             
                        ,W.ARRIVAL                                                                                                                                      
                        ,W.LAYER                                                                                                                                        
                        ,W.STAGE                                                                                                                                        
                        ,W.EQP_ID                                                                                                                                       
                        ,W.RETICLE_ID                                                                                                                                   
                        ,W.FLOW_RECIPE                                                                                                                                  
                        ,W.RECIPE_ID                                                                                                                                    
                        ,W.TRACKIN_TIME                                                                                                                                 
                        ,W.PROCESS_START_TIME                                                                                                                           
                        ,W.TECH_ID                                                                                                                                      
                        ,W.CUSTOMER_ID                                                                                                                                  
                        ,W.LOCATION_ID                                                                                                                                  
                        ,W.PARENT_LOT_ID                                                                                                                                
                        ,W.CRITICAL_RATIO                                                                                                                                           
                        ,W.JOB_PREPARE                                                                                                                                  
                        ,W.FAB_PHASE                                                                                                                                                
                        ,H.HOLD_CODE, W.WHITE_FLAG, W.BATCH_ID, W.FROMBATCH_TIME, W.FROMBATCH_TOOL,W.TRANS_STATE, W.FOUP_STATION_ID                                     
                  FROM  APS_TMP_ETL_WIP W                                                                                                                         
                  LEFT JOIN APS_TMP_ETL_WIP_HC H ON W.LOT_ID = H.LOT_ID AND W.PRODSPEC_ID = H.PRODSPEC_ID AND W.PLAN_ID = H.PLAN_ID AND W.OPE_NO = H.OPE_NO                    
                  WHERE 1=1                                                                                                                                                         
                  AND (W.LOT_TYPE < 'Equipment Monitor' OR W.LOT_TYPE > 'Equipment Monitor')  AND (W.TARGET_TOOLG_ID <'NoData' OR W.TARGET_TOOLG_ID >'NoData')
              ) A                                                                                                                                                       
          )                                                                                                                                                             
    """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_WIP_V3",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_WIP_V3")

    sql = """
     INSERT INTO APS_TMP_ETL_WIP_V4 (LOT_ID,STEP_ID,WIP_OPE_NO,TARGET_STEP_ID,TARGET_OPE_NO,TARGET_TOOLG_ID,PRODG_ID,PRODG_TECH,PRODSPEC_ID,PLAN_ID,TARGET_PLAN_ID,LOT_TYPE,
     FOUP_ID,WAFER_QTY,PRIORITY,SHR_FLAG,LOT_STATUS,ARRIVAL,LAYER,STAGE,EQP_ID,RETICLE_ID,RECIPE,PPID,TRACKIN_TIME,PROCESS_START_TIME,TECH_ID,
     CUSTOMER_ID,LOCATION_ID,PARENT_LOT_ID,FLOW_RECIPE,CRITICAL_RATIO,HOLD_CODE,JOB_PREPARE,FAB_PHASE,WHITE_FLAG,BATCH_ID,FROMBATCH_TIME,
     FROMBATCH_TOOL,TRANS_STATE,FOUP_STATION_ID,MULTI_TARGET_FLAG,MULTI_GROUP,RN)
         SELECT A.*                                                                                                                                                     
              , ROW_NUMBER() OVER(PARTITION BY A.LOT_ID, A.PLAN_ID, A.PRODSPEC_ID, A.WIP_OPE_NO ORDER BY A.TARGET_STEP_ID) AS RN
            FROM (                                                                                                                                                      
                     SELECT W.LOT_ID                                                                                                                                    
                           ,W.OPE_SEQ AS STEP_ID                                                                                                                        
                           ,W.OPE_NO AS WIP_OPE_NO                                                                                                                      
                           ,TF.STEP_ID AS TARGET_STEP_ID                                                                                                                
                           ,TF.OPE_NO  AS TARGET_OPE_NO                                                                                                                 
                           ,TF.TOOLG_ID AS TARGET_TOOLG_ID                                                                                                              
                           ,TF.PRODG_ID                                                                                                                                 
                           ,TF.PRODG_TECH                                                                                                                               
                           ,W.PRODSPEC_ID                                                                                                                               
                           ,W.PLAN_ID                                                                                                 
                           ,TF.PLAN_ID AS TARGET_PLAN_ID                                                                              
                           ,W.LOT_TYPE                                                                                                
                           ,W.FOUP_ID                                                                                                 
                           ,W.WAFER_QTY                                                                                               
                           ,W.PRIORITY                                                                                                
                           ,W.SHR_FLAG                                                                                                
                           ,W.LOT_STATUS                                                                                              
                           ,W.ARRIVAL                                                                                                 
                           ,W.LAYER                                                                                                   
                           ,W.STAGE                                                                                                   
                           ,W.EQP_ID                                                                                                  
                           ,W.RETICLE_ID                                                                                              
                           ,W.FLOW_RECIPE AS RECIPE                                                                                   
                           ,W.RECIPE_ID AS PPID                                                                                       
                           ,W.TRACKIN_TIME                                                                                            
                           ,W.PROCESS_START_TIME                                                                                      
                           ,W.TECH_ID                                                                                                 
                           ,W.CUSTOMER_ID                                                                                             
                           ,W.LOCATION_ID                                                                                             
                           ,W.PARENT_LOT_ID                                                                                           
                           ,W.FLOW_RECIPE AS FLOW_RECIPE                                                                              
                           ,W.CRITICAL_RATIO                                                                                          
                           ,W.HOLD_CODE                                                                                               
                           ,W.JOB_PREPARE                                                                                             
                           ,W.FAB_PHASE, W.WHITE_FLAG, W.BATCH_ID, W.FROMBATCH_TIME                                                    
                           ,W.FROMBATCH_TOOL,W.TRANS_STATE,W.FOUP_STATION_ID,TF.MULTI_TARGET_FLAG,TF.MULTI_GROUP                      
                     FROM APS_TMP_ETL_WIP_V3 W                                                                                    
                     INNER JOIN APS_TMP_ETL_WIP_LAST_FLOW TF ON  W.PRODSPEC_ID = TF.PROD_ID                                               
                                                         AND W.PLAN_ID = TF.PLAN_ID                                                   
                                                         AND TF.TOOLG_TYPE = 'P'                                                      
                     WHERE 1=1                                                                                                        
                     GROUP BY W.LOT_ID                                                                                                
                           ,W.OPE_SEQ                                                                                                 
                           ,W.OPE_NO                                                                                                  
                           ,TF.STEP_ID                                                                                                
                           ,TF.OPE_NO                                                                                                 
                           ,TF.TOOLG_ID                                                                                               
                           ,TF.PRODG_ID                                                                                               
                           ,TF.PRODG_TECH                                                                                             
                           ,W.PRODSPEC_ID                                                                                             
                           ,W.PLAN_ID                                                                                                 
                           ,TF.PLAN_ID                                                                                                
                           ,W.LOT_TYPE                                                                                                
                           ,W.FOUP_ID                                                                                                 
                           ,W.WAFER_QTY                                                                                               
                           ,W.PRIORITY                                                                                                
                           ,W.SHR_FLAG                                                                                                
                           ,W.LOT_STATUS                                                                                              
                           ,W.ARRIVAL                                                                                                 
                           ,W.LAYER                                                                                                   
                           ,W.STAGE                                                                                                   
                           ,W.EQP_ID                                                                                                  
                           ,W.RETICLE_ID                                                                                              
                           ,W.RECIPE_ID                                                                                               
                           ,W.FLOW_RECIPE                                                                                             
                           ,W.TRACKIN_TIME                                                                                            
                           ,W.PROCESS_START_TIME                                                                                      
                           ,W.TECH_ID                                                                                                 
                           ,W.CUSTOMER_ID                                                                                             
                           ,W.LOCATION_ID                                                                                             
                           ,W.PARENT_LOT_ID                                                                                                       
                           ,TF.RECIPE                                                                                                 
                           ,W.CRITICAL_RATIO                                                                                                      
                           ,W.HOLD_CODE                                                                                               
                           ,W.JOB_PREPARE                                                                                             
                           ,W.FAB_PHASE, W.WHITE_FLAG, W.BATCH_ID, W.FROMBATCH_TIME, W.FROMBATCH_TOOL, W.TRANS_STATE, W.FOUP_STATION_ID 
                           ,TF.MULTI_TARGET_FLAG,TF.MULTI_GROUP                                                                         
             ) A                                                                                                                      
            WHERE A.TARGET_STEP_ID > A.STEP_ID 
    """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_WIP_V4",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_WIP_V4")

    sql = """
    Insert /*+ append */ Into APS_TMP_HANDLE_WIP
     (
         PARENTID, LOT_ID, STEP_ID, OPE_NO, TARGET_STEP_ID, TARGET_OPE_NO, TARGET_TOOLG_ID, PRODG_ID, PRODG_TECH, PROD_ID, 
         PLAN_ID, TARGET_PLAN_ID, LOT_TYPE, FOUP_ID, QTY, PTY, SHR_FLAG, LOT_STATUS, ARRIVAL, LAYER, STAGE, TOOL_ID, 
         RETICLE_ID, RECIPE, PPID, TRACK_IN, PROCESS_START, TECH_ID, CUSTOMER, LOCATION, PARENT_LOT, FLOW_RECIPE, 
         CRITICAL_RATIO, HOLD_CODE, PRE_TOOL_ID, CREATE_TIME, JOB_PREPARE, FAB_PHASE, WHITE_FLAG, BATCH_ID,FROMBATCH_TIME, FROMBATCH_TOOL, TRANS_STATE, FOUP_STATION_ID,
         MULTI_TARGET_FLAG, MULTI_GROUP  
     )                              
     WITH TOOL_MODULE AS(                                       
          SELECT EQP_G                                          
          FROM APS_SYNC_ETL_TOOL.APS_SYNC_ETL_TOOL      
          WHERE REAL_MODULE = 'WET'                             
          -- AND PARTCODE='"+toolPCode +"'                         
          GROUP BY EQP_G                                        
     ),                                                         
     TARGET_DATA AS (                                                                                                                 
     SELECT  DISTINCT '{uuid}' AS PARENTID , WIP.LOT_ID                                                                        
         ,WIP.STEP_ID                                                                                                                 
         ,WIP.WIP_OPE_NO                                                                                                              
         ,WIP.TARGET_STEP_ID                                                                                                          
         ,WIP.TARGET_OPE_NO                                                                                                           
         ,WIP.TARGET_TOOLG_ID                                                                                                         
         ,WIP.PRODG_ID                                                                                                                
         ,WIP.PRODG_TECH                                                                                                              
         ,WIP.PRODSPEC_ID                                                                                                             
         ,WIP.PLAN_ID                                                                                                                 
         ,WIP.TARGET_PLAN_ID                                                                                                          
         ,WIP.LOT_TYPE                                                                                                                
         ,WIP.FOUP_ID                                                                                                                 
         ,WIP.WAFER_QTY   
           --modify by xiecheng for version up                                                                                                          
         --,WIP.PRIORITY                                                                                                                
        -- ,CASE WHEN LPS.LOT_ID IS NOT NULL THEN LPS.PRIORITY ELSE WIP.SHR_FLAG||'' END AS SHR_FLAG          
         ,CASE WHEN (LPS.LOT_ID IS NOT NULL and LPS.LOT_ID <> '') THEN LPS.PRIORITY ELSE WIP.PRIORITY END AS PRIORITY                       
         ,CASE WHEN WIP.SHR_FLAG= '-1' AND (PTT.OPE_NO IS NOT NULL and PTT.OPE_NO <> '') THEN '4' ELSE WIP.SHR_FLAG||'' END AS SHR_FLAG                          
         ,CASE WHEN (UCL.OPE_NO IS NOT NULL and UCL.OPE_NO <> '') THEN ('UMTHold'|| '_'|| WIP.LOT_STATUS) ELSE WIP.LOT_STATUS END AS LOT_STATUS              
         ,WIP.ARRIVAL                                                                                                                 
         ,WIP.LAYER                                                                                                                   
         ,WIP.STAGE                                                                                                                   
         ,WIP.EQP_ID                                                                                                                  
         ,WIP.RETICLE_ID                                                                                                              
         ,WIP.RECIPE                                                                                                                  
         ,WIP.PPID                                                                                                                    
         ,WIP.TRACKIN_TIME                                                                                                            
         ,WIP.PROCESS_START_TIME                                                                                                      
         ,WIP.TECH_ID                                                                                                                 
         ,WIP.CUSTOMER_ID                                                                                                             
         ,WIP.LOCATION_ID                                                                                                             
         ,WIP.PARENT_LOT_ID                                                                                                           
         ,WIP.FLOW_RECIPE                                                                                                             
         ,WIP.CRITICAL_RATIO                                                                                                          
         ,WIP.HOLD_CODE                                                                                                               
         ,'' AS PRE_EQP                                                                                                               
         ,'{current_time}' AS UPDATE_TIME                                                                                      
         ,WIP.JOB_PREPARE                                                                                                             
         ,WIP.FAB_PHASE, WIP.WHITE_FLAG, WIP.BATCH_ID,WIP.RN, WIP.FROMBATCH_TIME                                                                  
         ,NULL AS FROMBATCH_TOOL                                                                                                      
         ,WIP.TRANS_STATE, WIP.FOUP_STATION_ID,WIP.MULTI_GROUP,WIP.MULTI_TARGET_FLAG                                                  
      FROM APS_TMP_ETL_WIP_V4 WIP                                                                                               
      LEFT JOIN APS_TMP_ETL_WIP_UMT_CONTROL_LOT UCL ON   WIP.TARGET_OPE_NO = UCL.OPE_NO                                         
                                                          -- AND  DECODE(UCL.TECH,'ALL',WIP.PRODG_TECH,UCL.TECH) = WIP.PRODG_TECH
                                                          AND 
                                                            ((UCL.TECH <> 'ALL'
                                                             AND
                                                             UCL.TECH = WIP.PRODG_TECH
                                                            ) OR UCL.TECH = 'ALL')
                                                          -- AND  DECODE(UCL.PRODG1,'ALL',WIP.PRODG_ID,UCL.PRODG1) = WIP.PRODG_ID
                                                          AND 
                                                            (( UCL.PRODG1 <> 'ALL'
                                                              AND
                                                              UCL.PRODG1 = WIP.PRODG_ID
                                                            ) OR UCL.PRODG1 = 'ALL')
                                                          -- AND  DECODE(UCL.PRODUCT_ID,'ALL',WIP.PRODSPEC_ID,UCL.PRODUCT_ID) = WIP.PRODSPEC_ID
                                                          AND 
                                                            (( UCL.PRODUCT_ID <> 'ALL'
                                                              AND 
                                                              UCL.PRODUCT_ID = WIP.PRODSPEC_ID
                                                            ) OR UCL.PRODUCT_ID = 'ALL')
           -- lot特定站点改变等级
     -- LEFT JOIN "+Constant.GlobalTableName.V_SCHE_LOT_PURPTY_SETTING+" LPS ON WIP.LOT_ID = LPS.LOT_ID AND WIP.TARGET_OPE_NO = LPS.TARGET_OPE_NO AND LPS.PARTCODE='"+ PartCode
     LEFT JOIN APS_SYNC_SCHE_LOT_PURPTY_SETTING.APS_SYNC_SCHE_LOT_PURPTY_SETTING LPS ON WIP.LOT_ID = LPS.LOT_ID AND WIP.TARGET_OPE_NO = LPS.TARGET_OPE_NO 
     --modify by xiecheng for version up
     --车规产品等级
     LEFT JOIN APS_TMP_ETL_WIP_PREFER_TOOL PTT ON PTT.TECH = WIP.PRODG_TECH AND PTT.OPE_NO = WIP.TARGET_OPE_NO AND PTT.PRODUCT_ID=WIP.PRODSPEC_ID
     WHERE 1=1                                                                                                                        
     AND WIP.RN < 7                                                                                                                   
     ),                                                                                                                               
          -- 如果前三个Coming站点有WET的话，需要看6个Coming站点
     THRID_DATA AS (                                                                                                                  
        SELECT  DISTINCT WIP.LOT_ID                                                                                                           
        FROM TARGET_DATA WIP                                                                                                          
        INNER JOIN TOOL_MODULE TM                                                                                                     
        ON TM.EQP_G = WIP.TARGET_TOOLG_ID                                                                                             
        WHERE 1=1                                                                                                                     
        AND WIP.RN = 1 OR WIP.RN = 2 OR WIP.RN = 3                                                                                    
     )                                                                                                                                
     SELECT  WIP.PARENTID , WIP.LOT_ID                                                                                                
         ,WIP.STEP_ID                                                                                                                 
         ,WIP.WIP_OPE_NO                                                                                                              
         ,WIP.TARGET_STEP_ID                                                                                                          
         ,WIP.TARGET_OPE_NO                                                                                                           
         ,WIP.TARGET_TOOLG_ID                                                                                                         
         ,WIP.PRODG_ID                                                                                                                
         ,WIP.PRODG_TECH                                                                                                              
         ,WIP.PRODSPEC_ID                                                                                                             
         ,WIP.PLAN_ID                                                                                                                 
         ,WIP.TARGET_PLAN_ID                                                                                                          
         ,WIP.LOT_TYPE                                                                                                                
         ,WIP.FOUP_ID                                                                                                                 
         ,WIP.WAFER_QTY                                                                                                               
         ,WIP.PRIORITY                                                                                                                
         ,WIP.SHR_FLAG                                                                                                                
         ,WIP.LOT_STATUS                                                                                                              
         ,WIP.ARRIVAL                                                                                                                 
         ,WIP.LAYER                                                                                                                   
         ,WIP.STAGE                                                                                                                   
         ,WIP.EQP_ID                                                                                                                  
         ,WIP.RETICLE_ID                                                                                                              
         ,WIP.RECIPE                                                                                                                  
         ,WIP.PPID                                                                                                                    
         ,WIP.TRACKIN_TIME                                                                                                            
         ,WIP.PROCESS_START_TIME                                                                                                      
         ,WIP.TECH_ID                                                                                                                 
         ,WIP.CUSTOMER_ID                                                                                                             
         ,WIP.LOCATION_ID                                                                                                             
         ,WIP.PARENT_LOT_ID                                                                                                           
         ,WIP.FLOW_RECIPE                                                                                                             
         ,WIP.CRITICAL_RATIO                                                                                                          
         ,WIP.HOLD_CODE                                                                                                               
         ,WIP.PRE_EQP                                                                                                                 
         ,WIP.UPDATE_TIME                                                                                                             
         ,WIP.JOB_PREPARE                                                                                                             
         ,WIP.FAB_PHASE, WIP.WHITE_FLAG, WIP.BATCH_ID, WIP.FROMBATCH_TIME, WIP.FROMBATCH_TOOL, WIP.TRANS_STATE, WIP.FOUP_STATION_ID    
         ,WIP.MULTI_TARGET_FLAG, WIP.MULTI_GROUP                                                                                      
     FROM TARGET_DATA WIP                                                                                                             
     WHERE 1=1                                                                                                                        
     AND WIP.RN < 4                                                                                                                   
     UNION ALL                                                                                                                        
      -- 由于WET和DF 要当成一个站点来处理，所以如果第三个coming站点是WET 就需要把4、5、6增加进来
     SELECT  WIP.PARENTID , WIP.LOT_ID                                                                                                
         ,WIP.STEP_ID                                                                                                                 
         ,WIP.WIP_OPE_NO                                                                                                              
         ,WIP.TARGET_STEP_ID                                                                                                          
         ,WIP.TARGET_OPE_NO                                                                                                           
         ,WIP.TARGET_TOOLG_ID                                                                                                         
         ,WIP.PRODG_ID                                                                                                                
         ,WIP.PRODG_TECH                                                                                                              
         ,WIP.PRODSPEC_ID                                                                                                             
         ,WIP.PLAN_ID                                                                                                                 
         ,WIP.TARGET_PLAN_ID                                                                                                          
         ,WIP.LOT_TYPE                                                                                                                
         ,WIP.FOUP_ID                                                                                                                 
         ,WIP.WAFER_QTY                                                                                                               
         ,WIP.PRIORITY                                                                                                                
         ,WIP.SHR_FLAG                                                                                                                
         ,WIP.LOT_STATUS                                                                                                              
         ,WIP.ARRIVAL                                                                                                                 
         ,WIP.LAYER                                                                                                                   
         ,WIP.STAGE                                                                                                                   
         ,WIP.EQP_ID                                                                                                                  
         ,WIP.RETICLE_ID                                                                                                              
         ,WIP.RECIPE                                                                                                                  
         ,WIP.PPID                                                                                                                    
         ,WIP.TRACKIN_TIME                                                                                                            
         ,WIP.PROCESS_START_TIME                                                                                                      
         ,WIP.TECH_ID                                                                                                                 
         ,WIP.CUSTOMER_ID                                                                                                             
         ,WIP.LOCATION_ID                                                                                                             
         ,WIP.PARENT_LOT_ID                                                                                                           
         ,WIP.FLOW_RECIPE                                                                                                             
         ,WIP.CRITICAL_RATIO                                                                                                          
         ,WIP.HOLD_CODE                                                                                                               
         ,WIP.PRE_EQP                                                                                                                 
         ,WIP.UPDATE_TIME                                                                                                             
         ,WIP.JOB_PREPARE                                                                                                             
         ,WIP.FAB_PHASE, WIP.WHITE_FLAG, WIP.BATCH_ID, WIP.FROMBATCH_TIME, WIP.FROMBATCH_TOOL, WIP.TRANS_STATE, WIP.FOUP_STATION_ID
         ,WIP.MULTI_TARGET_FLAG, WIP.MULTI_GROUP                                                                                      
     FROM TARGET_DATA WIP                                                                                                             
     INNER JOIN THRID_DATA D                                                                                                          
     ON D.LOT_ID = WIP.LOT_ID                                                                                                         
     WHERE 1=1                                                                                                                        
     AND WIP.RN >= 4  AND WIP.RN <=6 
    """.format(uuid=uuid, current_time=current_time)

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_HANDLE_WIP",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_HANDLE_WIP")


def InsertOnHandeWip2HandleTable(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    # Onhand Wip Insert to Wip Handle Table
    sql = """
    --modify by xiecheng for version up
     INSERT /*+ append */ INTO  APS_TMP_HANDLE_WIP                                                                                                      
        (  PARENTID, LOT_ID, STEP_ID, OPE_NO, TARGET_STEP_ID, TARGET_OPE_NO, TARGET_TOOLG_ID, PRODG_ID, PRODG_TECH, PROD_ID,
       PLAN_ID, TARGET_PLAN_ID, LOT_TYPE, FOUP_ID, QTY, PTY, SHR_FLAG, LOT_STATUS, ARRIVAL, LAYER, STAGE, TOOL_ID,
        RETICLE_ID, RECIPE, PPID, TRACK_IN, PROCESS_START, TECH_ID, CUSTOMER, LOCATION, PARENT_LOT, FLOW_RECIPE,
       CRITICAL_RATIO, HOLD_CODE, PRE_TOOL_ID, CREATE_TIME, JOB_PREPARE, FAB_PHASE, WHITE_FLAG, BATCH_ID,FROMBATCH_TIME, FROMBATCH_TOOL, TRANS_STATE, FOUP_STATION_ID,
                           MULTI_TARGET_FLAG, MULTI_GROUP )                                                                                                                        
         SELECT DISTINCT '{uuid}'                                                                                                                    
               , W.LOT_ID                                                                                                                                    
               ,W.OPE_SEQ                                                                                                                                    
               ,W.OPE_NO                                                                                                                                     
               ,W.TARGET_OPE_SEQ                                                                                                                             
               ,W.TARGET_OPE_NO                                                                                                                              
               ,W.TARGET_TOOLG_ID                                                                                                                            
               ,W.PRODG_ID                                                                                                                                   
               ,W.PRODG_TECH                                                                                                                                 
               ,W.PRODSPEC_ID                                                                                                                                
               ,W.PLAN_ID                                                                                                                                    
               ,W.TARGET_PLAN_ID                                                                                                                             
               ,W.LOT_TYPE                                                                                                                                   
               ,W.FOUP_ID                                                                                                                                    
               ,W.WAFER_QTY                                                                                                                                  
               ,CASE WHEN (LPS.LOT_ID IS NOT NULL and LPS.LOT_ID <> '') THEN LPS.PRIORITY ELSE W.PRIORITY END AS PRIORITY                                                         
               ,CASE WHEN W.SHR_FLAG= '-1' AND (PTT.OPE_NO IS NOT NULL and PTT.OPE_NO <> '') THEN '4' ELSE W.SHR_FLAG||'' END AS SHR_FLAG                                              
               ,CASE WHEN (UCL.OPE_NO IS NOT NULL and UCL.OPE_NO <> '') AND W.LOT_STATUS ='WAIT' THEN 'UMTHold_WAIT' 
                     WHEN (H.LOT_ID IS NOT NULL and H.LOT_ID <> '' ) THEN H.LOT_HOLD_STATUS                                  
                     ELSE W.LOT_STATUS END AS  LOT_STATUS                                                                                                                     
               ,W.ARRIVAL                                                                                                                                    
               ,W.LAYER                                                                                                                                      
               ,W.STAGE                                                                                                                                      
               ,W.EQP_ID                                                                                                                                     
               ,W.RETICLE_ID                                                                                                                                 
               ,W.FLOW_RECIPE AS RECIPE                                                                                                                      
               ,W.RECIPE_ID AS PPID                                                                                                                          
               ,W.TRACKIN_TIME                                                                                                                               
               ,W.PROCESS_START_TIME                                                                                                                         
               ,W.TECH_ID                                                                                                                                    
               ,W.CUSTOMER_ID                                                                                                                                
               ,W.LOCATION_ID                                                                                                                                
               ,W.PARENT_LOT_ID                                                                                                                              
               ,W.FLOW_RECIPE                                                                                                                                
               ,W.CRITICAL_RATIO                                                                                                                             
               ,H.HOLD_CODE                                                                                                                                  
               ,'' AS PRE_EQP                                                                                                                                
               ,'{current_time}'                                                                                                                     
               ,W.JOB_PREPARE                                                                                                                                
               ,W.FAB_PHASE, W.WHITE_FLAG, W.BATCH_ID, W.FROMBATCH_TIME                                                                                      
               ,NULL AS FROMBATCH_TOOL                                                                                                                       
               ,W.TRANS_STATE, W.FOUP_STATION_ID, W.MULTI_TARGET_FLAG, W.MULTI_GROUP                                                                        
          FROM  APS_TMP_ETL_WIP  W                                                                                                                        
          LEFT JOIN  APS_TMP_ETL_WIP_HC  H ON W.LOT_ID = H.LOT_ID AND W.PRODSPEC_ID = H.PRODSPEC_ID AND W.PLAN_ID = H.PLAN_ID AND W.OPE_NO = H.OPE_NO     
          LEFT JOIN APS_TMP_ETL_WIP_UMT_CONTROL_LOT  UCL ON   W.TARGET_OPE_NO = UCL.OPE_NO                                                              
                                                            -- AND  DECODE(UCL.TECH,'ALL',W.PRODG_TECH,UCL.TECH) = W.PRODG_TECH                                
                                                           --  AND  DECODE(UCL.PRODG1,'ALL',W.PRODG_ID,UCL.PRODG1) = W.PRODG_ID                                
                                                            -- AND  DECODE(UCL.PRODUCT_ID,'ALL',W.PRODSPEC_ID,UCL.PRODUCT_ID) = W.PRODSPEC_ID                                                     
                                                          AND 
                                                            ((UCL.TECH <> 'ALL'
                                                             AND
                                                             UCL.TECH = W.PRODG_TECH
                                                            ) OR UCL.TECH = 'ALL')

                                                          AND 
                                                            (( UCL.PRODG1 <> 'ALL'
                                                              AND
                                                              UCL.PRODG1 = W.PRODG_ID
                                                            ) OR UCL.PRODG1 = 'ALL')

                                                          AND 
                                                            (( UCL.PRODUCT_ID <> 'ALL'
                                                              AND 
                                                              UCL.PRODUCT_ID = W.PRODSPEC_ID
                                                            ) OR UCL.PRODUCT_ID = 'ALL')

        -- lot特定站点改变等级
        LEFT JOIN APS_SYNC_SCHE_LOT_PURPTY_SETTING.APS_SYNC_SCHE_LOT_PURPTY_SETTING LPS ON W.LOT_ID = LPS.LOT_ID                  
        AND W.TARGET_OPE_NO = LPS.TARGET_OPE_NO              
        -- 车规产品等级
        LEFT JOIN APS_TMP_ETL_WIP_PREFER_TOOL PTT ON PTT.TECH = W.PRODG_TECH AND PTT.OPE_NO = W.TARGET_OPE_NO AND PTT.PRODUCT_ID=W.PRODSPEC_ID                                                        
    """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_HANDLE_WIP",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_HANDLE_WIP")


def InsertBackUpWip2HandleTable(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    sql = """
      INSERT /*+ append */ INTO APS_HANDLE_WIP
     (
        PARENTID, LOT_ID, STEP_ID, OPE_NO, TARGET_STEP_ID, TARGET_OPE_NO, TARGET_TOOLG_ID, PRODG_ID, PRODG_TECH, PROD_ID,
        PLAN_ID, TARGET_PLAN_ID, LOT_TYPE, FOUP_ID, QTY, PTY, SHR_FLAG, LOT_STATUS, ARRIVAL, LAYER, STAGE, TOOL_ID,
        RETICLE_ID, RECIPE, PPID, TRACK_IN, PROCESS_START, TECH_ID, CUSTOMER, LOCATION, PARENT_LOT, FLOW_RECIPE,
        CRITICAL_RATIO, HOLD_CODE, PRE_TOOL_ID, CREATE_TIME, JOB_PREPARE, FAB_PHASE, WHITE_FLAG, BATCH_ID,FROMBATCH_TIME, FROMBATCH_TOOL, TRANS_STATE, FOUP_STATION_ID,
        MULTI_TARGET_FLAG, MULTI_GROUP
     )                                                                                                                        
      WITH ALL_DATA AS (                                                                                                                                  
            SELECT W.*                                                                                                                                    
            ,ROW_NUMBER() OVER(PARTITION BY W.LOT_ID, W.TARGET_PLAN_ID, W.TARGET_STEP_ID ORDER BY W.TARGET_STEP_ID) AS RN1                                
            FROM APS_TMP_HANDLE_WIP W                                                                                                             
      )                                                                                                                                                   
      SELECT W.PARENTID                                                                                                                                   
            ,W.LOT_ID                                                                                                                                     
            ,W.STEP_ID                                                                                                                                    
            ,W.OPE_NO                                                                                                                                     
            ,W.TARGET_STEP_ID                                                                                                                             
            ,W.TARGET_OPE_NO                                                                                                                              
            ,W.TARGET_TOOLG_ID                                                                                                                            
            ,W.PRODG_ID                                                                                                                                   
            ,W.PRODG_TECH                                                                                                                                 
            ,W.PROD_ID                                                                                                                                    
            ,W.PLAN_ID                                                                                                                                    
            ,W.TARGET_PLAN_ID                                                                                                                             
            ,W.LOT_TYPE                                                                                                                                   
            ,W.FOUP_ID                                                                                                                                    
            ,W.QTY                                                                                                                                        
            ,W.PTY                                                                                                                                        
            ,W.SHR_FLAG                                                                                                                                   
            ,W.LOT_STATUS                                                                                                                                 
            ,W.ARRIVAL                                                                                                                                    
            ,W.LAYER                                                                                                                                      
            ,W.STAGE                                                                                                                                      
            ,W.TOOL_ID                                                                                                                                     
            ,W.RETICLE_ID                                                                                                                                 
            ,W.RECIPE                                                                                                                                     
            ,W.PPID                                                                                                                                       
            ,W.TRACK_IN                                                                                                                                   
            ,W.PROCESS_START                                                                                                                              
            ,W.TECH_ID                                                                                                                                    
            ,W.CUSTOMER                                                                                                                                   
            ,W.LOCATION                                                                                                                                   
            ,W.PARENT_LOT                                                                                                                                 
            ,W.FLOW_RECIPE                                                                                                                                
            ,W.CRITICAL_RATIO                                                                                                                             
            ,W.HOLD_CODE                                                                                                                                  
            ,W.PRE_TOOL_ID                                                                                                                                
            ,W.CREATE_TIME                                                                                                                                
            ,W.JOB_PREPARE                                                                                                                                
            ,W.FAB_PHASE, W.WHITE_FLAG, W.BATCH_ID, W.FROMBATCH_TIME, W.FROMBATCH_TOOL, W.TRANS_STATE,W.FOUP_STATION_ID                                   
            ,W.MULTI_TARGET_FLAG, W.MULTI_GROUP                                                                                                           
       FROM ALL_DATA W                                                                                                                                    
       WHERE W.RN1 = 1   
    """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_HANDLE_WIP",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_HANDLE_WIP")


def InsertWipPreEqp2Temp(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    # ODS.LOT@PDW -> 来自于 V_ETL_WIP,因该View 有限制条件导致不能完整的找到子母批关系，故直接使用 DB Link
    # 2/2 由于有资料新鲜度问题，导致出现问题，现在改成V_ETL_WIP
    sql = """
     -- INSERT /*+ append */ INTO APS_TMP_ETL_WIP_SPLIT_LOT
    --      (PROD_ID, PLAN_ID, OPE_NO, TARGET_PLAN_ID, TARGET_OPE_NO, CURRENT_LOT, SEQ, CHILD_LOT, PARENT_LOT)  
    --      SELECT DISTINCT                                                                                     
    --             CONNECT_BY_ROOT(W.PROD_ID) AS PROD_ID                                                        
    --            ,CONNECT_BY_ROOT(W.PLAN_ID) AS PLAN_ID                                                        
    --            ,CONNECT_BY_ROOT(W.OPE_NO) AS OPE_NO                                                          
    --            ,CONNECT_BY_ROOT(W.TARGET_PLAN_ID) AS TARGET_PLAN_ID                                          
    --            ,CONNECT_BY_ROOT(W.TARGET_OPE_NO) AS TARGET_OPE_NO                                            
    --            ,CONNECT_BY_ROOT(A.LOT_ID) AS CURRENT_LOT                                                     
    --            ,LEVEL AS SEQ                                                                                 
    --            ,A.LOT_ID AS CHILD_LOT                                                                        
    --            ,A.PARENT_LOT_ID AS PARENT_LOT                                                                
    --        FROM APS_TMP_ETL_WIP_V A                                                                          
    --        LEFT JOIN APS_HANDLE_WIP W ON A.LOT_ID = W.LOT_ID AND W.PARENT_LOT IS NOT NULL            
    --        START WITH A.LOT_ID = W.LOT_ID                                                                     
    --        CONNECT BY PRIOR A.PARENT_LOT_ID = A.LOT_ID

    WITH RECURSIVE rec(PROD_ID, PLAN_ID, OPE_NO, TARGET_PLAN_ID, TARGET_OPE_NO, CURRENT_LOT, levela, CHILD_LOT, PARENT_LOT) AS (
        SELECT W.PROD_ID         AS PROD_ID,
               W.PLAN_ID         AS PLAN_ID,
               W.OPE_NO          AS OPE_NO,
               W.TARGET_PLAN_ID  AS TARGET_PLAN_ID,
               W.TARGET_OPE_NO   AS TARGET_OPE_NO,
               W.LOT_ID          AS CURRENT_LOT,
               1                 AS SEQ, 
               A.LOT_ID          AS CHILD_LOT,
               A.PARENT_LOT_ID   AS PARENT_LOT 
               FROM APS_TMP_ETL_WIP_V A 
               LEFT JOIN APS_HANDLE_WIP W ON A.LOT_ID = W.LOT_ID AND (W.PARENT_LOT IS NOT NULL and W.PARENT_LOT <> '')
               WHERE 1=1
        UNION ALL
        SELECT RECCC.PROD_ID         AS PROD_ID,
               RECCC.PLAN_ID         AS PLAN_ID,
               RECCC.OPE_NO          AS OPE_NO,
               RECCC.TARGET_PLAN_ID  AS TARGET_PLAN_ID,
               RECCC.TARGET_OPE_NO   AS TARGET_OPE_NO,
               RECCC.CURRENT_LOT     AS CURRENT_LOT,
               levela+1              AS SEQ, 
               A.LOT_ID              AS CHILD_LOT,
               A.PARENT_LOT_ID       AS PARENT_LOT 
               FROM APS_TMP_ETL_WIP_V A 
               JOIN rec as RECCC ON RECCC.PARENT_LOT = A.LOT_ID

    )
    INSERT /*+ append */ INTO APS_TMP_ETL_WIP_SPLIT_LOT
    (PROD_ID, PLAN_ID, OPE_NO, TARGET_PLAN_ID, TARGET_OPE_NO, CURRENT_LOT, SEQ, CHILD_LOT, PARENT_LOT) 
    SELECT DISTINCT                                                                                     
             rec.PROD_ID AS PROD_ID                                                        
            ,rec.PLAN_ID AS PLAN_ID                                                        
            ,rec.OPE_NO AS OPE_NO                                                          
            ,rec.TARGET_PLAN_ID AS TARGET_PLAN_ID                                          
            ,rec.TARGET_OPE_NO AS TARGET_OPE_NO                                            
            ,rec.CURRENT_LOT AS CURRENT_LOT                                                     
            ,rec.levela AS SEQ                                                                                 
            ,rec.CHILD_LOT AS CHILD_LOT                                                                        
            ,rec.PARENT_LOT AS PARENT_LOT
    FROM rec
    """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_WIP_SPLIT_LOT",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_WIP_SPLIT_LOT")

    #  LotHistory & LotHistory_ARC 查找前一层站点进行过的EQP，插入到Temp表----目前看LotHistory的数据有到2017/6份
    #  SQL 逻辑：Normal Lot 前层机台 和 分批Lot 前层机台 串完之后Union
    #  分批Lot的话 优先找分批Lot的前层机台，若没有就看母批，母批也没有再看母批的母批，以此类推若没有前层机台会一直找到最原始母批为止。
    #  前二层 也同理。
    sql = """
    INSERT INTO APS_TMP_ETL_APC_PA_V1 (PRODSPEC_ID,PR_OP_NO,OP_NO_1,OP_NO_2) 
     SELECT DISTINCT                                                                                                                                      
         A.PRODSPEC_ID                                                                                                                                    
        ,A.PR_OP_NO                                                                                                                                       
        ,A.OP_NO_1                                                                                                                                        
        ,A.OP_NO_2                                                                                                                                        
     FROM APS_SYNC_SCHE_APC_PA.APS_SYNC_SCHE_APC_PA A 
     --modify by xiecheng for version up
      --FOURTH_PARM_VAL_FLAG='Y' 代表可用                                                                                        
     --WHERE 1=1                                                                                                                                            
           -- AND PARTCODE='"+ paPartCode +"'   
     WHERE  FOURTH_PARM_VAL_FLAG='Y'  
    """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_APC_PA_V1",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_APC_PA_V1")

    sql = """
     INSERT INTO APS_TMP_ETL_WIP_PREEQP_V1 (CURRENT_LOT,PROD_ID,PLAN_ID,OPE_NO,TARGET_PLAN_ID,TARGET_OPE_NO,OP_NO_1,PRE_EQP_1_HIS)
       SELECT B.LOT_ID                                                                                                                             	      
            , B.PROD_ID                                                                                                                                   
            , B.PLAN_ID                                                                                                                                   
            , B.OPE_NO                                                                                                                                    
            , B.TARGET_PLAN_ID                                                                                                                            
            , B.TARGET_OPE_NO                                                                                                                             
            , B.OP_NO_1                                                                                                                            	      
            , B.PRE_EQP_1_HIS                                                                                                                             
       FROM (                                                                                                                                             
              SELECT A.LOT_ID                                                                                                                             
                   , A.PROD_ID                                                                                                                            
                   , A.PLAN_ID                                                                                                                            
                   , A.OPE_NO                                                                                                                             
                   , A.TARGET_PLAN_ID                                                                                                                     
                   , A.TARGET_OPE_NO                                                                                                                      
                   , A.OP_NO_1                                                                                                                            
                   , A.PRE_EQP_1_HIS                                                                                                                      
                   , ROW_NUMBER() OVER(PARTITION BY A.LOT_ID, A.TARGET_OPE_NO ORDER BY A.CLAIM_TIME ) AS RN                                               
                FROM (SELECT  W.LOT_ID                                                                                                                    
                            , W.PROD_ID                                                                                                                   
                            , W.PLAN_ID                                                                                                                   
                            , W.OPE_NO                                                                                                                    
                            , W.TARGET_PLAN_ID                                                                                                            
                            , W.TARGET_OPE_NO                                                                                                             
                            , A.OP_NO_1                                                                                                                   
                            , LH1.EQP_ID AS PRE_EQP_1_HIS                                                                                                 
                            , LH1.CLAIM_TIME                                                                                                              
                      FROM APS_HANDLE_WIP W                                                                                                       
                      LEFT JOIN APS_TMP_ETL_APC_PA_V1 A ON W.PROD_ID = A.PRODSPEC_ID AND W.TARGET_OPE_NO = A.PR_OP_NO                               
                      LEFT JOIN APS_TMP_LOTHISTORY.APS_TMP_LOTHISTORY LH1 ON W.LOT_ID = LH1.LOT_ID   
                                                     --modify by xiecheng for version up                 
                                                    -- AND LH1.OPE_CATEGORY = 'OperationComplete'                                                            
                                                    AND LH1.OPE_NO = A.OP_NO_1                                                                            
                                                    --AND LH1.PRODSPEC_ID >= ' '  
                                                    and  LH1.PRODSPEC_ID is not null                                                                         
                                                    --AND LH1.MAINPD_ID >= ' '     
                                                     AND LH1.MAINPD_ID is not null                                                                        
                      WHERE NOT EXISTS (SELECT 1 FROM APS_TMP_ETL_WIP_SPLIT_LOT S WHERE W.LOT_ID = S.CURRENT_LOT)                                        
                ) A                                                                                                                                       
         ) B                                                                                                                                              
         WHERE B.RN = 1 
    """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_WIP_PREEQP_V1",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_WIP_PREEQP_V1")

    sql = """
     INSERT INTO APS_TMP_ETL_WIP_PREEQP_V1 (CURRENT_LOT,PROD_ID,PLAN_ID,OPE_NO,TARGET_PLAN_ID,TARGET_OPE_NO,OP_NO_1,PRE_EQP_1_HIS)
          SELECT  A.CURRENT_LOT                                                                                                                            
             , A.PROD_ID                                                                                                                                
             , A.PLAN_ID                                                                                                                                
             , A.OPE_NO                                                                                                                                 
             , A.TARGET_PLAN_ID                                                                                                                         
             , A.TARGET_OPE_NO                                                                                                                          
             , A.OP_NO_1                                                                                                                                
             , A.PRE_TOOL AS PRE_EQP_1_HIS                                                                                                              
       FROM (                                                                                                                                           
               SELECT A.CURRENT_LOT                                                                                                                     
              , A.PROD_ID                                                                                                                         
              , A.PLAN_ID                                                                                                                         
          , A.OPE_NO                                                                                                                          
          , A.TARGET_PLAN_ID                                                                                                                  
              , A.TARGET_OPE_NO                                                                                                                   
          , A.SEQ                                                                                                                             
          , A.CHILD_LOT                                                                                                                       
          , B.PR_OP_NO                                                                                                                        
          , B.OP_NO_1                                                                                                                         
          , LH1.EQP_ID                                                                                                                        
          , LH1.CLAIM_TIME                                                                                                                    
                    , LAST_VALUE(LH1.EQP_ID IGNORE NULLS) OVER(PARTITION BY A.CURRENT_LOT, A.TARGET_OPE_NO ORDER BY A.SEQ DESC
                                 ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS PRE_TOOL                            
                    , ROW_NUMBER() OVER(PARTITION BY A.CHILD_LOT, A.TARGET_OPE_NO ORDER BY LH1.CLAIM_TIME ) AS RN                                       
               FROM APS_TMP_ETL_WIP_SPLIT_LOT A                                                                                                        
               LEFT JOIN APS_TMP_ETL_APC_PA_V1 B ON A.PROD_ID = B.PRODSPEC_ID AND A.TARGET_OPE_NO = B.PR_OP_NO                                    
               LEFT JOIN APS_TMP_LOTHISTORY.APS_TMP_LOTHISTORY LH1 ON LH1.LOT_ID = A.CHILD_LOT   
                                             --modify by xiecheng for version up                                                  
                                             --AND LH1.OPE_CATEGORY = 'OperationComplete'                                                                 
                                             AND LH1.OPE_NO = B.OP_NO_1                                                                                 
                                             --AND LH1.PRODSPEC_ID >= ' '   
                                              AND LH1.PRODSPEC_ID is not null                                                                             
                                             --AND LH1.MAINPD_ID >= ' '   
                                             AND LH1.MAINPD_ID is not null
                                                                                                                             
            ) A                                                                                                                                         
            WHERE A.RN = 1                                                                                                                              
            AND A.SEQ = 1 
    """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_WIP_PREEQP_V1",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_WIP_PREEQP_V1")

    sql = """
    INSERT /*+ append */ INTO APS_TMP_ETL_WIP_PRE_EQP1                                                                                                       
    (LOT_ID, PROD_ID, PLAN_ID, OPE_NO, TARGET_PLAN_ID, TARGET_OPE_NO, OPE_NO_1, PRE_EQP, EQP_ID_1)                                                           
    SELECT E1.CURRENT_LOT                                                                                                                                    
         , E1.PROD_ID                                                                                                                                        
         , E1.PLAN_ID                                                                                                                                        
         , E1.OPE_NO                                                                                                                                         
         , E1.TARGET_PLAN_ID                                                                                                                                 
         , E1.TARGET_OPE_NO                                                                                                                                  
         , E1.OP_NO_1                                                                                                                                        
         , E1.PRE_EQP_1_HIS AS PRE_EQP                                                                                                                       
         , E1.PRE_EQP_1_HIS                                                                                                                                  
    FROM  APS_TMP_ETL_WIP_PREEQP_V1 E1
    """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_WIP_PRE_EQP1",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_WIP_PRE_EQP1")

    sql = """
    INSERT INTO APS_TMP_ETL_WIP_PREEQP_V2 (CURRENT_LOT,PROD_ID,PLAN_ID,OPE_NO,TARGET_PLAN_ID,TARGET_OPE_NO,OP_NO_2,PRE_EQP_2_HIS) 
       SELECT B.LOT_ID                                                                                                                             	      
            , B.PROD_ID                                                                                                                                   
            , B.PLAN_ID                                                                                                                                   
            , B.OPE_NO                                                                                                                                    
            , B.TARGET_PLAN_ID                                                                                                                            
            , B.TARGET_OPE_NO                                                                                                                             
            , B.OP_NO_2                                                                                                                            	      
            , B.PRE_EQP_2_HIS                                                                                                                             
       FROM (                                                                                                                                             
              SELECT A.LOT_ID                                                                                                                             
                   , A.PROD_ID                                                                                                                            
                   , A.PLAN_ID                                                                                                                            
                   , A.OPE_NO                                                                                                                             
                   , A.TARGET_PLAN_ID                                                                                                                     
                   , A.TARGET_OPE_NO                                                                                                                      
                   , A.OP_NO_2                                                                                                                            
                   , A.PRE_EQP_2_HIS                                                                                                                      
                   , ROW_NUMBER() OVER(PARTITION BY A.LOT_ID, A.TARGET_OPE_NO ORDER BY A.CLAIM_TIME ) AS RN                                               
                FROM (SELECT  W.LOT_ID                                                                                                                    
                            , W.PROD_ID                                                                                                                   
                            , W.PLAN_ID                                                                                                                   
                            , W.OPE_NO                                                                                                                    
                            , W.TARGET_PLAN_ID                                                                                                            
                            , W.TARGET_OPE_NO                                                                                                             
                            , A.OP_NO_2                                                                                                                   
                            , LH1.EQP_ID AS PRE_EQP_2_HIS                                                                                                 
                            , LH1.CLAIM_TIME                                                                                                              
                      FROM APS_HANDLE_WIP W                                                                                                       
                      LEFT JOIN APS_TMP_ETL_APC_PA_V1 A ON W.PROD_ID = A.PRODSPEC_ID AND W.TARGET_OPE_NO = A.PR_OP_NO                               
                      LEFT JOIN APS_TMP_LOTHISTORY.APS_TMP_LOTHISTORY LH1 ON W.LOT_ID = LH1.LOT_ID    
                                                    --modify by xiecheng for version up                                              
                                                    --AND LH1.OPE_CATEGORY = 'OperationComplete'                                                            
                                                    AND LH1.OPE_NO = A.OP_NO_2                                                                            
                                                    --AND LH1.PRODSPEC_ID >= ' '  
                                                    AND LH1.PRODSPEC_ID is not null                                                                         
                                                   -- AND LH1.MAINPD_ID >= ' '      
                                                    AND LH1.MAINPD_ID is not null                                                                        
                      WHERE NOT EXISTS (SELECT 1 FROM APS_TMP_ETL_WIP_SPLIT_LOT S WHERE W.LOT_ID = S.CURRENT_LOT)                                        
                ) A                                                                                                                                       
         ) B                                                                                                                                              
         WHERE B.RN = 1             
    """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_WIP_PREEQP_V2",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_WIP_PREEQP_V2")

    sql = """
    INSERT INTO APS_TMP_ETL_WIP_PREEQP_V2 (CURRENT_LOT,PROD_ID,PLAN_ID,OPE_NO,TARGET_PLAN_ID,TARGET_OPE_NO,OP_NO_2,PRE_EQP_2_HIS) 
        SELECT  A.CURRENT_LOT                                                                                                                            
        , A.PROD_ID                                                                                                                                
        , A.PLAN_ID                                                                                                                                
        , A.OPE_NO                                                                                                                                 
        , A.TARGET_PLAN_ID                                                                                                                         
        , A.TARGET_OPE_NO                                                                                                                          
        , A.OP_NO_2                                                                                                                                
        , A.PRE_TOOL AS PRE_EQP_2_HIS                                                                                                              
      FROM (                                                                                                                                           
              SELECT A.CURRENT_LOT                                                                                                                     
              , A.PROD_ID                                                                                                                         
              , A.PLAN_ID                                                                                                                         
          , A.OPE_NO                                                                                                                          
          , A.TARGET_PLAN_ID                                                                                                                  
              , A.TARGET_OPE_NO                                                                                                                   
          , A.SEQ                                                                                                                             
          , A.CHILD_LOT                                                                                                                       
          , B.PR_OP_NO                                                                                                                        
          , B.OP_NO_2                                                                                                                         
          , LH1.EQP_ID                                                                                                                        
          , LH1.CLAIM_TIME                                                                                                                    
                   , LAST_VALUE(LH1.EQP_ID IGNORE NULLS) OVER(PARTITION BY A.CURRENT_LOT, A.TARGET_OPE_NO ORDER BY A.SEQ DESC                          
                                 ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS PRE_TOOL                            
                   , ROW_NUMBER() OVER(PARTITION BY A.CHILD_LOT, A.TARGET_OPE_NO ORDER BY LH1.CLAIM_TIME ) AS RN                                       
              FROM APS_TMP_ETL_WIP_SPLIT_LOT A                                                                                                        
              LEFT JOIN APS_TMP_ETL_APC_PA_V1 B ON A.PROD_ID = B.PRODSPEC_ID AND A.TARGET_OPE_NO = B.PR_OP_NO                                    
              LEFT JOIN APS_TMP_LOTHISTORY.APS_TMP_LOTHISTORY LH1 ON LH1.LOT_ID = A.CHILD_LOT 
                                            --modify by xiecheng for version up                                                   
                                            --AND LH1.OPE_CATEGORY = 'OperationComplete'                                                                 
                                            AND LH1.OPE_NO = B.OP_NO_2                                                                                 
                                            --AND LH1.PRODSPEC_ID >= ' ' 
                                            AND LH1.PRODSPEC_ID is not null                                                                                
                                           -- AND LH1.MAINPD_ID >= ' '  
                                            AND LH1.MAINPD_ID is not null                                                                                
           ) A                                                                                                                                         
           WHERE A.RN = 1                                                                                                                              
           AND A.SEQ = 1   
    """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_WIP_PREEQP_V2",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_WIP_PREEQP_V2")

    # LotHistory & LotHistory_ARC 查找前二层站点进行过的EQP，插入到Temp表
    sql = """
     INSERT /*+ append */ INTO APS_TMP_ETL_WIP_PRE_EQP2                                                                                                         
     (LOT_ID, PROD_ID, PLAN_ID, OPE_NO, TARGET_PLAN_ID, TARGET_OPE_NO, OPE_NO_2, PRE_EQP, EQP_ID_1)                                                          
     SELECT E1.CURRENT_LOT                                                                                                                                    
          , E1.PROD_ID                                                                                                                                        
          , E1.PLAN_ID                                                                                                                                        
          , E1.OPE_NO                                                                                                                                         
          , E1.TARGET_PLAN_ID                                                                                                                                 
          , E1.TARGET_OPE_NO                                                                                                                                  
          , E1.OP_NO_2                                                                                                                                        
          , E1.PRE_EQP_2_HIS AS PRE_EQP                                                                                                                       
          , E1.PRE_EQP_2_HIS                                                                                                                                  
     FROM  APS_TMP_ETL_WIP_PREEQP_V2 E1 
    """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_WIP_PRE_EQP2",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_WIP_PRE_EQP2")

    # APS_TMP_ETL_WIP_PRE_EQP1 & APS_TMP_ETL_WIP_PRE_EQP2 两个表串接得出最终Pre Eqp Data.
    sql = """
     INSERT /*+ append */ INTO APS_TMP_ETL_WIP_PREEQP                                                                                                         
     (LOT_ID, PROD_ID, PLAN_ID, OPE_NO, TARGET_PLAN_ID, TARGET_OPE_NO, PRE_EQP, OPE_NO_1, OPE_NO_2)                                                             
     SELECT E1.LOT_ID, E1.PROD_ID, E1.PLAN_ID, E1.OPE_NO, E1.TARGET_PLAN_ID, E1.TARGET_OPE_NO                                                                   
            ,CASE WHEN (E1.PRE_EQP IS NULL OR E1.PRE_EQP = '') 
                  THEN E2.PRE_EQP                                                                                                       
                  WHEN (E1.PRE_EQP IS NOT NULL and E1.PRE_EQP <> '') 
                  THEN E1.PRE_EQP || (CASE WHEN (E2.PRE_EQP IS NOT NULL and E2.PRE_EQP <> '') THEN ';' || E2.PRE_EQP END)                                    
             END AS PRE_EQP                                                                                                                                     
            ,E1.OPE_NO_1, E2.OPE_NO_2                                                                                                                           
     FROM APS_TMP_ETL_WIP_PRE_EQP1 E1                                                                                                                          
     LEFT JOIN APS_TMP_ETL_WIP_PRE_EQP2 E2 ON E1.LOT_ID = E2.LOT_ID                                                                                            
                                           AND E1.PROD_ID = E2.PROD_ID                                                                                          
                                           AND E1.PLAN_ID = E2.PLAN_ID                                                                                          
                                           AND E1.OPE_NO = E2.OPE_NO                                                                                            
                                           AND E1.TARGET_PLAN_ID = E2.TARGET_PLAN_ID                                                                            
                                           AND E1.TARGET_OPE_NO = E2.TARGET_OPE_NO      
    """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_WIP_PREEQP",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_WIP_PREEQP")


def InsertParentToolFlag2TempTable(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    # 为了执行时间变少，先把V_WP_SPLIT_MERGE_DETAIL_HISTORY 过滤的条件单独拿出来
    sql = """
     INSERT /*+ append */ INTO APS_TMP_ETL_WIP_PARENT_TOOL_FLAG_PART3
     (FROM_OPE_NO, FROM_LOT, TO_LOT)                                                                                                           
     SELECT H.FROM_OPE_NO, H.FROM_LOT, H.TO_LOT                                                                                         
     FROM APS_SYNC_WP_SPLIT_MERGE_DETAIL_HISTORY.APS_SYNC_WP_SPLIT_MERGE_DETAIL_HISTORY H                                                              
     WHERE 1=1                                                                                                                          
     -- AND H.PARTCODE='"+ oldPartCode  + "'                                                                                               
     AND H.ACTION_IND = 'Split' 
    """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_WIP_PARENT_TOOL_FLAG_PART3",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_WIP_PARENT_TOOL_FLAG_PART3")

    sql = """
    INSERT /*+ append */ INTO APS_TMP_ETL_WIP_PARENT_TOOL_FLAG_PART1
     (PARENTID, LOT_ID, PROD_ID, PLAN_ID, STEP_ID, OPE_NO, TARGET_STEP_ID, TARGET_OPE_NO, TARGET_PLAN_ID, PARENT_TOOL_FLAG)
     SELECT W.PARENTID, W.LOT_ID, W.PROD_ID, W.PLAN_ID, W.STEP_ID, W.OPE_NO,                                                            
     W.TARGET_STEP_ID, W.TARGET_OPE_NO, W.TARGET_PLAN_ID, 'Y' AS PARENT_TOOL_FLAG                                                       
     FROM APS_TMP_ETL_WIP_PARENT_TOOL_FLAG_PART3 H     
     --modify by xiecheng for version up                                                                                    
     INNER JOIN APS_HANDLE_WIP W ON H.FROM_OPE_NO = W.TARGET_OPE_NO and
     (CASE WHEN W.LOT_ID = H.FROM_LOT THEN 1      
                  WHEN W.LOT_ID = H.TO_LOT THEN 1 
                 ELSE 0 END = 1)      
    """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_WIP_PARENT_TOOL_FLAG_PART1",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_WIP_PARENT_TOOL_FLAG_PART1")

    sql = """
    INSERT /*+ append */ INTO APS_TMP_ETL_WIP_PARENT_TOOL_FLAG_PART2
     (PARENTID, LOT_ID, PROD_ID, PLAN_ID, STEP_ID, OPE_NO, TARGET_STEP_ID, TARGET_OPE_NO, TARGET_PLAN_ID, PARENT_TOOL_FLAG)
     SELECT W.PARENTID, W.LOT_ID, W.PROD_ID, W.PLAN_ID, W.STEP_ID, W.OPE_NO,                                                            
     W.TARGET_STEP_ID, W.TARGET_OPE_NO, W.TARGET_PLAN_ID, 'Y' AS PARENT_TOOL_FLAG                                                       
     FROM APS_SYNC_RSSPLIT_INFO.APS_SYNC_RSSPLIT_INFO S                                                                               
     INNER JOIN APS_HANDLE_WIP W ON (S.LOT_MOTHER = W.LOT_ID OR S.LOT_SON = W.LOT_ID)                                         
                    AND S.SPLIT_OP_NO = W.TARGET_OPE_NO                                                                     
     WHERE 1=1                                                                                                                          
     --AND S.PARTCODE='"+ rsplitPartCode + "'                                                                                             
     AND S.LOT_MOTHER <> S.LOT_SON 
    """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_WIP_PARENT_TOOL_FLAG_PART2",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_WIP_PARENT_TOOL_FLAG_PART2")

    sql = """
    INSERT /*+ append */ INTO APS_TMP_ETL_WIP_PARENT_TOOL_FLAG                                                                             
     (PARENTID, LOT_ID, PROD_ID, PLAN_ID, STEP_ID, OPE_NO, TARGET_STEP_ID, TARGET_OPE_NO, TARGET_PLAN_ID, PARENT_TOOL_FLAG)
     SELECT W.PARENTID, W.LOT_ID, W.PROD_ID, W.PLAN_ID, W.STEP_ID, W.OPE_NO,                                                            
     W.TARGET_STEP_ID, W.TARGET_OPE_NO, W.TARGET_PLAN_ID, W.PARENT_TOOL_FLAG                                                            
     FROM APS_TMP_ETL_WIP_PARENT_TOOL_FLAG_PART1 W                                                                                          
     UNION                                                                                                                              
     SELECT W.PARENTID, W.LOT_ID, W.PROD_ID, W.PLAN_ID, W.STEP_ID, W.OPE_NO,                                                            
     W.TARGET_STEP_ID, W.TARGET_OPE_NO, W.TARGET_PLAN_ID, W.PARENT_TOOL_FLAG                                                            
     FROM APS_TMP_ETL_WIP_PARENT_TOOL_FLAG_PART2 W  
    """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_WIP_PARENT_TOOL_FLAG",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_WIP_PARENT_TOOL_FLAG")


def logFlowWip(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    sql = """
    INSERT /*+ append */ INTO APS_HANDLE_WIP_LOG
    SELECT * FROM APS_HANDLE_WIP_REPEAT
    """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_HANDLE_WIP_LOG",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_HANDLE_WIP_LOG")


def GetRetFlowWipData(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    sql = """
    INSERT INTO APS_ETL_WIP_HANDLE_RET_FLOW(                                                                  
         PARENTID,LOT_ID,STEP_ID,OPE_NO,TARGET_STEP_ID,TARGET_OPE_NO 
                    ,TARGET_TOOLG_ID,PRODG_ID,PRODG_TECH,PROD_ID,PLAN_ID 
                    ,TARGET_PLAN_ID,LOT_TYPE,FOUP_ID,QTY,PTY,SHR_FLAG,LOT_STATUS
                    ,ARRIVAL,LAYER,STAGE,TOOL_ID,RETICLE_ID,RECIPE,PPID,TRACK_IN  
                    ,PROCESS_START,TECH_ID,CUSTOMER,LOCATION,PARENT_LOT,FLOW_RECIPE 
                    ,CRITICAL_RATIO,HOLD_CODE,PRE_TOOL_ID,CREATE_TIME,JOB_PREPARE 
                    ,FAB_PHASE,TARGET_PROD_ID,FROM_STEP_ID,TO_STEP_ID,WHITE_FLAG
                    ,BATCH_ID,FROMBATCH_TIME,FROMBATCH_TOOL,TRANS_STATE,FOUP_STATION_ID,MULTI_GROUP,MULTI_TARGET_FLAG
                    ,REMAIN_QTIME, QTIME_STEP_ID_TO                                                                                       
         ) 
          WITH TOOL_DATA AS (
                SELECT DISTINCT EQP_G
                FROM APS_SYNC_ETL_TOOL.APS_SYNC_ETL_TOOL T 
                WHERE T.REAL_MODULE IN ('DIFF','WET')
          )                                                                                                     
          SELECT W.PARENTID                                                                                                                                    
                 ,W.LOT_ID                                                                                                       
                 ,W.STEP_ID                                                                                                      
                 ,W.OPE_NO                                                                                                       
                 ,CASE WHEN R.DZ = 2 THEN R.RETN_STEP_ID ELSE W.TARGET_STEP_ID END AS TARGET_STEP_ID                                 
                 ,CASE WHEN R.DZ = 2 THEN R.RETN_OPE_NO ELSE W.TARGET_OPE_NO END AS TARGET_OPE_NO                                
                 ,CASE WHEN R.DZ = 2 THEN R.TOOLG_ID ELSE W.TARGET_TOOLG_ID END AS TARGET_TOOLG_ID                                
                 ,W.PRODG_ID                                                                                                     
                 ,W.PRODG_TECH                                                                                                   
                 ,W.PROD_ID                                                                                                      
                 ,W.PLAN_ID                                                                                                      
                 ,CASE WHEN R.DZ = 2 THEN R.RETN_MAINPD_ID ELSE W.TARGET_PLAN_ID END AS TARGET_PLAN_ID                                   
                 ,W.LOT_TYPE                                                                                                     
                 ,W.FOUP_ID                                                                                                      
                 ,W.QTY                                                                                                          
                 ,W.PTY                                                                                                          
                 ,W.SHR_FLAG                                                                                                     
                 ,W.LOT_STATUS                                                                                                   
                 ,W.ARRIVAL                                                                                                      
                 ,W.LAYER                                                                                                        
                 ,W.STAGE                                                                                                        
                 ,W.TOOL_ID                                                                                                      
                 ,W.RETICLE_ID                                                                                                   
                 ,W.RECIPE                                                                                                       
                 ,W.PPID                                                                                                         
                 ,W.TRACK_IN                                                                                                     
                 ,W.PROCESS_START                                                                                                
                 ,W.TECH_ID                                                                                                      
                 ,W.CUSTOMER                                                                                                     
                 ,W.LOCATION                                                                                                     
                 ,W.PARENT_LOT                                                                                                   
                 ,W.FLOW_RECIPE                                                                                                  
                 ,W.CRITICAL_RATIO                                                                                               
                 ,W.HOLD_CODE                                                                                                    
                 ,W.PRE_TOOL_ID                                                                                                  
                 ,W.CREATE_TIME                                                                                                  
                 ,W.JOB_PREPARE                                                                                                  
                 ,W.FAB_PHASE                                                                                                    
                 ,W.TARGET_PROD_ID                                                                                               
                 ,CASE WHEN (R.LOT_ID IS NOT NULL and R.LOT_ID <> '') THEN COALESCE(R.STEP_ID,W.STEP_ID) ELSE W.FROM_STEP_ID END AS FROM_STEP_ID           
                 ,CASE WHEN (R.LOT_ID IS NOT NULL and R.LOT_ID <> '') THEN R.RETN_STEP_ID ELSE W.TO_STEP_ID END AS TO_STEP_ID                         
                 ,CASE WHEN T.EQP_G IS NOT NULL THEN W.WHITE_FLAG END AS WHITE_FLAG                                                                                                   
                 ,W.BATCH_ID                                                                                                     
                 ,W.FROMBATCH_TIME                                                                                               
                 ,W.FROMBATCH_TOOL                                                                                               
                 ,W.TRANS_STATE,W.FOUP_STATION_ID                                                                                
                 ,W.MULTI_GROUP,MULTI_TARGET_FLAG                                                                                
                 ,R.REMAIN_QTIME                                                                                                 
                 ,R.TARGET_STEP_ID AS QTIME_STEP_ID_TO                                                                           
          FROM APS_HANDLE_WIP_REPEAT W                                                                                                 
          LEFT JOIN APS_TMP_WIP_RET_FLOW_RESULT R                                                                                
          ON  W.LOT_ID = R.LOT_ID                                                                                                
          AND CASE WHEN position('DBY' in R.MAINPD_ID) = 0 AND W.TARGET_OPE_NO = R.OPE_NO THEN 1                                       
                   WHEN position('DBY' in R.MAINPD_ID) = 1 AND R.DZ = 1 AND  W.TARGET_OPE_NO = R.OPE_NO THEN 1                         
                   WHEN position('DBY' in R.MAINPD_ID) = 1 AND R.DZ = 2 AND  W.TARGET_OPE_NO = R.RETN_OPE_NO THEN 1                    
                   ELSE 0 END = 1
          LEFT JOIN TOOL_DATA T
         -- ON T.EQP_G = DECODE(R.DZ, 2, R.TOOLG_ID, W.TARGET_TOOLG_ID)
          ON CASE WHEN R.DZ = 2 AND T.EQP_G = R.TOOLG_ID THEN 1
               WHEN T.EQP_G = W.TARGET_TOOLG_ID THEN 1
               ELSE 0 END = 1                          
    """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_ETL_WIP_HANDLE_RET_FLOW",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_ETL_WIP_HANDLE_RET_FLOW")


def InsertFlowChange(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    # 将转flow基本设定信息插入到临时表：TMP_FLOW_ORDER_CHANGE
    sql = """
    INSERT /*+ append */ INTO TMP_FLOW_ORDER_CHANGE                               
     (CNT,CONVERT_TYPE,REACTION_FLAG,OBJECT_CAT,OBJECT_TYPE,OBJECT_NAME,OBJECT_ID, 
     OPE_NO,MAINPD_ID,PRODSPEC_ID,NEW_MAINPD_ID,NEW_OPE_NO,START_TIME,END_TIME
     )                                               
     WITH T1 AS                                                                          
      (SELECT COUNT(1) OVER(PARTITION BY OBJECT_ID, OPE_NO, MAINPD_ID) AS CNT,           
              CONVERT_TYPE,                                                              
              REACTION_FLAG,                                                             
              OBJECT_CAT,                                                                
              OBJECT_TYPE,                                                               
              OBJECT_NAME,                                                               
              CASE                                                                       
                 WHEN OBJECT_NAME = 'LotID' AND LENGTH(OBJECT_ID) > 0 THEN               
                     REPLACE(OBJECT_ID, '.', '')                                         
                 ELSE                                                                    
                     OBJECT_ID                                                           
                 END OBJECT_ID,                                                          
              OPE_NO,                                                                    
              MAINPD_ID,                                                                 
              PRODSPEC_ID,                                                               
              NEW_MAINPD_ID,                                                             
              NEW_OPE_NO,                                                                
              START_TIME,                                                                
              END_TIME                                                                   
         FROM APS_SYNC_FLOW_ORDER_CHANGE.APS_SYNC_FLOW_ORDER_CHANGE                       
         -- WHERE  PARTCODE='" + cfCode + "'
         WHERE  1=1                                                
        GROUP BY CONVERT_TYPE,                                                           
                 REACTION_FLAG,                                                          
                 OBJECT_CAT,                                                             
                 OBJECT_TYPE,                                                            
                 OBJECT_NAME,                                                            
                 OBJECT_ID,                                                              
                 OPE_NO,                                                                 
                 MAINPD_ID,                                                              
                 PRODSPEC_ID,                                                            
                 NEW_MAINPD_ID,                                                          
                 NEW_OPE_NO,                                                             
                 START_TIME,                                                             
                 END_TIME)                                                               
     SELECT *                                                                            
       FROM T1                                                                           
      WHERE CNT = 1                                                                      
        AND (OBJECT_NAME = 'LotID' OR                                                    
            (OBJECT_NAME = 'ProductID' AND REACTION_FLAG = 1))                           
        -- AND SYSDATE BETWEEN START_TIME AND END_TIME
        AND CURRENT_DATE BETWEEN START_TIME AND END_TIME
    """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into TMP_FLOW_ORDER_CHANGE",
                     sql=sql,
                     current_time=current_time,
                     update_table="TMP_FLOW_ORDER_CHANGE")

    # 将转flow的lot信息插入到临时表：TMP_APS_HANDLE_WIP中
    # 2023-03-23 将转flow拆分
    sql = """
    INSERT /*+ append */ INTO TMP_APS_HANDLE_WIP
     (
        PARENTID,LOT_ID,STEP_ID,OPE_NO,TARGET_STEP_ID,TARGET_OPE_NO,TARGET_TOOLG_ID 
        ,PRODG_ID,PRODG_TECH,PROD_ID,PLAN_ID,TARGET_PLAN_ID,LOT_TYPE,FOUP_ID,QTY
        ,PTY,SHR_FLAG,LOT_STATUS,ARRIVAL,LAYER,STAGE,TOOL_ID,RETICLE_ID
        ,RECIPE,PPID,TRACK_IN,PROCESS_START,TECH_ID,CUSTOMER,LOCATION
        ,PARENT_LOT,FLOW_RECIPE,CRITICAL_RATIO,HOLD_CODE,PRE_TOOL_ID
        ,CREATE_TIME,JOB_PREPARE,FAB_PHASE,TARGET_PROD_ID,FROM_STEP_ID
        ,TO_STEP_ID,ORIGINAL_TARGET_STEP_ID,WHITE_FLAG,BATCH_ID,MULTI_TARGET_FLAG,MULTI_GROUP
     )                                                         
     SELECT * FROM                                                                                                                             
     (WITH FROM_DATA1 AS                                                                                                                       
      (SELECT A.*,                                                                                                                             
              C.PROD_ID PROID,                                                                                                                 
              C.PLAN_ID ROUTE_ID,                                                                                                              
              C.STEP_ID STEPID,                                                                                                                
              C.OPE_NO OPENO,                                                                                                                  
              B.NEW_OPE_NO,                                                                                                                    
              LEAD(C.STEP_ID) OVER(PARTITION BY C.PROD_ID, C.PLAN_ID, A.LOT_ID, A.TARGET_STEP_ID ORDER BY C.STEP_ID) NEW_TARGET_STEPID,        
              A.TARGET_STEP_ID  ORIGINAL_TARGET_STEP_ID                                                                                        
         FROM APS_HANDLE_WIP A                                                                                                                 
         LEFT JOIN TMP_FLOW_ORDER_CHANGE B                                                                                           
           ON A.LOT_ID = B.OBJECT_ID                                                                                                           
          AND A.PLAN_ID = B.MAINPD_ID                                                                                                          
          AND A.OPE_NO = B.OPE_NO                                                                                                              
         LEFT JOIN APS_TMP_ETL_WIP_LAST_FLOW C                                                                                                 
           ON B.PRODSPEC_ID = C.PROD_ID                                                                                                        
          AND B.NEW_MAINPD_ID = C.PLAN_ID                                                                                                      
        WHERE  B.OBJECT_NAME = 'LotID'                                                                                                         
          AND B.OBJECT_CAT = 'MainPD'),                                                                                                        
     TO_DATA1 AS                                                                                                                               
      (SELECT A.*,                                                                                                                             
              C.PROD_ID PROID,                                                                                                                 
              C.PLAN_ID ROUTE_ID,                                                                                                              
              C.STEP_ID STEPID,                                                                                                                
              C.OPE_NO OPENO,                                                                                                                  
              B.NEW_OPE_NO,                                                                                                                    
              LEAD(C.STEP_ID) OVER(PARTITION BY C.PROD_ID, C.PLAN_ID, A.LOT_ID, A.TARGET_STEP_ID ORDER BY C.STEP_ID) NEW_TARGET_STEPID,        
              A.TARGET_STEP_ID  ORIGINAL_TARGET_STEP_ID                                                                                        
         FROM APS_HANDLE_WIP A                                                                                                                 
         LEFT JOIN TMP_FLOW_ORDER_CHANGE B                                                                                           
           ON A.LOT_ID = B.OBJECT_ID                                                                                                           
          AND A.PLAN_ID = B.MAINPD_ID                                                                                                          
          AND A.OPE_NO = B.OPE_NO                                                                                                              
         LEFT JOIN APS_TMP_ETL_WIP_LAST_FLOW C                                                                                                 
           ON B.PRODSPEC_ID = C.PROD_ID                                                                                                        
          AND B.NEW_MAINPD_ID = C.PLAN_ID                                                                                                      
        WHERE B.OBJECT_NAME = 'LotID'                                                                                                          
          AND B.OBJECT_CAT = 'MainPD')                                                                                                         
     SELECT T12.PARENTID,                                                                                                                      
            T12.LOT_ID,                                                                                                                        
            T12.STEP_ID,                                                                                                                       
            T12.OPE_NO,                                                                                                                        
            CASE                                                                                                                               
              WHEN T12.TARGET_STEP_ID = T12.STEP_ID THEN                                                                                       
               T12.TARGET_STEP_ID                                                                                                              
              ELSE                                                                                                                             
               T12.STEPID                                                                                                                      
            END TARGET_STEP_ID,                                                                                                                
            T12.TARGET_OPE_NO,                                                                                                                 
            T12.TARGET_TOOLG_ID,                                                                                                               
            T12.PRODG_ID,                                                                                                                      
            T12.PRODG_TECH,                                                                                                                    
            T12.PROD_ID,                                                                                                                       
            T12.PLAN_ID,                                                                                                                       
            CASE                                                                                                                               
              WHEN T12.TARGET_STEP_ID = T12.STEP_ID THEN                                                                                       
               T12.TARGET_PLAN_ID                                                                                                              
              ELSE                                                                                                                             
               T12.ROUTE_ID                                                                                                                    
            END TARGET_PLAN_ID,                                                                                                                
            T12.LOT_TYPE,                                                                                                                      
            T12.FOUP_ID,                                                                                                                       
            T12.QTY,                                                                                                                           
            T12.PTY,                                                                                                                           
            T12.SHR_FLAG,                                                                                                                      
            T12.LOT_STATUS,                                                                                                                    
            T12.ARRIVAL,                                                                                                                       
            T12.LAYER,                                                                                                                         
            T12.STAGE,                                                                                                                         
            T12.TOOL_ID,                                                                                                                       
            T12.RETICLE_ID,                                                                                                                    
            T12.RECIPE,                                                                                                                        
            T12.PPID,                                                                                                                          
            T12.TRACK_IN,                                                                                                                      
            T12.PROCESS_START,                                                                                                                 
            T12.TECH_ID,                                                                                                                       
            T12.CUSTOMER,                                                                                                                      
            T12.LOCATION,                                                                                                                      
            T12.PARENT_LOT,                                                                                                                    
            T12.FLOW_RECIPE,                                                                                                                   
            T12.CRITICAL_RATIO,                                                                                                                
            T12.HOLD_CODE,                                                                                                                     
            T12.PRE_TOOL_ID,                                                                                                                   
            T12.CREATE_TIME,                                                                                                                   
            T12.JOB_PREPARE,                                                                                                                   
            T12.FAB_PHASE,                                                                                                                     
            CASE                                                                                                                               
              WHEN T12.TARGET_STEP_ID = T12.STEP_ID THEN                                                                                       
               T12.PROD_ID                                                                                                                     
              ELSE                                                                                                                             
               T12.PROID                                                                                                                       
            END TARGET_PROD_ID,                                                                                                                
            T12.STEP_ID FROM_STEP_ID,                                                                                                          
            T11.STEPID TO_STEP_ID,                                                                                                             
            T12.ORIGINAL_TARGET_STEP_ID,                                                                                                       
            T12.WHITE_FLAG,                                                                                                                    
            T12.BATCH_ID,T12.MULTI_TARGET_FLAG,T12.MULTI_GROUP                                                                                 
     FROM TO_DATA1 T11                                                                                                                         
     JOIN FROM_DATA1 T12                                                                                                                       
     ON T11.OPENO = T11.NEW_OPE_NO                                                                                                             
     AND T12.OPENO = T12.TARGET_OPE_NO                                                                                                         
     WHERE T11.LOT_ID = T12.LOT_ID                                                                                                             
     AND T11.PROD_ID = T12.PROD_ID                                                                                                             
     AND T11.LAYER = T12.LAYER                                                                                                                 
     AND T11.STAGE = T12.STAGE                                                                                                                 
     AND T11.TARGET_STEP_ID = T12.TARGET_STEP_ID)  
    """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into TMP_APS_HANDLE_WIP",
                     sql=sql,
                     current_time=current_time,
                     update_table="TMP_APS_HANDLE_WIP")

    sql = """
    INSERT /*+ append */ INTO TMP_APS_HANDLE_WIP
     (
        PARENTID,LOT_ID,STEP_ID,OPE_NO,TARGET_STEP_ID,TARGET_OPE_NO,TARGET_TOOLG_ID
        ,PRODG_ID,PRODG_TECH,PROD_ID,PLAN_ID,TARGET_PLAN_ID,LOT_TYPE,FOUP_ID,QTY
        ,PTY,SHR_FLAG,LOT_STATUS,ARRIVAL,LAYER,STAGE,TOOL_ID,RETICLE_ID
        ,RECIPE,PPID,TRACK_IN,PROCESS_START,TECH_ID,CUSTOMER,LOCATION
        ,PARENT_LOT,FLOW_RECIPE,CRITICAL_RATIO,HOLD_CODE,PRE_TOOL_ID
        ,CREATE_TIME,JOB_PREPARE,FAB_PHASE,TARGET_PROD_ID,FROM_STEP_ID
        ,TO_STEP_ID,ORIGINAL_TARGET_STEP_ID,WHITE_FLAG,BATCH_ID,MULTI_TARGET_FLAG,MULTI_GROUP
     )
     SELECT * FROM                                                                                                                                                                                                                                                                                                
     (WITH D2 AS                                                                                                                           
      (SELECT A.*,                                                                                                                         
              C.PROD_ID PROID,                                                                                                             
              C.STEP_ID STEPID,                                                                                                            
              C.OPE_NO OPENO,                                                                                                              
              LEAD(C.STEP_ID) OVER(PARTITION BY C.PROD_ID, C.PLAN_ID, A.LOT_ID, A.TARGET_STEP_ID ORDER BY C.STEP_ID) NEXT_STEP_ID,         
              A.TARGET_STEP_ID  ORIGINAL_TARGET_STEP_ID                                                                                    
         FROM APS_HANDLE_WIP A                                                                                                             
         LEFT JOIN TMP_FLOW_ORDER_CHANGE B                                                                                       
           ON A.LOT_ID =B.OBJECT_ID                                                                                                        
          AND A.PLAN_ID = B.MAINPD_ID                                                                                                      
          AND A.OPE_NO = B.OPE_NO                                                                                                          
         LEFT JOIN APS_TMP_ETL_WIP_LAST_FLOW C                                                                                             
           ON B.PRODSPEC_ID = C.PROD_ID                                                                                                    
          AND B.MAINPD_ID = C.PLAN_ID                                                                                                      
        WHERE B.OBJECT_NAME = 'LotID'                                                                                                      
          AND B.OBJECT_CAT = 'Product')                                                                                                    
     SELECT PARENTID,                                                                                                                      
            LOT_ID,                                                                                                                        
            STEP_ID,                                                                                                                       
            OPE_NO,                                                                                                                        
            TARGET_STEP_ID,                                                                                                                
            TARGET_OPE_NO,                                                                                                                 
            TARGET_TOOLG_ID,                                                                                                               
            PRODG_ID,                                                                                                                      
            PRODG_TECH,                                                                                                                    
            PROD_ID,                                                                                                                       
            PLAN_ID,                                                                                                                       
            TARGET_PLAN_ID,                                                                                                                
            LOT_TYPE,                                                                                                                      
            FOUP_ID,                                                                                                                       
            QTY,                                                                                                                           
            PTY,                                                                                                                           
            SHR_FLAG,                                                                                                                      
            LOT_STATUS,                                                                                                                    
            ARRIVAL,                                                                                                                       
            LAYER,                                                                                                                         
            STAGE,                                                                                                                         
            TOOL_ID,                                                                                                                       
            RETICLE_ID,                                                                                                                    
            RECIPE,                                                                                                                        
            PPID,                                                                                                                          
            TRACK_IN,                                                                                                                      
            PROCESS_START,                                                                                                                 
            TECH_ID,                                                                                                                       
            CUSTOMER,                                                                                                                      
            LOCATION,                                                                                                                      
            PARENT_LOT,                                                                                                                    
            FLOW_RECIPE,                                                                                                                   
            CRITICAL_RATIO,                                                                                                                
            HOLD_CODE,                                                                                                                     
            PRE_TOOL_ID,                                                                                                                   
            CREATE_TIME,                                                                                                                   
            JOB_PREPARE,                                                                                                                   
            FAB_PHASE,                                                                                                                     
            CASE                                                                                                                           
              WHEN STEPID <= TARGET_STEP_ID THEN                                                                                           
               PROD_ID                                                                                                                     
              ELSE                                                                                                                         
               PROID                                                                                                                       
            END TARGET_PROD_ID,                                                                                                            
            STEPID FROM_STEP_ID,                                                                                                           
            NEXT_STEP_ID TO_STEP_ID,                                                                                                       
            ORIGINAL_TARGET_STEP_ID,                                                                                                       
            WHITE_FLAG,                                                                                                                    
            BATCH_ID,MULTI_TARGET_FLAG,MULTI_GROUP                                                                                         
     FROM D2                                                                                                                               
     WHERE OPE_NO = OPENO)   
    """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into TMP_APS_HANDLE_WIP",
                     sql=sql,
                     current_time=current_time,
                     update_table="TMP_APS_HANDLE_WIP")

    sql = """
    INSERT /*+ append */ INTO TMP_APS_HANDLE_WIP
     (
        PARENTID,LOT_ID,STEP_ID,OPE_NO,TARGET_STEP_ID,TARGET_OPE_NO,TARGET_TOOLG_ID
        ,PRODG_ID,PRODG_TECH,PROD_ID,PLAN_ID,TARGET_PLAN_ID,LOT_TYPE,FOUP_ID,QTY
        ,PTY,SHR_FLAG,LOT_STATUS,ARRIVAL,LAYER,STAGE,TOOL_ID,RETICLE_ID
        ,RECIPE,PPID,TRACK_IN,PROCESS_START,TECH_ID,CUSTOMER,LOCATION
        ,PARENT_LOT,FLOW_RECIPE,CRITICAL_RATIO,HOLD_CODE,PRE_TOOL_ID
        ,CREATE_TIME,JOB_PREPARE,FAB_PHASE,TARGET_PROD_ID,FROM_STEP_ID
        ,TO_STEP_ID,ORIGINAL_TARGET_STEP_ID,WHITE_FLAG,BATCH_ID,MULTI_TARGET_FLAG,MULTI_GROUP
     )                                                       
     SELECT * FROM (                                                                                                                    
      WITH D3 AS                                                                                                                        
      (SELECT A.*,                                                                                                                      
              C.PROD_ID PROID,                                                                                                          
              C.STEP_ID STEPID,                                                                                                         
              C.OPE_NO OPENO,                                                                                                           
              LEAD(C.STEP_ID) OVER(PARTITION BY C.PROD_ID, C.PLAN_ID, A.LOT_ID, A.TARGET_STEP_ID ORDER BY C.STEP_ID) NEXT_STEP_ID,      
              A.TARGET_STEP_ID  ORIGINAL_TARGET_STEP_ID                                                                                 
         FROM APS_HANDLE_WIP A                                                                                                          
         LEFT JOIN TMP_FLOW_ORDER_CHANGE B                                                                                    
           ON A.PROD_ID = B.OBJECT_ID                                                                                                   
          AND A.PLAN_ID = B.MAINPD_ID                                                                                                   
          AND A.OPE_NO = B.OPE_NO                                                                                                       
         LEFT JOIN APS_TMP_ETL_WIP_LAST_FLOW C                                                                                          
           ON B.PRODSPEC_ID = C.PROD_ID                                                                                                 
          AND B.MAINPD_ID = C.PLAN_ID                                                                                                   
        WHERE B.OBJECT_NAME = 'ProductID'                                                                                               
          AND B.OBJECT_CAT = 'Product')                                                                                                 
     SELECT PARENTID,                                                                                                                   
            LOT_ID,                                                                                                                     
            STEP_ID,                                                                                                                    
            OPE_NO,                                                                                                                     
            TARGET_STEP_ID,                                                                                                             
            TARGET_OPE_NO,                                                                                                              
            TARGET_TOOLG_ID,                                                                                                            
            PRODG_ID,                                                                                                                   
            PRODG_TECH,                                                                                                                 
            PROD_ID,                                                                                                                    
            PLAN_ID,                                                                                                                    
            TARGET_PLAN_ID,                                                                                                             
            LOT_TYPE,                                                                                                                   
            FOUP_ID,                                                                                                                    
            QTY,                                                                                                                        
            PTY,                                                                                                                        
            SHR_FLAG,                                                                                                                   
            LOT_STATUS,                                                                                                                 
            ARRIVAL,                                                                                                                    
            LAYER,                                                                                                                      
            STAGE,                                                                                                                      
            TOOL_ID,                                                                                                                    
            RETICLE_ID,                                                                                                                 
            RECIPE,                                                                                                                     
            PPID,                                                                                                                       
            TRACK_IN,                                                                                                                   
            PROCESS_START,                                                                                                              
            TECH_ID,                                                                                                                    
            CUSTOMER,                                                                                                                   
            LOCATION,                                                                                                                   
            PARENT_LOT,                                                                                                                 
            FLOW_RECIPE,                                                                                                                
            CRITICAL_RATIO,                                                                                                             
            HOLD_CODE,                                                                                                                  
            PRE_TOOL_ID,                                                                                                                
            CREATE_TIME,                                                                                                                
            JOB_PREPARE,                                                                                                                
            FAB_PHASE,                                                                                                                  
            CASE                                                                                                                        
              WHEN STEP_ID = TARGET_STEP_ID THEN                                                                                        
               PROD_ID                                                                                                                  
              ELSE                                                                                                                      
               PROID                                                                                                                    
            END TARGET_PROD_ID,                                                                                                         
            STEPID FROM_STEP_ID,                                                                                                        
            NEXT_STEP_ID TO_STEP_ID,                                                                                                    
            ORIGINAL_TARGET_STEP_ID,                                                                                                    
            WHITE_FLAG,                                                                                                                 
            BATCH_ID,MULTI_TARGET_FLAG,MULTI_GROUP                                                                                      
     FROM D3                                                                                                                            
     WHERE OPE_NO = OPENO)  
    """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into TMP_APS_HANDLE_WIP",
                     sql=sql,
                     current_time=current_time,
                     update_table="TMP_APS_HANDLE_WIP")

    sql = """
    INSERT /*+ append */ INTO TMP_APS_HANDLE_WIP
     (
        PARENTID,LOT_ID,STEP_ID,OPE_NO,TARGET_STEP_ID,TARGET_OPE_NO,TARGET_TOOLG_ID
        ,PRODG_ID,PRODG_TECH,PROD_ID,PLAN_ID,TARGET_PLAN_ID,LOT_TYPE,FOUP_ID,QTY
        ,PTY,SHR_FLAG,LOT_STATUS,ARRIVAL,LAYER,STAGE,TOOL_ID,RETICLE_ID
        ,RECIPE,PPID,TRACK_IN,PROCESS_START,TECH_ID,CUSTOMER,LOCATION
        ,PARENT_LOT,FLOW_RECIPE,CRITICAL_RATIO,HOLD_CODE,PRE_TOOL_ID
        ,CREATE_TIME,JOB_PREPARE,FAB_PHASE,TARGET_PROD_ID,FROM_STEP_ID
        ,TO_STEP_ID,ORIGINAL_TARGET_STEP_ID,WHITE_FLAG,BATCH_ID,MULTI_TARGET_FLAG,MULTI_GROUP
     )                                            
     SELECT * FROM (                                                             
      WITH CURRENT_WORKSTATION AS                                                
      (SELECT A.*,                                                               
              C.PROD_ID    PROID,                                                
              C.PLAN_ID    ROUTE_ID,                                             
              C.STEP_ID    STEPID,                                               
              C.OPE_NO     OPENO,                                                
              B.NEW_OPE_NO,                                                      
              A.TARGET_STEP_ID  ORIGINAL_TARGET_STEP_ID                          
         FROM APS_HANDLE_WIP A                                                   
         LEFT JOIN TMP_FLOW_ORDER_CHANGE B                             
           ON A.PROD_ID = B.OBJECT_ID                                            
          AND A.PLAN_ID = B.MAINPD_ID                                            
          AND A.OPE_NO = B.OPE_NO                                                
         LEFT JOIN APS_TMP_ETL_WIP_LAST_FLOW C                                   
           ON B.PRODSPEC_ID = C.PROD_ID                                          
          AND B.NEW_MAINPD_ID = C.PLAN_ID                                        
        WHERE  B.OBJECT_NAME = 'ProductID'                                       
          AND B.OBJECT_CAT = 'MainPD'),                                          
     TARGET_WORKSTATION AS                                                       
      (SELECT A.*,                                                               
              C.PROD_ID    PROID,                                                
              C.PLAN_ID    ROUTE_ID,                                             
              C.STEP_ID    STEPID,                                               
              C.OPE_NO     OPENO,                                                
              B.NEW_OPE_NO,                                                      
              A.TARGET_STEP_ID  ORIGINAL_TARGET_STEP_ID                          
         FROM APS_HANDLE_WIP A                                                   
         LEFT JOIN TMP_FLOW_ORDER_CHANGE B                             
           ON A.PROD_ID = B.OBJECT_ID                                            
          AND A.PLAN_ID = B.MAINPD_ID                                            
          AND A.OPE_NO = B.OPE_NO                                                
         LEFT JOIN APS_TMP_ETL_WIP_LAST_FLOW C                                   
           ON B.PRODSPEC_ID = C.PROD_ID                                          
          AND B.NEW_MAINPD_ID = C.PLAN_ID                                        
        WHERE  B.OBJECT_NAME = 'ProductID'                                       
          AND B.OBJECT_CAT = 'MainPD')                                           
     SELECT   T5.PARENTID,                                                       
            T5.LOT_ID,                                                           
            T5.STEP_ID,                                                          
            T5.OPE_NO,                                                           
            T5.TARGET_STEP_ID,                                                   
            T5.TARGET_OPE_NO,                                                    
            T5.TARGET_TOOLG_ID,                                                  
            T5.PRODG_ID,                                                         
            T5.PRODG_TECH,                                                       
            T5.PROD_ID,                                                          
            T5.PLAN_ID,                                                          
            T5.TARGET_PLAN_ID,                                                   
            T5.LOT_TYPE,                                                         
            T5.FOUP_ID,                                                          
            T5.QTY,                                                              
            T5.PTY,                                                              
            T5.SHR_FLAG,                                                         
            T5.LOT_STATUS,                                                       
            T5.ARRIVAL,                                                          
            T5.LAYER,                                                            
            T5.STAGE,                                                            
            T5.TOOL_ID,                                                          
            T5.RETICLE_ID,                                                       
            T5.RECIPE,                                                           
            T5.PPID,                                                             
            T5.TRACK_IN,                                                         
            T5.PROCESS_START,                                                    
            T5.TECH_ID,                                                          
            T5.CUSTOMER,                                                         
            T5.LOCATION,                                                         
            T5.PARENT_LOT,                                                       
            T5.FLOW_RECIPE,                                                      
            T5.CRITICAL_RATIO,                                                   
            T5.HOLD_CODE,                                                        
            T5.PRE_TOOL_ID,                                                      
            T5.CREATE_TIME,                                                      
            T5.JOB_PREPARE,                                                      
            T5.FAB_PHASE,                                                        
            CASE                                                                 
              WHEN T5.TARGET_STEP_ID <= T5.STEPID THEN                           
               T5.PROD_ID                                                        
              ELSE                                                               
               T5.PROID                                                          
            END TARGET_PROD_ID,                                                  
            T5.STEPID FROM_STEP_ID,                                              
            T4.STEPID AS TO_STEP_ID,                                             
            T5.ORIGINAL_TARGET_STEP_ID,                                          
            T5.WHITE_FLAG,                                                       
            T5.BATCH_ID,T5.MULTI_TARGET_FLAG,T5.MULTI_GROUP                      
     FROM TARGET_WORKSTATION T4                                                  
     JOIN CURRENT_WORKSTATION T5                                                 
     ON T4.LOT_ID = T5.LOT_ID                                                    
     AND T4.PROD_ID = T5.PROD_ID                                                 
     AND T4.LAYER = T5.LAYER                                                     
     AND T4.STAGE = T5.STAGE                                                     
     AND T4.TARGET_STEP_ID = T5.TARGET_STEP_ID                                   
     WHERE T5.OPE_NO = T5.OPENO                                                  
     AND T4.NEW_OPE_NO = T4.OPENO) 
    """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into TMP_APS_HANDLE_WIP",
                     sql=sql,
                     current_time=current_time,
                     update_table="TMP_APS_HANDLE_WIP")

    # 暂存APS_HANDLE_WIP到TMP_APS_HANDLE_WIP_V表，便于与转flow的APS_HANDLE_WIP表lot并表
    sql = """
    INSERT /*+ append */ INTO TMP_APS_HANDLE_WIP_V
    (
        PARENTID,LOT_ID,STEP_ID,OPE_NO,TARGET_STEP_ID,TARGET_OPE_NO
        ,TARGET_TOOLG_ID,PRODG_ID,PRODG_TECH,PROD_ID,PLAN_ID
        ,TARGET_PLAN_ID,LOT_TYPE,FOUP_ID,QTY,PTY,SHR_FLAG,LOT_STATUS
        ,ARRIVAL,LAYER,STAGE,TOOL_ID,RETICLE_ID,RECIPE,PPID,TRACK_IN
        ,PROCESS_START,TECH_ID,CUSTOMER,LOCATION,PARENT_LOT,FLOW_RECIPE
        ,CRITICAL_RATIO,HOLD_CODE,PRE_TOOL_ID,CREATE_TIME,JOB_PREPARE
        ,FAB_PHASE,TARGET_PROD_ID,FROM_STEP_ID,TO_STEP_ID,WHITE_FLAG
        ,BATCH_ID,FROMBATCH_TIME,FROMBATCH_TOOL,TRANS_STATE,FOUP_STATION_ID,MULTI_GROUP,MULTI_TARGET_FLAG
    ) SELECT  PARENTID,LOT_ID,STEP_ID,OPE_NO,TARGET_STEP_ID,TARGET_OPE_NO
        ,TARGET_TOOLG_ID,PRODG_ID,PRODG_TECH,PROD_ID,PLAN_ID
        ,TARGET_PLAN_ID,LOT_TYPE,FOUP_ID,QTY,PTY,SHR_FLAG,LOT_STATUS
        ,ARRIVAL,LAYER,STAGE,TOOL_ID,RETICLE_ID,RECIPE,PPID,TRACK_IN
        ,PROCESS_START,TECH_ID,CUSTOMER,LOCATION,PARENT_LOT,FLOW_RECIPE
        ,CRITICAL_RATIO,HOLD_CODE,PRE_TOOL_ID,CREATE_TIME,JOB_PREPARE
        ,FAB_PHASE,TARGET_PROD_ID,FROM_STEP_ID,TO_STEP_ID,WHITE_FLAG
        ,BATCH_ID,FROMBATCH_TIME,FROMBATCH_TOOL,TRANS_STATE,FOUP_STATION_ID,MULTI_GROUP,MULTI_TARGET_FLAG FROM APS_HANDLE_WIP
    """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into TMP_APS_HANDLE_WIP_V",
                     sql=sql,
                     current_time=current_time,
                     update_table="TMP_APS_HANDLE_WIP_V")

    # 删除APS_HANDLE_WIP_REPEAT表信息，将转flow信息重新插入到APS_HANDLE_WIP_REPEAT
    sql = """
    INSERT /*+ append */ INTO APS_HANDLE_WIP_REPEAT
     (
        PARENTID,LOT_ID,STEP_ID,OPE_NO,TARGET_STEP_ID,TARGET_OPE_NO
        ,TARGET_TOOLG_ID,PRODG_ID,PRODG_TECH,PROD_ID,PLAN_ID
        ,TARGET_PLAN_ID,LOT_TYPE,FOUP_ID,QTY,PTY,SHR_FLAG,LOT_STATUS
        ,ARRIVAL,LAYER,STAGE,TOOL_ID,RETICLE_ID,RECIPE,PPID,TRACK_IN
        ,PROCESS_START,TECH_ID,CUSTOMER,LOCATION,PARENT_LOT,FLOW_RECIPE
        ,CRITICAL_RATIO,HOLD_CODE,PRE_TOOL_ID,CREATE_TIME,JOB_PREPARE
        ,FAB_PHASE,TARGET_PROD_ID,FROM_STEP_ID,TO_STEP_ID,WHITE_FLAG
        ,BATCH_ID,FROMBATCH_TIME,FROMBATCH_TOOL,TRANS_STATE,FOUP_STATION_ID,MULTI_GROUP,MULTI_TARGET_FLAG
     )                                                  
     select distinct A.parentid,                                                          
          A.lot_id,                                                                       
          A.step_id,                                                                      
          A.ope_no,                                                                       
          CASE                                                                            
            WHEN (B.FROM_STEP_ID IS NOT NULL and B.FROM_STEP_ID <> '') 
                AND (B.TO_STEP_ID IS NOT NULL and B.TO_STEP_ID <> '') 
            THEN             
             B.TARGET_STEP_ID                                                             
            ELSE                                                                          
             A.TARGET_STEP_ID                                                             
          END TARGET_STEP_ID,                                                             
          A.target_ope_no,                                                                
          A.target_toolg_id,                                                              
          A.prodg_id,                                                                     
          A.prodg_tech,                                                                   
          A.prod_id,                                                                      
          A.plan_id,                                                                      
          CASE                                                                            
              WHEN (B.FROM_STEP_ID IS NOT NULL and B.FROM_STEP_ID <> '') 
                AND (B.TO_STEP_ID IS NOT NULL and B.TO_STEP_ID <> '') 
            THEN             
             B.target_plan_id                                                             
            ELSE                                                                          
             A.target_plan_id                                                             
          END target_plan_id,                                                             
          A.lot_type,                                                                     
          A.foup_id,                                                                      
          A.qty,                                                                          
          A.pty,                                                                          
          A.shr_flag,                                                                     
          A.lot_status,                                                                   
          A.arrival,                                                                      
          A.layer,                                                                        
          A.stage,                                                                        
          A.tool_id,                                                                      
          A.reticle_id,                                                                   
          A.recipe,                                                                       
          A.ppid,                                                                         
          A.track_in,                                                                     
          A.process_start,                                                                
          A.tech_id,                                                                      
          A.customer,                                                                     
          A.location,                                                                     
          A.parent_lot,                                                                   
          A.flow_recipe,                                                                  
          A.critical_ratio,                                                               
          A.hold_code,                                                                    
          A.pre_tool_id,                                                                  
          A.create_time,                                                                  
          A.job_prepare,                                                                  
          A.fab_phase,                                                                    
          -- NVL(B.TARGET_PROD_ID, A.PROD_ID) TARGET_PROD_ID,                                
          COALESCE(B.TARGET_PROD_ID, A.PROD_ID) TARGET_PROD_ID,
          B.from_step_id,                                                                 
          B.to_step_id,                                                                   
          A.white_flag,                                                                   
          A.batch_id,                                                                     
          A.FROMBATCH_TIME,                                                               
          A.FROMBATCH_TOOL,                                                               
          A.TRANS_STATE,                                                                  
          A.FOUP_STATION_ID,A.MULTI_GROUP,A.MULTI_TARGET_FLAG                             
     from TMP_APS_HANDLE_WIP_V A                                                          
     LEFT JOIN TMP_APS_HANDLE_WIP B                                                       
     ON A.LOT_ID = B.LOT_ID                                                               
     AND A.PROD_ID = B.PROD_ID                                                            
     AND A.PLAN_ID = B.PLAN_ID                                                            
     AND A.OPE_NO = B.OPE_NO                                                              
     AND A.STEP_ID = B.STEP_ID                                                            
     AND A.TARGET_STEP_ID = original_target_step_id 
    """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_HANDLE_WIP_REPEAT",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_HANDLE_WIP_REPEAT")

    # 记录log监控转flow导致主键冲突的问题
    logFlowWip(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name)
    # 特殊Flow Lot回归站点需求的逻辑加进来
    GetRetFlowWipData(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name)
    # 防止出现主键冲突的问题
    # APS_HANDLE_WIP_REPEAT重新插入到APS_HANDLE_WIP
    sql = """
    TRUNCATE TABLE APS_HANDLE_WIP
    """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="TRUNCATE  APS_HANDLE_WIP",
                     sql=sql,
                     current_time=current_time)

    sql = """
    INSERT /*+ append */ INTO APS_HANDLE_WIP                       
     (
        PARENTID,LOT_ID,STEP_ID,OPE_NO,TARGET_STEP_ID,TARGET_OPE_NO
        ,TARGET_TOOLG_ID,PRODG_ID,PRODG_TECH,PROD_ID,PLAN_ID
        ,TARGET_PLAN_ID,LOT_TYPE,FOUP_ID,QTY,PTY,SHR_FLAG,LOT_STATUS
        ,ARRIVAL,LAYER,STAGE,TOOL_ID,RETICLE_ID,RECIPE,PPID,TRACK_IN
        ,PROCESS_START,TECH_ID,CUSTOMER,LOCATION,PARENT_LOT,FLOW_RECIPE
        ,CRITICAL_RATIO,HOLD_CODE,PRE_TOOL_ID,CREATE_TIME,JOB_PREPARE
        ,FAB_PHASE,TARGET_PROD_ID,FROM_STEP_ID,TO_STEP_ID,WHITE_FLAG
        ,BATCH_ID,FROMBATCH_TIME,FROMBATCH_TOOL,TRANS_STATE,FOUP_STATION_ID,MULTI_GROUP,MULTI_TARGET_FLAG
     )                                            
      WITH ALL_DATA AS (                                                                                                                                  
            SELECT W.*                                                                                                                                    
            ,ROW_NUMBER() OVER(PARTITION BY W.LOT_ID, W.TARGET_PLAN_ID, W.TARGET_STEP_ID ORDER BY W.TARGET_STEP_ID) AS RN1
            FROM  APS_HANDLE_WIP_REPEAT  W                                                                                                                
      )                                                                                                                                                   
      SELECT	W.PARENTID                                        
        ,W.LOT_ID                                                 
        ,W.STEP_ID                                                
        ,W.OPE_NO                                                 
        ,W.TARGET_STEP_ID                                         
        ,W.TARGET_OPE_NO                                          
        ,W.TARGET_TOOLG_ID                                        
        ,W.PRODG_ID                                               
        ,W.PRODG_TECH                                             
        ,W.PROD_ID                                                
        ,W.PLAN_ID                                                
        ,W.TARGET_PLAN_ID                                         
        ,W.LOT_TYPE                                               
        ,W.FOUP_ID                                                
        ,W.QTY                                                    
        ,W.PTY                                                    
        ,W.SHR_FLAG                                               
        ,W.LOT_STATUS                                             
        ,W.ARRIVAL                                                
        ,W.LAYER                                                  
        ,W.STAGE                                                  
        ,W.TOOL_ID                                                
        ,W.RETICLE_ID                                             
        ,W.RECIPE                                                 
        ,W.PPID                                                   
        ,W.TRACK_IN                                               
        ,W.PROCESS_START                                          
        ,W.TECH_ID                                                
        ,W.CUSTOMER                                               
        ,W.LOCATION                                               
        ,W.PARENT_LOT                                             
        ,W.FLOW_RECIPE                                            
        ,W.CRITICAL_RATIO                                         
        ,W.HOLD_CODE                                              
        ,W.PRE_TOOL_ID                                            
        ,W.CREATE_TIME                                            
        ,W.JOB_PREPARE                                            
        ,W.FAB_PHASE                                              
        ,W.TARGET_PROD_ID                                         
        ,W.FROM_STEP_ID                                           
        ,W.TO_STEP_ID                                             
        ,W.WHITE_FLAG                                             
        ,W.BATCH_ID                                               
        ,W.FROMBATCH_TIME                                         
        ,W.FROMBATCH_TOOL                                         
        ,W.TRANS_STATE,W.FOUP_STATION_ID                          
        ,W.MULTI_GROUP,MULTI_TARGET_FLAG                          
       FROM ALL_DATA W                                            
       WHERE W.RN1 = 1   
    """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_HANDLE_WIP",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_HANDLE_WIP")


def getFutureHoldByMeasureData(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    sql = """
    INSERT INTO APS_TMP_ETL_WIP_FUTURE_HOLD_MS (                  
        LOT_ID,OPE_NO,PRODSPEC_ID,MAINPD_ID,WIP_OPE_NO,HOLD_TYPE
    )                                                                
     WITH F_DATE AS(                                                                                   
         SELECT DISTINCT F.LOT_ID,F.OPE_NO,                                                         
           W.PRODSPEC_ID, W.MAINPD_ID, W.OPE_NO AS WIP_OPE_NO, 
            REPLACE(F.HOLD_TYPE,'MergeHold','FutureMerge') AS HOLD_TYPE                               
         FROM APS_SYNC_FRLOT_FUTUREHOLD.APS_SYNC_FRLOT_FUTUREHOLD F 
         INNER JOIN APS_SYNC_WIP.APS_SYNC_WIP W     
         ON W.LOT_ID = F.LOT_ID                                        
         WHERE F.HOLD_TYPE IN ('FutureHold','MergeHold')                                              
          AND F.OPE_NO <> W.OPE_NO                                                       
     )                                                                                               
     SELECT F.LOT_ID,F.OPE_NO,                                                       
            MAX(F.PRODSPEC_ID) AS PRODSPEC_ID,                                       
            MAX(F.MAINPD_ID) AS MAINPD_ID,                                           
            MAX(F.WIP_OPE_NO) AS WIP_OPE_NO,                                         
            GROUP_CONCAT(F.HOLD_TYPE,';') AS HOLD_TYPE                       
       FROM F_DATE F                                                                                
       GROUP BY F.LOT_ID,F.OPE_NO   
    """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_WIP_FUTURE_HOLD_MS",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_WIP_FUTURE_HOLD_MS")


def getFutureHoldByMeasureResultData(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    sql = """
      INSERT INTO APS_TMP_ETL_WIP_FUTURE_HOLD_MR(                                         
         LOT_ID,TARGET_STEP_ID,LOT_STATUS                                                                             
        )                                                                                           
         WITH SOURCE_DATA AS (                                                                                                         
              SELECT DISTINCT D.LOT_ID,F.STEP_ID,                                                  
                     F1.STEP_ID AS WIP_STEP_ID,                                                    
                     D.HOLD_TYPE                                                                   
              FROM APS_TMP_ETL_WIP_FUTURE_HOLD_MS D                                                
              INNER JOIN APS_TMP_ETL_WIP_LAST_FLOW F                                                   
              ON F.PLAN_ID = D.MAINPD_ID                                                           
              AND F.PROD_ID = D.PRODSPEC_ID                                                        
              AND F.OPE_NO = D.OPE_NO                                                              
              INNER JOIN APS_TMP_ETL_WIP_LAST_FLOW F1                                                  
              ON F1.PLAN_ID = D.MAINPD_ID                                                          
              AND F1.PROD_ID = D.PRODSPEC_ID                                                       
              AND F1.OPE_NO = D.WIP_OPE_NO                                                         
         ),                                                                                        
         RESULT_DATA AS (                                                                          
             SELECT D.LOT_ID,                                                                      
                    D.STEP_ID,                                                                     
                    D.WIP_STEP_ID,                                                                 
                    D.HOLD_TYPE,                                                                   
                    ROW_NUMBER() OVER (PARTITION BY D.LOT_ID ORDER BY D.STEP_ID) AS ROW_NUM        
             FROM SOURCE_DATA D                                                                    
             WHERE D.STEP_ID >= D.WIP_STEP_ID                                                      
         )                                                                                         
         SELECT D.LOT_ID,                                                                          
                D.STEP_ID,                                                                         
                D.HOLD_TYPE                                                                        
         FROM RESULT_DATA D                                                                        
         WHERE ROW_NUM = 1                                                                         
    """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_WIP_FUTURE_HOLD_MR",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_WIP_FUTURE_HOLD_MR")

def getVirtQtimeSpecSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    sql = """
       INSERT  /*+ append */  INTO APS_TMP_ETL_WIP_CONSTRAINT_V1 (
           PRODSPEC_ID,FLOW_KEY, FROM_OPE_NO, FROM_OPE_SEQ, TO_OPE_NO,TO_OPE_SEQ,QTIME_LIMIT)  
            WITH QTIME_DATA AS (                                                                
                SELECT F.PROD_ID,F.PLAN_ID,                                                     
                       S.FORM_OPER_NO,                                                          
                       S.TO_OPER_NO,                                                            
                       CASE WHEN F.OPE_NO = S.FORM_OPER_NO THEN F.STEP_ID END AS STEP_ID_FROM,  
                       CASE WHEN F.OPE_NO = S.TO_OPER_NO THEN F.STEP_ID END AS STEP_ID_TO,      
                       S.QTIME_SPEC AS TIMELIMIT                                                
                FROM APS_SYNC_VIRT_QT_SETTING.APS_SYNC_VIRT_QT_SETTING S                         
                INNER JOIN APS_TMP_ETL_WIP_LAST_FLOW F                                              
                ON 1 = 1                                                                        
                AND F.PRODG_TECH LIKE REPLACE(S.TECH,'*','%')                                   
                AND F.PROD_ID LIKE REPLACE(S.PRODUCT_ID,'*','%')                                
                AND F.PRODG_ID LIKE REPLACE(S.PRODG,'*','%')                                    
                AND (CASE WHEN F.OPE_NO = S.TO_OPER_NO THEN 1                                   
                          WHEN F.OPE_NO = S.FORM_OPER_NO THEN 1                                 
                          ELSE 0 END = 1)                                                       
                WHERE S.QTIME_SPEC IS NOT NULL                                                  
               -- AND S.PARTCODE = '" + partCodeList.get("virtQtime") + "'                        
            ),                                                                                  
            RESULT_DATA AS(                                                                     
                SELECT PROD_ID,PLAN_ID,                                                         
                       MAX(FORM_OPER_NO) AS FORM_OPER_NO,                                       
                       MAX(TO_OPER_NO) AS TO_OPER_NO,                                           
                       MAX(STEP_ID_FROM) AS STEP_ID_FROM,                                       
                       MAX(STEP_ID_TO) AS STEP_ID_TO,                                           
                       TIMELIMIT                                                                
                 FROM QTIME_DATA                                                                
                 GROUP BY PROD_ID,PLAN_ID,TIMELIMIT                                             
            )                                                                                   
            SELECT                                                                               
                   PROD_ID,PLAN_ID,                                                             
                   FORM_OPER_NO,                                                                
                   STEP_ID_FROM,                                                                
                   TO_OPER_NO,                                                                    
                   STEP_ID_TO,                                                                  
                   TIMELIMIT                                                                    
            FROM  RESULT_DATA                                                                   
            WHERE STEP_ID_FROM IS NOT NULL                                                      
                 AND STEP_ID_TO IS NOT NULL                                                     
                 AND STEP_ID_FROM < STEP_ID_TO                                                                          
    """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_WIP_CONSTRAINT_V1_2",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_WIP_CONSTRAINT_V1")


def getAllQtimeSpecSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    sql = """
         INSERT  /*+ append */  INTO APS_TMP_ETL_WIP_CONSTRAINT_V2 ( 
               PRODSPEC_ID,FLOW_KEY, FROM_OPE_NO, FROM_OPE_SEQ, TO_OPE_NO,TO_OPE_SEQ,QTIME_LIMIT)  
         SELECT D.PRODSPEC_ID,                                                               
                D.FLOW_KEY,                                                                  
                MAX(D.FROM_OPE_NO) AS FROM_OPE_NO,                                           
                D.FROM_OPE_SEQ,                                                              
                MAX(D.TO_OPE_NO) AS TO_OPE_NO,                                               
                D.TO_OPE_SEQ,                                                                
                MIN(D.QTIME_LIMIT) AS QTIME_LIMIT                                            
         FROM APS_TMP_ETL_WIP_CONSTRAINT_V1 D                                                             
         WHERE D.FROM_OPE_SEQ is not null AND D.TO_OPE_SEQ is not null                                   
         GROUP BY D.PRODSPEC_ID,D.FLOW_KEY,D.FROM_OPE_SEQ,D.TO_OPE_SEQ    
    """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_WIP_CONSTRAINT_V2",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_WIP_CONSTRAINT_V2")


def InsertWipResultTable(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    # 量测站点也需要考量FutureHold/FutureMerge判断,所有的都考虑进来
    getFutureHoldByMeasureData(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name)

    getFutureHoldByMeasureResultData(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name)
    sql = """
    INSERT INTO APS_TMP_ETL_WIP_CONSTRAINT_V1 (
      PRODSPEC_ID,FLOW_KEY,FROM_OPE_NO,FROM_OPE_SEQ,TO_OPE_NO,TO_OPE_SEQ,QTIME_LIMIT
    )                                                                            
        SELECT QF.PRODSPEC_ID                                                    
               ,QF.FLOW_KEY                                                      
               ,QF.FROM_OPE_NO                                                   
               ,FF.STEP_ID AS FROM_OPE_SEQ                                       
               ,QF.TO_OPE_NO                                                     
               ,TF.STEP_ID AS TO_OPE_SEQ                                                                          
               ,QF.QTIME_LIMIT                                                   
         FROM APS_SYNC_QTIME_CONSTRAINT.APS_SYNC_QTIME_CONSTRAINT QF                
         LEFT JOIN APS_TMP_ETL_WIP_LAST_FLOW FF ON QF.PRODSPEC_ID = FF.PROD_ID       
                                               AND QF.FLOW_KEY = FF.PLAN_ID      
                                               AND QF.FROM_OPE_NO = FF.OPE_NO    
         LEFT JOIN APS_TMP_ETL_WIP_LAST_FLOW TF ON QF.PRODSPEC_ID = TF.PROD_ID       
                                               AND QF.FLOW_KEY = TF.PLAN_ID      
                                               AND QF.TO_OPE_NO = TF.OPE_NO      
         -- WHERE QF.PARTCODE='"+ fvQtimeCsCode +"'
         WHERE 1=1 
    """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_WIP_CONSTRAINT_V1",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_WIP_CONSTRAINT_V1")

    # V_VIRT_QT_SETTING 数据insert 到 temp table
    getVirtQtimeSpecSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name)

    # 取更紧的那个TIMELIMIT的资讯
    getAllQtimeSpecSql(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name)

    # V_QTIME_CONSTRAINT 数据insert 到 temp table
    sql = """
     INSERT /*+ append */ INTO APS_TMP_ETL_WIP_QTIME_FLOW
     (  PRODSPEC_ID                                                              
       ,FLOW_KEY                                                                 
       ,FROM_OPE_NO                                                              
       ,FROM_OPE_SEQ                                                             
       ,TO_OPE_NO                                                                
       ,TO_OPE_SEQ                                                               
       ,OPER_NO                                                                  
       ,OPER_SEQ                                                                 
       ,QTIME_LIMIT                                                              
     )                                                                           
     SELECT  CD.PRODSPEC_ID                                                      
             ,CD.FLOW_KEY                                                        
             ,CD.FROM_OPE_NO                                                     
             ,CD.FROM_OPE_SEQ                                                    
             ,CD.TO_OPE_NO                                                       
             ,CD.TO_OPE_SEQ                                                      
             ,CF.OPE_NO                                                          
             ,CF.STEP_ID AS OPER_SEQ                                             
             ,CD.QTIME_LIMIT                                                     
     FROM APS_TMP_ETL_WIP_CONSTRAINT_V2 CD                                              
     LEFT JOIN APS_TMP_ETL_WIP_LAST_FLOW CF ON CD.PRODSPEC_ID = CF.PROD_ID           
                          AND CD.FLOW_KEY = CF.PLAN_ID                           
                          AND CF.STEP_ID >= CD.FROM_OPE_SEQ                      
                          AND CF.STEP_ID <= CD.TO_OPE_SEQ 
    """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_WIP_QTIME_FLOW",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_WIP_QTIME_FLOW")

    # 插入Assign batch id数据
    sql = """
     INSERT /*+ append */ INTO APS_TMP_ETL_WIP_ASSIGN_ABTCH
     (LOT_ID, OPE_NO, ASSIGN_MULTI_ID)                           
     SELECT LOT_ID,OPE_NO,                                       
            MAX(ASSIGN_BATCH_ID) AS ASSIGN_MULTI_ID              
     FROM                                                        
     (                                                           
         SELECT B.LOT_ID,OPE_NO,                                 
               B.BATCH_ID || '' AS ASSIGN_BATCH_ID               
         FROM APS_SYNC_MLIF_FOR_BATCH_MANU_REG.APS_SYNC_MLIF_FOR_BATCH_MANU_REG B 
         WHERE 1=1
         UNION                                                   
         SELECT W.LOT_ID,OPE_NO,                                 
                W.MLIF_ID AS ASSIGN_BATCH_ID                     
         FROM APS_SYNC_MLIF_FOR_WOT_MANU_REG.APS_SYNC_MLIF_FOR_WOT_MANU_REG W 
         WHERE 1=1
     ) W                                                         
     GROUP BY LOT_ID,OPE_NO 
    """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_WIP_ASSIGN_ABTCH",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_WIP_ASSIGN_ABTCH")

    # 拆分两两join 查找QTime
    sql = """
    INSERT INTO APS_TMP_ETL_WIP_QTIME_RESULT1(                  
      LOT_ID,STEP_ID,OPE_NO,TARGET_STEP_ID,TARGET_OPE_NO,TARGET_PLAN_ID
      ,PROD_ID,PLAN_ID,TARGET_TOOLG_ID,FROM_OPE_NO,FROM_OPE_SEQ
      ,TO_OPE_NO,TO_OPE_SEQ ,OPER_NO,OPER_SEQ,QTIME_LIMIT,PRODSPEC_ID,FLOW_KEY
    )                                                                
     SELECT  W.LOT_ID                                                                                                                                         
            ,W.STEP_ID                                                                                                                                        
            ,W.OPE_NO AS CUR_OPE_NO                                                                                                                                       
            ,W.TARGET_STEP_ID                                                                                                                                 
            ,W.TARGET_OPE_NO                                                                                                                                  
            ,W.TARGET_PLAN_ID                                                                                                                                 
            ,W.PROD_ID                                                                                                                                        
            ,W.PLAN_ID                                                                                                                                        
            ,W.TARGET_TOOLG_ID                                                                                                                                
            ,QF.FROM_OPE_NO                                                                                                                                   
            ,QF.FROM_OPE_SEQ                                                                                                                                  
            ,QF.TO_OPE_NO                                                                                                                                     
            ,QF.TO_OPE_SEQ                                                                                                                                    
            ,QF.OPER_NO                                                                                                                                       
            ,QF.OPER_SEQ                                                                                                                                      
            ,QF.QTIME_LIMIT                                                                                                                                   
            ,QF.PRODSPEC_ID                                                                                                                                   
            ,QF.FLOW_KEY                                                                                                                                   
     FROM APS_HANDLE_WIP W                                                                                                                                 
     INNER JOIN APS_TMP_ETL_WIP_QTIME_FLOW QF ON W.PROD_ID = QF.PRODSPEC_ID AND W.PLAN_ID = QF.FLOW_KEY                                              
                                                  AND W.STEP_ID >= QF.FROM_OPE_SEQ                                                                         
                                                  AND W.TARGET_STEP_ID <= QF.TO_OPE_SEQ 
    """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_WIP_QTIME_RESULT1",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_WIP_QTIME_RESULT1")

    # 拆分两两join 查找QTime
    sql = """
    INSERT INTO APS_TMP_ETL_WIP_QTIME_RESULT2 (                  
       LOT_ID,STEP_ID,OPE_NO,TARGET_STEP_ID,TARGET_OPE_NO
       ,TARGET_PLAN_ID,PROD_ID,PLAN_ID,TARGET_TOOLG_ID
       ,FROM_OPE_NO,FROM_OPE_SEQ,TO_OPE_NO,TO_OPE_SEQ
       ,OPER_NO,OPER_SEQ,QTIME_LIMIT,TRIGGER_TIME,PRODSPEC_ID,FLOW_KEY
    )                                                                
     SELECT  W.LOT_ID                                                                                                                                         
            ,W.STEP_ID                                                                                                                                        
            ,W.OPE_NO                                                                                                                                  
            ,W.TARGET_STEP_ID                                                                                                                                 
            ,W.TARGET_OPE_NO                                                                                                                                  
            ,W.TARGET_PLAN_ID                                                                                                                                 
            ,W.PROD_ID                                                                                                                                        
            ,W.PLAN_ID                                                                                                                                        
            ,W.TARGET_TOOLG_ID                                                                                                                                
            ,W.FROM_OPE_NO                                                                                                                                   
            ,W.FROM_OPE_SEQ                                                                                                                                  
            ,W.TO_OPE_NO                                                                                                                                     
            ,W.TO_OPE_SEQ                                                                                                                                    
            ,W.OPER_NO                                                                                                                        
            ,W.OPER_SEQ                                                                                                                                      
            ,W.QTIME_LIMIT                                                                                                                                   
            ,LQ.TRIGGER_TIME                                                                                                                                  
            ,W.PRODSPEC_ID                                                                                                                                   
            ,W.FLOW_KEY                                                                                                                                      
     FROM APS_TMP_ETL_WIP_QTIME_RESULT1 W                                                                                                                
     INNER JOIN APS_SYNC_FVLOT_QTIME.APS_SYNC_FVLOT_QTIME LQ ON W.LOT_ID = LQ.LOT_ID AND W.TARGET_PLAN_ID = LQ.TRIGGER_MAINPD_ID AND W.FROM_OPE_NO = LQ.TRIGGER_OP_NO 
     WHERE 1=1
    """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_WIP_QTIME_RESULT2",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_WIP_QTIME_RESULT2")

    # 拆分两两join 查找QTime
    sql = """
    INSERT INTO APS_TMP_ETL_WIP_QTIME_RESULT3 (                  
     LOT_ID,STEP_ID,CUR_OPE_NO,TARGET_STEP_ID,TARGET_OPE_NO,TARGET_PLAN_ID
     ,PROD_ID,PLAN_ID,TARGET_TOOLG_ID,FROM_OPE_NO,FROM_OPE_SEQ,TO_OPE_NO
     ,TO_OPE_SEQ,OPER_NO_Q_FLOW,OPER_SEQ,TARGET_OPER_CT,QTIME_LIMIT,MAX_FROM_OPE_SEQ
     ,MIN_QTIME_LIMIT,TRIGGER_TIME
    )                                                               
     SELECT  W.LOT_ID                                                                                                                                         
            ,W.STEP_ID                                                                                                                                        
            ,W.OPE_NO                                                                                                                                         
            ,W.TARGET_STEP_ID                                                                                                                                 
            ,W.TARGET_OPE_NO                                                                                                                                  
            ,W.TARGET_PLAN_ID                                                                                                                                 
            ,W.PROD_ID                                                                                                                                        
            ,W.PLAN_ID                                                                                                                                        
            ,W.TARGET_TOOLG_ID                                                                                                                                
            ,W.FROM_OPE_NO                                                                                                                                   
            ,W.FROM_OPE_SEQ                                                                                                                                  
            ,W.TO_OPE_NO                                                                                                                                     
            ,W.TO_OPE_SEQ                                                                                                                                    
            ,W.OPER_NO                                                                                                                                       
            ,W.OPER_SEQ                                                                                                                                      
            ,F.CYCLE_TIME AS TARGET_OPER_CT                                                                                                                   
            ,W.QTIME_LIMIT                                                                                                                                   
            ,MAX(W.FROM_OPE_SEQ) OVER(PARTITION BY W.PRODSPEC_ID, W.FLOW_KEY, W.FROM_OPE_NO, W.TO_OPE_NO) AS MAX_FROM_OPE_SEQ
            ,MIN(W.QTIME_LIMIT) OVER(PARTITION BY W.PRODSPEC_ID, W.FLOW_KEY, W.FROM_OPE_NO, W.TO_OPE_NO) AS MIN_QTIME_LIMIT
            ,W.TRIGGER_TIME                                                                                                                                  
      FROM APS_TMP_ETL_WIP_QTIME_RESULT2 W                                                                                                                                 
      INNER JOIN APS_TMP_ETL_WIP_LAST_FLOW F ON W.PRODSPEC_ID = F.PROD_ID                                                                                      
                                        AND W.FLOW_KEY = F.PLAN_ID                                                                                         
                                        AND W.OPER_NO = F.OPE_NO                                                                                           
      GROUP BY W.LOT_ID                                                                                                                                       
            ,W.STEP_ID                                                                                                                                        
            ,W.OPE_NO                                                                                                                                         
            ,W.TARGET_STEP_ID                                                                                                                                 
            ,W.TARGET_OPE_NO                                                                                                                                  
            ,W.TARGET_PLAN_ID                                                                                                                                 
            ,W.PROD_ID                                                                                                                                        
            ,W.PLAN_ID                                                                                                                                        
            ,W.TARGET_TOOLG_ID                                                                                                                                
            ,W.PRODSPEC_ID                                                                                                                                   
            ,W.FLOW_KEY                                                                                                                                      
            ,W.FROM_OPE_NO                                                                                                                                   
            ,W.FROM_OPE_SEQ                                                                                                                                  
            ,W.TO_OPE_NO                                                                                                                                     
            ,W.TO_OPE_SEQ                                                                                                                                    
            ,W.OPER_NO                                                                                                                                       
            ,W.OPER_SEQ                                                                                                                                      
            ,W.QTIME_LIMIT                                                                                                                                   
            ,F.CYCLE_TIME                                                                                                                                     
            ,W.TRIGGER_TIME       
    """

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_WIP_QTIME_RESULT3",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_WIP_QTIME_RESULT3")

    sql = """
    INSERT /*+ append */ INTO APS_TMP_ETL_WIP_RESULT                                                                                                                      
     ( 
      --modify by xiecheng for version up
         PARENTID, LOT_ID, STEP_ID, OPE_NO, TARGET_STEP_ID, TARGET_OPE_NO, TARGET_TOOLG_ID, PRODG_ID, PRODG_TECH, PROD_ID,
        PLAN_ID, TARGET_PLAN_ID, LOT_TYPE, FOUP_ID, QTY, PTY, SHR_FLAG, LOT_STATUS, REMAIN_QTIME, QTIME_STEP_ID_TO,
        ARRIVAL, LAYER, STAGE, TOOL_ID, RETICLE_ID, RECIPE, PPID, JOB_PREPARE, TRACK_IN, PROCESS_START, TECH_ID, CUSTOMER,
        LOCATION, FACTORY, PARENT_LOT, CRITICAL_RATIO, HOLD_CODE, PRE_TOOL_ID, PARENT_TOOL_FLAG, UPDATE_TIME, PARTCODE, 
            TARGET_PROD_ID, FROM_STEP_ID,TO_STEP_ID, WHITE_FLAG, BATCH_ID, ASSIGN_MULTI_ID,FROMBATCH_TIME, ASSIGN_TOOL_ID, TRANS_STATE, 
               FOUP_STATION_ID, INHIBIT_PASS_FLAG, PREOHB_TOOL_ID
     )                                                                                                                                               
        WITH QTIME_RESULT AS (                                                                                                                                                   
                SELECT Q.* ,
                      -- ROUND(Q.QTIME_LIMIT - ((TO_DATE('" + updateTime + "', 'yyyy-mm-dd hh24:mi:ss') - Q.TRIGGER_TIME) * 24) - 
                      --           (SUM(Q.TARGET_OPER_CT)
                      --               OVER(PARTITION BY Q.LOT_ID, Q.CUR_OPE_NO, Q.TARGET_OPE_NO, Q.TARGET_PLAN_ID ORDER BY Q.OPER_SEQ  DESC 
                      --                   ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) - Q.TARGET_OPER_CT),2)
            -- AS REMAIN_QTIME      
             -- QTIME 首站不需要考虑QTIME时间 
             -- modify by xiecheng for version up 
             CASE WHEN TARGET_OPE_NO <> FROM_OPE_NO 
                  THEN  ROUND(CAST(Q.QTIME_LIMIT AS DECIMAL) - round((extract(epoch from(STRPTIME(SUBSTRING(CAST(current_timestamp AS STRING),1,POSITION('.' IN CAST(current_timestamp AS STRING))-1), '%Y-%m-%d %H:%M:%S') - STRPTIME(Q.TRIGGER_TIME, '%Y-%m-%d %H:%M:%S')))) / 3600.0,2) - 
                        (SUM(CAST(Q.TARGET_OPER_CT AS DECIMAL))
                        OVER(PARTITION BY Q.LOT_ID, Q.CUR_OPE_NO, Q.TARGET_OPE_NO, Q.TARGET_PLAN_ID ORDER BY Q.OPER_SEQ DESC 
                        ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) - CAST(Q.TARGET_OPER_CT AS DECIMAL)),2) 
             END AS REMAIN_QTIME                                                                                                                                                                    
        FROM (                                                                                                                                                              
               SELECT Q.*                                                                                                                                                   
                     ,ROW_NUMBER()                                                                                                                                          
                      OVER(PARTITION BY Q.LOT_ID, Q.PROD_ID, Q.PLAN_ID, Q.TARGET_OPE_NO, Q.TARGET_TOOLG_ID, Q.TARGET_PLAN_ID , Q.OPER_NO_Q_FLOW ORDER BY Q.QTIME_LIMIT) AS RN               
                FROM APS_TMP_ETL_WIP_QTIME_RESULT3 Q                                                                                                                                                                
              ) Q                                                                                                                                                                           
              WHERE Q.RN = 1                                                                                                                                                                
        ),                                                                                                                                                                                  
     -- 对LotStatus做特殊处理：针对MergeHold的处理
      MERGEHOLD_DETAIL_DATE AS (                                                                                    
          SELECT H.LOT_ID,H.OPE_NO,SUBSTRING(W.TARGET_STEP_ID,2,LENGTH(W.TARGET_STEP_ID)-1) AS TARGET_STEP_ID          
         FROM APS_TMP_ETL_WIP_MERGE_HC H                                                            
         INNER JOIN APS_HANDLE_WIP W                                                                                
                     ON W.LOT_ID= H.LOT_ID AND W.TARGET_OPE_NO = H.OPE_NO                                           
     ),                                                                                                             
     MERGEHOLD_DATE AS (                                                                                                                                                       
          SELECT H.LOT_ID, MIN(TARGET_STEP_ID) AS TARGET_STEP_ID                                                    
          FROM MERGEHOLD_DETAIL_DATE H                                                                              
          GROUP BY H.LOT_ID                                                                                                                           
      )                                                                                                             
       SELECT '{uuid}' AS PARENTID                                                                                                                            
             ,W.LOT_ID                                                                                                                                              
             ,W.STEP_ID                                                                                                                                             
             ,W.OPE_NO                                                                                                                                              
             ,W.TARGET_STEP_ID                                                                                                                                      
             ,W.TARGET_OPE_NO                                                                                                                                       
             ,W.TARGET_TOOLG_ID                                                                                                                                     
             ,W.PRODG_ID                                                                                                                                                    
             ,W.PRODG_TECH                                                                                                                                          
             ,W.PROD_ID                                                                                                                                             
             ,W.PLAN_ID                                                                                                                                             
             ,W.TARGET_PLAN_ID                                                                                                                                      
             ,W.LOT_TYPE                                                                                                                                            
             ,W.FOUP_ID                                                                                                                                             
             ,W.QTY                                                                                                                                                 
             ,W.PTY                                                                                                                                                 
             ,W.SHR_FLAG                                                                                                                                            
      -- 对LotStatus做特殊处理：针对MergeHold的处理
           -- ,CASE WHEN FHT.LOT_ID IS NOT NULL AND W.TARGET_STEP_ID >= FHT.TARGET_STEP_ID THEN FHT.LOT_STATUS ELSE (                                                                                                                                       
           --  CASE WHEN W.LOT_STATUS LIKE 'UMTHold%' AND (SELECT TN.LOT_ID FROM MERGEHOLD_DATE TN WHERE TN.LOT_ID = W.LOT_ID) IS NOT NULL AND SUBSTRING(W.TARGET_STEP_ID,2,LENGTH(W.TARGET_STEP_ID)-1) >=(SELECT WIP.TARGET_STEP_ID FROM MERGEHOLD_DATE WIP WHERE WIP.LOT_ID = W.LOT_ID)                                                                                                                                         
           --  THEN ('MergeHold;'|| W.LOT_STATUS) ELSE (CASE WHEN W.LOT_STATUS NOT LIKE 'UMTHold%' AND (SELECT TN.LOT_ID FROM MERGEHOLD_DATE TN WHERE TN.LOT_ID = W.LOT_ID) IS NOT NULL AND SUBSTRING(W.TARGET_STEP_ID,2,LENGTH(W.TARGET_STEP_ID)-1) >=(SELECT WIP.TARGET_STEP_ID FROM MERGEHOLD_DATE WIP WHERE WIP.LOT_ID = W.LOT_ID)                                                                                                         
           --  THEN 'MergeHold' ELSE W.LOT_STATUS END )END)END AS LOT_STATUS  
              --modify by xiecheng for version up    
              ,CASE WHEN W.LOT_STATUS LIKE 'UMTHold%' AND ((SELECT TN.LOT_ID FROM MERGEHOLD_DATE TN WHERE TN.LOT_ID = W.LOT_ID) IS NOT NULL and 
                        (SELECT TN.LOT_ID FROM MERGEHOLD_DATE TN WHERE TN.LOT_ID = W.LOT_ID) <> '') 
                        AND SUBSTRING(W.TARGET_STEP_ID,2,LENGTH(W.TARGET_STEP_ID)-1) >=(SELECT WIP.TARGET_STEP_ID FROM MERGEHOLD_DATE WIP WHERE WIP.LOT_ID = W.LOT_ID)                                                                                                                   
                    THEN ('MergeHold;'|| W.LOT_STATUS) 
                    WHEN W.LOT_STATUS NOT LIKE 'UMTHold%' AND ((SELECT TN.LOT_ID FROM MERGEHOLD_DATE TN WHERE TN.LOT_ID = W.LOT_ID) IS NOT NULL and
                        (SELECT TN.LOT_ID FROM MERGEHOLD_DATE TN WHERE TN.LOT_ID = W.LOT_ID) <> '')
                        AND SUBSTRING(W.TARGET_STEP_ID,2,LENGTH(W.TARGET_STEP_ID)-1) >=(SELECT WIP.TARGET_STEP_ID FROM MERGEHOLD_DATE WIP WHERE WIP.LOT_ID = W.LOT_ID)                                                                                                
                    THEN 'MergeHold'
                ELSE W.LOT_STATUS END  AS LOT_STATUS  
             --modify by xiecheng for version up                                                                                            
             -- ,NVL(Q.REMAIN_QTIME, 999) AS REMAIN_QTIME
            -- ,COALESCE(Q.REMAIN_QTIME, 999) AS REMAIN_QTIME     
              ,COALESCE(W.REMAIN_QTIME, COALESCE(Q.REMAIN_QTIME, 999)) AS REMAIN_QTIME                                                                                                         
            -- ,Q.TO_OPE_SEQ AS QTIME_STEP_ID_TO   
             ,COALESCE(W.QTIME_STEP_ID_TO, Q.TO_OPE_SEQ) AS QTIME_STEP_ID_TO                                                                                                                    
             ,W.ARRIVAL                                                                                                                                             
             ,W.LAYER                                                                                                                                               
             ,W.STAGE                                                                                                                                               
             ,W.TOOL_ID   
             --modify by xiecheng for version up                                                                                                                                          
             --,W.RETICLE_ID  
              ,CASE WHEN (W.PROCESS_START IS NOT NULL and W.PROCESS_START <> '') AND W.STEP_ID = W.TARGET_STEP_ID 
                         AND (W.RETICLE_ID IS NOT NULL and W.RETICLE_ID <> '') 
                    THEN W.RETICLE_ID
               ELSE MRTN.RTCL_ID END AS RETICLE_ID                                                                                                                                                                                    
             ,W.RECIPE                                                                                                                                              
             ,W.PPID                                                                                                                                                
             ,W.JOB_PREPARE                                                                                                                                         
             ,W.TRACK_IN                                                                                                                                            
             ,W.PROCESS_START                                                                                                                                       
             ,W.TECH_ID                                                                                                                                             
             ,W.CUSTOMER                                                                                                                                            
            -- 如果LOCATION在运输中，则先看前层机台的位置
             -- ,CASE WHEN (W.LOCATION IS NULL OR W.LOCATION='')AND (E.PRE_EQP IS NOT NULL and E.PRE_EQP <>'') THEN NVL((SELECT VLI.LOCATION_ID FROM  " + wip_Location_Info_TempTable + " VLI
             ,CASE WHEN (W.LOCATION IS NULL OR W.LOCATION='')AND (E.PRE_EQP IS NOT NULL and E.PRE_EQP <>'') THEN COALESCE((SELECT VLI.LOCATION_ID FROM  APS_TMP_ETL_WIP_LOCATION_INFO VLI                 
             -- WHERE VLI.TOOL_ID = SUBSTRING(E.PRE_EQP,1,5) ), 'NA') ELSE NVL(W.LOCATION, 'NA') END LOCATION
             WHERE VLI.TOOL_ID = SUBSTRING(E.PRE_EQP,1,5) ), 'NA') ELSE COALESCE(W.LOCATION, 'NA') END AS LOCATION                                                             
             ,W.FAB_PHASE                                                                                                                                           
             ,W.PARENT_LOT                                                                                                                                                  
             ,W.CRITICAL_RATIO                                                                                                                                      
             ,CASE WHEN LENGTH(W.HOLD_CODE) > 512 THEN SUBSTRING(W.HOLD_CODE,0,512) ELSE W.HOLD_CODE END AS HOLD_CODE                                                  
             ,E.PRE_EQP                                                                                                                                             
             ,T.PARENT_TOOL_FLAG                                                                                                                                    
            ,'{current_time}'                                                                                                                                 
            ,''
             ,W.TARGET_PROD_ID                                                                                                                                      
             ,W.FROM_STEP_ID                                                                                                                                        
             ,W.TO_STEP_ID                                                                                                                                          
             ,W.WHITE_FLAG                                                                                                                                          
             ,W.BATCH_ID                                                                                                                                            
             ,ABT.ASSIGN_MULTI_ID                                                                                                                                   
       -- 判断只有当BATCH_ID有值，才输出FROMBATCH_TIME和FROMBATCH_TOOL;FROMBATCH_TOOL 只针对Onhand的数据
             ,CASE WHEN (W.BATCH_ID IS NOT NULL and W.BATCH_ID <> '') THEN (CASE WHEN (BRT.LOT_ID IS NOT NULL and BRT.LOT_ID <> '') THEN BRT.CLAIM_TIME END) END AS FROMBATCH_TIME                                
             ,CASE WHEN (W.BATCH_ID IS NOT NULL and W.BATCH_ID <> '') THEN (CASE WHEN (BRT.LOT_ID IS NOT NULL and BRT.LOT_ID <> '') AND W.MULTI_TARGET_FLAG = 1 THEN BRT.EQP_ID END) END AS FROMBATCH_TOOL        
             ,W.TRANS_STATE, W.FOUP_STATION_ID                                                                                                                      
             ,CASE WHEN (W.BATCH_ID IS NOT NULL and W.BATCH_ID <> '') THEN (CASE WHEN (BRT.LOT_ID IS NOT NULL and BRT.LOT_ID <> '') AND BRT.CLAIM_USER_ID <> 'WFBWD' THEN 1 ELSE 0 END) ELSE 0 END AS INHIBIT_PASS_FLAG          
            --modify by xiecheng for version up
            ,CASE WHEN (POTT.EQP_ID IS NOT NULL and POTT.EQP_ID <> '') AND W.STEP_ID = W.TARGET_STEP_ID THEN POTT.EQP_ID END AS PREOHB_TOOL_ID   
       FROM APS_HANDLE_WIP W                                                                                                                                        
       LEFT JOIN QTIME_RESULT Q ON W.LOT_ID = Q.LOT_ID                                                                                                              
                         AND W.PROD_ID = Q.PROD_ID                                                                                                                  
                         AND W.PLAN_ID = Q.PLAN_ID                                                                                                                  
                         AND W.OPE_NO = Q.CUR_OPE_NO                                                                                                                
                         AND Q.TARGET_OPE_NO = Q.OPER_NO_Q_FLOW                                                                                                     
                         AND W.TARGET_OPE_NO = Q.TARGET_OPE_NO                                                                                                      
       LEFT JOIN APS_TMP_ETL_WIP_PREEQP E ON W.LOT_ID = E.LOT_ID                                                                                                      
                                       AND W.PROD_ID = E.PROD_ID                                                                                                    
                                       AND W.PLAN_ID = E.PLAN_ID                                                                                                    
                                       AND W.OPE_NO = E.OPE_NO                                                                                                      
                                       AND W.TARGET_PLAN_ID = E.TARGET_PLAN_ID                                                                                      
                                       AND W.TARGET_OPE_NO = E.TARGET_OPE_NO                                                                                        
       LEFT JOIN APS_TMP_ETL_WIP_PARENT_TOOL_FLAG T ON W.PARENTID = T.PARENTID                                                                                          
                                               AND W.LOT_ID = T.LOT_ID                                                                                              
                                               AND W.PROD_ID = T.PROD_ID                                                                                            
                                               AND W.PLAN_ID = T.PLAN_ID                                                                                            
                                               AND W.STEP_ID = T.STEP_ID                                                                                                        
                                               AND W.OPE_NO = T.OPE_NO                                                                                              
                                               AND W.TARGET_STEP_ID = T.TARGET_STEP_ID                                                                              
                                               AND W.TARGET_OPE_NO = T.TARGET_OPE_NO                                                                                
                                               AND W.TARGET_PLAN_ID = T.TARGET_PLAN_ID                                                                              
       LEFT JOIN APS_TMP_ETL_WIP_ASSIGN_ABTCH ABT ON ABT.LOT_ID = W.LOT_ID                                                                                      
                                                      AND ABT.OPE_NO = W.TARGET_OPE_NO                                                                              
       LEFT JOIN APS_TMP_ETL_WIP_FORMING_RESULT BRT ON BRT.LOT_ID = W.LOT_ID                                                                                      
                                                      AND BRT.BATCH_NAME = W.MULTI_GROUP                                                                              
       --modify by xiecheng for version up 
       --LEFT JOIN APS_TMP_ETL_WIP_FUTURE_HOLD FHT ON FHT.LOT_ID = W.LOT_ID
       --modify by xiecheng for version up 
        LEFT JOIN APS_TMP_ETL_WIP_MORE_RETICLE MRTN  ON MRTN.PROD_ID = W.PROD_ID                                               
                                                     AND MRTN.OPE_NO = W.TARGET_OPE_NO                                             
        LEFT JOIN APS_TMP_ETL_WIP_PRE_OHB POTT ON POTT.STK_ID = W.FOUP_STATION_ID   
    """.format(uuid=uuid, current_time=current_time)

    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_TMP_ETL_WIP_RESULT",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_TMP_ETL_WIP_RESULT")
    # 增加量测站点FutrueHold的数据进去
    insertWipResultData(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name)


def insertWipResultData(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    sql = """
        INSERT INTO APS_ETL_WIP(                                                   
            PARENTID, LOT_ID, STEP_ID, OPE_NO, TARGET_STEP_ID, TARGET_OPE_NO, TARGET_TOOLG_ID, PRODG_ID, PRODG_TECH, PROD_ID,
            PLAN_ID, TARGET_PLAN_ID, LOT_TYPE, FOUP_ID, QTY, PTY, SHR_FLAG, LOT_STATUS, REMAIN_QTIME, QTIME_STEP_ID_TO,
            ARRIVAL, LAYER, STAGE, TOOL_ID, RETICLE_ID, RECIPE, PPID, JOB_PREPARE, TRACK_IN, PROCESS_START, TECH_ID, CUSTOMER,
            LOCATION, FACTORY, PARENT_LOT, CRITICAL_RATIO, HOLD_CODE, PRE_TOOL_ID, PARENT_TOOL_FLAG, UPDATE_TIME, PARTCODE, 
            TARGET_PROD_ID, FROM_STEP_ID,TO_STEP_ID, WHITE_FLAG, BATCH_ID, ASSIGN_MULTI_ID,FROMBATCH_TIME, ASSIGN_TOOL_ID, TRANS_STATE, 
            FOUP_STATION_ID, INHIBIT_PASS_FLAG, PREOHB_TOOL_ID                                                                         
        )                                                                                        
         SELECT R.PARENTID,                                                                     
                R.LOT_ID,                                                                       
                R.STEP_ID,                                                                      
                R.OPE_NO,                                                                       
                R.TARGET_STEP_ID,                                                               
                R.TARGET_OPE_NO,                                                                
                R.TARGET_TOOLG_ID,                                                              
                R.PRODG_ID,                                                                     
                R.PRODG_TECH,                                                                   
                R.PROD_ID,                                                                      
                R.PLAN_ID,                                                                      
                R.TARGET_PLAN_ID,                                                               
                R.LOT_TYPE,                                                                     
                R.FOUP_ID,                                                                      
                CAST(R.QTY AS DECIMAL), CAST(R.PTY AS INTEGER),                                                                     
                CAST(R.SHR_FLAG AS INTEGER),                                                                     
                CASE WHEN (M.LOT_ID IS NOT NULL and M.LOT_ID <>'') AND R.TARGET_STEP_ID >= M.TARGET_STEP_ID         
                                 THEN M.LOT_STATUS ELSE R.LOT_STATUS END AS LOT_STATUS,         
                CAST(R.REMAIN_QTIME AS DECIMAL),                                                                 
                R.QTIME_STEP_ID_TO,                                                             
                CAST(R.ARRIVAL AS TIMESTAMP),                                                                      
                R.LAYER, R.STAGE,                                                                 
                R.TOOL_ID,                                                                      
                R.RETICLE_ID,                                                                   
                R.RECIPE,                                                                       
                R.PPID,                                                                         
                CAST(R.JOB_PREPARE AS TIMESTAMP),                                                                  
                CAST(R.TRACK_IN AS TIMESTAMP),                                                                     
                CAST(R.PROCESS_START AS TIMESTAMP),                                                                
                R.TECH_ID,                                                                      
                R.CUSTOMER,                                                                     
                R.LOCATION,                                                                     
                R.FACTORY,                                                                      
                R.PARENT_LOT,                                                                   
                CAST(R.CRITICAL_RATIO AS DECIMAL),                                                               
                R.HOLD_CODE,                                                                    
                R.PRE_TOOL_ID,                                                                  
                R.PARENT_TOOL_FLAG,                                                             
                CAST(R.UPDATE_TIME AS TIMESTAMP),                                                                  
                R.PARTCODE,                                                                     
                R.TARGET_PROD_ID,                                                               
                R.FROM_STEP_ID,                                                                 
                R.TO_STEP_ID,                                                                   
                R.WHITE_FLAG,                                                                   
                R.BATCH_ID,                                                                     
                R.ASSIGN_MULTI_ID,                                                              
                CAST(R.FROMBATCH_TIME AS TIMESTAMP),                                                               
                R.ASSIGN_TOOL_ID,                                                               
                R.TRANS_STATE,                                                                  
                R.FOUP_STATION_ID,                                                              
                CAST(R.INHIBIT_PASS_FLAG AS INTEGER),                                                            
                R.PREOHB_TOOL_ID                                                                                                                                                 
         FROM APS_TMP_ETL_WIP_RESULT R                                                      
         LEFT JOIN APS_TMP_ETL_WIP_FUTURE_HOLD_MR M                                             
         ON R.LOT_ID = M.LOT_ID                                                                 
        """
    my_duck.exec_sql(oracle_conn=oracle_conn,
                     duck_db_memory=duck_db_memory,
                     ETL_Proc_Name=ETL_Proc_Name,
                     methodName="Insert Into APS_ETL_WIP",
                     sql=sql,
                     current_time=current_time,
                     update_table="APS_ETL_WIP")


def SummaryOnhandAndTragetWip(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name):
    # 获取车规等级的数据
    getPreferToolData(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name)
    # 获取PreOHB的数据,注意针对Onhand的Lot,如果符合会优先给对应机台排程
    getPreOHBData(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name)
    # 针对特殊Flow Lot回归站点需求
    getRetFlowData(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name)
    # 针对特殊Flow Lot回归站点需求
    getRetFlowStepData(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name)
    # 针对特殊Flow Lot回归站点需求
    getRetFlowResultData(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name)
    InsertNormalFlowTargetWip2HandleTable(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name)
    InsertOnHandeWip2HandleTable(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name)
    # 防止APS_HANDLE_WIP_PRIMARY主键冲突
    InsertBackUpWip2HandleTable(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name)
    # Onhand & Incoming Wip 都串完之后串 Pre Eqp
    InsertWipPreEqp2Temp(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name)
    # Parent Tool Flag 串完之后 insert 到 APS_TMP_ETL_WIP_PARENT_TOOL_FLAG，然后InsertWipResultTable（）的时候串接之后再放到最终的APS_ETL_WIP.
    InsertParentToolFlag2TempTable(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name)
    # insert转flow流程信息，便于关联表aps_etl_wip,aps_etl_flow表
    InsertFlowChange(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name)
    # Insert Result Table
    InsertWipResultTable(duck_db_memory, uuid, current_time, oracle_conn, ETL_Proc_Name)